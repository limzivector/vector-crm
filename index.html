            
            </div>
            <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vector CRM v40.8.5.3</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f8f9fa; --card: #fff; --border: #e0e0e0;
            --text: #1a1a1a; --text2: #555; --muted: #999;
            --bg-primary: #fff; --bg-secondary: #f5f6f8;
            --text-primary: #1a1a1a; --text-secondary: #555;
            --green: #00c875; --green-lt: #e6f9f1;
            --yellow: #fdab3d; --yellow-lt: #fff4e5;
            --red: #e2445c; --red-lt: #ffe5e9;
            --blue: #0073ea; --blue-lt: #e6f4ff;
            --purple: #a25ddc; --purple-lt: #f4ecfb;
            --gray: #c4c4c4; --gray-lt: #f5f6f8;
            --mobile-nav-height: 64px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); font-size: 14px; }
        .app { display: flex; min-height: 100vh; }
        .sidebar { width: 240px; background: #292f4c; color: #fff; position: fixed; height: 100vh; overflow-y: auto; }
        .sidebar-logo { padding: 20px; font-weight: 700; font-size: 18px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; }
        .sidebar-logo span { width: 32px; height: 32px; background: var(--blue); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .org-switcher { margin: 14px 16px 6px; padding: 10px 12px; border-radius: 10px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); display: flex; align-items: center; justify-content: space-between; gap: 10px; cursor: pointer; }
        .org-switcher:hover { background: rgba(255,255,255,0.12); }
        .org-switcher-label { font-size: 11px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.6px; }
        .org-switcher-name { font-size: 13px; font-weight: 600; color: #fff; }
        .org-switcher-caret { color: rgba(255,255,255,0.7); font-size: 14px; }
        .org-switcher-overlay { position: fixed; inset: 0; background: rgba(15,18,30,0.45); display: none; align-items: flex-start; justify-content: flex-start; z-index: 200; }
        .org-switcher-overlay.show { display: flex; }
        .org-switcher-card { margin: 86px 0 0 70px; width: 320px; background: #fff; border-radius: 14px; box-shadow: 0 18px 40px rgba(0,0,0,0.25); border: 1px solid var(--border); overflow: hidden; }
        .org-switcher-header { padding: 12px; border-bottom: 1px solid var(--border); background: #f8f9fb; font-size: 12px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.6px; }
        .org-switcher-list { max-height: 300px; overflow: auto; }
        .org-switcher-item { padding: 10px 12px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; border-bottom: 1px solid var(--border); }
        .org-switcher-item:last-child { border-bottom: none; }
        .org-switcher-item:hover { background: var(--gray-lt); }
        .org-switcher-item .meta { font-size: 11px; color: var(--muted); }
        .org-switcher-item.active { background: var(--blue-lt); }
        .org-switcher-item.active .name { color: var(--blue); font-weight: 600; }
        .nav-group { padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-group-title { padding: 8px 20px; font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.5); text-transform: uppercase; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 20px; color: rgba(255,255,255,0.8); cursor: pointer; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: rgba(255,255,255,0.15); color: #fff; border-left: 3px solid var(--blue); }
        .nav-item svg { width: 18px; height: 18px; opacity: 0.7; }
        .nav-badge { margin-left: auto; background: var(--red); color: #fff; font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px; }
        .nav-integrations { padding: 16px 20px; margin-top: auto; }
        .integration-item { display: flex; align-items: center; gap: 10px; padding: 6px 0; font-size: 13px; color: rgba(255,255,255,0.6); }
        .integration-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); margin-left: auto; }
        .main { flex: 1; margin-left: 240px; }
        .header { background: var(--card); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-title { font-size: 20px; font-weight: 700; }
        .header-tabs { display: flex; gap: 4px; margin-left: 24px; }
        .header-tabs.compact { margin-left: 16px; }
        .header-tabs.compact .header-tab { padding: 6px 10px; font-size: 12px; }
        .header-tab { padding: 8px 16px; font-size: 13px; font-weight: 500; color: var(--text2); border-radius: 6px; cursor: pointer; }
        .header-tab:hover { background: var(--gray-lt); }
        .header-tab.active { background: var(--blue-lt); color: var(--blue); }
        .btn { padding: 8px 16px; border-radius: 6px; font-family: inherit; font-size: 13px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--blue); color: #fff; }
        .btn-outline { background: var(--card); border: 1px solid var(--border); color: var(--text); }
        .btn:hover { opacity: 0.9; }
        .content { padding: 24px; }
        #view-clients .content { background: #fff; border: 1px solid var(--border); border-radius: 8px; }
        .spreadsheet { background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .cs-inbox { background: var(--card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 16px; overflow: hidden; }
        .cs-inbox-header { padding: 12px 16px; font-weight: 600; border-bottom: 1px solid var(--border); background: #f8f9fa; display:flex; align-items:center; justify-content:space-between; }
        .cs-scroll { overflow-x: auto; }
        .cs-inbox table { width:100%; border-collapse: separate; border-spacing:0; font-size:12px; }
        .cs-inbox th, .cs-inbox td { padding: 8px 10px; border-bottom:1px solid var(--border); border-right:1px solid var(--border); vertical-align: top; }
        .cs-inbox th { background: #f5f6f8; font-size:11px; font-weight:600; text-transform: uppercase; color: var(--muted); }
        .cs-inbox input, .cs-inbox select { width: 100%; font-size: 12px; padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; }
        .cs-inbox .cs-actions { white-space: nowrap; }
        .po-group { border-bottom: 1px solid var(--border); }
        .po-header { display: grid; grid-template-columns: 40px 1fr 120px 120px 120px 100px 100px; background: #f8f9fa; cursor: pointer; }
        .po-header:hover { background: #f0f1f3; }
        .po-header > div { padding: 12px; border-right: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
        .po-expand { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; color: var(--muted); transition: transform 0.2s; }
        .po-expand.open { transform: rotate(90deg); }
        .po-subitems { display: none; }
        .po-subitems.open { display: block; }
        .subitem-header { display: grid; grid-template-columns: 40px 1fr 120px 120px 120px 100px 100px; background: #f5f6f8; font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; border-bottom: 1px solid var(--border); }
        .subitem-header > div { padding: 8px 12px; border-right: 1px solid var(--border); }
        .subitem-header > div:first-child { padding-left: 40px; }
        .subitem-row { display: grid; grid-template-columns: 40px 1fr 120px 120px 120px 100px 100px; border-bottom: 1px solid var(--border); cursor:pointer; }
        .subitem-row:hover { background: #fafbfc; }
        .subitem-row > div { padding: 10px 12px; border-right: 1px solid var(--border); display: flex; align-items: center; }
        .subitem-row > div:first-child { padding-left: 40px; }
        .add-subitem { padding: 8px 12px 8px 52px; color: var(--blue); font-size: 13px; cursor: pointer; }
        .add-subitem:hover { background: var(--blue-lt); }
        .shipments-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .shipments-scroll .po-header,
        .shipments-scroll .subitem-header,
        .shipments-scroll .subitem-row,
        .shipments-scroll .add-subitem { min-width: 760px; }
        .status { padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .status-received { background: var(--green); color: #fff; }
        .status-not-received { background: var(--gray-lt); color: var(--text2); }
        .scans-grid { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .scans-header, .scans-row { display: grid; grid-template-columns: 44px minmax(180px, 2fr) 110px 110px 110px 100px; min-width: 720px; }
        .scans-header { background: var(--gray-lt); font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; border-bottom: 1px solid var(--border); }
        .scans-header > div, .scans-row > div { padding: 10px 12px; border-right: 1px solid var(--border); display: flex; align-items: center; min-width: 0; }
        .scans-header > div:last-child, .scans-row > div:last-child { border-right: none; }
        .scans-row { border-bottom: 1px solid var(--border); cursor: pointer; }
        .scans-row:hover { background: #fafbfc; }
        .pm-checklist { display: grid; gap: 6px; margin-top: 4px; }
        .pm-check { display: flex; align-items: center; gap: 8px; font-size: 12px; background: var(--gray-lt); padding: 6px 8px; border-radius: 6px; }
        .scan-indicator { width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .scan-indicator.pending { background: var(--yellow-lt); }
        .scan-indicator.done { background: var(--green-lt); }
        .calendar-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
        .calendar-nav { display: flex; gap: 4px; }
        .calendar-nav button { width: 32px; height: 32px; border: 1px solid var(--border); background: var(--card); border-radius: 6px; cursor: pointer; }
        .calendar-month { font-size: 18px; font-weight: 600; min-width: 180px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .calendar-day-header { background: var(--gray-lt); padding: 10px; text-align: center; font-size: 12px; font-weight: 600; color: var(--muted); }
        .calendar-day { background: var(--card); min-height: 100px; padding: 8px; }
        .calendar-day.other { background: #fafafa; }
        .calendar-day.today { background: var(--blue-lt); }
        .day-num { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
        .calendar-event { background: var(--green); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-bottom: 2px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .calendar-event.followup { background: var(--yellow); color: #fff; }
        .calendar-event.no-team { background: var(--yellow); }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
        .list-search { position: relative; margin-left: 16px; }
        .list-search .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 12px; }
        .list-search input { padding: 8px 12px 8px 28px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; width: 260px; }
        .list-search input:focus { outline: none; border-color: var(--blue); }
        .pipeline-board { display: grid; grid-auto-flow: column; grid-auto-columns: minmax(240px, 1fr); gap: 14px; overflow-x: auto; padding-bottom: 8px; }
        .pipeline-col { background: var(--gray-lt); border: 1px solid var(--border); border-radius: 10px; display: flex; flex-direction: column; min-height: 220px; }
        .pipeline-col-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--text2); letter-spacing: 0.5px; }
        .pipeline-col-body { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .pipeline-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 10px; cursor: pointer; transition: all 0.15s; }
        .pipeline-card:hover { border-color: var(--blue); box-shadow: 0 4px 10px rgba(0,0,0,0.08); transform: translateY(-1px); }
        .pipeline-card-title { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
        .pipeline-card-sub { font-size: 12px; color: var(--text2); }
        .pipeline-card-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; font-size: 11px; color: var(--muted); }
        .pipeline-empty { font-size: 12px; color: var(--muted); padding: 6px 4px; }
        .projects-table { width: 100%; border-collapse: collapse; background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .projects-table th { background: var(--gray-lt); padding: 10px 12px; text-align: left; font-size: 11px; text-transform: uppercase; color: var(--muted); font-weight: 600; border-bottom: 1px solid var(--border); }
        .projects-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 13px; }
        .projects-table tr:hover td { background: #fafbfc; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .dashboard-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
        .dashboard-card h3 { font-size: 14px; font-weight: 700; margin-bottom: 12px; }
        .dashboard-stat { font-size: 28px; font-weight: 700; color: var(--blue); }
        .dashboard-stat-label { font-size: 12px; color: var(--text2); margin-top: 4px; }
        .dashboard-list { display: flex; flex-direction: column; gap: 8px; }
        .dashboard-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--card); cursor: pointer; }
        .dashboard-item:hover { border-color: var(--blue); }
        .dashboard-item-title { font-weight: 600; font-size: 13px; }
        .dashboard-item-sub { font-size: 12px; color: var(--text2); margin-top: 2px; }
        .dashboard-item-meta { font-size: 12px; color: var(--muted); }
        .auto-toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:16px; }
        .auto-filters { display:flex; gap:8px; flex-wrap:wrap; }
        .auto-filter-btn { padding:6px 10px; border:1px solid var(--border); border-radius:6px; font-size:12px; background:var(--card); cursor:pointer; color:var(--text2); }
        .auto-filter-btn.active { border-color: var(--blue); color: var(--blue); background: var(--blue-lt); }
        .auto-table { width:100%; border-collapse:collapse; background:var(--card); border:1px solid var(--border); border-radius:8px; overflow:hidden; }
        .auto-table th { background: var(--gray-lt); padding:10px 12px; text-align:left; font-size:11px; text-transform:uppercase; color:var(--muted); font-weight:600; border-bottom:1px solid var(--border); }
        .auto-table td { padding:10px 12px; border-bottom:1px solid var(--border); font-size:13px; }
        .auto-table tr:hover td { background:#fafbfc; }
        .status-pill.small { font-size:10px; padding:2px 6px; }
        .auto-row-actions { display:flex; gap:8px; align-items:center; }
        .auto-kebab { background:none; border:none; font-size:16px; cursor:pointer; color:var(--text2); }
        .availability-layout { display:grid; grid-template-columns:1.2fr 1fr; gap:20px; }
        .availability-card { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:16px; }
        .availability-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
        .availability-row { display:grid; grid-template-columns:120px 1fr 60px; align-items:center; gap:12px; padding:8px 0; border-bottom:1px solid var(--border); }
        .availability-row:last-child { border-bottom:none; }
        .availability-day { font-weight:600; font-size:13px; color:var(--text2); }
        .availability-times { display:flex; flex-direction:column; gap:6px; }
        .availability-time { display:flex; align-items:center; gap:8px; }
        .availability-time input[type="time"] { padding:6px 8px; border:1px solid var(--border); border-radius:6px; font-size:12px; }
        .availability-actions { display:flex; gap:6px; }
        .availability-muted { font-size:12px; color:var(--muted); }
        .availability-right { display:flex; flex-direction:column; gap:12px; }
        .availability-date-row { display:grid; grid-template-columns:120px 1fr; gap:12px; align-items:center; padding:8px 0; border-bottom:1px solid var(--border); }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; cursor: pointer; }
        .card:hover { border-color: var(--blue); }
        .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .card-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--purple-lt); color: var(--purple); display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .card-title { font-weight: 600; }
        .card-subtitle { font-size: 13px; color: var(--text2); }
        .card-stats { display: flex; gap: 16px; font-size: 13px; color: var(--text2); padding-top: 12px; border-top: 1px solid var(--border); }
        .status-pill { font-size: 11px; background: var(--gray-lt); color: var(--text2); padding: 2px 8px; border-radius: 12px; margin-left: 6px; display: inline-block; }
        .mini-card { background: var(--gray-lt); padding: 8px; border-radius: 6px; margin-bottom: 6px; }
        .panel { position: fixed; top: 0; right: -500px; width: 500px; height: 100vh; background: var(--card); border-left: 1px solid var(--border); z-index: 100; transition: right 0.3s; overflow-y: auto; }
        .panel.open { right: 0; }
        .panel-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .panel-close { width: 32px; height: 32px; border: none; background: var(--gray-lt); border-radius: 6px; cursor: pointer; }
        .panel-title { font-size: 18px; font-weight: 700; }
        .panel-subtitle { font-size: 14px; color: var(--text2); margin-top: 4px; }
        .panel-body { padding: 20px; }
        .panel-section { margin-bottom: 24px; }
        .panel-section-title { font-size: 12px; font-weight: 600; color: var(--muted); text-transform: uppercase; margin-bottom: 12px; }
        .team-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--gray-lt); border-radius: 6px; margin-bottom: 8px; cursor: pointer; }
        .team-item:hover { background: #e8e9eb; }
        .team-item.assigned { background: var(--green-lt); }
        .team-item.assigned .card-avatar { background: var(--green); color: #fff; }
        .team-check { width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 4px; margin-left: auto; display: flex; align-items: center; justify-content: center; }
        .team-item.assigned .team-check { background: var(--green); border-color: var(--green); }
        .doc-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--gray-lt); border-radius: 6px; margin-bottom: 8px; }
        .doc-item:hover { background: #e8e9eb; }
        .doc-status { font-size: 12px; color: var(--muted); }
        .doc-status.has { color: var(--green); }
        .doc-actions { margin-left: auto; display: flex; gap: 8px; }
        .doc-actions .btn { padding: 4px 10px; font-size: 11px; }
        .doc-meta { font-size: 12px; color: var(--muted); }
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 200; }
        .modal-bg.open { display: flex; }
        .modal { background: var(--card); border-radius: 12px; width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 700; }
        .modal-close { width: 32px; height: 32px; border: none; background: var(--gray-lt); border-radius: 6px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; }
        .form-label .req { color: var(--red); }
        .form-input, .form-select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 14px; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--blue); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-hint { font-size: 12px; color: var(--muted); margin-top: 4px; }
        .inline-add { display: flex; gap: 8px; margin-top: 8px; padding: 10px; background: var(--blue-lt); border-radius: 6px; }
        .inline-add.hidden { display: none; }
        .file-attached { background: var(--green-lt); padding: 12px; border-radius: 6px; display: flex; align-items: center; gap: 10px; }
        .toast { position: fixed; bottom: 24px; right: 24px; background: #333; color: #fff; padding: 12px 20px; border-radius: 8px; transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 300; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .scan-alert { position: fixed; top: 20px; right: 20px; background: var(--card); border: 2px solid var(--green); border-radius: 12px; padding: 16px; width: 320px; display: none; z-index: 150; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .scan-alert.show { display: block; }
        .scan-alert-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .scan-alert-icon { width: 40px; height: 40px; background: var(--green-lt); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .scan-alert-title { font-weight: 600; }
        .scan-alert-file { font-size: 13px; color: var(--text2); }
        .scan-alert-actions { display: flex; gap: 8px; }
        .scan-alert-btn { flex: 1; padding: 10px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; }
        .scan-alert-btn.primary { background: var(--green); color: #fff; }
        .scan-alert-btn.secondary { background: var(--gray-lt); }
        .view { display: none; }
        .view.active { display: block; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .punchlist-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .punchlist-stat { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
        .punchlist-stat-label { font-size: 12px; color: var(--muted); text-transform: uppercase; font-weight: 600; margin-bottom: 8px; }
        .punchlist-stat-value { font-size: 28px; font-weight: 700; }
        .punchlist-filters { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        .punchlist-filter { padding: 8px 16px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); cursor: pointer; font-size: 13px; }
        .punchlist-filter.active { background: var(--blue-lt); border-color: var(--blue); color: var(--blue); }
        .punchlist-table { background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .punchlist-header { display: grid; grid-template-columns: 1fr 120px 100px 120px 100px 120px; background: var(--gray-lt); padding: 12px; font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; border-bottom: 1px solid var(--border); }
        .punchlist-row { display: grid; grid-template-columns: 1fr 120px 100px 120px 100px 120px; padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .punchlist-row:hover { background: #fafbfc; }
        .punchlist-row > div { display: flex; align-items: center; gap: 8px; }
        .punchlist-info { display: flex; flex-direction: column; gap: 4px; }
        .punchlist-item-desc { font-weight: 500; }
        .punchlist-item-po { font-size: 12px; color: var(--muted); font-family: monospace; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .badge-damaged { background: var(--red-lt); color: var(--red); }
        .badge-missing { background: var(--yellow-lt); color: var(--yellow); }
        .badge-backorder { background: var(--blue-lt); color: var(--blue); }
        .badge-open { background: var(--red-lt); color: var(--red); }
        .badge-inprogress { background: var(--yellow-lt); color: var(--yellow); }
        .badge-resolved { background: var(--green-lt); color: var(--green); }
        .photo-preview { width: 60px; height: 60px; border-radius: 6px; background: var(--gray-lt); display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .photo-preview img { width: 100%; height: 100%; object-fit: cover; }
        .photo-preview-grid { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
        .photo-remove { position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; border-radius: 50%; border: none; background: var(--red); color: #fff; font-size: 12px; line-height: 20px; cursor: pointer; }
        .upload-photo-btn { padding: 8px 12px; background: var(--blue-lt); color: var(--blue); border: 1px dashed var(--blue); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .scan-thumbnail { width: 100%; max-width: 300px; max-height: 200px; border-radius: 8px; margin-top: 12px; border: 1px solid var(--border); }
        .hidden-file-input { display: none; }
        .wh-breadcrumb { display:flex; align-items:center; gap:8px; padding:12px 0; margin-bottom:16px; font-size:13px; flex-wrap:wrap; }
        .wh-breadcrumb a { color:var(--blue); cursor:pointer; text-decoration:none; padding:4px 8px; border-radius:4px; }
        .wh-breadcrumb a:hover { background:var(--blue-lt); }
        .wh-breadcrumb .separator { color:var(--text2); margin:0 4px; }
        .wh-breadcrumb .current { color:var(--text); font-weight:500; }
        .wh-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:16px; margin-bottom:24px; }
        .wh-card { background:var(--card); border:1px solid var(--border); border-radius:8px; padding:16px; cursor:pointer; transition:all 0.2s; display:flex; gap:12px; align-items:flex-start; }
        .wh-card:hover { border-color:var(--blue); box-shadow:0 2px 8px rgba(0,0,0,0.1); transform:translateY(-2px); }
        .wh-card-icon { width:48px; height:48px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:600; color:#fff; flex-shrink:0; }
        .wh-card-icon.row { background:var(--blue); } .wh-card-icon.bay { background:var(--purple); } .wh-card-icon.bin { background:var(--green); } .wh-card-icon.special { background:var(--yellow); }
        .wh-card-info .name { font-weight:500; color:var(--text); margin-bottom:4px; } .wh-card-info .count { font-size:12px; color:var(--text2); }
        .wh-item-card { background:var(--card); border:1px solid var(--border); border-radius:8px; padding:12px; cursor:pointer; transition:all 0.2s; display:flex; gap:12px; }
        .wh-item-card:hover { border-color:var(--blue); background:var(--bg); }
        .wh-item-card .thumb { width:60px; height:60px; border-radius:6px; background:var(--border); flex-shrink:0; overflow:hidden; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:24px; }
        .wh-item-card .thumb img { width:100%; height:100%; object-fit:cover; }
        .wh-item-card .info .name { font-weight:500; margin-bottom:4px; } .wh-item-card .info .qty { font-size:13px; color:var(--text2); }
        .wh-detail { background:var(--card); border:1px solid var(--border); border-radius:8px; padding:24px; max-width:700px; }
        .wh-detail-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px; gap:12px; }
        .wh-detail-title { font-size:20px; font-weight:600; }
        .wh-detail-section { margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid var(--border); }
        .wh-detail-section:last-child { border-bottom:none; }
        .wh-detail-label { font-size:11px; font-weight:600; text-transform:uppercase; color:var(--text2); margin-bottom:8px; letter-spacing:0.5px; }
        .wh-detail-value { font-size:14px; color:var(--text); }
        .wh-detail-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px; }
        .wh-photos { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:12px; }
        .wh-photo { aspect-ratio:1; border-radius:6px; overflow:hidden; background:var(--border); }
        .wh-photo img { width:100%; height:100%; object-fit:cover; }
        .wh-tag { display:inline-block; background:var(--gray-lt); color:var(--text); padding:4px 12px; border-radius:20px; font-size:12px; margin:0 8px 8px 0; }
        .wh-custom-field { display:grid; grid-template-columns:1fr 1fr auto; gap:12px; margin-bottom:12px; align-items:flex-end; }
        .wh-custom-field input { padding:8px 12px; border:1px solid var(--border); border-radius:4px; font-size:13px; }
        .wh-custom-field .remove-btn { padding:8px 12px; background:var(--red-lt); color:var(--red); border:1px solid var(--red); border-radius:4px; cursor:pointer; font-size:12px; }
        .wh-empty { text-align:center; padding:60px 20px; color:var(--text2); }
        .wh-empty-icon { font-size:48px; margin-bottom:16px; }
        /* Location Autocomplete */
        .loc-suggestions { position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid var(--border); border-radius:0 0 6px 6px; max-height:180px; overflow-y:auto; z-index:100; box-shadow:0 4px 12px rgba(0,0,0,0.12); }
        .loc-sug-item { padding:8px 12px; cursor:pointer; font-size:13px; border-bottom:1px solid var(--border); }
        .loc-sug-item:last-child { border-bottom:none; }
        .loc-sug-item:hover { background:var(--blue-lt); }
        .loc-sug-item strong { color:var(--blue); }
        /* Loading Sheet Styles */
        .ls-search-box { position:relative; margin-bottom:16px; }
        .ls-search-input { width:100%; padding:10px 12px 10px 36px; border:1px solid var(--border); border-radius:6px; font-size:14px; font-family:inherit; }
        .ls-search-input:focus { outline:none; border-color:var(--blue); }
        .ls-search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--muted); }
        .wh-header-actions { display:flex; align-items:center; gap:12px; }
        .wh-search-box { margin-bottom:0; width:280px; }
        .wh-search-meta { font-size:12px; color:var(--text2); margin-bottom:12px; }
        .wh-search-section { margin-bottom:20px; }
        .wh-search-title { font-size:11px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; }
        .ls-results { border:1px solid var(--border); border-radius:6px; max-height:250px; overflow-y:auto; margin-bottom:16px; }
        .ls-result-item { display:flex; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid var(--border); }
        .ls-result-item:last-child { border-bottom:none; }
        .ls-po-label { font-family:monospace; font-weight:500; }
        .ls-po-meta { font-size:12px; color:var(--text2); }
        .ls-selected { background:var(--green-lt); border:1px solid var(--green); border-radius:6px; padding:12px; margin-bottom:16px; }
        .ls-selected-title { font-size:12px; font-weight:600; color:var(--green); text-transform:uppercase; margin-bottom:8px; }
        .ls-equipment { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
        .ls-equipment label { display:flex; align-items:center; gap:8px; padding:6px; cursor:pointer; font-size:13px; border-radius:4px; }
        .ls-equipment label:hover { background:var(--gray-lt); }
        .ls-split-banner { background:var(--yellow-lt); border:1px solid var(--yellow); border-radius:6px; padding:12px; margin-bottom:16px; display:flex; align-items:center; gap:10px; }
        .ls-history-card { padding:14px; border:1px solid var(--border); border-radius:8px; margin-bottom:10px; background:var(--card); }
        .ls-history-card:hover { border-color:var(--blue); }
        .ls-tag { display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; }
        .ls-tag-loading { background:var(--yellow-lt); color:#b8860b; }
        .ls-tag-complete { background:var(--green-lt); color:var(--green); }
        .ls-tag-partial { background:var(--blue-lt); color:var(--blue); }
        .ls-tag-split { background:var(--purple-lt); color:var(--purple); }
        /* Project Completion Styles */
        .pc-section { margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid var(--border); }
        .pc-section:last-child { border-bottom:none; }
        .pc-section-title { font-size:12px; font-weight:700; text-transform:uppercase; color:var(--text2); margin-bottom:10px; letter-spacing:0.5px; }
        .pc-checklist { display:flex; flex-direction:column; gap:6px; }
        .pc-checklist label { display:flex; align-items:center; gap:10px; padding:6px 8px; cursor:pointer; font-size:13px; border-radius:4px; }
        .pc-checklist label:hover { background:var(--gray-lt); }
        .pc-role-lock { background:var(--yellow-lt); border:1px solid var(--yellow); border-radius:8px; padding:16px; text-align:center; margin:24px 0; }
        .pc-role-lock-icon { font-size:32px; margin-bottom:8px; }
        .panel-tabs { display:flex; gap:4px; padding:0 20px; border-bottom:1px solid var(--border); }
        .panel-tab-btn { padding:10px 16px; font-size:13px; font-weight:500; color:var(--text2); cursor:pointer; border-bottom:2px solid transparent; }
        .panel-tab-btn:hover { color:var(--text); }
        .panel-tab-btn.active { color:var(--blue); border-bottom-color:var(--blue); }
        /* Client Portal Styles */
        .portal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:#292f4c; z-index:9999; display:none; flex-direction:column; }
        .portal-overlay.active { display:flex; }
        .portal-login { max-width:400px; margin:auto; padding:40px; background:var(-card); border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
        .portal-login h1 { font-size:24px; font-weight:700; margin-bottom:8px; text-align:center; }
        .portal-login p { color:var(--text2); font-size:14px; text-align:center; margin-bottom:24px; }
        .portal-login .form-group { margin-bottom:16px; }
        .portal-login .form-label { display:block; font-weight:600; margin-bottom:6px; font-size:13px; }
        .portal-login .form-input { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:6px; font-family:inherit; font-size:14px; }
        .portal-login .btn-primary { width:100%; padding:12px; font-size:15px; margin-top:8px; }
        .portal-login .portal-error { color:var(--red); font-size:13px; text-align:center; margin-top:12px; display:none; }
        .portal-logo { text-align:center; margin-bottom:24px; }
        .portal-logo span { display:inline-flex; width:48px; height:48px; background:var(--blue); border-radius:12px; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:22px; }
        .portal-dash { display:none; flex-direction:column; height:100vh; background:var(--bg); }
        .portal-dash.active { display:flex; }
        .portal-topbar { background:#292f4c; color:#fff; padding:16px 24px; display:flex; align-items:center; justify-content:space-between; }
        .portal-topbar h2 { font-size:18px; font-weight:600; display:flex; align-items:center; gap:10px; }
        .portal-topbar h2 span { width:32px; height:32px; background:var(--blue); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:14px; }
        .portal-topbar .btn-outline { color:#fff; border-color:rgba(255,255,255,0.3); }
        .portal-body { flex:1; overflow-y:auto; padding:24px; }
        .portal-section { margin-bottom:32px; }
        .portal-section h3 { font-size:18px; font-weight:700; margin-bottom:16px; display:flex; align-items:center; gap:8px; }
        .portal-project-card { background:var(--card); border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:12px; cursor:pointer; }
        .portal-project-card:hover { border-color:var(--blue); }
        .portal-project-card h4 { font-size:16px; font-weight:600; margin-bottom:8px; }
        .portal-project-card .meta { display:flex; gap:16px; font-size:13px; color:var(--text2); }
        .portal-shipment-table { width:100%; border-collapse:collapse; background:var(--card); border:1px solid var(--border); border-radius:8px; overflow:hidden; }
        .portal-shipment-table th { background:var(--gray-lt); padding:10px 12px; text-align:left; font-size:11px; text-transform:uppercase; color:var(--muted); font-weight:600; border-bottom:1px solid var(--border); }
        .portal-shipment-table td { padding:10px 12px; border-bottom:1px solid var(--border); font-size:13px; }
        .portal-shipment-table tr:hover td { background:#fafbfc; }
        .portal-stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:16px; margin-bottom:24px; }
        .portal-stat { background:var(--card); border:1px solid var(--border); border-radius:8px; padding:16px; text-align:center; }
        .portal-stat .num { font-size:28px; font-weight:700; color:var(--blue); }
        .portal-stat .label { font-size:12px; color:var(--text2); margin-top:4px; }

        /* Quote Share (public link-only quote view) */
        .quote-share-overlay { position:fixed; inset:0; background:#f4f6fa; z-index:10001; display:none; overflow:auto; }
        .quote-share-overlay.active { display:block; }
        .quote-share-topbar { position:sticky; top:0; background:#292f4c; color:#fff; padding:14px 18px; border-bottom:1px solid rgba(255,255,255,0.12); z-index:1; }
        .quote-share-brand { display:flex; align-items:center; gap:10px; font-weight:700; }
        .quote-share-brand span { width:32px; height:32px; background:var(--blue); border-radius:8px; display:flex; align-items:center; justify-content:center; }
        .quote-share-wrap { max-width:860px; margin:24px auto; padding:0 16px 48px; }
        .quote-share-card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; box-shadow:0 12px 30px rgba(0,0,0,0.08); }
        .quote-share-loading { font-size:14px; color:var(--text2); }
        .quote-share-error { color:var(--red); font-size:14px; }
        .quote-share-kv { display:flex; gap:16px; flex-wrap:wrap; margin-top:12px; font-size:12px; color:var(--text2); }
        .quote-share-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:16px; flex-wrap:wrap; }
        .quote-share-table { width:100%; border-collapse:collapse; margin-top:16px; }
        .quote-share-table th { text-align:left; font-size:11px; text-transform:uppercase; color:var(--muted); padding:10px 8px; border-bottom:1px solid var(--border); background:var(--gray-lt); }
        .quote-share-table td { padding:10px 8px; border-bottom:1px solid var(--border); font-size:13px; }
        .quote-share-total { text-align:right; margin-top:12px; }
        .quote-share-total div { font-size:13px; color:var(--text2); }
        .quote-share-total strong { font-size:16px; color:var(--text); }
        @media (max-width: 600px) {
          .quote-share-card { padding:14px; }
          .quote-share-actions { justify-content:stretch; }
          .quote-share-actions .btn { width:100%; justify-content:center; }
        }

        /* Settings & Staff Management */
        .settings-tabs { display:flex; gap:4px; margin-bottom:24px; background:var(--gray-lt); border-radius:8px; padding:4px; }
        .settings-tab { padding:10px 20px; border-radius:6px; font-size:13px; font-weight:600; cursor:pointer; color:var(--text2); border:none; background:none; font-family:inherit; }
        .settings-tab:hover { background:rgba(0,0,0,0.05); }
        .settings-tab.active { background:var(--card); color:var(--blue); box-shadow:0 1px 3px rgba(0,0,0,0.1); }
        .settings-section { display:none; }
        .settings-section.active { display:block; }
        .settings-card { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:20px; margin-bottom:16px; }
        .settings-card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
        .settings-card-header h3 { font-size:16px; font-weight:700; }
        .settings-card-header .badge { font-size:11px; padding:4px 10px; border-radius:20px; font-weight:600; }
        .badge-connected { background:var(--green-lt); color:#0a8f4f; }
        .badge-disconnected { background:var(--gray-lt); color:var(--muted); }
        .integration-card { display:flex; gap:16px; align-items:flex-start; }
        .integration-icon { width:48px; height:48px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:24px; flex-shrink:0; }
        .integration-info { flex:1; }
        .integration-info p { font-size:13px; color:var(--text2); margin:4px 0 12px; }
        .toggle-switch { position:relative; width:44px; height:24px; cursor:pointer; }
        .toggle-switch input { display:none; }
        .toggle-slider { position:absolute; top:0; left:0; right:0; bottom:0; background:var(--gray); border-radius:24px; transition:0.3s; }
        .toggle-slider:before { content:''; position:absolute; width:18px; height:18px; left:3px; bottom:3px; background:#fff; border-radius:50%; transition:0.3s; }
        .toggle-switch input:checked + .toggle-slider { background:var(--green); }
        .toggle-switch input:checked + .toggle-slider:before { transform:translateX(20px); }
        .perm-grid { width:100%; border-collapse:separate; border-spacing:0; background:var(--card); border:1px solid var(--border); border-radius:8px; overflow:hidden; }
        .perm-grid th { padding:10px 14px; text-align:left; font-size:11px; text-transform:uppercase; color:var(--muted); font-weight:600; background:var(--gray-lt); border-bottom:1px solid var(--border); }
        .perm-grid th:not(:first-child) { text-align:center; }
        .perm-grid td { padding:10px 14px; border-bottom:1px solid var(--border); font-size:13px; }
        .perm-grid td:not(:first-child) { text-align:center; }
        .perm-grid tr:last-child td { border-bottom:none; }
        .perm-check { width:18px; height:18px; accent-color:var(--blue); cursor:pointer; }
        .staff-table { width:100%; border-collapse:separate; border-spacing:0; }
        .staff-table th { padding:10px 14px; text-align:left; font-size:11px; text-transform:uppercase; color:var(--muted); font-weight:600; background:var(--gray-lt); border-bottom:1px solid var(--border); }
        .staff-table td { padding:10px 14px; border-bottom:1px solid var(--border); font-size:13px; }
        .staff-table tr:hover td { background:#fafbfc; }
        .role-badge { display:inline-block; padding:3px 10px; border-radius:20px; font-size:11px; font-weight:600; }
        .role-admin { background:#fee2e2; color:#dc2626; }
        .role-lead { background:var(--blue-lt); color:var(--blue); }
        .role-installer { background:var(--green-lt); color:#0a8f4f; }
        .role-driver { background:var(--yellow-lt); color:#b45309; }
        .role-office { background:var(--purple-lt); color:var(--purple); }
        .role-card { background:var(--card); border:1px solid var(--border); border-radius:8px; padding:14px; display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
        .role-card .role-name { font-weight:600; font-size:14px; }
        .staff-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
        .staff-header h3 { font-size:16px; font-weight:700; }
        .system-item { display:flex; align-items:center; justify-content:space-between; padding:14px 0; border-bottom:1px solid var(--border); }
        .system-item:last-child { border-bottom:none; }
        .system-item .sys-label { font-weight:600; font-size:14px; }
        .system-item .sys-desc { font-size:12px; color:var(--text2); margin-top:2px; }
    
    /* Auth Overlay */
    #auth-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      display: flex; align-items: center; justify-content: center;
      z-index: 10000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .auth-card {
      background: rgba(255,255,255,0.07); border-radius: 16px; padding: 48px;
      width: 400px; max-width: 90vw; text-align: center; backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    }
    .auth-card h1 { color: #fff; font-size: 28px; margin: 0 0 8px; font-weight: 700; }
    .auth-card p { color: rgba(255,255,255,0.6); margin: 0 0 32px; font-size: 14px; }
    .auth-btn {
      display: flex; align-items: center; justify-content: center; gap: 12px;
      width: 100%; padding: 14px 24px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.08); color: #fff; font-size: 15px; font-weight: 500;
      cursor: pointer; transition: all 0.2s; margin-bottom: 12px;
    }
    .auth-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-1px); }
    .auth-btn svg { width: 20px; height: 20px; }
    #auth-error { color: #ff6b6b; margin-top: 16px; font-size: 13px; display: none; }
    #auth-loading { color: rgba(255,255,255,0.5); margin-top: 16px; font-size: 13px; display: none; }
    .sign-out-btn {
      background: none; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.7);
      padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 12px;
      transition: all 0.2s; margin-left: 12px;
    }
    .sign-out-btn:hover { background: rgba(255,0,0,0.15); border-color: rgba(255,0,0,0.3); color: #ff6b6b; }
    .user-info { display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.7); font-size: 13px; }
  
    .mobile-only { display: none; }
    .mobile-subtabs { display: none; gap: 6px; margin-top: 10px; background: #eef1f5; padding: 4px; border-radius: 12px; }
    .mobile-subtabs .seg-btn { flex:1; border:none; background:transparent; padding:8px 10px; border-radius:10px; font-size:12px; font-weight:600; color:var(--text2); cursor:pointer; }
    .mobile-subtabs .seg-btn.active { background:#fff; color:var(--text); box-shadow:0 1px 3px rgba(0,0,0,0.08); }
    .mobile-subtabs .seg-btn .badge { margin-left:6px; background:var(--red); color:#fff; font-size:10px; padding:2px 6px; border-radius:10px; display:inline-block; }
    .mobile-nav { display:none; position:fixed; bottom:0; left:0; right:0; height:calc(var(--mobile-nav-height) + env(safe-area-inset-bottom, 0px)); background:#fff; border-top:1px solid var(--border); z-index:9999; align-items:center; padding-bottom:env(safe-area-inset-bottom, 0); }
    .mobile-nav .mobile-tab { flex:1; background:none; border:none; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; font-size:11px; color:var(--text2); position:relative; cursor:pointer; padding:6px 0; }
    .mobile-nav .mobile-icon { font-size:18px; line-height:1; }
    .mobile-nav .mobile-tab.active { color:var(--blue); }
    .mobile-nav .mobile-badge { position:absolute; top:6px; right:24px; background:var(--red); color:#fff; font-size:10px; padding:2px 6px; border-radius:10px; display:none; }
    .dispatch-grid { display:grid; grid-template-columns:1fr 1fr; gap:24px; }
    .pm-toggle { display:flex; align-items:center; gap:10px; font-size:12px; color:var(--text2); }
    .pm-toggle input { width:16px; height:16px; }

    @media (max-width: 900px) {
      aside.sidebar { display:none !important; }
      main.main { position:relative !important; left:0 !important; right:0 !important; margin-left:0 !important; width:100% !important; padding-bottom:84px; }
      .header { flex-direction:column; align-items:flex-start; gap:10px; padding:12px; }
      .header-left { width:100%; }
      .header-tabs.desktop-only { display:none; }
      .mobile-only { display:flex; }
      .mobile-subtabs { display:flex; }
      .content { padding:12px; }
      .card-grid { grid-template-columns:1fr; gap:12px; }
      .mobile-nav { display:flex; }
      .dispatch-grid { display:block; }
      .settings-tabs { display:none; }
      .panel { width:100%; }
      .scans-header, .scans-row { grid-template-columns: 40px minmax(160px, 2fr) 96px 96px 96px 90px; min-width: 620px; }
      .modal-bg { align-items:flex-start; padding-top:16px; padding-bottom:80px; }
      .modal { max-height: calc(100vh - 120px); margin-bottom: 72px; }
      .modal-body { padding-bottom: 20px; }
      #client-edit-modal > div { max-height: calc(100vh - 120px); margin-bottom: 72px; padding-bottom: 20px; }
      .wh-header-actions { width:100%; flex-direction:column; align-items:stretch; }
      .wh-search-box { width:100%; }
      .wh-header-actions .btn { width:100%; justify-content:center; }
    }

/* V38 layout fix */
aside.sidebar { position: fixed !important; top: 0; left: 0; bottom: 0; width: 240px; z-index: 2; overflow-y: auto; }
main.main { position: fixed !important; top: 0; left: 240px; right: 0; bottom: 0; overflow-y: auto; margin-left: 0 !important; z-index: 1; background: #f0f2f5; }

@media (max-width: 900px) {
  main.main { bottom: calc(var(--mobile-nav-height) + env(safe-area-inset-bottom, 0px)) !important; }
  .panel { bottom: calc(var(--mobile-nav-height) + env(safe-area-inset-bottom, 0px)); height: calc(100vh - (var(--mobile-nav-height) + env(safe-area-inset-bottom, 0px))); }
  .panel-body { padding-bottom: 24px; }
  .content { padding-bottom: 24px; }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <div id="auth-overlay">
      <div class="auth-card">
        <h1>Vector CRM</h1>
        <p>Sign in to continue</p>
        <button class="auth-btn" onclick="signInWithGoogle()">
          <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.27-4.74 3.27-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Sign in with Google
        </button>
        <button class="auth-btn" onclick="signInWithMicrosoft()">
          <svg viewBox="0 0 24 24"><rect fill="#F25022" x="1" y="1" width="10" height="10"/><rect fill="#7FBA00" x="13" y="1" width="10" height="10"/><rect fill="#00A4EF" x="1" y="13" width="10" height="10"/><rect fill="#FFB900" x="13" y="13" width="10" height="10"/></svg>
          Sign in with Microsoft
        </button>
        <div id="auth-error"></div>
        <div id="auth-loading">Signing in...</div>
      </div>
    </div>
    <!-- Client Portal -->
    <div class="portal-overlay" id="portal-overlay">
        <div class="portal-login" id="portal-login">
            <div class="portal-logo"><span>V</span></div>
            <h1>Client Portal</h1>
            <p>Sign in to view your projects and inventory</p>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="portal-email" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">Access Code</label>
                <input type="password" class="form-input" id="portal-code" placeholder="Enter your access code">
            </div>
            <button class="btn btn-primary" onclick="portalLogin()">Sign In</button>
            <div class="portal-error" id="portal-error">Invalid email or access code</div>
        </div>
    </div>
    <div class="portal-dash" id="portal-dash">
        <div class="portal-topbar">
            <h2><span>V</span> <span id="portal-company">Client</span>  Portal</h2>
            <button class="btn btn-outline" onclick="portalLogout()">Sign Out</button>
        </div>
        <div class="portal-body" id="portal-body"></div>
    </div>

    <!-- Quote Share (link-only) -->
    <div class="quote-share-overlay" id="quote-share-overlay">
        <div class="quote-share-topbar">
            <div class="quote-share-brand" id="quote-share-brand"><span>V</span> Quote</div>
        </div>
        <div class="quote-share-wrap">
            <div class="quote-share-card">
                <div id="quote-share-loading" class="quote-share-loading">Loading quote...</div>
                <div id="quote-share-error" class="quote-share-error" style="display:none"></div>
                <div id="quote-share-content" style="display:none"></div>
            </div>
        </div>
    </div>

    <div class="app">
        <aside class="sidebar">
            <div class="sidebar-logo"><span>V</span> Vector CRM</div>
            <div class="org-switcher" onclick="toggleOrgSwitcher(event)">
                <div>
                    <div class="org-switcher-label">Workspace</div>
                    <div class="org-switcher-name" id="org-switch-name">Vector Installations</div>
                </div>
                <div class="org-switcher-caret"></div>
            </div>
            <div class="nav-group">
                <div class="nav-group-title">Overview</div>
                <div class="nav-item" id="nav-dashboard" onclick="showNav('dashboard')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="14" width="7" height="7"/></svg>
                    Dashboard
                </div>
            </div>
            <div class="nav-group">
                <div class="nav-group-title">Operations</div>
                <div class="nav-item active" id="nav-receiving" onclick="showNav('receiving')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                    Receiving
                    <span class="nav-badge" id="nav-scans-badge">0</span>
                </div>
                <div class="nav-item" id="nav-warehouse" onclick="showNav('warehouse');initWarehouse();">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 3h16v18H4z"/><path d="M4 10h16"/><path d="M12 3v7"/></svg>
                    Warehouse
                </div>
                <div class="nav-item" id="nav-dispatch" onclick="showNav('dispatch')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 17H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-4"/><polyline points="12 15 17 20 7 20"/></svg>
                    Dispatch
                </div>
            </div>
            <div class="nav-group">
                <div class="nav-group-title">Planning</div>
                <div class="nav-item" onclick="showNav('calendar')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    Calendar
                </div>
                <div class="nav-item" id="nav-moving" onclick="showProjectsBoard()" style="display:none">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7h13v10H3z"/><path d="M16 10h3l2 3v4h-5z"/><circle cx="7.5" cy="18" r="1.5"/><circle cx="18.5" cy="18" r="1.5"/></svg>
                    Moving
                </div>
                <div class="nav-item" id="nav-projects" onclick="showProjectsList()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                    Projects
                </div>
            </div>
            <div class="nav-group">
                <div class="nav-group-title">Management</div>
                <div class="nav-item" onclick="showNav('people')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                    People
                </div>
                <div class="nav-item" onclick="showNav('clients')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
                    Clients
                </div>
            </div>
            <div class="nav-group">
                <div class="nav-group-title">Admin</div>
                <div class="nav-item" onclick="showNav('settings');settingsTab('staff')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    My Staff
                </div>
                <div class="nav-item" onclick="showNav('automations')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    Automations
                </div>
                <div class="nav-item" onclick="showNav('settings');settingsTab('integrations')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    Settings
                </div>
            </div></div>
        </aside>
        <main class="main">
            <div id="view-dashboard" class="view">
                <header class="header">
                    <div class="header-left">
                        <h1 class="header-title">Dashboard</h1>
                    </div>
                </header>
                <div class="content" id="dashboard-content"></div>
            </div>
            <div id="view-receiving" class="view active">
                <header class="header">
                    <div class="header-left">
                        <h1 class="header-title">Receiving</h1>
                        <div class="header-tabs desktop-only">
                            <div class="header-tab active" data-tab="scans" onclick="switchTab('scans', this)">Raw Scans</div>
                            <div class="header-tab" data-tab="shipments" onclick="switchTab('shipments', this)">Shipments</div>
                        </div>
                        <div class="mobile-subtabs mobile-only mobile-receiving-tabs">
                            <button class="seg-btn active" data-tab="scans" onclick="mobileReceivingTab('scans')">Raw Scans <span class="badge mobile-raw-badge">0</span></button>
                            <button class="seg-btn" data-tab="shipments" onclick="mobileReceivingTab('shipments')">Shipments</button>
                            <button class="seg-btn" data-tab="warehouse" onclick="mobileReceivingTab('warehouse')">Warehouse</button>
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="openCameraUpload()"> Upload Scan</button>
                    <input type="file" id="camera-input" class="hidden-file-input" accept="image/*,.pdf" capture="environment" onchange="handleCameraUpload(event)">
                </header>
                <div class="content">
                    <div id="tab-scans" class="tab-content active"><div class="spreadsheet" id="scans-table"></div></div>
                    <div id="tab-shipments" class="tab-content">
                        <div id="cam-inbox"></div>
                        <div class="spreadsheet" id="shipments-table"></div>
                    </div>
            </div>
            
            </div>
            </div><!-- close view-receiving -->
            <div id="view-calendar" class="view">
                <header class="header">
                    <div class="header-left">
                        <h1 class="header-title">Calendar</h1>
                        <div class="header-tabs compact desktop-only" id="calendar-tabs">
                            <div class="header-tab active calendar-tab-btn" data-tab="calendar" onclick="setCalendarTab('calendar')">Calendar</div>
                            <div class="header-tab calendar-tab-btn" data-tab="availability" onclick="setCalendarTab('availability')">Availability</div>
                            <div class="header-tab calendar-tab-btn" data-tab="connections" onclick="setCalendarTab('connections')">Connections</div>
                        </div>
                    </div>
                    <button class="btn btn-outline" id="calendar-sync-btn" onclick="syncOutlookCalendar()"> Sync Outlook</button>
                </header>
                <div class="content">
                    <div id="calendar-tab-calendar">
                        <div class="calendar-header">
                            <div class="calendar-nav"><button onclick="changeMonth(-1)"></button><button onclick="changeMonth(1)"></button></div>
                            <div class="calendar-month" id="calendar-month"></div>
                            <button class="btn btn-outline" onclick="goToToday()">Today</button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid"></div>
                    </div>
                    <div id="calendar-tab-availability" style="display:none">
                        <div id="calendar-availability"></div>
                    </div>
                    <div id="calendar-tab-connections" style="display:none">
                        <div id="calendar-connections"></div>
                    </div>
                </div>
            </div>
            <div id="view-projects" class="view">
                <header class="header">
                    <div class="header-left">
                        <h1 class="header-title">Projects</h1>
                        <div class="header-tabs compact desktop-only" id="projects-view-tabs" style="display:none">
                            <div class="header-tab active projects-view-tab" data-mode="board" onclick="setProjectsViewMode('board')">Board</div>
                            <div class="header-tab projects-view-tab" data-mode="list" onclick="setProjectsViewMode('list')">Projects</div>
                        </div>
                        <div class="list-search" id="projects-search">
                            <span class="search-icon"></span>
                            <input type="text" id="projects-search-input" placeholder="Search projects..." oninput="setProjectSearch(this.value)">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('project')">+ New Project</button>
                </header>
                <div class="content"><div class="card-grid" id="projects-list"></div></div>
            </div>
            <div id="view-people" class="view">
                <header class="header">
                    <div class="header-left"><h1 class="header-title">People</h1></div>
                    <div class="mobile-subtabs mobile-only mobile-settings-tabs">
                        <button class="seg-btn active" data-tab="people" onclick="mobileSettingsTab('people')">People</button>
                        <button class="seg-btn" data-tab="clients" onclick="mobileSettingsTab('clients')">Clients</button>
                        <button class="seg-btn" data-tab="staff" onclick="mobileSettingsTab('staff')">My Staff</button>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('person')">+ Add Person</button>
                </header>
                <div class="content"><div class="card-grid" id="people-list"></div></div>
            </div>
            <div id="view-clients" class="view">
                <header class="header">
                    <div class="header-left">
                        <h1 class="header-title">Clients</h1>
                        <div class="list-search">
                            <span class="search-icon"></span>
                            <input type="text" id="clients-search-input" placeholder="Search clients..." oninput="setClientSearch(this.value)">
                        </div>
                    </div>
                    <div class="mobile-subtabs mobile-only mobile-settings-tabs">
                        <button class="seg-btn" data-tab="people" onclick="mobileSettingsTab('people')">People</button>
                        <button class="seg-btn active" data-tab="clients" onclick="mobileSettingsTab('clients')">Clients</button>
                        <button class="seg-btn" data-tab="staff" onclick="mobileSettingsTab('staff')">My Staff</button>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('client')">+ New Client</button>
                </header>
                <div class="content"><div style="padding:12px;display:flex;justify-content:flex-end"><button class="btn btn-primary" onclick="openClientPanel(0)" style="font-size:13px">+ Add Client</button></div>
<div class="card-grid" id="clients-list"></div></div>
            </div>
            <div id="view-dispatch" class="view">
                <header class="header">
                    <div class="header-left">
                        <h1 class="header-title">Dispatch</h1>
                    </div>
                    <div class="mobile-subtabs mobile-only mobile-dispatch-tabs">
                        <button class="seg-btn active" data-tab="prepare" onclick="mobileDispatchTab('prepare')">Prepare</button>
                        <button class="seg-btn" data-tab="history" onclick="mobileDispatchTab('history')">History</button>
                    </div>
                </header>
                <div class="content">
                    <div class="dispatch-grid">
                        <div id="dispatch-prepare" style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:20px">
                            <h3 style="margin-bottom:16px;font-weight:600">Prepare Dispatch</h3>
                            <div class="form-group">
                                <label class="form-label">Search by PO # or Project Name <span class="req">*</span></label>
                                <div class="ls-search-box">
                                    <span class="ls-search-icon">&#128269;</span>
                                    <input type="text" class="ls-search-input" id="ls-po-search" placeholder="Type PO number or project name..." oninput="searchPOShipments()">
                                </div>
                            </div>
                            <div id="ls-search-results"></div>
                            <div id="ls-selected-items" style="display:none"></div>
                            <div id="ls-split-section" style="display:none">
                                <div class="ls-split-banner">
                                    <input type="checkbox" id="ls-is-split" onchange="toggleSplitLoad()" style="cursor:pointer">
                                    <div>
                                        <div style="font-weight:600;font-size:13px">Split Load</div>
                                        <div style="font-size:12px;color:var(--text2)">Check if this PO needs multiple trucks</div>
                                    </div>
                                </div>
                                <div id="ls-split-details" style="display:none;margin-bottom:16px">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Load #</label>
                                            <input type="number" class="form-input" id="ls-load-num" value="1" min="1">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Total Loads</label>
                                            <input type="number" class="form-input" id="ls-load-total" value="2" min="2">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Driver <span class="req">*</span></label>
                                <select class="form-select" id="ls-driver"><option value="">Select driver...</option></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Truck # <span class="req">*</span></label>
                                <select class="form-select" id="ls-truck">
                                    <option value="">Select truck...</option>
                                    <option>Truck 1</option><option>Truck 2</option><option>Truck 3</option><option>Truck 4</option>
                                    <option>White Van</option><option>BMG Van</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Equipment</label>
                                <div class="ls-equipment">
                                    <label><input type="checkbox" class="ls-equip" value="Straps"> Straps</label>
                                    <label><input type="checkbox" class="ls-equip" value="Masonite"> Masonite</label>
                                    <label><input type="checkbox" class="ls-equip" value="Tape"> Tape</label>
                                    <label><input type="checkbox" class="ls-equip" value="Vacuum"> Vacuum</label>
                                    <label><input type="checkbox" class="ls-equip" value="Shrink Wrap"> Shrink Wrap</label>
                                    <label><input type="checkbox" class="ls-equip" value="Cleaning Kit"> Cleaning Kit</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Is The Load Complete?</label>
                                <select class="form-select" id="ls-complete">
                                    <option value="">Select...</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                    <option value="partial">Partial</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea class="form-input" id="ls-notes" placeholder="Add any special instructions..." style="resize:vertical;min-height:80px"></textarea>
                            </div>
                            <button class="btn btn-primary" style="width:100%" onclick="submitLoadingSheet()">Submit Dispatch</button>
                        </div>
                        <div id="dispatch-history" style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:20px">
                                <h3 style="margin-bottom:16px;font-weight:600">Dispatch History</h3>
                                <div class="form-group">
                                    <input type="text" class="form-input" id="ls-history-search" placeholder="Search history by PO or project..." oninput="renderLoadingHistory()">
                                </div>
                                <div id="ls-history" style="max-height:600px;overflow-y:auto"></div>
                                <div id="d-history" style="max-height:400px;overflow-y:auto;margin-top:16px"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="view-warehouse" class="view">
                <header class="header">
                    <div class="header-left">
                        <h1 class="header-title">Warehouse</h1>
                        <div class="mobile-subtabs mobile-only mobile-receiving-tabs">
                            <button class="seg-btn" data-tab="scans" onclick="mobileReceivingTab('scans')">Raw Scans <span class="badge mobile-raw-badge">0</span></button>
                            <button class="seg-btn" data-tab="shipments" onclick="mobileReceivingTab('shipments')">Shipments</button>
                            <button class="seg-btn active" data-tab="warehouse" onclick="mobileReceivingTab('warehouse')">Warehouse</button>
                        </div>
                    </div>
                    <div class="wh-header-actions">
                        <div class="ls-search-box wh-search-box">
                            <span class="ls-search-icon">&#128269;</span>
                            <input type="text" class="ls-search-input" id="wh-search" placeholder="Search items, bins, or shipments..." oninput="setWarehouseSearch(this.value)">
                        </div>
                        <button class="btn btn-primary" onclick="openItemModal(null)">+ Add Item</button>
                    </div>
                </header>
                <div class="content">
                    <div id="wh-breadcrumb"></div>
                    <div id="wh-content"></div>
                </div>
            </div>

            <div id="view-settings" class="view">
                <header class="header">
                    <div class="header-left"><h1 class="header-title">Settings</h1></div>
                    <div class="mobile-subtabs mobile-only mobile-settings-tabs">
                        <button class="seg-btn" data-tab="people" onclick="mobileSettingsTab('people')">People</button>
                        <button class="seg-btn" data-tab="clients" onclick="mobileSettingsTab('clients')">Clients</button>
                        <button class="seg-btn active" data-tab="staff" onclick="mobileSettingsTab('staff')">My Staff</button>
                    </div>
                </header>
                <div class="content">
                    <div class="settings-tabs">
                        <button class="settings-tab active" onclick="settingsTab('integrations',this)">Integrations</button>
                        <button class="settings-tab" onclick="settingsTab('staff',this)">Staff & Permissions</button>
                        <button class="settings-tab" onclick="settingsTab('system',this)">System</button>
                    </div>
                    <div id="settings-integrations" class="settings-section active"></div>
                    <div id="settings-staff" class="settings-section"></div>
                    <div id="settings-system" class="settings-section"></div>
                </div>
            </div>
            <div id="view-automations" class="view">
                <header class="header"><h1 class="header-title">Automations</h1></header>
                <div class="content">
                    <div id="automations-list"></div>
                </div>
            </div>
        
<!-- Client Edit Modal -->
<div id="client-edit-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:none;align-items:center;justify-content:center">
<div style="background:#fff;border-radius:12px;padding:24px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto;margin:auto;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 id="client-modal-title">Edit Client</h3><button onclick="closeClientModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-primary)"></button></div>
<div class="form-group"><label class="form-label">Company Name *</label><input class="form-input" id="ce-company" placeholder="Company name"></div>
<div class="form-group"><label class="form-label">Email</label><input class="form-input" id="ce-email" type="email" placeholder="Email"></div>
<div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="ce-phone" placeholder="Phone"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div class="form-group"><label class="form-label">Address</label><input class="form-input" id="ce-address" placeholder="Address"></div>
<div class="form-group"><label class="form-label">City</label><input class="form-input" id="ce-city" placeholder="City"></div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div class="form-group"><label class="form-label">State</label><input class="form-input" id="ce-state" placeholder="State"></div>
<div class="form-group"><label class="form-label">Zip</label><input class="form-input" id="ce-zip" placeholder="Zip"></div>
</div>
<div class="form-group"><label class="form-label">CC Emails</label><input class="form-input" id="ce-ccemails" placeholder="Comma-separated CC emails"></div>
<div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="ce-notes" rows="3" placeholder="Notes"></textarea></div>
<div class="form-group"><label class="form-label">Project Managers</label> <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><input class="form-input" id="pm-name" placeholder="PM name" style="flex:1"><input class="form-input" id="pm-email" placeholder="PM email" style="flex:1"><button class="btn btn-secondary" id="pm-save-btn" onclick="savePM()">Add</button></div> <div id="ce-pm-list"></div> </div> <div id="ce-projects" style="margin-bottom:16px"></div>
<div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-secondary" onclick="closeClientModal()">Cancel</button><button class="btn btn-primary" onclick="saveClientEdit()">Save</button></div>
</div></div>

    <div class="modal-bg" id="modal-automation"><div class="modal" style="max-width:720px">
        <div class="modal-header">
            <h2 class="modal-title" id="automation-modal-title">Create Workflow</h2>
            <button class="modal-close" onclick="closeAutomationModal()"></button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="auto-name" placeholder="Workflow name"></div>
                <div class="form-group"><label class="form-label">Folder</label><input type="text" class="form-input" id="auto-folder" placeholder="Operations"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Status</label>
                    <select class="form-select" id="auto-status">
                        <option value="draft">Draft</option>
                        <option value="published">Published</option>
                        <option value="paused">Paused</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">Audience</label>
                    <select class="form-select" id="auto-audience">
                        <option>PM</option>
                        <option>Client PM</option>
                        <option>Crew</option>
                        <option>Foreman</option>
                        <option>Warehouse</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Trigger Type</label>
                    <select class="form-select" id="auto-trigger-type">
                        <option value="date">Date</option>
                        <option value="status">Project Status</option>
                        <option value="schedule">Schedule</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">Trigger Value</label>
                    <input type="text" class="form-input" id="auto-trigger-value" placeholder="move_date / close / weekly_fri_3pm">
                </div>
                <div class="form-group"><label class="form-label">Offset (days)</label>
                    <input type="number" class="form-input" id="auto-offset" value="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="form-label">Channel</label>
                    <select class="form-select" id="auto-channel">
                        <option>Email</option>
                        <option>SMS</option>
                        <option>Email/SMS</option>
                        <option>Task</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">Subject</label>
                    <input type="text" class="form-input" id="auto-subject" placeholder="Subject (email only)">
                </div>
            </div>
            <div class="form-group"><label class="form-label">Message</label>
                <textarea class="form-input" id="auto-message" rows="4" placeholder="Message body. You can use tokens like {{project_name}}, {{date}}, {{address}}."></textarea>
            </div>
            <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);margin-bottom:10px">
                <input type="checkbox" id="auto-ai-enabled" onchange="toggleAutomationAI(this.checked)"> Use AI (Gemini) to draft message
            </label>
            <div id="auto-ai-section" style="display:none">
                <div class="form-group"><label class="form-label">AI Prompt</label>
                    <textarea class="form-input" id="auto-ai-prompt" rows="3" placeholder="Prompt template for Gemini..."></textarea>
                </div>
            </div>
            <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:16px;">
                <h3 style="margin:0 0 12px;font-size:15px;font-weight:600;">Workflow Steps</h3>
                <div id="steps-list"><div style="color:var(--muted);padding:8px 0;font-size:13px;">No steps defined. Click + Add Step to build the workflow.</div></div>
                <button type="button" class="btn btn-outline" style="margin-top:8px;" onclick="addWorkflowStep()">+ Add Step</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeAutomationModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveAutomation()">Save Workflow</button>
        </div>
    </div></div>
</main>
        <nav class="mobile-nav" id="mobile-nav">
            <button class="mobile-tab active" id="mobile-tab-receiving" data-view="receiving" onclick="mobileNav('receiving')">
                <span class="mobile-icon"></span>
                <span class="mobile-label">Receiving</span>
                <span class="mobile-badge" id="mobile-receiving-badge">0</span>
            </button>
            <button class="mobile-tab" data-view="dispatch" onclick="mobileNav('dispatch')">
                <span class="mobile-icon"></span>
                <span class="mobile-label">Dispatch</span>
            </button>
            <button class="mobile-tab" data-view="projects" onclick="mobileNav('projects')">
                <span class="mobile-icon"></span>
                <span class="mobile-label">Projects</span>
            </button>
            <button class="mobile-tab" data-view="calendar" onclick="mobileNav('calendar')">
                <span class="mobile-icon"></span>
                <span class="mobile-label">Calendar</span>
            </button>
            <button class="mobile-tab" data-view="settings" onclick="mobileNav('settings')">
                <span class="mobile-icon"></span>
                <span class="mobile-label">Settings</span>
            </button>
        </nav>
        <div class="org-switcher-overlay" id="org-switcher-overlay" onclick="closeOrgSwitcher(event)">
            <div class="org-switcher-card" onclick="event.stopPropagation()">
            <div class="org-switcher-header">Workspaces</div>
            <div class="org-switcher-list" id="org-switcher-list"></div>
            </div>
        </div>
    </div>
    <div class="panel" id="panel">
        <div class="panel-header"><div><div class="panel-title" id="panel-title"></div><div class="panel-subtitle" id="panel-subtitle"></div></div><button class="panel-close" onclick="closePanel()"></button></div>
        <div class="panel-tabs" id="panel-tabs">
            <div class="panel-tab-btn active" onclick="switchPanelTab('details',this)">Details</div>
            <div class="panel-tab-btn" onclick="switchPanelTab('moving',this)">Moving</div>
            <div class="panel-tab-btn" onclick="switchPanelTab('completion',this)">Completion</div>
        </div>
        <div class="panel-body">
            <div id="panel-tab-details">
                <div class="panel-section"><div class="panel-section-title">Details</div><div id="panel-details"></div></div>
                <div class="panel-section"><div class="panel-section-title">Assigned Team</div><div id="panel-team"></div></div>
                <div class="panel-section"><div class="panel-section-title">PM Access</div><div id="panel-pm-access"></div></div>
                <div class="panel-section"><div class="panel-section-title">Shipments</div><div id="panel-shipments"></div></div>
                <div class="panel-section"><div class="panel-section-title" style="display:flex;justify-content:space-between;align-items:center">Punchlist Items <button class="btn btn-outline" style="padding:4px 10px;font-size:12px" onclick="openPunchlistFromPanel()">+ Add Item</button></div><div id="panel-punchlist-stats" style="margin-bottom:8px"></div><div id="panel-punchlist"></div></div>
                <div class="panel-section"><div class="panel-section-title">Documents</div><div id="panel-docs"></div></div>
                <div class="panel-section"><div class="panel-section-title" style="display:flex;justify-content:space-between;align-items:center">Jobsite Readiness <button class="btn btn-outline" style="padding:4px 10px;font-size:12px" onclick="saveJobsiteReadiness()">Save</button></div><div id="panel-readiness"></div></div>
                <div class="panel-section"><div class="panel-section-title" style="display:flex;justify-content:space-between;align-items:center">Field Issues (RFI / Site) <button class="btn btn-outline" style="padding:4px 10px;font-size:12px" onclick="openPunchlistFromPanel('rfi')">+ Add Issue</button></div><div id="panel-issues"></div></div>
                <div class="panel-section"><div class="panel-section-title" style="display:flex;justify-content:space-between;align-items:center">Returns & Backorders <button class="btn btn-outline" style="padding:4px 10px;font-size:12px" onclick="openPunchlistFromPanel('return')">+ Add Return</button></div><div id="panel-returns"></div></div>
                <div class="panel-section"><div class="panel-section-title" style="display:flex;justify-content:space-between;align-items:center">Crew Time <button class="btn btn-outline" style="padding:4px 10px;font-size:12px" onclick="toggleTimeEntryForm()">+ Add Time</button></div><div id="panel-time"></div></div>
                <div class="panel-section"><div class="panel-section-title" style="display:flex;justify-content:space-between;align-items:center">Status Updates <button class="btn btn-outline" style="padding:4px 10px;font-size:12px" onclick="toggleStatusUpdateForm()">+ Add Update</button></div><div id="panel-updates"></div></div>
                <div class="panel-section"><div class="panel-section-title" style="display:flex;justify-content:space-between;align-items:center">Change Orders <button class="btn btn-outline" style="padding:4px 10px;font-size:12px" onclick="toggleChangeOrderForm()">+ Add CO</button></div><div id="panel-change-orders"></div></div>
            </div>
            <div id="panel-tab-moving" style="display:none">
                <div class="panel-section"><div class="panel-section-title">Move Checklist</div><div id="panel-move-checklist"></div></div>
                <div class="panel-section"><div class="panel-section-title" style="display:flex;justify-content:space-between;align-items:center">Move Inventory <button class="btn btn-outline" style="padding:4px 10px;font-size:12px" onclick="toggleMoveItemForm()">+ Add Item</button></div><div id="panel-move-inventory"></div></div>
                <div class="panel-section"><div class="panel-section-title">Survey & Estimate</div><div id="panel-survey"></div></div>
                <div class="panel-section"><div class="panel-section-title">Quote</div><div id="panel-quote"></div></div>
                <div class="panel-section"><div class="panel-section-title">Milestones</div><div id="panel-milestones"></div></div>
                <div class="panel-section"><div class="panel-section-title">Access & COI</div><div id="panel-access"></div></div>
                <div class="panel-section"><div class="panel-section-title">Floor Plans & Maps</div><div id="panel-floorplans"></div></div>
                <div class="panel-section"><div class="panel-section-title">Labels & QR</div><div id="panel-labels"></div></div>
                <div class="panel-section"><div class="panel-section-title">Materials</div><div id="panel-materials"></div></div>
            </div>
            <div id="panel-tab-completion" style="display:none">
                <div id="pc-role-gate"></div>
            </div>
        </div>
    </div>
    <div class="modal-bg" id="modal-scan">
        <div class="modal">
            <div class="modal-header"><h2 class="modal-title">Process Scan</h2><button class="modal-close" onclick="closeModal('scan')"></button></div>
            <div class="modal-body">
                <div class="file-attached"><span style="color:var(--green)"></span><div><div style="font-weight:500" id="scan-filename"></div><div style="font-size:12px;color:var(--text2)" id="scan-time"></div></div></div>
                <div id="scan-thumbnail-container" style="margin-top:12px"></div>
                <div class="form-group" style="margin-top:16px"><label class="form-label">Purchase Order(PO) # <span class="req">*</span></label><input type="text" class="form-input" id="f-po"></div>
                <div class="form-group"><label class="form-label">Is this a Return Product?</label><select class="form-select" id="f-return"><option value="no">No</option><option value="yes">Yes</option></select></div>
                <div class="form-group"><label class="form-label">Client Name <span class="req">*</span></label><select class="form-select" id="f-client" onchange="onClientChange()"><option value="">Select...</option></select><div class="inline-add hidden" id="inline-client"><input type="text" class="form-input" id="il-client" placeholder="Company"><button class="btn btn-primary" onclick="addInlineClient()">Add</button></div><div class="form-hint"><a href="#" onclick="toggleInline('client');return false">+ Add new</a></div></div>
                <div class="form-group"><label class="form-label">Project Name <span class="req">*</span></label><div style="position:relative"><input type="text" class="form-input" id="f-project-search" placeholder="Search project..." oninput="showProjectSuggestions(this,'f-project-sug')" onfocus="focusProjectInput(this,'f-project-sug')" onblur="blurProjectInput(this,'f-project-sug')" autocomplete="off"><div class="loc-suggestions" id="f-project-sug" style="display:none"></div></div><input type="hidden" id="f-project-id"><div class="inline-add hidden" id="inline-project"><input type="text" class="form-input" id="il-project" placeholder="Project"><button class="btn btn-primary" onclick="addInlineProject()">Add</button></div><div class="form-hint"><a href="#" onclick="toggleInline('project');return false">+ Add new</a></div></div>
                <div class="form-group"><label class="form-label">Project Managers (CC)</label><div id="f-pm-list" class="pm-checklist"></div><div class="form-hint">Select one or more PMs to CC</div></div>
                <div class="form-group"><label class="form-label">Manufacturer</label><input type="text" class="form-input" id="f-mfr"></div>
                <div class="form-group"><label class="form-label">Cartons/Pallets</label><input type="text" class="form-input" id="f-cartons"></div>
                <div class="form-group"><label class="form-label">Warehouse Location</label><select class="form-select" id="f-location" onchange="onFormLocationChange(this)"></select></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Received Date</label><input type="date" class="form-input" id="f-date"></div>
                    <div class="form-group"><label class="form-label">Complete</label><select class="form-select" id="f-status"><option value="received">Received</option><option value="not-received">Not Received</option></select></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Send Email</label>
                    <div class="pm-toggle">
                        <input type="checkbox" id="f-send-email" checked>
                        <span>Send email to client + selected PMs on submit</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('scan')">Cancel</button><button class="btn btn-primary" onclick="submitScan()">Submit</button></div>
        </div>
    </div>
    <div class="modal-bg" id="modal-punchitem"><div class="modal"><div class="modal-header"><h2 class="modal-title">New Punchlist Item</h2><button class="modal-close" onclick="closeModal('punchitem')"></button></div><div class="modal-body"><div class="form-group"><label class="form-label">Project <span class="req">*</span></label><select class="form-select" id="pi-project"><option value="">Select...</option></select></div><div class="form-group"><label class="form-label">Type <span class="req">*</span></label><select class="form-select" id="pi-type"><option value="">Select...</option><option value="damaged">Damaged</option><option value="missing">Missing</option><option value="backorder">Back-ordered</option><option value="return">Return</option><option value="rfi">RFI</option><option value="site">Site Issue</option></select></div><div class="form-group"><label class="form-label">Description <span class="req">*</span></label><input type="text" class="form-input" id="pi-description" placeholder="Item description"></div><div class="form-group"><label class="form-label">Manufacturer / Vendor</label><input type="text" class="form-input" id="pi-manufacturer"></div><div class="form-group"><label class="form-label">PO # Reference</label><input type="text" class="form-input" id="pi-po" placeholder="e.g., 11041-18-MM HON"></div><div class="form-group"><label class="form-label">Quantity</label><input type="number" class="form-input" id="pi-qty" value="1" min="1"></div><div class="form-group"><label class="form-label">Assigned To</label><select class="form-select" id="pi-assigned"><option value="">Select...</option></select></div><div class="form-group"><label class="form-label">Follow-up Date</label><input type="date" class="form-input" id="pi-followup-date"></div><div class="form-group"><label class="form-label">Reported By</label><select class="form-select" id="pi-reportedby"><option value="">Select...</option></select></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="pi-status"><option value="open">Open</option><option value="inprogress">In Progress</option><option value="resolved">Resolved</option></select></div><div class="form-row"><div class="form-group"><label class="form-label">ETA</label><input type="date" class="form-input" id="pi-eta"></div><div class="form-group"><label class="form-label">RMA #</label><input type="text" class="form-input" id="pi-rma" placeholder="Optional"></div></div><div class="form-group"><label class="form-label">Photo Tags (comma-separated)</label><input type="text" class="form-input" id="pi-photo-tags" placeholder="damage, install, label"></div><div class="form-group"><label class="form-label">Photos</label><input type="file" class="form-input" id="pi-photos" accept="image/*" multiple style="padding:0" onchange="handlePunchlistPhotos(event)"><div id="pi-photo-previews" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap"></div></div><div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="pi-notes" placeholder="Additional notes" style="resize:vertical;min-height:80px"></textarea></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('punchitem')">Cancel</button><button class="btn btn-primary" onclick="savePunchlistItem()">Create</button></div></div></div>
    <div class="modal-bg" id="modal-project"><div class="modal"><div class="modal-header"><h2 class="modal-title">New Project</h2><button class="modal-close" onclick="closeModal('project')"></button></div><div class="modal-body"><div class="form-group"><label class="form-label">Project Name <span class="req">*</span></label><input type="text" class="form-input" id="p-name"></div><div class="form-group"><label class="form-label">Client <span class="req">*</span></label><select class="form-select" id="p-client" onchange="loadPMDropdown()"><option value="">Select...</option></select></div><div class="form-row"><div class="form-group"><label class="form-label">Project Type</label><select class="form-select" id="p-project-type"><option value="install">Install</option><option value="move">Move (B2B Relocation)</option></select></div><div class="form-group"><label class="form-label">Install Date</label><input type="date" class="form-input" id="p-date"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="p-time" value="07:00"></div><div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" id="p-location"></div></div><div class="form-group"><label class="form-label">Project Manager</label><select class="form-select" id="p-project-manager"><option value="">Select PM...</option></select></div><div class="form-group"><label class="form-label">PM Access Emails (comma-separated)</label><input type="text" class="form-input" id="p-pm-emails" placeholder="pm1@company.com, pm2@company.com"><div class="form-hint">Only these emails (plus the client email) can view this project in the portal.</div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('project')">Cancel</button><button class="btn btn-primary" onclick="saveProject()">Create</button></div></div></div>
    <div class="modal-bg" id="modal-person"><div class="modal"><div class="modal-header"><h2 class="modal-title">Add Person</h2><button class="modal-close" onclick="closeModal('person')"></button></div><div class="modal-body"><div class="form-group"><label class="form-label">Name <span class="req">*</span></label><input type="text" class="form-input" id="pe-name"></div><div class="form-group"><label class="form-label">Role</label><select class="form-select" id="pe-role"><option>Installer</option><option>Lead Installer</option><option>Driver</option></select></div><div class="form-row"><div class="form-group"><label class="form-label">Phone</label><input type="tel" class="form-input" id="pe-phone"></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="pe-email"></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('person')">Cancel</button><button class="btn btn-primary" onclick="savePerson()">Add</button></div></div></div>
    <div class="modal-bg" id="modal-client"><div class="modal"><div class="modal-header"><h2 class="modal-title">New Client</h2><button class="modal-close" onclick="closeModal('client')"></button></div><div class="modal-body"><div class="form-group"><label class="form-label">Company <span class="req">*</span></label><input type="text" class="form-input" id="c-company"></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="c-email"></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('client')">Cancel</button><button class="btn btn-primary" onclick="saveClient()">Create</button></div></div></div>
    <div class="modal-bg" id="modal-delete-project"><div class="modal"><div class="modal-header"><h2 class="modal-title">Delete Project?</h2><button class="modal-close" onclick="closeModal('delete-project')"></button></div><div class="modal-body"><p id="delete-project-warning" style="color:var(--text2);margin-bottom:16px">This action will permanently delete the project and all associated data (shipments, punchlist items). This cannot be undone.</p></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('delete-project')">Cancel</button><button class="btn" style="background:var(--red);color:#fff" onclick="confirmDeleteProject()">Delete Project</button></div></div></div>
    <div class="modal-bg" id="modal-inventory-item"><div class="modal" style="max-width:560px"><div class="modal-header"><h2 class="modal-title" id="wh-modal-title">Add Item</h2><button class="modal-close" onclick="closeModal('inventory-item')"></button></div><div class="modal-body"><div class="form-group"><label class="form-label">Item Name <span class="req">*</span></label><input type="text" class="form-input" id="wh-item-name" placeholder="Enter item name"></div><div class="form-group"><label class="form-label">Location</label><div id="wh-location-display" style="padding:10px 12px;background:var(--gray-lt);border-radius:6px;font-size:13px;margin-bottom:8px">Not assigned</div><div class="form-group"><label class="form-label">Bin</label><select class="form-select" id="wh-item-bin"><option value="">Select bin...</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Quantity</label><input type="number" class="form-input" id="wh-item-quantity" value="0" min="0"></div><div class="form-group"><label class="form-label">Unit Type</label><select class="form-select" id="wh-item-unit"><option value="units">Units</option><option value="plt">Pallets</option><option value="box">Boxes</option><option value="pk">Packs</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Min Level</label><input type="number" class="form-input" id="wh-item-min-level" value="0" min="0"></div><div class="form-group"><label class="form-label">Price ($)</label><input type="number" class="form-input" id="wh-item-price" value="0" min="0" step="0.01"></div></div><div class="form-group"><label class="form-label">Tags (comma-separated)</label><input type="text" class="form-input" id="wh-item-tags" placeholder="e.g. fragile, electronics"></div><div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="wh-item-notes" placeholder="Additional notes..." style="resize:vertical;min-height:80px"></textarea></div><div class="form-group"><label class="form-label">Barcode/QR ID</label><input type="text" class="form-input" id="wh-item-barcode" placeholder="Scan or enter barcode"></div><div class="form-group"><label class="form-label">Photos</label><input type="file" class="form-input" id="wh-item-photos" accept="image/*" multiple style="padding:0" onchange="handleWarehousePhotos(event)"><div id="wh-photo-previews" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap"></div></div><div class="form-group"><label class="form-label">Custom Fields</label><div id="wh-custom-fields-container"></div><button type="button" class="btn btn-outline" style="padding:4px 12px;font-size:12px;margin-top:8px" onclick="addCustomField()">+ Add Field</button></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('inventory-item')">Cancel</button><button class="btn btn-primary" onclick="saveItem()">Save</button></div></div></div>
    <div class="scan-alert" id="scan-alert"><div class="scan-alert-header"><div class="scan-alert-icon"></div><div><div class="scan-alert-title">New scan!</div><div class="scan-alert-file" id="alert-file"></div></div></div><div class="scan-alert-actions"><button class="scan-alert-btn primary" onclick="processNewScan()">Process</button><button class="scan-alert-btn secondary" onclick="closeScanAlert()">Later</button></div></div>
        <div class="modal-bg" id="modal-shipment-list"><div class="modal" style="max-width:720px;max-height:90vh"><div class="modal-header"><h2 class="modal-title">Upload Shipment List</h2><button class="modal-close" onclick="closeModal('shipment-list')">&#10005;</button></div><div class="modal-body" style="overflow-y:auto;max-height:60vh"><div class="form-group"><label class="form-label">Client <span class="req">*</span></label><select class="form-select" id="sl-client" onchange="onSLClientChange()"><option value="">Select...</option></select></div><div class="form-group"><label class="form-label">Project <span class="req">*</span></label><select class="form-select" id="sl-project"><option value="">Select...</option></select></div><div class="form-group"><label class="form-label">Customer PO # <span class="req">*</span></label><input type="text" class="form-input" id="sl-po" placeholder="e.g. DV061882116001"></div><div class="form-group"><label class="form-label">Paste Shipment Email <span class="req">*</span></label><textarea class="form-input" id="sl-email" placeholder="Paste the full shipment email here..." style="resize:vertical;min-height:160px;font-family:monospace;font-size:12px"></textarea></div><div class="form-group"><button class="btn btn-outline" onclick="parseShipmentEmail()" style="width:100%">&#128269; Parse Shipment List</button></div><div id="sl-preview" style="display:none"><div style="font-weight:600;margin-bottom:8px;font-size:14px">Preview &mdash; <span id="sl-count">0</span> orders found</div><div id="sl-items" style="max-height:300px;overflow-y:auto"></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('shipment-list')">Cancel</button><button class="btn btn-primary" id="sl-submit-btn" onclick="submitShipmentList()" disabled>Import Shipments</button></div></div></div>
<div class="toast" id="toast"><span id="toast-msg"></span></div>
<script>
// Supabase Configuration
const SUPABASE_URL = 'https://ilbrtyoeqrbkbbotoopu.supabase.co';
const SUPABASE_REF = (SUPABASE_URL.split('//')[1] || '').split('.')[0];
let camScans = [], camScansLoaded = false;
let scanInbox = [];
    let camScanEdits = {}, camScanProcessed = {};
    let scanTargetShipmentId = null;
let _authAccessToken = null;
// Synchronously read auth token from localStorage for immediate use
    try {
      var _storedSession = localStorage.getItem('sb-ilbrtyoeqrbkbbotoopu-auth-token');
      if (_storedSession) {
        var _parsed = JSON.parse(_storedSession);
        if (_parsed && _parsed.access_token) {
          // Avoid using an already-expired access token
          const payload = decodeJwtPayload(_parsed.access_token);
          const expMs = payload && payload.exp ? payload.exp * 1000 : 0;
          if (expMs && (Date.now() < (expMs - 30000))) {
            _authAccessToken = _parsed.access_token;
            console.log('[AUTH] Token loaded from localStorage');
          } else {
            console.warn('[AUTH] Stored access token expired, will refresh');
          }
        }
      }
    } catch(_e) { console.log('[AUTH] No stored session'); }
    let _currentUser = null;

const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsYnJ0eW9lcXJia2Jib3Rvb3B1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MjIzMTcsImV4cCI6MjA4NTk5ODMxN30.yPscdd0HuC7jBkBWpPM3Cm4pNC_xGFz1YqvmGVxNVPM';
        const SB = SUPABASE_URL;
        const SK = SUPABASE_KEY;

// Helper function to make Supabase API calls
let sbLastError = null;
async function sbFetch(table, method = 'GET', query = '', data = null, headers = {}) {
    const url = `${SUPABASE_URL}/rest/v1/${table}${query}`;
    // If we have a stored session but no active access token, try restore/refresh first
    if (!_authAccessToken && getStoredAuth()) {
        await restoreSessionIfPossible();
    }
    if (_authAccessToken && isTokenExpired(_authAccessToken)) {
        console.warn('[AUTH] Access token expired in sbFetch  refreshing');
        _authAccessToken = null;
        await ensureAccessToken();
    }
    if (!_authAccessToken) {
        await ensureAccessToken();
    }
    const options = {
        method,
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${_authAccessToken || SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            ...headers
        }
    };
    if (data) options.body = JSON.stringify(data);

    try {
        let response = await fetch(url, options);
        if (!response.ok) {
            const bodyText = await response.text().catch(() => '');
            sbLastError = { table, method, status: response.status, body: bodyText };
            // Auto-recover on expired JWT
            if (response.status === 401 && /JWT expired|invalid|PGRST301/i.test(bodyText || '')) {
                console.warn('[AUTH] JWT expired  refreshing session and retrying');
                await tryRefreshSession();
                const retryOptions = {
                    ...options,
                    headers: {
                        ...options.headers,
                        'Authorization': `Bearer ${_authAccessToken || SUPABASE_KEY}`
                    }
                };
                response = await fetch(url, retryOptions);
                if (response.ok) return await response.json();
            }
            console.warn(`Supabase ${method} ${table} failed:`, response.status, bodyText);
            return null;
        }
        return await response.json();
    } catch (e) {
        console.warn('Supabase fetch error:', e);
        sbLastError = { table, method, status: 'network', body: String(e) };
        return null;
    }
}

// Insert a row and get the generated id
async function sbInsert(table, obj) {
    const payload = assignOrgId(obj, table);
    const result = await sbFetch(table, 'POST', '', payload, { 'Prefer': 'return=representation' });
    return result && result[0] ? result[0].id : null;
}

// Update a row by id
async function sbUpdate(table, id, obj) {
    const query = `?id=eq.${id}`;
    return await sbFetch(table, 'PATCH', query, obj, { 'Prefer': 'return=representation' });
}

// Delete a row by id
async function sbDelete(table, id) {
    const query = `?id=eq.${id}`;
    return await sbFetch(table, 'DELETE', query, null, { 'Prefer': 'return=representation' });
}

// Field mapping: camelCase JS  snake_case Supabase
function toDb(table, obj) {
    const mapping = {
        projects: { clientId: 'client_id', date: 'install_date', time: 'install_time', projectType: 'project_type' },
        shipments: { clientId: 'client_id', projectId: 'project_id', expectedDate: 'expected_date', date: 'received_date', inventoryStatus: 'inventory_status', location: 'sortly', leadTimeDays: 'lead_time_days', etaDate: 'eta_date', poStatus: 'po_status' },
        punchlist: { projectId: 'project_id', reportedById: 'reported_by_id', dateReported: 'date_reported', followupDate: 'followup_date', followupAssignedId: 'followup_assigned_id', etaDate: 'eta_date', rmaNumber: 'rma_number', photoTags: 'photo_tags' },
        dispatches: { projectId: 'project_id', dispatchDate: 'dispatch_date', dispatchedById: 'dispatched_by_id' },
        jobsite_readiness: { projectId: 'project_id', updatedAt: 'updated_at' },
        time_entries: { projectId: 'project_id', personId: 'person_id', workDate: 'work_date', createdAt: 'created_at' },
        project_updates: { projectId: 'project_id', authorId: 'author_id', createdAt: 'created_at' },
        change_orders: { projectId: 'project_id', requestedBy: 'requested_by', approvedBy: 'approved_by', createdAt: 'created_at' },
        move_checklists: { projectId: 'project_id', updatedAt: 'updated_at' },
        move_items: { projectId: 'project_id', pickupLocation: 'pickup_location', dropLocation: 'drop_location', isHighValue: 'is_high_value', qrCode: 'qr_code', qrDataUrl: 'qr_data_url', verifiedById: 'verified_by_id', verifiedAt: 'verified_at', beforePhotos: 'before_photos', afterPhotos: 'after_photos', createdAt: 'created_at', updatedAt: 'updated_at' },
        surveys: { projectId: 'project_id', scheduledAt: 'scheduled_at', completedAt: 'completed_at', createdAt: 'created_at' },
        survey_rooms: { surveyId: 'survey_id', createdAt: 'created_at' },
        survey_items: { roomId: 'room_id', isHighValue: 'is_high_value', laborFactor: 'labor_factor', createdAt: 'created_at' },
        quotes: { projectId: 'project_id', createdAt: 'created_at', approvedAt: 'approved_at', expiresAt: 'expires_at', signedAt: 'signed_at', signedName: 'signed_name', signedEmail: 'signed_email', signatureData: 'signature_data' },
        quote_items: { quoteId: 'quote_id', unitPrice: 'unit_price', lineTotal: 'line_total' },
        move_milestones: { projectId: 'project_id', dueDate: 'due_date', updatedAt: 'updated_at' },
        move_access: { projectId: 'project_id', contactName: 'contact_name', contactPhone: 'contact_phone', contactEmail: 'contact_email', dockReservation: 'dock_reservation', elevatorReservation: 'elevator_reservation', coiStatus: 'coi_status', updatedAt: 'updated_at' },
        move_labels: { projectId: 'project_id', qrDataUrl: 'qr_data_url', createdAt: 'created_at' },
        move_materials: { projectId: 'project_id', plannedQty: 'planned_qty', actualQty: 'actual_qty', unitCost: 'unit_cost', totalCost: 'total_cost', updatedAt: 'updated_at' }
    };
    const map = mapping[table] || {};
    const result = {};
    for (let [k, v] of Object.entries(obj)) {
        const dbKey = map[k] || k;
        result[dbKey] = v;
    }
    return result;
}

function fromDb(table, obj) {
    const mapping = {
        projects: { client_id: 'clientId', install_date: 'date', install_time: 'time', project_type: 'projectType' },
        shipments: { client_id: 'clientId', project_id: 'projectId', expected_date: 'expectedDate', received_date: 'date', inventory_status: 'inventoryStatus', sortly: 'location', lead_time_days: 'leadTimeDays', eta_date: 'etaDate', po_status: 'poStatus' },
        punchlist: { project_id: 'projectId', reported_by_id: 'reportedById', date_reported: 'dateReported', followup_date: 'followupDate', followup_assigned_id: 'followupAssignedId', eta_date: 'etaDate', rma_number: 'rmaNumber', photo_tags: 'photoTags' },
        dispatches: { project_id: 'projectId', dispatch_date: 'dispatchDate', dispatched_by_id: 'dispatchedById' },
        jobsite_readiness: { project_id: 'projectId', updated_at: 'updatedAt' },
        time_entries: { project_id: 'projectId', person_id: 'personId', work_date: 'workDate', created_at: 'createdAt' },
        project_updates: { project_id: 'projectId', author_id: 'authorId', created_at: 'createdAt' },
        change_orders: { project_id: 'projectId', requested_by: 'requestedBy', approved_by: 'approvedBy', created_at: 'createdAt' },
        move_checklists: { project_id: 'projectId', updated_at: 'updatedAt' },
        move_items: { project_id: 'projectId', pickup_location: 'pickupLocation', drop_location: 'dropLocation', is_high_value: 'isHighValue', qr_code: 'qrCode', qr_data_url: 'qrDataUrl', verified_by_id: 'verifiedById', verified_at: 'verifiedAt', before_photos: 'beforePhotos', after_photos: 'afterPhotos', created_at: 'createdAt', updated_at: 'updatedAt' },
        surveys: { project_id: 'projectId', scheduled_at: 'scheduledAt', completed_at: 'completedAt', created_at: 'createdAt' },
        survey_rooms: { survey_id: 'surveyId', created_at: 'createdAt' },
        survey_items: { room_id: 'roomId', is_high_value: 'isHighValue', labor_factor: 'laborFactor', created_at: 'createdAt' },
        quotes: { project_id: 'projectId', created_at: 'createdAt', approved_at: 'approvedAt', expires_at: 'expiresAt', signed_at: 'signedAt', signed_name: 'signedName', signed_email: 'signedEmail', signature_data: 'signatureData' },
        quote_items: { quote_id: 'quoteId', unit_price: 'unitPrice', line_total: 'lineTotal' },
        move_milestones: { project_id: 'projectId', due_date: 'dueDate', updated_at: 'updatedAt' },
        move_access: { project_id: 'projectId', contact_name: 'contactName', contact_phone: 'contactPhone', contact_email: 'contactEmail', dock_reservation: 'dockReservation', elevator_reservation: 'elevatorReservation', coi_status: 'coiStatus', updated_at: 'updatedAt' },
        move_labels: { project_id: 'projectId', qr_data_url: 'qrDataUrl', created_at: 'createdAt' },
        move_materials: { project_id: 'projectId', planned_qty: 'plannedQty', actual_qty: 'actualQty', unit_cost: 'unitCost', total_cost: 'totalCost', updated_at: 'updatedAt' }
    };
    const map = mapping[table] || {};
    const result = {};
    for (let [k, v] of Object.entries(obj)) {
        const jsKey = map[k] || k;
        result[jsKey] = v;
    }
    return result;
}

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
function escapeHtml(str) {
    return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}
const PHOTO_COMPRESS = { maxWidth: 1600, maxHeight: 1600, quality: 0.72, mimeType: 'image/jpeg' };
const INSTALL_STATUS_OPTIONS = [
    { value: 'scheduled', label: 'Scheduled' },
    { value: 'ready', label: 'Ready for Install' },
    { value: 'in-progress', label: 'In Progress' },
    { value: 'dispatched', label: 'Dispatched' },
    { value: 'installed', label: 'Installed' },
    { value: 'completed', label: 'Completed' }
];
const MOVE_STATUS_OPTIONS = [
    { value: 'survey', label: 'Survey' },
    { value: 'plan', label: 'Move Plan' },
    { value: 'coi', label: 'COI' },
    { value: 'pack', label: 'Packing' },
    { value: 'loadout', label: 'Loadout' },
    { value: 'dispatch', label: 'Dispatch' },
    { value: 'move', label: 'Move / Transit' },
    { value: 'unload', label: 'Unload / Placement' },
    { value: 'qc', label: 'QC / Walkthrough' },
    { value: 'close', label: 'Closeout' }
];
const DEFAULT_AUTOMATIONS = [
    { id: 'move-plan-reminder', name: 'Move Plan Reminder', folder: 'Operations', status: 'published', triggerType: 'date', triggerValue: 'move_date', offsetDays: -7, channel: 'Email', audience: 'PM', subject: 'Move plan needed', message: 'Please upload the move plan for {{project_name}}.' },
    { id: 'coi-followup', name: 'COI Follow-up', folder: 'Operations', status: 'published', triggerType: 'date', triggerValue: 'move_date', offsetDays: -5, channel: 'Email/SMS', audience: 'PM', subject: 'COI status', message: 'COI is still pending for {{project_name}}. Please confirm approval.' },
    { id: 'dispatch-brief', name: 'Dispatch Brief', folder: 'Operations', status: 'published', triggerType: 'date', triggerValue: 'dispatch_date', offsetDays: -1, channel: 'SMS', audience: 'Crew', subject: '', message: 'Dispatch briefing for {{project_name}}: {{address}} {{time}}.' },
    { id: 'arrival-checkin', name: 'Arrival Check-in', folder: 'Operations', status: 'published', triggerType: 'date', triggerValue: 'move_date', offsetDays: 0, channel: 'SMS', audience: 'Foreman', subject: '', message: 'Confirm arrival at {{project_name}} jobsite.' },
    { id: 'post-move-docs', name: 'Post-move Docs', folder: 'Closeout', status: 'paused', triggerType: 'status', triggerValue: 'close', offsetDays: 0, channel: 'Email', audience: 'PM', subject: 'Post-move docs', message: 'Please upload after photos and sign-off for {{project_name}}.' },
    { id: 'client-status', name: 'Client Status Update', folder: 'Client', status: 'draft', triggerType: 'schedule', triggerValue: 'weekly_fri_3pm', offsetDays: 0, channel: 'Email', audience: 'Client PM', subject: 'Weekly status update', message: 'Weekly update for {{project_name}}: {{status_summary}}.' }
];
const JOBSITE_CHECKLIST = [
    { id: 'access', label: 'Site access confirmed' },
    { id: 'elevator', label: 'Elevator reserved' },
    { id: 'floor', label: 'Floor protection installed' },
    { id: 'afterhours', label: 'After-hours approval' },
    { id: 'contact', label: 'On-site contact confirmed' },
    { id: 'parking', label: 'Loading dock / parking confirmed' }
];
const MOVE_CHECKLISTS = {
    pre: [
        { id: 'coi_sent', label: 'COI sent to building' },
        { id: 'kickoff_meeting', label: 'Kickoff meeting scheduled' },
        { id: 'guide_review', label: 'Move guide reviewed with client' },
        { id: 'access_confirmed', label: 'Access/parking/elevator confirmed' },
        { id: 'it_handoff', label: 'IT/AV disconnect plan confirmed' },
        { id: 'labels_printed', label: 'Labels/QR printed' },
        { id: 'floor_protection', label: 'Floor protection plan confirmed' },
        { id: 'security_badges', label: 'Badges / security clearance arranged' }
    ],
    team: [
        { id: 'safety_brief', label: 'Safety briefing completed' },
        { id: 'equipment_check', label: 'Dollies/straps/blankets checked' },
        { id: 'qr_ready', label: 'QR scanning ready for high-value items' },
        { id: 'before_photos', label: 'Before photos captured' },
        { id: 'inventory_count', label: 'Inventory count verified' },
        { id: 'chain_custody', label: 'Chain-of-custody for high-value' }
    ],
    dayof: [
        { id: 'staging_set', label: 'Staging zones set' },
        { id: 'elevator_lockout', label: 'Elevator lockout confirmed' },
        { id: 'dock_clear', label: 'Loading dock clear' },
        { id: 'arrival_verify', label: 'Arrival verification done' },
        { id: 'after_photos', label: 'After photos captured' },
        { id: 'client_signoff', label: 'Client sign-off obtained' }
    ]
};
const BMG_MILESTONE_STAGES = [
    { key: 'survey', label: 'Survey' },
    { key: 'plan', label: 'Plan' },
    { key: 'coi', label: 'COI' },
    { key: 'pack', label: 'Pack' },
    { key: 'move', label: 'Move' },
    { key: 'close', label: 'Close' }
];

const SAMPLE_ORGS = [
    { name: 'Vector Installation Services', slug: 'vector', default_project_type: 'install' },
    { name: 'Business Moving Group', slug: 'bmg', default_project_type: 'move' },
    { name: 'Stucco Champions', slug: 'stucco', default_project_type: 'stucco' }
];
const ORG_SCOPED_TABLES = new Set([
    'clients','people','projects','scans','scan_inbox','shipments','punchlist','dispatches','loading_sheets','project_completions',
    'move_checklists','move_items','jobsite_readiness','time_entries','project_updates','change_orders',
    'surveys','survey_rooms','survey_items','quotes','quote_items','quote_share_links','move_milestones','move_access','move_labels','move_materials',
    'staff_roles','staff_permissions','users','integrations',
    'warehouse_rows','warehouse_bays','warehouse_bins','inventory_items'
, 'automations', 'automation_folders', 'workflow_steps']);

function ensureFallbackOrgs() {
    if (orgs && orgs.length) return;
    orgs = SAMPLE_ORGS.map((o, idx) => ({ id: `local-${o.slug || idx}`, ...o }));
    defaultOrgId = orgs[0]?.id || null;
    activeOrgId = activeOrgId || defaultOrgId;
}

function getActiveOrgId() {
    if (activeOrgId) return activeOrgId;
    if (orgs && orgs.length) return orgs[0].id;
    return null;
}
function getActiveOrg() {
    const id = getActiveOrgId();
    return orgs.find(o => String(o.id) === String(id)) || orgs[0] || null;
}
function getOrgDisplayName(org) {
    if (!org) return '';
    const slug = (org.slug || '').toLowerCase();
    if (slug === 'vector') return 'Vector Installation Services';
    if (slug === 'bmg') return 'Business Moving Group';
    return org.name || '';
}
function getDefaultProjectType() {
    const org = getActiveOrg();
    return (org && org.default_project_type) ? org.default_project_type : 'install';
}
function assignOrgId(obj, table) {
    if (!obj || typeof obj !== 'object') return obj;
    if (!ORG_SCOPED_TABLES.has(table)) return obj;
    if (!obj.org_id && getActiveOrgId()) obj.org_id = getActiveOrgId();
    return obj;
}
function applyDefaultOrg(list) {
    if (!Array.isArray(list)) return list;
    const fallback = defaultOrgId || getActiveOrgId();
    if (!fallback) return list;
    list.forEach(item => { if (item && !item.org_id) item.org_id = fallback; });
    return list;
}
function matchesActiveOrg(item) {
    const orgId = getActiveOrgId();
    if (!orgId || !item) return true;
    const itemOrg = item.org_id || item.orgId || item.org || null;
    if (!itemOrg) return String(orgId) === String(defaultOrgId || orgId);
    return String(itemOrg) === String(orgId);
}
function filterByOrg(list) {
    return (list || []).filter(matchesActiveOrg);
}
function getOrgClients() { return filterByOrg(clients); }
function getOrgPeople() { return filterByOrg(people); }
function getOrgProjects() { return filterByOrg(projects); }
function getOrgShipments() { return filterByOrg(shipments); }
function getOrgScans() { return filterByOrg(scans); }
function getOrgScanInbox() { return filterByOrg(scanInbox); }
function getOrgDispatches() { return filterByOrg(dispatches); }
function getOrgStaffRoles() { return filterByOrg(staffRoles); }
function getOrgStaffPermissions() { return filterByOrg(staffPermissions); }
function getOrgUsers() { return filterByOrg(crmUsers); }
function getOrgIntegrations() { return filterByOrg(crmIntegrations); }
function getOrgMoveItems() { return filterByOrg(moveItems); }

function renderOrgSwitcherList() {
    const listEl = document.getElementById('org-switcher-list');
    if (!listEl) return;
    ensureFallbackOrgs();
    const items = (orgs || []);
    listEl.innerHTML = items.map(o => {
        const isActive = String(o.id) === String(getActiveOrgId());
        const displayName = getOrgDisplayName(o);
        const idVal = String(o.id).replace(/'/g, "\\'");
        return `<div class="org-switcher-item ${isActive ? 'active' : ''}" onclick="setActiveOrg('${idVal}')">` +
            `<div><div class="name">${escapeHtml(displayName)}</div><div class="meta">${escapeHtml(o.slug || '')}</div></div>` +
            `<div>${isActive ? '' : ''}</div></div>`;
    }).join('');
}
function updateOrgScopedUI() {
    const isBmg = isBmgWorkspace();
    const movingNav = document.getElementById('nav-moving');
    const projectsNav = document.getElementById('nav-projects');
    const receivingNav = document.getElementById('nav-receiving');
    const warehouseNav = document.getElementById('nav-warehouse');
    if (movingNav) movingNav.style.display = isBmg ? 'flex' : 'none';
    if (projectsNav) projectsNav.style.display = 'flex';
    if (receivingNav) receivingNav.style.display = isBmg ? 'none' : 'flex';
    if (warehouseNav) warehouseNav.style.display = isBmg ? 'none' : 'flex';
    const projectsTitle = document.querySelector('#view-projects .header-title');
    if (projectsTitle) {
        if (isBmg) {
            projectsTitle.textContent = projectsViewMode === 'list' ? 'Projects' : 'Moves';
        } else {
            projectsTitle.textContent = 'Projects';
        }
    }
    const projectsSearch = document.getElementById('projects-search-input');
    if (projectsSearch) projectsSearch.placeholder = isBmg ? 'Search moves...' : 'Search projects...';
    const viewTabs = document.getElementById('projects-view-tabs');
    if (viewTabs) viewTabs.style.display = isBmg ? 'flex' : 'none';
    if (isBmg && !projectsViewMode) projectsViewMode = 'board';

    const mobileReceiving = document.querySelector('.mobile-tab[data-view="receiving"]');
    const mobileReceivingBtn = document.getElementById('mobile-tab-receiving');
    const mobileBadge = document.getElementById('mobile-receiving-badge');
    if (mobileReceivingBtn) {
        if (isBmg) {
            mobileReceivingBtn.dataset.view = 'dashboard';
            mobileReceivingBtn.setAttribute('onclick', "mobileNav('dashboard')");
            const icon = mobileReceivingBtn.querySelector('.mobile-icon');
            const label = mobileReceivingBtn.querySelector('.mobile-label');
            if (icon) icon.textContent = '';
            if (label) label.textContent = 'Dashboard';
            if (mobileBadge) mobileBadge.style.display = 'none';
        } else {
            mobileReceivingBtn.dataset.view = 'receiving';
            mobileReceivingBtn.setAttribute('onclick', "mobileNav('receiving')");
            const icon = mobileReceivingBtn.querySelector('.mobile-icon');
            const label = mobileReceivingBtn.querySelector('.mobile-label');
            if (icon) icon.textContent = '';
            if (label) label.textContent = 'Receiving';
            if (mobileBadge) mobileBadge.style.display = '';
        }
    }
    const mobileProjects = document.querySelector('.mobile-tab[data-view="projects"]');
    if (mobileProjects) {
        const icon = mobileProjects.querySelector('.mobile-icon');
        const label = mobileProjects.querySelector('.mobile-label');
        if (icon) icon.textContent = isBmg ? '' : '';
        if (label) label.textContent = isBmg ? 'Moving' : 'Projects';
    }

    if (isBmg) {
        const activeView = document.querySelector('.view.active');
        if (activeView && (activeView.id === 'view-receiving' || activeView.id === 'view-warehouse')) {
            showProjectsBoard();
        }
    }
}
function renderOrgSwitcher() {
    const nameEl = document.getElementById('org-switch-name');
    ensureFallbackOrgs();
    const org = getActiveOrg();
    if (nameEl) nameEl.textContent = org ? getOrgDisplayName(org) : 'Workspace';
    renderOrgSwitcherList();
    updateOrgScopedUI();
}
function toggleOrgSwitcher(e) {
    if (e) e.stopPropagation();
    const overlay = document.getElementById('org-switcher-overlay');
    if (!overlay) return;
    overlay.classList.add('show');
    renderOrgSwitcherList();
}
function closeOrgSwitcher(e) {
    if (e) e.stopPropagation();
    const overlay = document.getElementById('org-switcher-overlay');
    if (overlay) overlay.classList.remove('show');
}
function setActiveOrg(id) {
    activeOrgId = id;
    localStorage.setItem('v10_active_org', String(id));
    closeOrgSwitcher();
    recomputePMAccess();
    projectsViewMode = isBmgWorkspace() ? 'board' : 'list';
    automations = [];
    automationFolders = [];
    renderOrgSwitcher();
    currentProject = null;
    currentQuoteId = null;
    render();
    closePanel();
    if (whLoaded) { loadWarehouse().then(renderWarehouse); }
}

function getActiveRoleName() {
    let role = (_currentUser && _currentUser.role ? String(_currentUser.role).toLowerCase() : '');
    if (!role || role === 'staff') {
        const email = (_currentUser && _currentUser.email ? _currentUser.email.toLowerCase() : '');
        if (email && Array.isArray(people)) {
            const person = people.find(p => (p.email || '').toLowerCase() === email);
            if (person && person.role) role = String(person.role).toLowerCase();
        }
    }
    return role;
}

function roleMatches(role, keywords) {
    if (!role) return false;
    return keywords.some(k => role.includes(k));
}

function canEditFeature(feature) {
    const role = getActiveRoleName();
    if (role.includes('admin') || role.includes('owner')) return true;
    const map = {
        readiness: ['lead', 'foreman', 'super'],
        completion: ['lead', 'foreman', 'super'],
        loadout: ['warehouse'],
        issues: ['lead', 'installer', 'crew', 'field'],
        returns: ['warehouse', 'office', 'pm'],
        updates: ['office', 'pm', 'admin'],
        pm_access: ['office']
    };
    const keys = map[feature] || [];
    return roleMatches(role, keys);
}

function getProjectType(project) {
    if (!project) return 'install';
    const t = project.projectType || project.project_type || project.projectType || project.type;
    return (t || 'install').toString().toLowerCase();
}

function isMoveProject(project) {
    return getProjectType(project) === 'move';
}

function getProjectStatusOptions(project) {
    return isMoveProject(project) ? MOVE_STATUS_OPTIONS : INSTALL_STATUS_OPTIONS;
}

function getProjectStatusLabel(project, status) {
    const opts = getProjectStatusOptions(project || {});
    const found = opts.find(o => o.value === status);
    if (found) return found.label;
    if (status) return status;
    return isMoveProject(project) ? 'Survey' : 'Scheduled';
}

function normalizeEmailList(list) {
    const emails = (Array.isArray(list) ? list : [])
        .map(s => String(s || '').trim().toLowerCase())
        .filter(Boolean);
    return Array.from(new Set(emails));
}

function getProjectPmEmails(project) {
    if (!project) return [];
    let emails = [];
    if (Array.isArray(project.pm_emails)) emails = project.pm_emails.slice();
    else if (typeof project.pm_emails === 'string' && project.pm_emails.trim()) {
        try {
            const parsed = JSON.parse(project.pm_emails);
            if (Array.isArray(parsed)) emails = parsed;
            else emails = parseEmailList(project.pm_emails);
        } catch (e) {
            emails = parseEmailList(project.pm_emails);
        }
    }
    if (project.project_manager && String(project.project_manager).includes('@')) {
        emails = emails.concat(parseEmailList(project.project_manager));
    }
    return normalizeEmailList(emails);
}

function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function blobToDataURL(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

async function loadImageFromFile(file) {
    if (window.createImageBitmap) {
        try {
            return await createImageBitmap(file, { imageOrientation: 'from-image' });
        } catch (e) {}
    }
    return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = (err) => { URL.revokeObjectURL(url); reject(err); };
        img.src = url;
    });
}

function canvasToBlob(canvas, mimeType, quality) {
    return new Promise((resolve) => {
        if (!canvas.toBlob) return resolve(null);
        canvas.toBlob((blob) => resolve(blob), mimeType, quality);
    });
}

async function compressImageFile(file, opts) {
    if (!file || !file.type || !file.type.startsWith('image/')) {
        return { blob: file, dataUrl: await readFileAsDataURL(file) };
    }
    const cfg = Object.assign({}, PHOTO_COMPRESS, opts || {});
    const img = await loadImageFromFile(file);
    const ratio = Math.min(1, cfg.maxWidth / img.width, cfg.maxHeight / img.height);
    const w = Math.max(1, Math.round(img.width * ratio));
    const h = Math.max(1, Math.round(img.height * ratio));
    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, w, h);
    ctx.drawImage(img, 0, 0, w, h);
    const blob = (await canvasToBlob(canvas, cfg.mimeType, cfg.quality)) || file;
    const dataUrl = await blobToDataURL(blob);
    return { blob, dataUrl };
}
let orgs=[], activeOrgId=null, defaultOrgId=null;
let clients=[], projects=[], people=[], scans=[], shipments=[], punchlist=[], dispatches=[];
let loadingSheets=[], projectCompletions=[];
let jobsiteReadiness=[], timeEntries=[], projectUpdates=[], changeOrders=[];
let moveChecklists=[], moveItems=[];
let surveys=[], surveyRooms=[], surveyItems=[], quotes=[], quoteItems=[];
let moveMilestones=[], moveAccess=[], moveLabels=[], moveMaterials=[];
let staffRoles=[], staffPermissions=[], crmUsers=[], crmIntegrations=[];
let activeSettingsTab = 'integrations';
let currentMonth = new Date(), currentScan = null, currentScanSource = 'local', currentCamScanId = null, currentProject = null, pendingScan = null, openPOs = {};
let pendingPhotoUploads = [], pendingItemPhotos = [], punchlistFilter = {project: null, type: null, status: null};
let projectSearchQuery = '', clientSearchQuery = '';
let projectsViewMode = 'list';
let automations = [];
let automationSearchQuery = '';
let automationFilter = 'all';
let automationFolderFilter = 'all';
let automationFolders = [];
let editingAutomationId = null;
let projectToDelete = null;
let currentUserId = null;
let pmAccess = { enabled: false, email: null, clientIds: [], projectIds: [] };
let currentQuoteId = null;
let surveyItemPhotos = {};

function recomputePMAccess() {
    const email = (_currentUser && _currentUser.email ? _currentUser.email.toLowerCase() : '');
    const role = (_currentUser && _currentUser.role ? String(_currentUser.role).toLowerCase() : '');
    if (!email || role === 'admin') { pmAccess = { enabled:false, email:null, clientIds:[], projectIds:[] }; return; }
    const projectIds = getOrgProjects().filter(p => getProjectPmEmails(p).includes(email)).map(p => p.id);
    if (!projectIds.length) { pmAccess = { enabled:false, email:null, clientIds:[], projectIds:[] }; return; }
    const clientIds = Array.from(new Set(getOrgProjects().filter(p => projectIds.includes(p.id)).map(p => p.clientId)));
    pmAccess = { enabled: true, email, clientIds, projectIds };
}

function getVisibleProjects() {
    const orgProjects = getOrgProjects();
    return pmAccess.enabled ? orgProjects.filter(p => pmAccess.projectIds.includes(p.id)) : orgProjects;
}

function getVisibleShipments() {
    const orgShipments = getOrgShipments();
    if (!pmAccess.enabled) return orgShipments;
    return orgShipments.filter(s => (s.projectId && pmAccess.projectIds.includes(s.projectId)) || (!s.projectId && pmAccess.clientIds.includes(s.clientId)));
}

const sampleClients = [{id:1,company:'Red Thread',email:'client@redthread.com'},{id:2,company:'Service Champions',email:'client@sc.com'},{id:3,company:'Kayne',email:'client@kayne.com'}];
const samplePeople = [{id:1,name:'Carlos Martinez',role:'Lead Installer',phone:'(714) 555-0101',email:'carlos@vector.com'},{id:2,name:'James Wilson',role:'Installer',phone:'(714) 555-0102',email:'james@vector.com'},{id:3,name:'Mike Johnson',role:'Driver',phone:'(714) 555-0103',email:'mike@vector.com'}];
const sampleProjects = [{id:1,name:'Red Thread',clientId:1,date:'2025-02-10',time:'07:00',location:'123 Business Park',team:[1,2],docs:{}},{id:2,name:'Service Champions',clientId:2,date:'2025-02-08',time:'06:30',location:'456 Industrial',team:[3],docs:{}},{id:3,name:'Kayne',clientId:3,date:'2025-02-12',time:'07:30',location:'789 Corporate',team:[1,2,3],docs:{}}];
const sampleScans = [{id:1,filename:'Camera_02-06_14-30.jpg',timestamp:'2025-02-06T14:30:00',status:'pending',thumbnail:null},{id:2,filename:'Camera_02-06_11-15.jpg',timestamp:'2025-02-06T11:15:00',status:'pending',thumbnail:null},{id:3,filename:'Camera_02-05_09-00.jpg',timestamp:'2025-02-05T09:00:00',status:'done',po:'11041-18-MM HON',thumbnail:null}];
const sampleShipments = [
    {id:1,po:'11041',subitem:'11041-18-MM HON',clientId:1,projectId:1,mfr:'HON',expectedDate:'2025-02-08',date:'2025-02-06',status:'received',location:'A1-01',inventoryStatus:'in-warehouse'},
    {id:2,po:'11041',subitem:'11041-19-MM HON',clientId:1,projectId:1,mfr:'HON',expectedDate:'2025-02-08',date:'2025-02-06',status:'received',location:'A1-02',inventoryStatus:'in-warehouse'},
    {id:3,po:'11041',subitem:'11041-20-MM HON',clientId:1,projectId:1,mfr:'HON',expectedDate:'2025-02-08',date:'2025-02-06',status:'received',location:'A1-03',inventoryStatus:'in-warehouse'},
    {id:4,po:'11509',subitem:'11509 1',clientId:2,projectId:2,mfr:'',expectedDate:'2025-02-10',date:null,status:'not-received',location:'',inventoryStatus:'in-warehouse'},
    {id:5,po:'11509',subitem:'11509 2',clientId:2,projectId:2,mfr:'',expectedDate:'2025-02-10',date:null,status:'not-received',location:'',inventoryStatus:'in-warehouse'},
    {id:6,po:'11456',subitem:'11456-01-RS Deskmakers',clientId:3,projectId:3,mfr:'Deskmakers',expectedDate:'2025-02-09',date:null,status:'not-received',location:'',inventoryStatus:'in-warehouse'},
    {id:7,po:'11456',subitem:'11456-02-RS N9NE Furniture',clientId:3,projectId:3,mfr:'N9NE Furniture',expectedDate:'2025-02-09',date:'2025-02-06',status:'received',location:'B2-01',inventoryStatus:'in-warehouse'}
];
const samplePunchlist = [
    {id:1,projectId:1,type:'damaged',description:'Corner cabinet door damage',manufacturer:'HON',po:'11041-18-MM HON',quantity:1,status:'open',reportedById:1,dateReported:'2025-02-06',photos:[],notes:'Arrived with corner damage on left side'},
    {id:2,projectId:2,type:'missing',description:'Missing drawer hardware',manufacturer:'',po:'',quantity:4,status:'inprogress',reportedById:2,dateReported:'2025-02-05',photos:[],notes:'4 drawer handles not included in shipment'},
    {id:3,projectId:3,type:'backorder',description:'Credenza top in walnut',manufacturer:'Deskmakers',po:'11456-01-RS Deskmakers',quantity:1,status:'resolved',reportedById:3,dateReported:'2025-02-04',photos:[],notes:'Ordered and scheduled for delivery 2/15'}
];

const USE_ONEDRIVE_SCAN_INBOX = true;
const SHOW_CAM_INBOX = false;
const ENABLE_CAMSCANNER_API = false;

document.addEventListener('DOMContentLoaded', async () => {
    loadCamScanState();
    // Don't call load() here  initAuth() will call load() after session is established.
    // Calling load() before auth causes 401 JWT expired errors on all tables,
    // which cascades into false SIGNED_OUT events and a logout loop.
    if (ENABLE_CAMSCANNER_API) loadCamScannerDocs();
});

async function load() {
    // Try to load from Supabase first
    const sbOrgs = await sbFetch('orgs', 'GET');
    if (sbOrgs === null) {
        if (sbLastError && sbLastError.status === 401) {
            const refreshed = await tryRefreshSession();
            if (refreshed) return await load();
        }
        if (sbLastError && sbLastError.status === 404) {
            orgs = SAMPLE_ORGS.map((o, idx) => ({ id: `local-${o.slug || idx}`, ...o }));
        } else {
            loadLocalFallback();
            return;
        }
    }
    if (sbOrgs && sbOrgs.length > 0) {
        orgs = sbOrgs;
        const findExisting = (sample) => {
            const bySlug = orgs.find(o => (o.slug || '').toLowerCase() === sample.slug);
            if (bySlug) return bySlug;
            return orgs.find(o => (o.name || '').toLowerCase() === sample.name.toLowerCase());
        };
        for (const sample of SAMPLE_ORGS) {
            const existing = findExisting(sample);
            if (existing) {
                const updates = {};
                if (!existing.slug || String(existing.slug).toLowerCase() !== sample.slug) updates.slug = sample.slug;
                if (!existing.name || existing.name !== sample.name) updates.name = sample.name;
                if (!existing.default_project_type || existing.default_project_type !== sample.default_project_type) updates.default_project_type = sample.default_project_type;
                if (Object.keys(updates).length) {
                    await sbUpdate('orgs', existing.id, updates);
                    Object.assign(existing, updates);
                }
            } else {
                const newId = await sbInsert('orgs', { name: sample.name, slug: sample.slug, default_project_type: sample.default_project_type });
                orgs.push({ id: newId || Date.now(), ...sample });
            }
        }
    } else if (orgs.length === 0) {
        orgs = [];
        for (const o of SAMPLE_ORGS) {
            const newId = await sbInsert('orgs', { name: o.name, slug: o.slug, default_project_type: o.default_project_type });
            orgs.push({ id: newId || Date.now(), ...o });
        }
    }
    defaultOrgId = (orgs.find(o => o.slug === 'vector') || orgs[0] || {}).id || null;
    const storedOrg = localStorage.getItem('v10_active_org');
    activeOrgId = storedOrg && orgs.some(o => String(o.id) === String(storedOrg)) ? storedOrg : (defaultOrgId || (orgs[0] ? orgs[0].id : null));
    projectsViewMode = isBmgWorkspace() ? 'board' : 'list';
    renderOrgSwitcher();

    const sbClients = await sbFetch('clients', 'GET');
    const sbPeople = await sbFetch('people', 'GET');
    const sbProjects = await sbFetch('projects', 'GET');
    const sbScans = await sbFetch('scans', 'GET');
    const sbShipments = await sbFetch('shipments', 'GET');
    const sbPunchlist = await sbFetch('punchlist', 'GET');
    const sbDispatches = await sbFetch('dispatches', 'GET');
    const sbLoadingSheets = await sbFetch('loading_sheets', 'GET');
    const sbProjectCompletions = await sbFetch('project_completions', 'GET');
    const sbMoveChecklists = await sbFetch('move_checklists', 'GET');
    const sbMoveItems = await sbFetch('move_items', 'GET');
    const sbJobsiteReadiness = await sbFetch('jobsite_readiness', 'GET');
    const sbTimeEntries = await sbFetch('time_entries', 'GET');
    const sbProjectUpdates = await sbFetch('project_updates', 'GET');
    const sbChangeOrders = await sbFetch('change_orders', 'GET');
    const sbSurveys = await sbFetch('surveys', 'GET');
    const sbSurveyRooms = await sbFetch('survey_rooms', 'GET');
    const sbSurveyItems = await sbFetch('survey_items', 'GET');
    const sbQuotes = await sbFetch('quotes', 'GET');
    const sbQuoteItems = await sbFetch('quote_items', 'GET');
    const sbMoveMilestones = await sbFetch('move_milestones', 'GET');
    const sbMoveAccess = await sbFetch('move_access', 'GET');
    const sbMoveLabels = await sbFetch('move_labels', 'GET');
    const sbMoveMaterials = await sbFetch('move_materials', 'GET');
    const sbStaffRoles = await sbFetch('staff_roles', 'GET'); const sbStaffPerms = await sbFetch('staff_permissions', 'GET'); const sbUsers = await sbFetch('users', 'GET'); const sbIntegrations = await sbFetch('integrations', 'GET');

    if (sbClients === null) {
        // If auth failed, try refresh and retry once
        if (sbLastError && sbLastError.status === 401) {
            const refreshed = await tryRefreshSession();
            if (refreshed) return await load();
        }
        // Supabase failed (offline/RLS). Fallback to cached local data if available.
        loadLocalFallback();
        return;
    }
    if (sbClients && sbClients.length > 0) {
        // Supabase has data - use it
        clients = applyDefaultOrg(sbClients);
        people = applyDefaultOrg(sbPeople || []);
        projects = applyDefaultOrg((sbProjects || []).map(p => fromDb('projects', p)));
        scans = applyDefaultOrg(sbScans || []);
        shipments = applyDefaultOrg((sbShipments || []).map(s => fromDb('shipments', s)));
        punchlist = applyDefaultOrg((sbPunchlist || []).map(p => fromDb('punchlist', p)));
        dispatches = applyDefaultOrg((sbDispatches || []).map(d => fromDb('dispatches', d)));
        loadingSheets = applyDefaultOrg(sbLoadingSheets || []);
        projectCompletions = applyDefaultOrg(sbProjectCompletions || []);
        moveChecklists = applyDefaultOrg((sbMoveChecklists || []).map(m => fromDb('move_checklists', m)));
        moveItems = applyDefaultOrg((sbMoveItems || []).map(m => fromDb('move_items', m)));
        jobsiteReadiness = applyDefaultOrg((sbJobsiteReadiness || []).map(r => fromDb('jobsite_readiness', r)));
        timeEntries = applyDefaultOrg((sbTimeEntries || []).map(t => fromDb('time_entries', t)));
        projectUpdates = applyDefaultOrg((sbProjectUpdates || []).map(u => fromDb('project_updates', u)));
        changeOrders = applyDefaultOrg((sbChangeOrders || []).map(c => fromDb('change_orders', c)));
        surveys = applyDefaultOrg((sbSurveys || []).map(s => fromDb('surveys', s)));
        surveyRooms = applyDefaultOrg((sbSurveyRooms || []).map(r => fromDb('survey_rooms', r)));
        surveyItems = applyDefaultOrg((sbSurveyItems || []).map(i => fromDb('survey_items', i)));
        quotes = applyDefaultOrg((sbQuotes || []).map(q => fromDb('quotes', q)));
        quoteItems = applyDefaultOrg((sbQuoteItems || []).map(i => fromDb('quote_items', i)));
        moveMilestones = applyDefaultOrg((sbMoveMilestones || []).map(m => fromDb('move_milestones', m)));
        moveAccess = applyDefaultOrg((sbMoveAccess || []).map(a => fromDb('move_access', a)));
        moveLabels = applyDefaultOrg((sbMoveLabels || []).map(l => fromDb('move_labels', l)));
        moveMaterials = applyDefaultOrg((sbMoveMaterials || []).map(m => fromDb('move_materials', m)));
      staffRoles = applyDefaultOrg(sbStaffRoles || []); staffPermissions = applyDefaultOrg(sbStaffPerms || []); crmUsers = applyDefaultOrg(sbUsers || []); crmIntegrations = applyDefaultOrg(sbIntegrations || []);
    } else {
        // Supabase is empty - seed with sample data
        const idMaps = { clients: {}, people: {}, projects: {}, scans: {}, shipments: {}, punchlist: {}, dispatches: {} };

        // Seed clients
        for (let sc of sampleClients) {
            const { id: oldId, ...data } = sc;
            const newId = await sbInsert('clients', assignOrgId(data, 'clients'));
            idMaps.clients[oldId] = newId;
            clients.push({ id: newId, ...data });
        }

        // Seed people
        for (let sp of samplePeople) {
            const { id: oldId, ...data } = sp;
            const newId = await sbInsert('people', assignOrgId(data, 'people'));
            idMaps.people[oldId] = newId;
            people.push({ id: newId, ...data });
        }

        // Seed projects
        for (let sp of sampleProjects) {
            const { id: oldId, ...data } = sp;
            const dbData = toDb('projects', assignOrgId({ ...data, team: data.team || [] }, 'projects'));
            const newId = await sbInsert('projects', dbData);
            idMaps.projects[oldId] = newId;
            projects.push({ id: newId, ...data, clientId: idMaps.clients[data.clientId], team: data.team || [] });
        }

        // Seed scans
        for (let ss of sampleScans) {
            const { id: oldId, thumbnail, ...data } = ss;
            const newId = await sbInsert('scans', assignOrgId(data, 'scans'));
            idMaps.scans[oldId] = newId;
            scans.push({ id: newId, ...data, thumbnail: null });
        }

        // Seed shipments
        for (let ss of sampleShipments) {
            const { id: oldId, ...data } = ss;
            const dbData = toDb('shipments', assignOrgId({ ...data, clientId: idMaps.clients[data.clientId], projectId: idMaps.projects[data.projectId], inventoryStatus: data.inventoryStatus || 'in-warehouse' }, 'shipments'));
            const newId = await sbInsert('shipments', dbData);
            idMaps.shipments[oldId] = newId;
            shipments.push({ id: newId, ...data, clientId: idMaps.clients[data.clientId], projectId: idMaps.projects[data.projectId], inventoryStatus: data.inventoryStatus || 'in-warehouse' });
        }

        // Seed punchlist
        for (let sp of samplePunchlist) {
            const { id: oldId, ...data } = sp;
            const dbData = toDb('punchlist', assignOrgId({ ...data, projectId: idMaps.projects[data.projectId], reportedById: idMaps.people[data.reportedById], photos: [] }, 'punchlist'));
            const newId = await sbInsert('punchlist', dbData);
            idMaps.punchlist[oldId] = newId;
            punchlist.push({ id: newId, ...data, projectId: idMaps.projects[data.projectId], reportedById: idMaps.people[data.reportedById], photos: [] });
        }
    }

    // Load scan inbox (Supabase)
    await loadScanInbox();
    // Recompute PM access after data load
    recomputePMAccess();
    // Cache to localStorage
    if (ENABLE_CAMSCANNER_API) await loadCamScannerDocs();
    saveLocal();
    // Load warehouse bins for location dropdown
    var _whBinsData = await sbFetch('warehouse_bins','GET');
    whBins = filterByOrg(_whBinsData||[]).sort(function(a,b){return (a.sort_order||0)-(b.sort_order||0);});

    // Handle Outlook OAuth callback after integrations are loaded
    try { await handleOAuthCallback(); } catch (e) { console.warn('Outlook OAuth callback error:', e); }
}

function save() {
    // This function now just calls saveLocal() as fallback cache
    saveLocal();
}

function saveLocal() {
    localStorage.setItem('v10_orgs', JSON.stringify(orgs));
    if (activeOrgId) localStorage.setItem('v10_active_org', String(activeOrgId));
    localStorage.setItem('v10_clients', JSON.stringify(clients));
    localStorage.setItem('v10_projects', JSON.stringify(projects));
    localStorage.setItem('v10_people', JSON.stringify(people));
    localStorage.setItem('v10_scans', JSON.stringify(scans));
    localStorage.setItem('v10_shipments', JSON.stringify(shipments));
    localStorage.setItem('v10_punchlist', JSON.stringify(punchlist));
    localStorage.setItem('v10_dispatches', JSON.stringify(dispatches));
    localStorage.setItem('v10_loadingSheets', JSON.stringify(loadingSheets));
    localStorage.setItem('v10_projectCompletions', JSON.stringify(projectCompletions));
    localStorage.setItem('v10_moveChecklists', JSON.stringify(moveChecklists));
    localStorage.setItem('v10_moveItems', JSON.stringify(moveItems));
    localStorage.setItem('v10_jobsiteReadiness', JSON.stringify(jobsiteReadiness));
    localStorage.setItem('v10_timeEntries', JSON.stringify(timeEntries));
    localStorage.setItem('v10_projectUpdates', JSON.stringify(projectUpdates));
    localStorage.setItem('v10_changeOrders', JSON.stringify(changeOrders));
    localStorage.setItem('v10_surveys', JSON.stringify(surveys));
    localStorage.setItem('v10_surveyRooms', JSON.stringify(surveyRooms));
    localStorage.setItem('v10_surveyItems', JSON.stringify(surveyItems));
    localStorage.setItem('v10_quotes', JSON.stringify(quotes));
    localStorage.setItem('v10_quoteItems', JSON.stringify(quoteItems));
    localStorage.setItem('v10_moveMilestones', JSON.stringify(moveMilestones));
    localStorage.setItem('v10_moveAccess', JSON.stringify(moveAccess));
    localStorage.setItem('v10_moveLabels', JSON.stringify(moveLabels));
    localStorage.setItem('v10_moveMaterials', JSON.stringify(moveMaterials));
}
function loadLocalFallback() {
    try {
        orgs = JSON.parse(localStorage.getItem('v10_orgs') || '[]');
        defaultOrgId = (orgs.find(o => o.slug === 'vector') || orgs[0] || {}).id || null;
        const storedOrg = localStorage.getItem('v10_active_org');
        activeOrgId = storedOrg && orgs.some(o => String(o.id) === String(storedOrg)) ? storedOrg : (defaultOrgId || (orgs[0] ? orgs[0].id : null));
        ensureFallbackOrgs();
        const lc = localStorage.getItem('v10_clients');
        if (!lc) { toast('Data unavailable. Check Supabase connection.'); return; }
        clients = applyDefaultOrg(JSON.parse(lc || '[]'));
        projects = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_projects') || '[]'));
        people = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_people') || '[]'));
        scans = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_scans') || '[]'));
        shipments = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_shipments') || '[]'));
        punchlist = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_punchlist') || '[]'));
        dispatches = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_dispatches') || '[]'));
        loadingSheets = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_loadingSheets') || '[]'));
        projectCompletions = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_projectCompletions') || '[]'));
        moveChecklists = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_moveChecklists') || '[]'));
        moveItems = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_moveItems') || '[]'));
        jobsiteReadiness = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_jobsiteReadiness') || '[]'));
        timeEntries = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_timeEntries') || '[]'));
        projectUpdates = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_projectUpdates') || '[]'));
        changeOrders = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_changeOrders') || '[]'));
        surveys = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_surveys') || '[]'));
        surveyRooms = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_surveyRooms') || '[]'));
        surveyItems = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_surveyItems') || '[]'));
        quotes = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_quotes') || '[]'));
        quoteItems = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_quoteItems') || '[]'));
        moveMilestones = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_moveMilestones') || '[]'));
        moveAccess = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_moveAccess') || '[]'));
        moveLabels = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_moveLabels') || '[]'));
        moveMaterials = applyDefaultOrg(JSON.parse(localStorage.getItem('v10_moveMaterials') || '[]'));
        toast('Loaded cached data (Supabase offline)');
        renderOrgSwitcher();
    } catch(e) {
        console.warn('Local fallback error:', e);
        toast('Data unavailable. Check Supabase connection.');
    }
}
function loadCamScanState() {
    try { camScanEdits = JSON.parse(localStorage.getItem('v10_camScanEdits') || '{}'); } catch(e) { camScanEdits = {}; }
    try { camScanProcessed = JSON.parse(localStorage.getItem('v10_camScanProcessed') || '{}'); } catch(e) { camScanProcessed = {}; }
}
function saveCamScanState() {
    localStorage.setItem('v10_camScanEdits', JSON.stringify(camScanEdits || {}));
    localStorage.setItem('v10_camScanProcessed', JSON.stringify(camScanProcessed || {}));
}
async function loadScanInbox() {
    const rows = await sbFetch('scan_inbox', 'GET', '?order=created_at.desc');
    scanInbox = applyDefaultOrg(rows || []);
}
function render() { renderOrgSwitcher(); renderDashboard(); renderScans(); renderShipments(); renderCamScanInbox(); renderCalendar(); renderCalendarConnections(); renderCalendarAvailability(); renderProjects(); renderPeople(); renderClients(); renderPunchlist(); renderDispatches(); renderLoadingSheet(); populateSelects(); updateBadges(); renderSettings(); renderAutomations(); updateMobileReceivingTabs(); updateMobileDispatchTabs(); updateMobileSettingsTabs(); }
function updateBadges() {
    const pendingInbox = getOrgScanInbox().filter(s => s.status === 'pending').length;
    const pendingLocal = getOrgScans().filter(s => s.status === 'pending').length;
    const p = USE_ONEDRIVE_SCAN_INBOX ? pendingInbox : (pendingInbox + pendingLocal);
    $('#nav-scans-badge').textContent = p;
    $('#nav-scans-badge').style.display = p > 0 ? 'inline' : 'none';
    const mobileBadge = document.getElementById('mobile-receiving-badge');
    if (mobileBadge) {
        mobileBadge.textContent = p;
        mobileBadge.style.display = isBmgWorkspace() ? 'none' : (p > 0 ? 'inline' : 'none');
    }
    document.querySelectorAll('.mobile-raw-badge').forEach(function(el) {
        el.textContent = p;
        el.style.display = p > 0 ? 'inline' : 'none';
    });
}

function renderScans() {
  var localScans = (getOrgScans() || []).map(function(sc) { sc.source = sc.source || "local"; return sc; });
  var inboxScans = (getOrgScanInbox() || []).map(function(sc) {
    return {
      id: sc.id,
      filename: sc.filename || sc.title || sc.name || sc.file_name || sc.email_subject || sc.po || "Scan",
      timestamp: sc.received_at || sc.created_at || sc.timestamp || new Date().toISOString(),
      status: sc.status || "pending",
      source: sc.source || "onedrive",
      pdf_url: sc.file_url || sc.pdf_url || ""
    };
  });
  var all = USE_ONEDRIVE_SCAN_INBOX ? inboxScans : localScans.concat(inboxScans).concat(camScans || []);
  all.sort(function(a, b) { return new Date(b.timestamp) - new Date(a.timestamp); });
  var el = document.getElementById("scans-table") || document.getElementById("tab-scans");
  if (!el) return;
  if (all.length === 0) {
    el.innerHTML = '<p style="color:#888;text-align:center;padding:40px">No scans yet. OneDrive files will appear here.</p>';
    return;
  }
  var html = '<div class="spreadsheet scans-grid">';
  html += '<div class="scans-header"><div></div><div>Name</div><div>Source</div><div>Date</div><div>Status</div><div>Actions</div></div>';
  all.forEach(function(sc) {
    var date = sc.timestamp ? new Date(sc.timestamp).toLocaleDateString() : "";
    var sourceLabel = sc.source === "camscanner" ? "CS" : (sc.source === "onedrive" ? "OneDrive" : "Local");
    var sourceColor = sc.source === "camscanner" ? "var(--green)" : (sc.source === "onedrive" ? "var(--purple)" : "var(--blue)");
    var statusText = sc.status || "pending";
    var statusClass = (statusText === "pending" || statusText === "processing") ? "pending" : "done";
    var pdfUrl = sc.pdf_url || sc.file_url || "";
    var actions = pdfUrl ? '<a href="' + pdfUrl + '" target="_blank" onclick="event.stopPropagation()" style="color:var(--blue)">View PDF</a>' : "";
    var safeId = String(sc.id).replace(/'/g, "\\'");
    var source = sc.source || "local";
    var clickSource = source === "onedrive" ? "inbox" : source;
    html += '<div class="scans-row" onclick="openRawScanForm(\'' + safeId + '\',\'' + clickSource + '\')">' +
      '<div><div class="scan-indicator ' + statusClass + '">' + (statusClass === "pending" ? "" : "") + '</div></div>' +
      '<div>' + escapeHtml(sc.filename || sc.po || "Untitled") + '</div>' +
      '<div><span style="background:' + sourceColor + ';color:#fff;padding:2px 8px;border-radius:10px;font-size:11px">' + sourceLabel + '</span></div>' +
      '<div>' + date + '</div>' +
      '<div>' + escapeHtml(statusText) + '</div>' +
      '<div>' + actions + '</div>' +
    '</div>';
  });
  html += "</div>";
  el.innerHTML = html;
}

function renderShipments() {
    const visibleShipments = getVisibleShipments();
    const groups = {}; visibleShipments.forEach(s => { if (!groups[s.po]) groups[s.po] = []; groups[s.po].push(s); });
    let h = '<div class="shipments-scroll">';
    Object.keys(groups).forEach(po => {
        const items = groups[po], isOpen = openPOs[po];
        const cl = items[0]?.clientId ? (getOrgClients().find(c=>c.id===items[0].clientId)||{}).company||'' : '';
        const pr = items[0]?.projectId ? (getOrgProjects().find(p=>p.id===items[0].projectId)||{}).name||'' : '';
        h += `<div class="po-group"><div class="po-header" onclick="togglePO('${po}')"><div><input type="checkbox" onclick="event.stopPropagation()"></div><div><span class="po-expand ${isOpen ? 'open' : ''}"></span><strong style="font-family:monospace">${po}</strong><span style="color:var(--muted);margin-left:8px">(${items.length})</span></div><div style="font-size:12px;color:var(--text2)">${cl}</div><div style="font-size:12px;color:var(--text2)">${pr}</div><div></div><div></div><div></div></div><div class="po-subitems ${isOpen ? 'open' : ''}"><div class="subitem-header"><div></div><div>Subitem</div><div>Manufacturer</div><div>Location</div><div>Status</div><div>Received</div><div>Inventory</div></div>${items.map(s => `<div class="subitem-row" onclick="openShipmentPanel(${s.id})"><div><input type="checkbox" onclick="event.stopPropagation()"></div><div style="font-family:monospace;font-size:13px">${s.subitem}${(function(){var cs=getCamScanForShipment(s);return cs&&cs.pdf_url?' <a href="'+cs.pdf_url+'" target="_blank" onclick="event.stopPropagation()" style="color:var(--blue);text-decoration:none">\u{1F4C4}</a>':'';})()}</div><div style="font-size:12px">${s.mfr || ''}</div><div style="font-size:12px;font-family:monospace">${s.location || '<span style=color:var(--muted)></span>'}</div><div><span class="status status-${s.status}">${s.status === 'received' ? 'Received' : 'Not Received'}</span></div><div style="font-size:12px">${s.date || ''}</div><div><span class="status status-${s.inventoryStatus === 'in-warehouse' ? 'received' : 'not-received'}" style="font-size:11px">${s.inventoryStatus === 'in-warehouse' ? 'In Warehouse' : s.inventoryStatus === 'dispatched' ? 'Dispatched' : 'Delivered'}</span></div></div>`).join('')}<div class="add-subitem" onclick="addSubitem('${po}')">+ Add subitem</div></div></div>`;
    });
    h += '<div class="add-subitem" style="padding-left:12px;border-top:1px solid var(--border)" onclick="addNewPO()">+ Add Item</div>';
    h += '</div>';
    $('#shipments-table').innerHTML = h;
}

function ensureCamEditDefaults(sc) {
    if (!camScanEdits[sc.id]) camScanEdits[sc.id] = {};
    const edit = camScanEdits[sc.id];
    if (!edit.po && sc.po) edit.po = sc.po;
    if (!edit.receivedDate && sc.timestamp) edit.receivedDate = sc.timestamp.split('T')[0];
    return edit;
}

function updateCamEdit(id, field, value) {
    const edit = camScanEdits[id] || {};
    edit[field] = value;
    camScanEdits[id] = edit;
    saveCamScanState();
}

function updateCamClient(id, value) {
    updateCamEdit(id, 'clientId', value ? parseInt(value) : '');
    updateCamEdit(id, 'projectId', '');
    updateCamEdit(id, 'pmEmails', []);
    renderCamScanInbox();
}

function updateCamProject(id, value) {
    updateCamEdit(id, 'projectId', value || '');
}

function updateCamPMs(id, el) {
    const emails = Array.from(el.selectedOptions || []).map(o => o.dataset.email).filter(Boolean);
    updateCamEdit(id, 'pmEmails', emails);
}

function dismissCamScan(id) {
    const inboxRow = (scanInbox || []).find(x => String(x.id) === String(id));
    if (inboxRow) {
        sbUpdate('scan_inbox', inboxRow.id, { status: 'ignored' });
        scanInbox = scanInbox.map(r => r.id === inboxRow.id ? { ...r, status: 'ignored' } : r);
    }
    camScanProcessed[id] = { ignored: true, processedAt: new Date().toISOString() };
    saveCamScanState();
    renderCamScanInbox();
}

async function processCamScan(id, opts) {
    const skipEmail = opts && opts.skipEmail;
    const inboxRow = (scanInbox || []).find(x => String(x.id) === String(id));
    const sc = inboxRow || (camScans || []).find(x => x.id === id);
    if (!sc) return;
    const edit = camScanEdits[id] || {};
    const po = (edit.po || '').trim();
    const clientId = edit.clientId ? parseInt(edit.clientId) : null;
    const projectId = edit.projectId && edit.projectId !== '_unknown' ? parseInt(edit.projectId) : null;
    if (!po) return toast('Enter PO #');
    if (!clientId) return toast('Select client');

    const shipmentData = {
        po: po.split('-')[0],
        subitem: po,
        client_id: clientId,
        project_id: projectId || null,
        mfr: edit.manufacturer || '',
        expected_date: null,
        received_date: edit.receivedDate || null,
        status: 'received',
        sortly: edit.location || '',
        inventory_status: 'in-warehouse'
    };

    const newShipmentId = await sbInsert('shipments', shipmentData);
    if (newShipmentId) {
        shipments.unshift(assignOrgId({
            id: newShipmentId,
            po: shipmentData.po,
            subitem: shipmentData.subitem,
            clientId: clientId,
            projectId: projectId || null,
            mfr: shipmentData.mfr,
            expectedDate: null,
            date: shipmentData.received_date,
            status: shipmentData.status,
            location: shipmentData.sortly,
            inventoryStatus: 'in-warehouse'
        }, 'shipments'));
    }

    const processedAt = new Date().toISOString();
    const shipmentId = newShipmentId || null;
    if (inboxRow && !skipEmail) {
        await sbUpdate('scan_inbox', inboxRow.id, { status: 'processing', processed_at: processedAt, shipment_id: shipmentId });
        scanInbox = scanInbox.map(r => r.id === inboxRow.id ? { ...r, status: 'processing', processed_at: processedAt, shipment_id: shipmentId } : r);
        renderScans();
        renderCamScanInbox();
        updateBadges();
    }
    camScanProcessed[id] = { processedAt, shipmentId };
    saveCamScanState();
    renderShipments();
    if (!skipEmail) {
        try {
            var details = {
                manufacturer: edit.manufacturer || '',
                cartons: edit.cartons || '',
                location: edit.location || '',
                receivedDate: edit.receivedDate || '',
                status: 'received',
                pdfUrl: (sc.file_url || sc.pdf_url || '')
            };
            await sendReceivingEmailMulti(clientId, edit.pmEmails || [], po, projectId || null, details);
        } catch(e) {}
    }
    if (inboxRow) {
        const finalStatus = skipEmail ? 'processed' : 'sent';
        await sbUpdate('scan_inbox', inboxRow.id, { status: finalStatus, processed_at: processedAt, shipment_id: shipmentId });
        scanInbox = scanInbox.map(r => r.id === inboxRow.id ? { ...r, status: finalStatus, processed_at: processedAt, shipment_id: shipmentId } : r);
    }
    renderScans();
    renderCamScanInbox();
    updateBadges();
    toast('CamScanner entry processed');
}

function renderCamScanInbox() {
    const el = document.getElementById('cam-inbox');
    if (!el) return;
    if (!SHOW_CAM_INBOX) { el.innerHTML = ''; return; }
    const useInbox = (getOrgScanInbox() || []).length > 0;
    const pending = useInbox
        ? (getOrgScanInbox() || []).filter(sc => !['processed','ignored','sent','processing'].includes(sc.status))
        : (camScans || []).filter(sc => !camScanProcessed[sc.id]);
    if (!pending.length) { el.innerHTML = ''; return; }

    let html = '<div class="cs-inbox">';
    html += '<div class="cs-inbox-header"><div>CamScanner Inbox</div><div style="font-size:12px;color:var(--muted)">' + pending.length + ' pending</div></div>';
    html += '<div class="cs-scroll"><table><thead><tr>';
    html += '<th>Document</th><th>PO #</th><th>Packing Slip</th><th>Client</th><th>Project</th><th>PMs</th><th>Manufacturer</th><th>Received</th><th>Cartons</th><th>Location</th><th>Actions</th>';
    html += '</tr></thead><tbody>';

    pending.forEach(function(sc) {
        const edit = ensureCamEditDefaults(sc);
        const clientId = edit.clientId || '';
        const projectId = edit.projectId || '';
        const visibleClients = pmAccess.enabled ? getOrgClients().filter(c => pmAccess.clientIds.includes(c.id)) : getOrgClients();
        const visibleProjects = getVisibleProjects();
        const clientsOpts = '<option value="">Select...</option>' + visibleClients.map(c => `<option value="${c.id}" ${clientId==c.id?'selected':''}>${escapeHtml(c.company)}</option>`).join('');
        const projList = clientId ? visibleProjects.filter(p => p.clientId == clientId) : visibleProjects;
        const projectOpts = '<option value="">Select...</option><option value="_unknown"' + (projectId==='_unknown'?' selected':'') + '> Unknown</option>' + projList.map(p => `<option value="${p.id}" ${projectId==p.id?'selected':''}>${escapeHtml(p.name)}</option>`).join('');
        const client = getOrgClients().find(c => c.id == clientId);
        const pms = client ? getClientPMs(client) : [];
        const pmEmails = Array.isArray(edit.pmEmails) ? edit.pmEmails : [];
        const pmOptions = pms.map(pm => `<option value="${pm.email||''}" data-email="${pm.email||''}" ${pmEmails.includes(pm.email)?'selected':''}>${pm.email ? (pm.name + '  ' + pm.email) : pm.name}</option>`).join('');
        const docName = sc.filename || sc.title || sc.email_subject || sc.po || 'Scan';
        const pdfUrl = sc.file_url || sc.pdf_url || '';
        const locOpts = buildLocationOptions(edit.location || '');

        html += '<tr>';
        html += '<td>' + escapeHtml(docName) + '</td>';
        html += `<td><input value="${edit.po || ''}" onchange="updateCamEdit('${sc.id}','po',this.value)"></td>`;
        html += `<td>${pdfUrl ? '<a href="'+pdfUrl+'" target="_blank" style="color:var(--blue)">View PDF</a>' : ''}</td>`;
        html += `<td><select onchange="updateCamClient('${sc.id}',this.value)">${clientsOpts}</select></td>`;
        html += `<td><select onchange="updateCamProject('${sc.id}',this.value)">${projectOpts}</select></td>`;
        html += `<td><select multiple size="2" onchange="updateCamPMs('${sc.id}',this)">${pmOptions}</select></td>`;
        html += `<td><input value="${edit.manufacturer || ''}" onchange="updateCamEdit('${sc.id}','manufacturer',this.value)"></td>`;
        html += `<td><input type="date" value="${edit.receivedDate || ''}" onchange="updateCamEdit('${sc.id}','receivedDate',this.value)"></td>`;
        html += `<td><input value="${edit.cartons || ''}" onchange="updateCamEdit('${sc.id}','cartons',this.value)"></td>`;
        html += `<td><select onchange="updateCamLocation('${sc.id}',this)">${locOpts}</select></td>`;
        html += `<td class="cs-actions"><button class="btn btn-primary" style="padding:4px 10px;font-size:11px" onclick="processCamScan('${sc.id}')">Process</button> <button class="btn btn-outline" style="padding:4px 10px;font-size:11px" onclick="dismissCamScan('${sc.id}')">Dismiss</button></td>`;
        html += '</tr>';
    });

    html += '</tbody></table></div></div>';
    el.innerHTML = html;
}

function togglePO(po) { openPOs[po] = !openPOs[po]; renderShipments(); }
async function addSubitem(po) {
    const n = prompt('Subitem name:');
    if (!n) return;
    const e = shipments.find(s => s.po === po);

    const data = {
        po,
        subitem: n,
        client_id: e?.clientId,
        project_id: e?.projectId,
        mfr: '',
        expected_date: null,
        received_date: null,
        status: 'not-received',
        sortly: '',
        inventory_status: 'in-warehouse'
    };

    const newId = await sbInsert('shipments', data);
    if (newId) {
        shipments.push({
            id: newId,
            po,
            subitem: n,
            clientId: e?.clientId,
            projectId: e?.projectId,
            mfr: '',
            expectedDate: null,
            date: null,
            status: 'not-received',
            location: '',
            inventoryStatus: 'in-warehouse'
        });
    }
    openPOs[po] = true;
    saveLocal();
    render();
}
async function addNewPO() {
    const po = prompt('PO #:');
    if (!po) return;

    const data = {
        po: po.split('-')[0],
        subitem: po,
        client_id: null,
        project_id: null,
        mfr: '',
        expected_date: null,
        received_date: null,
        status: 'not-received',
        sortly: '',
        inventory_status: 'in-warehouse'
    };

    const newId = await sbInsert('shipments', data);
    if (newId) {
        shipments.push({
            id: newId,
            po: po.split('-')[0],
            subitem: po,
            clientId: null,
            projectId: null,
            mfr: '',
            expectedDate: null,
            date: null,
            status: 'not-received',
            location: '',
            inventoryStatus: 'in-warehouse'
        });
    }
    openPOs[po.split('-')[0]] = true;
    saveLocal();
    render();
}


// Shipment List Parser & Import
let parsedShipmentOrders = [];
function openShipmentListForProject(pid) {
    const p = getOrgProjects().find(x=>x.id===pid);
    if(!p) return;
    openModal('shipment-list');
    if(p.clientId) { $('#sl-client').value = p.clientId; onSLClientChange(); }
    $('#sl-project').value = pid;
}

function onSLClientChange() {
    const cid = +$('#sl-client').value;
    const opts = '<option value="">Select...</option>' + getOrgProjects().filter(p => !cid || p.clientId === cid).map(p => '<option value="'+p.id+'">'+p.name+'</option>').join('');
    $('#sl-project').innerHTML = opts;
}

function parseShipmentEmail() {
    const text = $('#sl-email').value;
    if (!text.trim()) return toast('Paste the shipment email first');
    parsedShipmentOrders = [];
    const orderBlocks = text.split(/Order Number:\s*/i).filter(b => b.trim());
    orderBlocks.forEach(block => {
        const order = {};
        const onMatch = block.match(/^(\S+)/);
        order.orderNumber = onMatch ? onMatch[1].trim() : '';
        const vcMatch = block.match(/Vendor Code:\s*(\w+),?\s*\(([^)]+)\)/i);
        order.vendorCode = vcMatch ? vcMatch[1].trim() : '';
        order.vendorName = vcMatch ? vcMatch[2].trim() : '';
        const sfMatch = block.match(/shipping from\s+([^,\n]+)/i);
        order.shipFrom = sfMatch ? sfMatch[1].trim().replace(/\s+/g,' ') : '';
        const dateMatch = block.match(/arrive between\s+(\d{1,2}\/\d{1,2}\/\d{2,4})\s*&\s*(\d{1,2}\/\d{1,2}\/\d{2,4})/i);
        order.arriveStart = dateMatch ? dateMatch[1] : '';
        order.arriveEnd = dateMatch ? dateMatch[2] : '';
        const ccMatch = block.match(/Carton Count:\s*(\d+)/i);
        order.cartons = ccMatch ? parseInt(ccMatch[1]) : 0;
        const wtMatch = block.match(/Total Approximate Weight:\s*([\d,]+)/i);
        order.weight = wtMatch ? wtMatch[1] : '';
        order.items = [];
        const itemLines = block.split('\n');
        let currentItem = null;
        for (let i = 0; i < itemLines.length; i++) {
            const line = itemLines[i].trim();
            const itemMatch = line.match(/^(\w+)\s+(.+?)\s+(\d+)\s+\$[\d.]+/);
            if (itemMatch) {
                currentItem = { itemNum: itemMatch[1], description: itemMatch[2].trim(), qty: parseInt(itemMatch[3]) };
                order.items.push(currentItem);
            }
            const altMatch = line.match(/^(\w+)\s+(.+?)\s+(\d+)\s*$/);
            if (altMatch && !itemMatch && altMatch[2].length > 5) {
                currentItem = { itemNum: altMatch[1], description: altMatch[2].trim(), qty: parseInt(altMatch[3]) };
                order.items.push(currentItem);
            }
            const skuMatch = line.match(/SKU Descr:\s*(.+)/i);
            if (skuMatch && currentItem) {
                currentItem.skuDesc = skuMatch[1].trim();
            }
        }
        if (order.orderNumber) parsedShipmentOrders.push(order);
    });
    if (parsedShipmentOrders.length === 0) {
        toast('No orders found. Check the email format.');
        return;
    }
    $('#sl-count').textContent = parsedShipmentOrders.length;
    let ph = '';
    parsedShipmentOrders.forEach((o, idx) => {
        const dateStr = o.arriveStart ? o.arriveStart+' - '+o.arriveEnd : 'Unknown';
        ph += '<div style="padding:12px;background:var(--gray-lt);border-radius:8px;margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div><strong style="font-family:monospace">'+o.orderNumber+'</strong><span style="color:var(--muted);margin-left:8px;font-size:12px">'+o.vendorCode+'</span></div><label style="font-size:12px;cursor:pointer"><input type="checkbox" checked id="sl-check-'+idx+'" style="margin-right:4px">Include</label></div><div style="font-size:12px;color:var(--text2);margin-bottom:4px">'+(o.vendorName||'Unknown')+' - '+(o.shipFrom||'Unknown')+'</div><div style="font-size:12px;color:var(--text2);margin-bottom:4px">'+o.cartons+' cartons - '+(o.weight||'?')+' lbs - '+dateStr+'</div><div style="font-size:12px;color:var(--muted)">'+o.items.length+' item(s): '+o.items.map(it => it.description.substring(0,40)+' x'+it.qty).join(', ')+'</div></div>';
    });
    $('#sl-items').innerHTML = ph;
    $('#sl-preview').style.display = 'block';
    $('#sl-submit-btn').disabled = false;
}

async function submitShipmentList() {
    const clientId = +$('#sl-client').value;
    const projectId = +$('#sl-project').value;
    const customerPO = $('#sl-po').value.trim();
    if (!clientId) return toast('Select a client');
    if (!projectId) return toast('Select a project');
    if (!customerPO) return toast('Enter the Customer PO #');
    if (!parsedShipmentOrders.length) return toast('Parse the email first');
    $('#sl-submit-btn').disabled = true;
    $('#sl-submit-btn').textContent = 'Importing...';
    let added = 0, updated = 0;
    for (let i = 0; i < parsedShipmentOrders.length; i++) {
        const chk = document.getElementById('sl-check-' + i);
        if (chk && !chk.checked) continue;
        const o = parsedShipmentOrders[i];
        let expectedDate = null;
        if (o.arriveEnd) {
            const parts = o.arriveEnd.split('/');
            if (parts.length === 3) {
                let yr = parts[2]; if (yr.length === 2) yr = '20' + yr;
                expectedDate = yr+'-'+parts[0].padStart(2,'0')+'-'+parts[1].padStart(2,'0');
            }
        }
        const shortPO = customerPO.length > 6 ? customerPO.substring(0,6) : customerPO;
        const subitemBase = shortPO+'-'+(o.vendorCode || o.orderNumber.substring(0,6));
        const existing = shipments.find(s => s.po === customerPO && s.subitem && s.subitem.includes(o.vendorCode));
        if (existing) {
            existing.expectedDate = expectedDate || existing.expectedDate;
            existing.mfr = o.vendorName || existing.mfr;
            existing.clientId = clientId;
            existing.projectId = projectId;
            await sbUpdate('shipments', existing.id, {
                expected_date: expectedDate,
                mfr: o.vendorName || existing.mfr,
                client_id: clientId,
                project_id: projectId
            });
            updated++;
        } else {
            const desc = o.items.map(it => it.description+' x'+it.qty).join('; ');
            const itemDesc = desc.substring(0, 100) || o.vendorName;
            const subitem = subitemBase + (o.items.length === 1 && o.items[0].description ? ' ' + o.items[0].description.substring(0,30) : '');
            const data = {
                po: customerPO,
                subitem: subitem,
                client_id: clientId,
                project_id: projectId,
                mfr: o.vendorName || o.vendorCode,
                expected_date: expectedDate,
                received_date: null,
                status: 'not-received',
                sortly: '',
                inventory_status: 'in-warehouse'
            };
            const newId = await sbInsert('shipments', data);
            if (newId) {
                shipments.push({
                    id: newId,
                    po: customerPO,
                    subitem: subitem,
                    clientId,
                    projectId,
                    mfr: o.vendorName || o.vendorCode,
                    expectedDate,
                    date: null,
                    status: 'not-received',
                    location: '',
                    inventoryStatus: 'in-warehouse'
                });
                added++;
            }
        }
    }
    openPOs[customerPO] = true;
    saveLocal();
    render();
    closeModal('shipment-list');
    toast('Imported '+added+' new, updated '+updated+' existing shipments');
    parsedShipmentOrders = [];
    $('#sl-email').value = '';
    $('#sl-preview').style.display = 'none';
    $('#sl-submit-btn').textContent = 'Import Shipments';
    $('#sl-submit-btn').disabled = true;
}


function openCameraUpload() {
    const input = $('#camera-input');
    input.value = '';
    input.click();
}

async function handleCameraUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const timestamp = new Date();
    const filename = file.name || `Camera_${timestamp.toISOString().slice(5,16).replace('T','_').replace(/:/g,'-')}.${file.type.includes('pdf') ? 'pdf' : 'jpg'}`;

    let thumbnail = null;
    if (file.type.startsWith('image/')) {
        try {
            const compressed = await compressImageFile(file);
            thumbnail = compressed.dataUrl;
        } catch (e) {
            console.warn('Image compress failed, using original', e);
            thumbnail = await readFileAsDataURL(file);
        }
    }

    pendingScan = {
        id: Date.now(),
        filename: filename,
        timestamp: timestamp.toISOString(),
        status: 'pending',
        thumbnail: thumbnail
    };

    $('#alert-file').textContent = filename;
    $('#scan-alert').classList.add('show');
}

function openScanForm(id) {
    openRawScanForm(id, 'local');
}

function openRawScanForm(id, source) {
    var src = source || 'local';
    var isCam = src !== 'local';
    currentScanSource = isCam ? 'cam' : 'local';
    currentCamScanId = null;
    currentScan = null;

    var sc = null;
    if (src === 'inbox' || src === 'onedrive') {
        sc = (scanInbox || []).find(function(x){ return String(x.id) === String(id); });
    } else if (src === 'camscanner') {
        sc = (camScans || []).find(function(x){ return String(x.id) === String(id); });
    } else {
        sc = (scans || []).find(function(x){ return String(x.id) === String(id); });
        currentScan = sc || null;
    }
    if (!sc) return;
    if (isCam) currentCamScanId = sc.id;

    var pdfUrl = sc.pdf_url || sc.file_url || '';
    var title = sc.filename || sc.title || sc.email_subject || sc.po || 'Scan';
    $('#scan-filename').innerHTML = pdfUrl ? '<a href="'+pdfUrl+'" target="_blank" style="color:var(--accent)">' + escapeHtml(title) + ' </a>' : escapeHtml(title);
    var ts = sc.timestamp || sc.received_at || sc.created_at || new Date().toISOString();
    $('#scan-time').textContent = new Date(ts).toLocaleString();

    const thumbnailContainer = $('#scan-thumbnail-container');
    if (!isCam && currentScan && currentScan.thumbnail) {
        thumbnailContainer.innerHTML = `<img src="${currentScan.thumbnail}" class="scan-thumbnail" alt="Scan thumbnail">`;
    } else {
        thumbnailContainer.innerHTML = '';
    }

    const visibleClients = pmAccess.enabled ? getOrgClients().filter(c => pmAccess.clientIds.includes(c.id)) : getOrgClients();
    $('#f-client').innerHTML = '<option value="">Select...</option>' + visibleClients.map(c => `<option value="${c.id}">${escapeHtml(c.company)}</option>`).join('');

    var edit = isCam ? ensureCamEditDefaults(sc) : (currentScan || {});
    if (isCam && !edit.receivedDate && (sc.received_at || sc.created_at)) {
        edit.receivedDate = (sc.received_at || sc.created_at).split('T')[0];
    }

    $('#f-po').value = edit.po || '';
    $('#f-client').value = edit.clientId || '';
    onClientChange();
    var projId = edit.projectId || '';
    var projInput = $('#f-project-search');
    var projHidden = $('#f-project-id');
    if (projHidden) projHidden.value = projId || '';
    if (projInput) {
        if (projId === '_unknown') {
            projInput.value = 'Unknown';
        } else if (projId) {
            var pObj = getOrgProjects().find(function(p){ return p.id == projId; });
            projInput.value = pObj ? pObj.name : '';
        } else {
            projInput.value = '';
        }
    }
    renderPMCheckboxes(edit.clientId ? parseInt(edit.clientId) : null, edit.pmEmails || []);
    $('#f-mfr').value = edit.manufacturer || '';
    $('#f-cartons').value = edit.cartons || '';
    $('#f-date').value = edit.receivedDate || new Date().toISOString().split('T')[0];
    $('#f-status').value = edit.status || 'received';

    var locSel = $('#f-location');
    if (locSel) {
        locSel.innerHTML = buildLocationOptions(edit.location || '');
        if (edit.location) locSel.value = edit.location;
    }
    const sendEl = document.getElementById('f-send-email');
    if (sendEl) sendEl.checked = true;

    openModal('scan');
}

function renderPMCheckboxes(clientId, selectedEmails) {
    var wrap = document.getElementById('f-pm-list');
    if (!wrap) return;
    if (!clientId) {
        wrap.innerHTML = '<div style="color:var(--text2);font-size:12px">Select a client to see PMs</div>';
        return;
    }
    var client = getOrgClients().find(function(c) { return c.id === clientId; });
    var pms = client ? getClientPMs(client) : [];
    if (!pms.length) {
        wrap.innerHTML = '<div style="color:var(--text2);font-size:12px">No PMs for this client</div>';
        return;
    }
    wrap.innerHTML = pms.map(function(pm, idx) {
        var email = pm.email || '';
        var name = pm.name || email || ('PM ' + (idx + 1));
        var checked = Array.isArray(selectedEmails) && email && selectedEmails.includes(email);
        return '<label class="pm-check">' +
            '<input type="checkbox" data-email="' + escapeHtml(email) + '"' + (checked ? ' checked' : '') + '>' +
            '<span>' + escapeHtml(name) + (email ? '  ' + escapeHtml(email) : '') + '</span>' +
            '</label>';
    }).join('');
}

function onClientChange() {
    const c = +$('#f-client').value;
    const p = c ? getOrgProjects().filter(x => x.clientId === c) : getOrgProjects();
    var projInput = $('#f-project-search');
    var projHidden = $('#f-project-id');
    if (projInput) projInput.value = '';
    if (projHidden) projHidden.value = '';
    renderPMCheckboxes(c || null, []);
}

async function submitScan() {
    const po = $('#f-po').value.trim(), cid = +$('#f-client').value, pid = $('#f-project-id').value;
    const pmEmails = Array.from(document.querySelectorAll('#f-pm-list input[type=checkbox]:checked')).map(el => el.dataset.email).filter(Boolean);
    const sendEmail = $('#f-send-email') ? $('#f-send-email').checked : true;
    if (!po) return toast('Enter PO #');
    if (!cid) return toast('Select client');
    if (!pid) return toast('Select project');

    if (currentScanSource === 'cam' && currentCamScanId) {
        updateCamEdit(currentCamScanId, 'po', po);
        updateCamEdit(currentCamScanId, 'clientId', cid);
        updateCamEdit(currentCamScanId, 'projectId', pid);
        updateCamEdit(currentCamScanId, 'pmEmails', pmEmails);
        updateCamEdit(currentCamScanId, 'manufacturer', $('#f-mfr').value.trim());
        updateCamEdit(currentCamScanId, 'cartons', $('#f-cartons').value.trim());
        updateCamEdit(currentCamScanId, 'location', $('#f-location').value || '');
        updateCamEdit(currentCamScanId, 'receivedDate', $('#f-date').value || null);
        updateCamEdit(currentCamScanId, 'status', $('#f-status').value);
        closeModal('scan');
        await processCamScan(currentCamScanId, { skipEmail: !sendEmail });
        return;
    }
    if (!currentScan) return;

    // Create shipment in Supabase
    const shipmentData = {
        po: po.split('-')[0],
        subitem: po,
        client_id: cid,
        project_id: pid === '_unknown' ? null : +pid,
        mfr: $('#f-mfr').value.trim(),
        expected_date: null,
        received_date: $('#f-date').value || null,
        status: $('#f-status').value,
        sortly: ($('#f-location').value || '').trim() || '',
        inventory_status: 'in-warehouse'
    };

    const newShipmentId = await sbInsert('shipments', shipmentData);
    if (newShipmentId) {
        shipments.unshift(assignOrgId({
            id: newShipmentId,
            po: po.split('-')[0],
            subitem: po,
            clientId: cid,
            projectId: pid === '_unknown' ? '_unknown' : +pid,
            mfr: shipmentData.mfr,
            expectedDate: null,
            date: shipmentData.received_date,
            status: shipmentData.status,
            location: shipmentData.sortly,
            inventoryStatus: 'in-warehouse'
        }, 'shipments'));
    }

    // Update scan status in Supabase
    await sbUpdate('scans', currentScan.id, { status: 'done', po: po });
    currentScan.status = 'done';
    currentScan.po = po;
    openPOs[po.split('-')[0]] = true;
    saveLocal();
    render();
    closeModal('scan');
    toast('Shipment added!');
    if (sendEmail) {
        try {
            var details = {
                manufacturer: $('#f-mfr').value.trim(),
                cartons: $('#f-cartons').value.trim(),
                location: $('#f-location').value || '',
                receivedDate: $('#f-date').value || '',
                status: $('#f-status').value,
                pdfUrl: (currentScan && currentScan.pdf_url) ? currentScan.pdf_url : ''
            };
            sendReceivingEmailMulti(cid, pmEmails, po, pid === '_unknown' ? null : +pid, details);
        } catch(e) {}
    }
    switchTab('shipments');
}

function renderCalendar() {
    const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
    $('#calendar-month').textContent = currentMonth.toLocaleDateString('en-US', {month:'long', year:'numeric'});
    const first = new Date(y, m, 1), last = new Date(y, m + 1, 0), start = first.getDay(), total = last.getDate(), today = new Date().toISOString().split('T')[0];
    let h = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => `<div class="calendar-day-header">${d}</div>`).join('');
    const prev = new Date(y, m, 0);
    for (let i = start - 1; i >= 0; i--) h += `<div class="calendar-day other"><div class="day-num">${prev.getDate() - i}</div></div>`;
    const visibleProjects = getVisibleProjects();
    for (let d = 1; d <= total; d++) {
        const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dp = visibleProjects.filter(p => p.date === ds);
        const df = punchlist.filter(p => p.followupDate === ds && p.status !== 'resolved');
        const projHtml = dp.map(p => `<div class="calendar-event ${p.team?.length ? '' : 'no-team'}" onclick="openPanel(${p.id})">${escapeHtml(p.name)}</div>`).join('');
        const followHtml = df.map(f => `<div class="calendar-event followup" onclick="editPunchlistItem(${f.id})">Follow-up: ${escapeHtml(f.description || 'Item')}</div>`).join('');
        h += `<div class="calendar-day ${ds === today ? 'today' : ''}"><div class="day-num">${d}</div>${projHtml}${followHtml}</div>`;
    }
    const rem = 42 - (start + total);
    for (let d = 1; d <= rem; d++) h += `<div class="calendar-day other"><div class="day-num">${d}</div></div>`;
    $('#calendar-grid').innerHTML = h;
}

function setCalendarTab(tab) {
    calendarTab = tab || 'calendar';
    document.querySelectorAll('.calendar-tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === calendarTab);
    });
    const calEl = document.getElementById('calendar-tab-calendar');
    const availEl = document.getElementById('calendar-tab-availability');
    const connEl = document.getElementById('calendar-tab-connections');
    if (calEl) calEl.style.display = calendarTab === 'calendar' ? 'block' : 'none';
    if (availEl) availEl.style.display = calendarTab === 'availability' ? 'block' : 'none';
    if (connEl) connEl.style.display = calendarTab === 'connections' ? 'block' : 'none';
    const syncBtn = document.getElementById('calendar-sync-btn');
    if (syncBtn) syncBtn.style.display = calendarTab === 'calendar' ? 'inline-flex' : 'none';
    if (calendarTab === 'connections') renderCalendarConnections();
    if (calendarTab === 'availability') renderCalendarAvailability();
}

function renderCalendarConnections() {
    const el = document.getElementById('calendar-connections');
    if (!el) return;
    const outlookInt = getOutlookIntegration();
    const isConnected = outlookInt && outlookInt.status === 'connected';
    const cfg = getOutlookConfig();
    const connectedEmail = (cfg.connectedEmail || '').trim();
    const linked = cfg.linkedCalendar || 'Outlook Calendar';
    const conflicts = (cfg.conflictCalendars || []).join(', ');
    const staffOptions = getOrgPeople().map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');

    el.innerHTML = `
        <div class="form-group" style="max-width:320px">
            <label class="form-label">My Staff</label>
            <select class="form-select">${staffOptions || '<option>No staff yet</option>'}</select>
        </div>
        <div class="header-tabs compact" style="margin:8px 0 16px 0">
            <div class="header-tab active">Calendars</div>
            <div class="header-tab" style="opacity:0.6">Video Conferencing</div>
            <div class="header-tab" style="opacity:0.6">Google Organic Booking</div>
        </div>
        <div class="settings-card">
            <div class="settings-card-header" style="justify-content:space-between;align-items:center">
                <h3>Connected Calendars</h3>
                <button class="btn btn-primary" onclick="initiateOutlookAuth()">+ Add New</button>
            </div>
            <div class="integration-card">
                <div class="integration-icon" style="background:#0078d4;color:#fff"></div>
                <div class="integration-info">
                    <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
                        <strong>Outlook Calendar</strong>
                        <span class="badge ${isConnected ? 'badge-connected' : 'badge-disconnected'}">${isConnected ? 'Connected' : 'Not Connected'}</span>
                    </div>
                    <div style="font-size:12px;color:var(--text2)">${connectedEmail ? escapeHtml(connectedEmail) : 'No account connected'}</div>
                    <div style="display:flex;gap:8px;margin-top:10px">
                        ${isConnected ? '<button class="btn btn-outline" onclick="syncOutlookCalendar()">Sync Now</button><button class="btn btn-outline" style="color:var(--red);border-color:var(--red)" onclick="disconnectOutlook()">Disconnect</button>' : '<button class="btn btn-outline" onclick="initiateOutlookAuth()">Connect Outlook</button>'}
                    </div>
                </div>
            </div>
        </div>
        <div class="settings-card">
            <div class="settings-card-header"><h3>Calendar Configuration</h3></div>
            <div class="form-group">
                <label class="form-label">Linked Calendar</label>
                <input type="text" class="form-input" id="cal-linked" value="${escapeHtml(linked)}" placeholder="Outlook Calendar">
            </div>
            <div class="form-group">
                <label class="form-label">Conflict Calendars (comma-separated)</label>
                <input type="text" class="form-input" id="cal-conflicts" value="${escapeHtml(conflicts)}" placeholder="Outlook Calendar, Team Calendar">
            </div>
            <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);margin-bottom:10px">
                <input type="checkbox" id="cal-private-mode" ${cfg.privateMode ? 'checked' : ''}> Private mode for synced events
            </label>
            <div style="display:flex;justify-content:flex-end">
                <button class="btn btn-outline" onclick="saveCalendarConnections()">Save</button>
            </div>
        </div>
    `;
}

async function saveCalendarConnections() {
    const linked = (document.getElementById('cal-linked')?.value || '').trim() || 'Outlook Calendar';
    const conflicts = (document.getElementById('cal-conflicts')?.value || '').split(',').map(s => s.trim()).filter(Boolean);
    const privateMode = !!document.getElementById('cal-private-mode')?.checked;
    await saveOutlookConfig({ linkedCalendar: linked, conflictCalendars: conflicts, privateMode });
    toast('Calendar settings saved');
    renderCalendarConnections();
}

function getAvailabilityStorageKey() {
    return 'v10_availability_schedules_' + (getActiveOrgId() || 'default');
}

function defaultAvailability() {
    return {
        timezone: 'America/Los_Angeles',
        days: {
            sun: [],
            mon: [{ start: '08:00', end: '17:00' }],
            tue: [{ start: '08:00', end: '17:00' }],
            wed: [{ start: '08:00', end: '17:00' }],
            thu: [{ start: '08:00', end: '17:00' }],
            fri: [{ start: '08:00', end: '17:00' }],
            sat: []
        },
        dateOverrides: []
    };
}

function loadAvailabilitySchedules() {
    if (availabilitySchedules && availabilitySchedules.length) return;
    let stored = [];
    try { stored = JSON.parse(localStorage.getItem(getAvailabilityStorageKey()) || '[]'); } catch(e) { stored = []; }
    if (stored && stored.length) {
        availabilitySchedules = stored;
        activeAvailabilityScheduleId = stored[0].id;
    } else {
        const def = { id: 'default', name: 'Default', data: defaultAvailability() };
        availabilitySchedules = [def];
        activeAvailabilityScheduleId = def.id;
        saveAvailabilitySchedules();
    }
}

function saveAvailabilitySchedules() {
    localStorage.setItem(getAvailabilityStorageKey(), JSON.stringify(availabilitySchedules || []));
}

function getActiveAvailabilitySchedule() {
    loadAvailabilitySchedules();
    return availabilitySchedules.find(s => s.id === activeAvailabilityScheduleId) || availabilitySchedules[0];
}

function setActiveAvailabilitySchedule(id) {
    activeAvailabilityScheduleId = id;
    renderCalendarAvailability();
}

function createAvailabilitySchedule() {
    const name = prompt('Schedule name');
    if (!name) return;
    const schedule = { id: 'sched-' + Date.now(), name, data: defaultAvailability() };
    availabilitySchedules.push(schedule);
    activeAvailabilityScheduleId = schedule.id;
    saveAvailabilitySchedules();
    renderCalendarAvailability();
}

function updateAvailabilityTimezone(val) {
    const sched = getActiveAvailabilitySchedule();
    if (!sched) return;
    sched.data.timezone = val;
    saveAvailabilitySchedules();
}

function addAvailabilitySlot(day) {
    const sched = getActiveAvailabilitySchedule();
    if (!sched) return;
    if (!sched.data.days[day]) sched.data.days[day] = [];
    sched.data.days[day].push({ start: '08:00', end: '17:00' });
    saveAvailabilitySchedules();
    renderCalendarAvailability();
}

function updateAvailabilitySlot(day, idx, field, val) {
    const sched = getActiveAvailabilitySchedule();
    if (!sched) return;
    if (!sched.data.days[day] || !sched.data.days[day][idx]) return;
    sched.data.days[day][idx][field] = val;
    saveAvailabilitySchedules();
}

function removeAvailabilitySlot(day, idx) {
    const sched = getActiveAvailabilitySchedule();
    if (!sched) return;
    if (!sched.data.days[day]) return;
    sched.data.days[day].splice(idx, 1);
    saveAvailabilitySchedules();
    renderCalendarAvailability();
}

function addDateOverride() {
    const sched = getActiveAvailabilitySchedule();
    if (!sched) return;
    const date = document.getElementById('avail-date')?.value;
    if (!date) return toast('Select a date');
    const start = document.getElementById('avail-date-start')?.value || '08:00';
    const end = document.getElementById('avail-date-end')?.value || '17:00';
    sched.data.dateOverrides.push({ date, start, end });
    saveAvailabilitySchedules();
    renderCalendarAvailability();
}

function removeDateOverride(idx) {
    const sched = getActiveAvailabilitySchedule();
    if (!sched) return;
    sched.data.dateOverrides.splice(idx, 1);
    saveAvailabilitySchedules();
    renderCalendarAvailability();
}

function renderCalendarAvailability() {
    const el = document.getElementById('calendar-availability');
    if (!el) return;
    loadAvailabilitySchedules();
    const sched = getActiveAvailabilitySchedule();
    const days = [
        { key: 'sun', label: 'Sunday' },
        { key: 'mon', label: 'Monday' },
        { key: 'tue', label: 'Tuesday' },
        { key: 'wed', label: 'Wednesday' },
        { key: 'thu', label: 'Thursday' },
        { key: 'fri', label: 'Friday' },
        { key: 'sat', label: 'Saturday' }
    ];
    const tzOptions = ['America/Los_Angeles','America/Denver','America/Chicago','America/New_York'].map(t => `<option value="${t}" ${sched.data.timezone===t?'selected':''}>${t}</option>`).join('');
    const staffOptions = getOrgPeople().map(p => `<option value="${p.id}" ${availabilityStaffId===p.id?'selected':''}>${escapeHtml(p.name)}</option>`).join('');
    const scheduleOptions = availabilitySchedules.map(s => `<option value="${s.id}" ${s.id===activeAvailabilityScheduleId?'selected':''}>${escapeHtml(s.name)}</option>`).join('');
    let left = days.map(d => {
        const slots = sched.data.days[d.key] || [];
        const slotsHtml = slots.length ? slots.map((s, idx) => `
            <div class="availability-time">
                <input type="time" value="${s.start}" onchange="updateAvailabilitySlot('${d.key}',${idx},'start',this.value)">
                <span class="availability-muted">to</span>
                <input type="time" value="${s.end}" onchange="updateAvailabilitySlot('${d.key}',${idx},'end',this.value)">
                <button class="btn btn-outline" onclick="removeAvailabilitySlot('${d.key}',${idx})"></button>
            </div>`).join('') : '<div class="availability-muted">Unavailable</div>';
        return `
            <div class="availability-row">
                <div class="availability-day">${d.label}</div>
                <div class="availability-times">${slotsHtml}</div>
                <div class="availability-actions">
                    <button class="btn btn-outline" onclick="addAvailabilitySlot('${d.key}')">+</button>
                </div>
            </div>`;
    }).join('');

    const overrides = sched.data.dateOverrides || [];
    const rightList = overrides.length ? overrides.map((o, idx) => `
        <div class="availability-date-row">
            <div><strong>${o.date}</strong></div>
            <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
                <div class="availability-muted">${o.start} - ${o.end}</div>
                <button class="btn btn-outline" onclick="removeDateOverride(${idx})">Remove</button>
            </div>
        </div>`).join('') : '<div class="availability-muted">No date specific time added.</div>';

    el.innerHTML = `
        <div class="availability-card" style="margin-bottom:16px">
            <div class="availability-header">
                <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
                    <div class="form-group" style="margin-bottom:0;min-width:200px">
                        <label class="form-label">My Staff</label>
                        <select class="form-select" onchange="availabilityStaffId=this.value">${staffOptions || '<option>No staff</option>'}</select>
                    </div>
                    <div class="form-group" style="margin-bottom:0;min-width:200px">
                        <label class="form-label">Schedule</label>
                        <select class="form-select" onchange="setActiveAvailabilitySchedule(this.value)">${scheduleOptions}</select>
                    </div>
                </div>
                <div style="display:flex;gap:8px">
                    <button class="btn btn-outline" onclick="createAvailabilitySchedule()">+ Create Schedule</button>
                    <button class="btn btn-primary" onclick="saveAvailabilitySchedules();toast('Availability saved')">Save Changes</button>
                </div>
            </div>
            <div class="form-group" style="max-width:220px">
                <label class="form-label">Timezone</label>
                <select class="form-select" onchange="updateAvailabilityTimezone(this.value)">${tzOptions}</select>
            </div>
            <div class="availability-layout">
                <div class="availability-card">
                    <div class="availability-header">
                        <div style="font-weight:600">Weekly Working Hours</div>
                    </div>
                    ${left}
                </div>
                <div class="availability-right">
                    <div class="availability-card">
                        <div class="availability-header">
                            <div style="font-weight:600">Date Specific Hours</div>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
                            <input type="date" class="form-input" id="avail-date">
                            <input type="time" class="form-input" id="avail-date-start" value="08:00">
                            <input type="time" class="form-input" id="avail-date-end" value="17:00">
                            <button class="btn btn-outline" onclick="addDateOverride()">+ Add</button>
                        </div>
                        ${rightList}
                    </div>
                </div>
            </div>
        </div>
    `;
}
function changeMonth(d) { currentMonth.setMonth(currentMonth.getMonth() + d); renderCalendar(); }
function goToToday() { currentMonth = new Date(); renderCalendar(); }

function renderPunchlist() {
    // Punchlist now renders inside the project panel via openPanel()
    // This function is kept for compatibility with render() calls
}

function setPunchlistFilter(type, value) {
    if (type === 'project') punchlistFilter.project = value;
    if (type === 'type') punchlistFilter.type = punchlistFilter.type === value ? null : value;
    if (type === 'status') punchlistFilter.status = punchlistFilter.status === value ? null : value;
    renderPunchlist();
}

async function handlePunchlistPhotos(event) {
    const files = Array.from(event.target.files || []);
    pendingPhotoUploads = [];
    const container = $('#pi-photo-previews');
    container.innerHTML = '';

    for (const file of files) {
        try {
            const compressed = await compressImageFile(file);
            pendingPhotoUploads.push(compressed.dataUrl);
            const preview = document.createElement('div');
            preview.className = 'photo-preview';
            preview.innerHTML = `<img src="${compressed.dataUrl}" alt="preview">`;
            container.appendChild(preview);
        } catch (e) {
            console.warn('Photo compress failed, skipping', e);
        }
    }
}

async function savePunchlistItem() {
    const projectId = +$('#pi-project').value;
    const type = $('#pi-type').value;
    const description = $('#pi-description').value.trim();
    const manufacturer = $('#pi-manufacturer').value.trim();
    const po = $('#pi-po').value.trim();
    const qty = +$('#pi-qty').value;
    const followupAssignedId = +($('#pi-assigned').value || 0) || null;
    const followupDate = $('#pi-followup-date').value || null;
    const reportedById = +$('#pi-reportedby').value;
    const status = $('#pi-status').value;
    const etaDate = $('#pi-eta').value || null;
    const rmaNumber = $('#pi-rma').value.trim();
    const photoTags = ($('#pi-photo-tags').value || '').split(',').map(s => s.trim()).filter(Boolean);
    const notes = $('#pi-notes').value.trim();

    if (!projectId) return toast('Select project');
    if (!type) return toast('Select type');
    if (!description) return toast('Enter description');
    if (!reportedById) return toast('Select reporter');

    const data = {
        project_id: projectId,
        type,
        description,
        manufacturer,
        po,
        quantity: qty,
        status,
        reported_by_id: reportedById,
        followup_assigned_id: followupAssignedId,
        followup_date: followupDate,
        date_reported: new Date().toISOString().split('T')[0],
        eta_date: etaDate,
        rma_number: rmaNumber,
        photo_tags: photoTags,
        photos: pendingPhotoUploads || [],
        notes
    };

    const newId = await sbInsert('punchlist', data);
    if (newId) {
        punchlist.push({
            id: newId,
            projectId,
            type,
            description,
            manufacturer,
            po,
            quantity: qty,
            status,
            reportedById,
            followupAssignedId,
            followupDate,
            dateReported: data.date_reported,
            etaDate,
            rmaNumber,
            photoTags,
            photos: pendingPhotoUploads || [],
            notes
        });
    }

    saveLocal();
    render();
    closeModal('punchitem');
    toast('Item created!');
    pendingPhotoUploads = [];
    if (currentProject) openPanel(currentProject.id);
}

function openPunchlistFromPanel(defaultType) {
    if (!currentProject) return;
    if (defaultType === 'rfi' || defaultType === 'site') {
        if (!canEditFeature('issues')) return toast('Lead/crew access only');
    }
    if (defaultType === 'return') {
        if (!canEditFeature('returns')) return toast('Warehouse/office access only');
    }
    populateSelects();
    openModal('punchitem');
    $('#pi-project').value = currentProject.id;
    $('#pi-type').value = defaultType || '';
    $('#pi-description').value = '';
    $('#pi-manufacturer').value = '';
    $('#pi-po').value = '';
    $('#pi-qty').value = 1;
    $('#pi-assigned').value = '';
    $('#pi-followup-date').value = '';
    $('#pi-reportedby').value = '';
    $('#pi-status').value = 'open';
    $('#pi-eta').value = '';
    $('#pi-rma').value = '';
    $('#pi-photo-tags').value = '';
    $('#pi-notes').value = '';
    $('#pi-photo-previews').innerHTML = '';
    pendingPhotoUploads = [];
}

function editPunchlistItem(id) {
    const item = punchlist.find(p => p.id === id);
    if (!item) return;
    if ((item.type === 'rfi' || item.type === 'site') && !canEditFeature('issues')) return toast('Lead/crew access only');
    if (item.type === 'return' && !canEditFeature('returns')) return toast('Warehouse/office access only');

    populateSelects();
    openModal('punchitem');
    document.querySelector('#modal-punchitem .modal-title').textContent = 'Edit Punchlist Item';
    const saveBtn = document.querySelector('#modal-punchitem .modal-footer .btn-primary');
    saveBtn.textContent = 'Save';
    saveBtn.setAttribute('onclick', `updatePunchlistItem(${id})`);

    $('#pi-project').value = item.projectId;
    $('#pi-type').value = item.type;
    $('#pi-description').value = item.description;
    $('#pi-manufacturer').value = item.manufacturer || '';
    $('#pi-po').value = item.po || '';
    $('#pi-qty').value = item.quantity;
    $('#pi-assigned').value = item.followupAssignedId || '';
    $('#pi-followup-date').value = item.followupDate || '';
    $('#pi-reportedby').value = item.reportedById || '';
    $('#pi-status').value = item.status;
    $('#pi-eta').value = item.etaDate || '';
    $('#pi-rma').value = item.rmaNumber || '';
    $('#pi-photo-tags').value = Array.isArray(item.photoTags) ? item.photoTags.join(', ') : (item.photoTags || '');
    $('#pi-notes').value = item.notes || '';

    const container = $('#pi-photo-previews');
    container.innerHTML = (item.photos || []).map(src => `<div class="photo-preview"><img src="${src}" alt="photo"></div>`).join('');
    pendingPhotoUploads = (item.photos || []).slice();
}

async function updatePunchlistItem(id) {
    const item = punchlist.find(p => p.id === id);
    if (!item) return;
    if ((item.type === 'rfi' || item.type === 'site') && !canEditFeature('issues')) return toast('Lead/crew access only');
    if (item.type === 'return' && !canEditFeature('returns')) return toast('Warehouse/office access only');

    const projectId = +$('#pi-project').value;
    const type = $('#pi-type').value;
    const description = $('#pi-description').value.trim();
    if (!projectId || !type || !description) return toast('Fill required fields');

    const data = {
        project_id: projectId,
        type,
        description,
        manufacturer: $('#pi-manufacturer').value.trim(),
        po: $('#pi-po').value.trim(),
        quantity: +$('#pi-qty').value,
        followup_assigned_id: +($('#pi-assigned').value || 0) || null,
        followup_date: $('#pi-followup-date').value || null,
        reported_by_id: +$('#pi-reportedby').value,
        status: $('#pi-status').value,
        eta_date: $('#pi-eta').value || null,
        rma_number: $('#pi-rma').value.trim(),
        photo_tags: ($('#pi-photo-tags').value || '').split(',').map(s => s.trim()).filter(Boolean),
        notes: $('#pi-notes').value.trim(),
        photos: pendingPhotoUploads || []
    };

    await sbUpdate('punchlist', id, data);
    item.projectId = projectId;
    item.type = type;
    item.description = description;
    item.manufacturer = data.manufacturer;
    item.po = data.po;
    item.quantity = data.quantity;
    item.followupAssignedId = data.followup_assigned_id;
    item.followupDate = data.followup_date;
    item.reportedById = data.reported_by_id;
    item.status = data.status;
    item.etaDate = data.eta_date;
    item.rmaNumber = data.rma_number;
    item.photoTags = data.photo_tags;
    item.notes = data.notes;
    item.photos = pendingPhotoUploads || [];

    saveLocal();
    render();
    closeModal('punchitem');
    toast('Item updated!');
    pendingPhotoUploads = [];

    // Reset modal back to create mode
    document.querySelector('#modal-punchitem .modal-title').textContent = 'New Punchlist Item';
    const saveBtn = document.querySelector('#modal-punchitem .modal-footer .btn-primary');
    saveBtn.textContent = 'Create';
    saveBtn.setAttribute('onclick', 'savePunchlistItem()');

    if (currentProject) openPanel(currentProject.id);
}

function openPanel(pid) {
    currentProject = getOrgProjects().find(p => p.id === pid) || null;
    if (!currentProject) return;
    currentQuoteId = null;
    const client = getOrgClients().find(c => c.id === currentProject.clientId);
    $('#panel-title').textContent = currentProject.name;
    $('#panel-subtitle').textContent = client?.company || '';
    const dt = currentProject.date ? new Date(currentProject.date + 'T12:00:00') : null;
    const statusLabel = getProjectStatusLabel(currentProject, currentProject.status);
    const typeLabel = isMoveProject(currentProject) ? 'Move' : 'Install';
    let extra = '';
    if (isMoveProject(currentProject)) {
        const shipStats = getProjectShipmentStats(currentProject.id);
        const moveStats = getProjectMoveItemStats(currentProject.id);
        const pending = shipStats.pending + moveStats.pending;
        const total = shipStats.total + moveStats.total;
        const locStatus = getProjectLocationStatus(currentProject.id);
        extra = `<br><strong>Current Location:</strong> ${escapeHtml(locStatus)}<br><strong>Pending Items:</strong> ${pending}/${total}`;
    }
    $('#panel-details').innerHTML = `${dt ? ' ' + dt.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric'}) + '<br>' : ''}${currentProject.time ? ' ' + currentProject.time + '<br>' : ''}${currentProject.location ? ' ' + currentProject.location + '<br>' : ''}<strong>Status:</strong> ${escapeHtml(statusLabel)}<br><strong>Type:</strong> ${typeLabel}${extra}`;
    const assigned = currentProject.team || [];
    $('#panel-team').innerHTML = getOrgPeople().map(p => `<div class="team-item ${assigned.includes(p.id) ? 'assigned' : ''}" onclick="toggleTeam(${p.id})"><div class="card-avatar">${p.name.split(' ').map(n=>n[0]).join('')}</div><div><div style="font-weight:500">${p.name}</div><div style="font-size:12px;color:var(--muted)">${p.role}</div></div><div class="team-check">${assigned.includes(p.id) ? '' : ''}</div></div>`).join('');
    const ps = getOrgShipments().filter(s => s.projectId === currentProject.id);
    let shipHtml = '';
    if (ps.length) {
        const rec = ps.filter(s=>s.status==='received').length;
        shipHtml += '<div style="font-size:12px;color:var(--muted);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center"><span>'+rec+'/'+ps.length+' received</span><button class="btn btn-outline" style="padding:2px 10px;font-size:11px" onclick="openShipmentListForProject('+currentProject.id+')">Upload List</button></div>';
        shipHtml += ps.map(s => {
            const expD = s.expectedDate ? new Date(s.expectedDate+'T12:00:00') : null;
            const expStr = expD ? expD.toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '';
            const locStr = s.location ? '<span style="color:var(--blue);font-size:11px;font-family:monospace"> '+s.location+'</span>' : '';
            return `<div style="display:flex;gap:8px;padding:8px 10px;background:var(--gray-lt);border-radius:6px;margin-bottom:4px;font-size:12px;align-items:center;cursor:pointer" onclick="openShipmentPanel(${s.id})"><span class="status status-${s.status}" style="font-size:10px;padding:2px 6px">${s.status === 'received' ? '' : ''}</span><span style="font-family:monospace;flex:1">${s.subitem}</span><span style="color:var(--muted)">${s.mfr||''}</span>${locStr}${expStr ? '<span style="color:var(--text2);font-size:11px"> '+expStr+'</span>' : ''}</div>`;
        }).join('');
    } else {
        shipHtml = '<div style="color:var(--muted);text-align:center;padding:12px"><div>No shipments yet</div><button class="btn btn-outline" style="margin-top:8px;font-size:12px" onclick="openShipmentListForProject('+currentProject.id+')">Upload Shipment List</button></div>';
    }
    $('#panel-shipments').innerHTML = shipHtml;

    const pl = punchlist.filter(p => p.projectId === currentProject.id);
    const plStats = { open: pl.filter(i => i.status === 'open').length, inprogress: pl.filter(i => i.status === 'inprogress').length, resolved: pl.filter(i => i.status === 'resolved').length };
    $('#panel-punchlist-stats').innerHTML = pl.length ? `<div style="display:flex;gap:12px;font-size:12px;margin-bottom:8px"><span style="color:var(--red);font-weight:600">${plStats.open} Open</span><span style="color:var(--yellow);font-weight:600">${plStats.inprogress} In Progress</span><span style="color:var(--green);font-weight:600">${plStats.resolved} Resolved</span></div>` : '';
    $('#panel-punchlist').innerHTML = pl.length ? pl.map(p => {
        const typeMap = {
            damaged: { color: 'damaged', label: 'Damaged' },
            missing: { color: 'missing', label: 'Missing' },
            backorder: { color: 'backorder', label: 'Back-ordered' },
            return: { color: 'missing', label: 'Return' },
            rfi: { color: 'inprogress', label: 'RFI' },
            site: { color: 'inprogress', label: 'Site Issue' }
        };
        const typeInfo = typeMap[p.type] || { color: 'backorder', label: (p.type || 'Issue').toString() };
        const statusColor = p.status === 'open' ? 'open' : p.status === 'inprogress' ? 'inprogress' : 'resolved';
        const statusLbl = p.status === 'inprogress' ? 'In Progress' : p.status.charAt(0).toUpperCase() + p.status.slice(1);
        const follow = p.followupDate ? '  Follow-up: ' + p.followupDate : '';
        return `<div style="padding:10px;background:var(--gray-lt);border-radius:6px;margin-bottom:6px;cursor:pointer" onclick="editPunchlistItem(${p.id})"><div style="display:flex;gap:8px;align-items:center;margin-bottom:4px;flex-wrap:wrap"><span class="badge badge-${typeInfo.color}" style="padding:2px 8px;font-size:11px">${typeInfo.label}</span><span class="badge badge-${statusColor}" style="padding:2px 8px;font-size:11px">${statusLbl}</span>${p.photos?.length ? '<span style="font-size:11px;color:var(--muted)"> '+p.photos.length+'</span>' : ''}</div><div style="font-weight:500;font-size:13px">${p.description}</div><div style="font-size:12px;color:var(--muted);margin-top:2px">${p.manufacturer ? p.manufacturer + '  ' : ''}${p.po ? 'PO: ' + p.po : ''}${p.quantity > 1 ? '  Qty: ' + p.quantity : ''}${follow}</div></div>`;
    }).join('') : '<div style="color:var(--muted);padding:12px;text-align:center">No punchlist items yet</div>';

    const docs = currentProject.docs || {};
    const dt2 = [
        {k:'workOrder',n:'Work Order',i:''},
        {k:'deliveryReceipt',n:'Delivery Receipt',i:''},
        {k:'drawing',n:'Drawing',i:''},
        {k:'moveGuide',n:'Move Guide',i:''},
        {k:'coi',n:'COI',i:''},
        {k:'beforePlan',n:'Before Prints',i:''},
        {k:'afterPlan',n:'After Prints',i:''},
        {k:'floorPlan',n:'Floor Plan',i:''},
        {k:'zoneMap',n:'Zone Map',i:''},
        {k:'destinationMap',n:'Destination Map',i:''}
    ];
    $('#panel-docs').innerHTML = dt2.map(d => {
        const entry = normalizeDocEntry(docs[d.k]);
        const hasUrl = entry && entry.url;
        const fileName = entry && entry.name ? entry.name : (hasUrl ? 'View file' : 'No file uploaded');
        return `<div class="doc-item">
            <div style="font-size:20px">${d.i}</div>
            <div>
                <div style="font-weight:500">${d.n}</div>
                <div class="doc-meta">${escapeHtml(fileName)}</div>
            </div>
            <div class="doc-actions">
                <button class="btn btn-outline" onclick="uploadDoc('${d.k}')">Upload</button>
                ${hasUrl ? `<a class="btn btn-primary" href="${escapeHtml(entry.url)}" target="_blank" rel="noopener">Download</a>` : ''}
            </div>
        </div>`;
    }).join('');

    renderProjectPanelExtras(currentProject);

    const panelBody = document.querySelector('.panel-body');
    const existingActionBtn = panelBody?.querySelector('.panel-action-btn');
    if (existingActionBtn) existingActionBtn.remove();

    const actionBtn = document.createElement('div');
    actionBtn.className = 'panel-action-btn';
    actionBtn.style.cssText = 'display:flex;gap:8px;margin-top:16px';
    actionBtn.innerHTML = `<button class="btn btn-primary" onclick="notifyTeam()" style="flex:1"> Send Notification</button>` +
        (currentProject.status === 'completed'
            ? `<button class="btn" style="flex:1;background:var(--red);color:#fff" onclick="completeProject()"> Delete Project</button>`
            : `<button class="btn btn-outline" style="flex:1" onclick="completeProject()"> Complete Project</button>`);
    panelBody.appendChild(actionBtn);

    // Reset to Details tab
    document.getElementById('panel-tab-details').style.display = 'block';
    document.getElementById('panel-tab-moving').style.display = 'none';
    document.getElementById('panel-tab-completion').style.display = 'none';
    document.querySelectorAll('.panel-tab-btn').forEach(t => t.classList.remove('active'));
    document.querySelector('.panel-tab-btn').classList.add('active');

    $('#panel').classList.add('open');
}
function closePanel() { $('#panel').classList.remove('open'); }

function getJobsiteReadiness(projectId){
    return jobsiteReadiness.find(r => r.projectId === projectId) || null;
}

function renderJobsiteReadiness(project){
    if (!project) return '';
    const canEdit = canEditFeature('readiness');
    const existing = getJobsiteReadiness(project.id);
    const checklist = existing && existing.checklist ? existing.checklist : {};
    let h = '<div class="pc-checklist" style="margin-bottom:8px">';
    JOBSITE_CHECKLIST.forEach(item => {
        const checked = checklist[item.id] ? ' checked' : '';
        const disabled = canEdit ? '' : ' disabled';
        h += `<label style="display:flex;gap:8px;align-items:center;font-size:12px"><input type="checkbox" id="jr-${item.id}"${checked}${disabled}> <span>${item.label}</span></label>`;
    });
    h += '</div>';
    const ro = canEdit ? '' : 'readonly';
    h += `<div class="form-group" style="margin-bottom:0"><label class="form-label">Notes</label><textarea class="form-input" id="jr-notes" placeholder="Access notes, contacts, instructions" style="resize:vertical;min-height:70px" ${ro}>${existing?.notes || ''}</textarea></div>`;
    if (!canEdit) h += '<div style="font-size:11px;color:var(--muted);margin-top:6px">Lead access only.</div>';
    return h;
}

async function saveJobsiteReadiness(){
    if (!currentProject) return;
    if (!canEditFeature('readiness')) return toast('Lead access only');
    const checklist = {};
    JOBSITE_CHECKLIST.forEach(item => {
        const el = document.getElementById('jr-' + item.id);
        checklist[item.id] = !!el?.checked;
    });
    const notes = (document.getElementById('jr-notes')?.value || '').trim();
    const payload = { project_id: currentProject.id, checklist, notes, updated_at: new Date().toISOString() };
    const existing = getJobsiteReadiness(currentProject.id);
    if (existing && existing.id) {
        await sbUpdate('jobsite_readiness', existing.id, payload);
        Object.assign(existing, { projectId: currentProject.id, checklist, notes, updatedAt: payload.updated_at });
    } else {
        const newId = await sbInsert('jobsite_readiness', payload);
        jobsiteReadiness.push(assignOrgId({ id: newId || Date.now(), projectId: currentProject.id, checklist, notes, updatedAt: payload.updated_at }, 'jobsite_readiness'));
    }
    saveLocal();
    renderProjectPanelExtras(currentProject);
    toast('Jobsite readiness saved');
}

let timeEntryFormOpen = false;
function toggleTimeEntryForm(){
    timeEntryFormOpen = !timeEntryFormOpen;
    if (currentProject) renderProjectPanelExtras(currentProject);
}

function renderTimeEntries(project){
    if (!project) return '';
    const entries = timeEntries.filter(t => t.projectId === project.id).sort((a,b)=>new Date(b.workDate||b.createdAt)-new Date(a.workDate||a.createdAt));
    let h = '';
    if (timeEntryFormOpen) {
        h += '<div class="mini-card" style="background:#fff;border:1px solid var(--border)">';
        h += '<div class="form-row"><div class="form-group"><label class="form-label">Crew Member</label><select class="form-select" id="te-person"><option value="">Select...</option>' +
            people.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('') + '</select></div>' +
            '<div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="te-date"></div></div>';
        h += '<div class="form-row"><div class="form-group"><label class="form-label">Hours</label><input type="number" class="form-input" id="te-hours" min="0" step="0.25"></div>' +
            '<div class="form-group"><label class="form-label">Notes</label><input type="text" class="form-input" id="te-notes" placeholder="Optional"></div></div>';
        h += '<div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-outline" onclick="toggleTimeEntryForm()">Cancel</button><button class="btn btn-primary" onclick="saveTimeEntry()">Save</button></div>';
        h += '</div>';
    }
    if (!entries.length) {
        h += '<div style="color:var(--muted);font-size:12px">No time entries yet.</div>';
        return h;
    }
    h += entries.map(t => {
        const person = people.find(p => p.id === t.personId);
        return `<div class="mini-card"><div style="display:flex;justify-content:space-between"><strong>${escapeHtml(person?.name || 'Unknown')}</strong><span style="color:var(--muted)">${t.workDate || ''}</span></div><div style="font-size:12px;color:var(--text2)">${t.hours} hrs${t.notes ? '  ' + escapeHtml(t.notes) : ''}</div></div>`;
    }).join('');
    return h;
}

async function saveTimeEntry(){
    if (!currentProject) return;
    const personId = +($('#te-person').value || 0);
    const workDate = $('#te-date').value || new Date().toISOString().split('T')[0];
    const hours = parseFloat($('#te-hours').value || '0');
    const notes = ($('#te-notes').value || '').trim();
    if (!personId) return toast('Select a crew member');
    if (!hours) return toast('Enter hours');
    const payload = { project_id: currentProject.id, person_id: personId, work_date: workDate, hours, notes, created_at: new Date().toISOString() };
    const newId = await sbInsert('time_entries', payload);
    timeEntries.push(assignOrgId({ id: newId || Date.now(), projectId: currentProject.id, personId, workDate, hours, notes, createdAt: payload.created_at }, 'time_entries'));
    timeEntryFormOpen = false;
    saveLocal();
    renderProjectPanelExtras(currentProject);
    toast('Time entry saved');
}

let statusUpdateFormOpen = false;
function toggleStatusUpdateForm(){
    if (!canEditFeature('updates')) return toast('Office/PM access only');
    statusUpdateFormOpen = !statusUpdateFormOpen;
    if (currentProject) renderProjectPanelExtras(currentProject);
}

function renderProjectUpdates(project){
    if (!project) return '';
    const updates = projectUpdates.filter(u => u.projectId === project.id).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
    let h = '';
    if (statusUpdateFormOpen) {
        h += '<div class="mini-card" style="background:#fff;border:1px solid var(--border)">';
        const statusOpts = getProjectStatusOptions(project).map(o => `<option value="${o.value}">${o.label}</option>`).join('');
        h += '<div class="form-row"><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="pu-status">' +
            statusOpts + '</select></div>' +
            '<div class="form-group"><label class="form-label">Message</label><input type="text" class="form-input" id="pu-message" placeholder="Short update"></div></div>';
        h += '<div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-outline" onclick="toggleStatusUpdateForm()">Cancel</button><button class="btn btn-primary" onclick="saveProjectUpdate()">Post</button></div>';
        h += '</div>';
    }
    if (!updates.length) {
        h += '<div style="color:var(--muted);font-size:12px">No updates yet.</div>';
        return h;
    }
    h += updates.map(u => {
        const statusLabel = getProjectStatusLabel(project, u.status);
        const when = u.createdAt ? new Date(u.createdAt).toLocaleString() : '';
        return `<div class="mini-card"><div style="display:flex;justify-content:space-between"><strong>${escapeHtml(statusLabel)}</strong><span style="color:var(--muted)">${when}</span></div><div style="font-size:12px;color:var(--text2)">${escapeHtml(u.message || '')}</div></div>`;
    }).join('');
    return h;
}

async function saveProjectUpdate(){
    if (!currentProject) return;
    if (!canEditFeature('updates')) return toast('Office/PM access only');
    const status = $('#pu-status').value;
    const message = ($('#pu-message').value || '').trim();
    if (!status || !message) return toast('Add status and message');
    const payload = { project_id: currentProject.id, status, message, created_at: new Date().toISOString(), author_id: currentUserId || null };
    const newId = await sbInsert('project_updates', payload);
    projectUpdates.push(assignOrgId({ id: newId || Date.now(), projectId: currentProject.id, status, message, createdAt: payload.created_at, authorId: payload.author_id }, 'project_updates'));
    const proj = getOrgProjects().find(p => p.id === currentProject.id);
    if (proj) { proj.status = status; await sbUpdate('projects', proj.id, { status }); }
    statusUpdateFormOpen = false;
    saveLocal();
    render();
    openPanel(currentProject.id);
    toast('Status update posted');
}

let changeOrderFormOpen = false;
function toggleChangeOrderForm(){
    changeOrderFormOpen = !changeOrderFormOpen;
    if (currentProject) renderProjectPanelExtras(currentProject);
}

function renderChangeOrders(project){
    if (!project) return '';
    const orders = changeOrders.filter(c => c.projectId === project.id).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
    let h = '';
    if (changeOrderFormOpen) {
        h += '<div class="mini-card" style="background:#fff;border:1px solid var(--border)">';
        h += '<div class="form-group"><label class="form-label">Title</label><input type="text" class="form-input" id="co-title" placeholder="Change order title"></div>';
        h += '<div class="form-group"><label class="form-label">Description</label><textarea class="form-input" id="co-desc" rows="2" placeholder="Details"></textarea></div>';
        h += '<div class="form-row"><div class="form-group"><label class="form-label">Amount</label><input type="number" class="form-input" id="co-amount" step="0.01"></div>' +
            '<div class="form-group"><label class="form-label">Status</label><select class="form-select" id="co-status"><option value="requested">Requested</option><option value="approved">Approved</option><option value="rejected">Rejected</option></select></div></div>';
        h += '<div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-outline" onclick="toggleChangeOrderForm()">Cancel</button><button class="btn btn-primary" onclick="saveChangeOrder()">Save</button></div>';
        h += '</div>';
    }
    if (!orders.length) {
        h += '<div style="color:var(--muted);font-size:12px">No change orders yet.</div>';
        return h;
    }
    h += orders.map(c => {
        const when = c.createdAt ? new Date(c.createdAt).toLocaleDateString() : '';
        return `<div class="mini-card"><div style="display:flex;justify-content:space-between"><strong>${escapeHtml(c.title || 'Change Order')}</strong><span style="color:var(--muted)">${when}</span></div><div style="font-size:12px;color:var(--text2)">${escapeHtml(c.description || '')}</div><div style="font-size:12px;color:var(--text2);margin-top:4px">${c.amount ? '$'+Number(c.amount).toFixed(2) : ''} <span style="margin-left:6px;color:var(--muted)">${escapeHtml(c.status || '')}</span></div></div>`;
    }).join('');
    return h;
}

async function saveChangeOrder(){
    if (!currentProject) return;
    const title = ($('#co-title').value || '').trim();
    const description = ($('#co-desc').value || '').trim();
    const amount = parseFloat($('#co-amount').value || '0');
    const status = $('#co-status').value;
    if (!title) return toast('Enter change order title');
    const payload = { project_id: currentProject.id, title, description, amount, status, created_at: new Date().toISOString(), requested_by: currentUserId || null };
    const newId = await sbInsert('change_orders', payload);
    changeOrders.push(assignOrgId({ id: newId || Date.now(), projectId: currentProject.id, title, description, amount, status, createdAt: payload.created_at, requestedBy: payload.requested_by }, 'change_orders'));
    changeOrderFormOpen = false;
    saveLocal();
    renderProjectPanelExtras(currentProject);
    toast('Change order saved');
}

function renderFieldIssues(project){
    if (!project) return '';
    const issues = punchlist.filter(p => p.projectId === project.id && (p.type === 'rfi' || p.type === 'site'));
    if (!issues.length) return '<div style="color:var(--muted);font-size:12px">No field issues yet.</div>';
    return issues.map(p => {
        const assigned = people.find(pe => pe.id === p.followupAssignedId);
        const follow = p.followupDate ? '  Due ' + p.followupDate : '';
        return `<div class="mini-card" onclick="editPunchlistItem(${p.id})"><div style="display:flex;justify-content:space-between"><strong>${escapeHtml(p.type === 'rfi' ? 'RFI' : 'Site Issue')}</strong><span style="color:var(--muted)">${p.status}</span></div><div style="font-size:12px;color:var(--text2)">${escapeHtml(p.description || '')}</div><div style="font-size:11px;color:var(--muted)">${assigned ? 'Assigned: ' + escapeHtml(assigned.name) : ''}${follow}</div></div>`;
    }).join('');
}

function renderReturnsBackorders(project){
    if (!project) return '';
    const items = punchlist.filter(p => p.projectId === project.id && (p.type === 'backorder' || p.type === 'return'));
    if (!items.length) return '<div style="color:var(--muted);font-size:12px">No returns/backorders yet.</div>';
    return items.map(p => {
        const eta = p.etaDate ? 'ETA ' + p.etaDate : '';
        const rma = p.rmaNumber ? 'RMA ' + p.rmaNumber : '';
        const meta = [eta, rma].filter(Boolean).join('  ');
        return `<div class="mini-card" onclick="editPunchlistItem(${p.id})"><div style="display:flex;justify-content:space-between"><strong>${escapeHtml(p.type === 'backorder' ? 'Backorder' : 'Return')}</strong><span style="color:var(--muted)">${p.status}</span></div><div style="font-size:12px;color:var(--text2)">${escapeHtml(p.description || '')}</div>${meta ? `<div style="font-size:11px;color:var(--muted)">${escapeHtml(meta)}</div>` : ''}</div>`;
    }).join('');
}

function getMoveChecklist(projectId){
    return moveChecklists.find(m => m.projectId === projectId) || null;
}

function renderMoveChecklist(project){
    if (!project) return '';
    if (!isMoveProject(project)) {
        return '<div style="color:var(--muted);font-size:12px">Set project type to Move to use move checklists.</div>';
    }
    const existing = getMoveChecklist(project.id);
    const checklist = existing?.checklist || {};
    const notes = existing?.notes || {};
    const sections = [
        { key: 'pre', title: 'Pre-Move Checklist' },
        { key: 'team', title: 'Team Checklist' },
        { key: 'dayof', title: 'Day-Of Checklist' }
    ];
    let h = '';
    sections.forEach(sec => {
        h += `<div class="mini-card" style="background:#fff;border:1px solid var(--border)"><div style="font-weight:600;margin-bottom:6px">${sec.title}</div>`;
        MOVE_CHECKLISTS[sec.key].forEach(item => {
            const checked = checklist?.[sec.key]?.[item.id] ? ' checked' : '';
            h += `<label style="display:flex;gap:8px;align-items:center;font-size:12px;margin-bottom:4px"><input type="checkbox" id="mc-${sec.key}-${item.id}"${checked}> <span>${item.label}</span></label>`;
        });
        h += `<div class="form-group" style="margin:6px 0 0"><label class="form-label">Notes</label><textarea class="form-input" id="mc-notes-${sec.key}" style="resize:vertical;min-height:60px">${notes?.[sec.key] || ''}</textarea></div>`;
        h += '</div>';
    });
    h += '<div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn btn-outline" onclick="saveMoveChecklist()">Save Move Checklist</button></div>';
    return h;
}

async function saveMoveChecklist(){
    if (!currentProject) return;
    if (!isMoveProject(currentProject)) return toast('Set project type to Move');
    const checklist = { pre:{}, team:{}, dayof:{} };
    Object.keys(MOVE_CHECKLISTS).forEach(key => {
        MOVE_CHECKLISTS[key].forEach(item => {
            const el = document.getElementById(`mc-${key}-${item.id}`);
            checklist[key][item.id] = !!el?.checked;
        });
    });
    const notes = {
        pre: document.getElementById('mc-notes-pre')?.value || '',
        team: document.getElementById('mc-notes-team')?.value || '',
        dayof: document.getElementById('mc-notes-dayof')?.value || ''
    };
    const payload = { project_id: currentProject.id, checklist, notes, updated_at: new Date().toISOString() };
    const existing = getMoveChecklist(currentProject.id);
    if (existing && existing.id) {
        await sbUpdate('move_checklists', existing.id, payload);
        Object.assign(existing, { projectId: currentProject.id, checklist, notes, updatedAt: payload.updated_at });
    } else {
        const newId = await sbInsert('move_checklists', payload);
        moveChecklists.push(assignOrgId({ id: newId || Date.now(), projectId: currentProject.id, checklist, notes, updatedAt: payload.updated_at }, 'move_checklists'));
    }
    saveLocal();
    toast('Move checklist saved');
}

let moveItemFormOpen = false;
function toggleMoveItemForm(){
    moveItemFormOpen = !moveItemFormOpen;
    if (currentProject) renderProjectPanelExtras(currentProject);
}

async function generateQrDataUrl(text){
    if (window.QRCode && text) {
        try { return await QRCode.toDataURL(text, { width: 140, margin: 1 }); } catch(e) { return ''; }
    }
    return '';
}

async function saveMoveItem(){
    if (!currentProject) return;
    if (!isMoveProject(currentProject)) return toast('Set project type to Move');
    const name = ($('#mi-name').value || '').trim();
    const qty = parseInt($('#mi-qty').value || '1', 10);
    const category = ($('#mi-category').value || '').trim();
    const pickupLocation = ($('#mi-pickup').value || '').trim();
    const dropLocation = ($('#mi-drop').value || '').trim();
    const isHighValue = !!$('#mi-highvalue').checked;
    const notes = ($('#mi-notes').value || '').trim();
    if (!name) return toast('Enter item name');
    let qrCode = '';
    let qrDataUrl = '';
    if (isHighValue) {
        qrCode = `MV-${currentProject.id}-${Date.now().toString(36).slice(-6)}`;
        qrDataUrl = await generateQrDataUrl(qrCode);
    }
    const payload = {
        project_id: currentProject.id,
        name,
        quantity: qty,
        category,
        pickup_location: pickupLocation,
        drop_location: dropLocation,
        is_high_value: isHighValue,
        qr_code: qrCode,
        qr_data_url: qrDataUrl,
        picked: false,
        arrived: false,
        notes,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
    };
    const newId = await sbInsert('move_items', payload);
    moveItems.push(assignOrgId({ id: newId || Date.now(), projectId: currentProject.id, name, quantity: qty, category, pickupLocation, dropLocation, isHighValue, qrCode, qrDataUrl, picked:false, arrived:false, notes, createdAt: payload.created_at, updatedAt: payload.updated_at }, 'move_items'));
    moveItemFormOpen = false;
    saveLocal();
    renderProjectPanelExtras(currentProject);
    toast('Move item added');
}

async function updateMoveItemFlag(id, field, val){
    const item = moveItems.find(i => i.id === id);
    if (!item) return;
    item[field] = val;
    item.updatedAt = new Date().toISOString();
    const update = {};
    update[field] = val;
    update.updated_at = item.updatedAt;
    await sbUpdate('move_items', id, update);
    saveLocal();
}

async function verifyMoveItemByQr(){
    const code = ($('#mi-verify').value || '').trim();
    if (!code) return;
    const item = moveItems.find(i => i.projectId === currentProject.id && i.qrCode === code);
    if (!item) return toast('QR code not found');
    await updateMoveItemFlag(item.id, 'arrived', true);
    $('#mi-verify').value = '';
    renderProjectPanelExtras(currentProject);
    toast('Item marked arrived');
}

function renderMoveInventory(project){
    if (!project) return '';
    if (!isMoveProject(project)) {
        return '<div style="color:var(--muted);font-size:12px">Set project type to Move to use move inventory.</div>';
    }
    const items = moveItems.filter(i => i.projectId === project.id);
    let h = '';
    if (moveItemFormOpen) {
        h += '<div class="mini-card" style="background:#fff;border:1px solid var(--border)">';
        h += '<div class="form-row"><div class="form-group"><label class="form-label">Item</label><input type="text" class="form-input" id="mi-name" placeholder="Desk, file, AV rack"></div>' +
            '<div class="form-group"><label class="form-label">Qty</label><input type="number" class="form-input" id="mi-qty" value="1" min="1"></div></div>';
        h += '<div class="form-row"><div class="form-group"><label class="form-label">Category</label><input type="text" class="form-input" id="mi-category" placeholder="Office, IT, AV"></div>' +
            '<div class="form-group"><label class="form-label">High Value</label><label style="display:flex;align-items:center;gap:8px;font-size:12px"><input type="checkbox" id="mi-highvalue"> Generate QR</label></div></div>';
        h += '<div class="form-row"><div class="form-group"><label class="form-label">Pickup Area</label><input type="text" class="form-input" id="mi-pickup" placeholder="Floor 3 / Room 312"></div>' +
            '<div class="form-group"><label class="form-label">Drop Area</label><input type="text" class="form-input" id="mi-drop" placeholder="New site / Room 410"></div></div>';
        h += '<div class="form-group"><label class="form-label">Notes</label><input type="text" class="form-input" id="mi-notes" placeholder="Condition / handling"></div>';
        h += '<div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-outline" onclick="toggleMoveItemForm()">Cancel</button><button class="btn btn-primary" onclick="saveMoveItem()">Save</button></div>';
        h += '</div>';
    }
    h += '<div class="form-row" style="margin:8px 0"><div class="form-group" style="flex:1"><label class="form-label">Verify Arrival (QR Code)</label><input type="text" class="form-input" id="mi-verify" placeholder="Scan or enter code"></div><div class="form-group" style="display:flex;align-items:flex-end"><button class="btn btn-outline" onclick="verifyMoveItemByQr()">Mark Arrived</button></div></div>';
    if (!items.length) {
        h += '<div style="color:var(--muted);font-size:12px">No move inventory yet.</div>';
        return h;
    }
    h += items.map(it => {
        const status = it.arrived ? 'Arrived' : (it.picked ? 'Picked' : 'Planned');
        const badge = it.arrived ? 'badge-connected' : 'badge-disconnected';
        const qr = it.isHighValue && it.qrDataUrl ? `<img src="${it.qrDataUrl}" style="width:80px;height:80px;object-fit:cover;border:1px solid var(--border);border-radius:6px">` : '';
        return `<div class="mini-card" style="display:flex;gap:12px;align-items:center">
            <div style="flex:1;min-width:0">
                <div style="display:flex;gap:8px;align-items:center"><strong>${escapeHtml(it.name)}</strong><span class="badge ${badge}">${status}</span>${it.isHighValue ? '<span class="badge badge-missing">High Value</span>' : ''}</div>
                <div style="font-size:12px;color:var(--text2)">${it.quantity || 1}  ${escapeHtml(it.category || 'General')}</div>
                <div style="font-size:11px;color:var(--muted)">${escapeHtml(it.pickupLocation || '')}${it.dropLocation ? '  ' + escapeHtml(it.dropLocation) : ''}</div>
                ${it.notes ? '<div style="font-size:11px;color:var(--muted)">Notes: ' + escapeHtml(it.notes) + '</div>' : ''}
                <div style="display:flex;gap:10px;margin-top:6px;font-size:11px">
                    <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" ${it.picked ? 'checked' : ''} onchange="updateMoveItemFlag(${it.id},'picked',this.checked)">Picked</label>
                    <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" ${it.arrived ? 'checked' : ''} onchange="updateMoveItemFlag(${it.id},'arrived',this.checked)">Arrived</label>
                </div>
            </div>
            ${qr}
        </div>`;
    }).join('');
    return h;
}

function isBmgWorkspace() {
    const org = getActiveOrg();
    const slug = (org && org.slug ? String(org.slug).toLowerCase() : '');
    return slug === 'bmg';
}
function isStuccoWorkspace() {
    const org = getActiveOrg();
    const slug = (org && org.slug ? String(org.slug).toLowerCase() : '');
    return slug === 'stucco';
}
function isBmgContext(project) {
    if (!project) return false;
    return isBmgWorkspace() || getProjectType(project) === 'move';
}
async function updateProjectStatusForBmg(status) {
    if (!currentProject || !isBmgContext(currentProject)) return;
    const proj = getOrgProjects().find(p => p.id === currentProject.id);
    if (!proj) return;
    const targetIdx = MOVE_STATUS_OPTIONS.findIndex(o => o.value === status);
    if (targetIdx === -1) return;
    const currentIdx = MOVE_STATUS_OPTIONS.findIndex(o => o.value === proj.status);
    if (currentIdx !== -1 && currentIdx > targetIdx) return;
    proj.status = status;
    await sbUpdate('projects', proj.id, { status });
    saveLocal();
    render();
    if (document.getElementById('panel')?.classList.contains('open')) {
        openPanel(proj.id);
    }
}

function getSurveyForProject(projectId){
    return (surveys || []).find(s => s.projectId === projectId) || null;
}
function getSurveyRooms(surveyId){
    return (surveyRooms || []).filter(r => r.surveyId === surveyId);
}
function getSurveyItems(roomId){
    return (surveyItems || []).filter(i => i.roomId === roomId);
}
async function createSurveyForProject(projectId){
    const payload = { project_id: projectId, status: 'in-progress', created_at: new Date().toISOString() };
    const newId = await sbInsert('surveys', payload);
    const survey = assignOrgId({ id: newId || Date.now(), projectId, status: 'in-progress', createdAt: payload.created_at }, 'surveys');
    surveys.push(survey);
    await updateProjectStatusForBmg('survey');
    return survey;
}
async function addSurveyRoom(){
    if (!currentProject) return;
    if (!isBmgContext(currentProject)) return;
    const name = ($('#sr-name').value || '').trim();
    const floor = ($('#sr-floor').value || '').trim();
    const notes = ($('#sr-notes').value || '').trim();
    if (!name) return toast('Enter room name');
    let survey = getSurveyForProject(currentProject.id);
    if (!survey) survey = await createSurveyForProject(currentProject.id);
    const payload = { survey_id: survey.id, name, floor, notes, created_at: new Date().toISOString() };
    const newId = await sbInsert('survey_rooms', payload);
    surveyRooms.push(assignOrgId({ id: newId || Date.now(), surveyId: survey.id, name, floor, notes, createdAt: payload.created_at }, 'survey_rooms'));
    $('#sr-name').value = ''; $('#sr-floor').value = ''; $('#sr-notes').value = '';
    renderProjectPanelExtras(currentProject);
}
async function handleSurveyItemPhotos(roomId, event){
    const files = Array.from(event.target.files || []);
    if (!files.length) return;
    if (!surveyItemPhotos[roomId]) surveyItemPhotos[roomId] = [];
    for (const file of files) {
        try {
            const compressed = await compressImageFile(file);
            surveyItemPhotos[roomId].push(compressed.dataUrl);
        } catch (e) {}
    }
    event.target.value = '';
    renderProjectPanelExtras(currentProject);
}
function removeSurveyItemPhoto(roomId, idx){
    if (!surveyItemPhotos[roomId]) return;
    surveyItemPhotos[roomId].splice(idx, 1);
    renderProjectPanelExtras(currentProject);
}
async function addSurveyItem(roomId){
    if (!currentProject) return;
    const name = ($('#si-name-' + roomId).value || '').trim();
    const qty = parseInt($('#si-qty-' + roomId).value || '1', 10);
    const category = ($('#si-cat-' + roomId).value || '').trim();
    const notes = ($('#si-notes-' + roomId).value || '').trim();
    const isHighValue = !!$('#si-high-' + roomId).checked;
    if (!name) return toast('Enter item name');
    const photos = (surveyItemPhotos[roomId] || []).slice();
    const payload = { room_id: roomId, name, quantity: qty, category, notes, is_high_value: isHighValue, photos, created_at: new Date().toISOString() };
    const newId = await sbInsert('survey_items', payload);
    surveyItems.push(assignOrgId({ id: newId || Date.now(), roomId, name, quantity: qty, category, notes, isHighValue, photos, createdAt: payload.created_at }, 'survey_items'));
    surveyItemPhotos[roomId] = [];
    $('#si-name-' + roomId).value = '';
    $('#si-qty-' + roomId).value = '1';
    $('#si-cat-' + roomId).value = '';
    $('#si-notes-' + roomId).value = '';
    $('#si-high-' + roomId).checked = false;
    renderProjectPanelExtras(currentProject);
}
async function markSurveyComplete(){
    if (!currentProject) return;
    const survey = getSurveyForProject(currentProject.id);
    if (!survey) return toast('No survey to complete');
    survey.status = 'completed';
    survey.completedAt = new Date().toISOString();
    await sbUpdate('surveys', survey.id, { status: survey.status, completed_at: survey.completedAt });
    await updateProjectStatusForBmg('plan');
    renderProjectPanelExtras(currentProject);
    toast('Survey completed');
}

function renderBmgSurvey(project){
    if (!isBmgContext(project)) return '<div style="color:var(--muted);font-size:12px">BMG move survey is available for moving projects.</div>';
    const survey = getSurveyForProject(project.id);
    let h = '';
    if (!survey) {
        h += '<div class="mini-card" style="background:#fff;border:1px solid var(--border)"><div style="font-weight:600;margin-bottom:6px">Start Survey</div>' +
            '<div style="font-size:12px;color:var(--text2);margin-bottom:8px">Create rooms and item lists with photos for an accurate estimate.</div>' +
            '<button class="btn btn-outline" onclick="addSurveyRoom()">Create First Room</button></div>';
    }
    h += '<div class="mini-card" style="background:#fff;border:1px solid var(--border)"><div style="font-weight:600;margin-bottom:6px">Add Room</div>' +
        '<div class="form-row"><div class="form-group"><label class="form-label">Room</label><input type="text" class="form-input" id="sr-name" placeholder="Office, Conference"></div>' +
        '<div class="form-group"><label class="form-label">Floor</label><input type="text" class="form-input" id="sr-floor" placeholder="Floor 3"></div></div>' +
        '<div class="form-group"><label class="form-label">Notes</label><input type="text" class="form-input" id="sr-notes" placeholder="Access or staging notes"></div>' +
        '<div style="display:flex;justify-content:flex-end"><button class="btn btn-primary" onclick="addSurveyRoom()">Add Room</button></div></div>';

    if (survey) {
        const rooms = getSurveyRooms(survey.id);
        h += rooms.length ? rooms.map(r => {
            const items = getSurveyItems(r.id);
            const pendingPhotos = surveyItemPhotos[r.id] || [];
            const photoPreview = pendingPhotos.length
                ? `<div class="photo-preview-grid">${pendingPhotos.map((src, idx) => `<div class="photo-preview"><img src="${src}"><button type="button" class="photo-remove" onclick="removeSurveyItemPhoto(${r.id},${idx})">x</button></div>`).join('')}</div>`
                : '';
            return `<div class="mini-card" style="background:#fff;border:1px solid var(--border)">
                <div style="display:flex;justify-content:space-between;align-items:center"><strong>${escapeHtml(r.name || 'Room')}</strong><span style="font-size:11px;color:var(--muted)">${escapeHtml(r.floor || '')}</span></div>
                ${r.notes ? `<div style="font-size:12px;color:var(--text2);margin-top:4px">${escapeHtml(r.notes)}</div>` : ''}
                <div style="margin-top:8px">
                    ${items.length ? items.map(i => `<div style="font-size:12px;margin-bottom:4px"> ${escapeHtml(i.name)} (${i.quantity || 1}) ${i.category ? ' '+escapeHtml(i.category) : ''}${i.isHighValue ? ' <span class="badge badge-missing" style="margin-left:4px">High Value</span>' : ''}</div>`).join('') : '<div style="font-size:12px;color:var(--muted)">No items yet.</div>'}
                </div>
                <div style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px">
                    <div class="form-row"><div class="form-group"><label class="form-label">Item</label><input type="text" class="form-input" id="si-name-${r.id}" placeholder="Desk, chair"></div>
                    <div class="form-group"><label class="form-label">Qty</label><input type="number" class="form-input" id="si-qty-${r.id}" value="1" min="1"></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Category</label><input type="text" class="form-input" id="si-cat-${r.id}" placeholder="Office, IT, AV"></div>
                    <div class="form-group"><label class="form-label">High Value</label><label style="display:flex;align-items:center;gap:8px;font-size:12px"><input type="checkbox" id="si-high-${r.id}"> Track & QR</label></div></div>
                    <div class="form-group"><label class="form-label">Notes</label><input type="text" class="form-input" id="si-notes-${r.id}" placeholder="Condition, disassembly"></div>
                    <div class="form-group"><label class="form-label">Photos</label><input type="file" class="form-input" accept="image/*" multiple onchange="handleSurveyItemPhotos(${r.id}, event)">${photoPreview}</div>
                    <div style="display:flex;justify-content:flex-end"><button class="btn btn-outline" onclick="addSurveyItem(${r.id})">Add Item</button></div>
                </div>
            </div>`;
        }).join('') : '<div style="color:var(--muted);font-size:12px">No rooms yet.</div>';
        h += `<div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn btn-outline" onclick="markSurveyComplete()">Mark Survey Complete</button></div>`;
    }
    return h;
}

function getQuotesForProject(projectId){
    return (quotes || []).filter(q => q.projectId === projectId).sort((a,b)=> (b.version||0)-(a.version||0));
}
function getQuoteById(id){ return (quotes || []).find(q => String(q.id) === String(id)) || null; }
function getActiveQuote(projectId){
    if (currentQuoteId) {
        const q = getQuoteById(currentQuoteId);
        if (q && q.projectId === projectId) return q;
    }
    return getQuotesForProject(projectId)[0] || null;
}
function getQuoteItems(quoteId){
    return (quoteItems || []).filter(i => i.quoteId === quoteId);
}
async function createQuoteVersion(){
    if (!currentProject) return;
    const existing = getQuotesForProject(currentProject.id);
    const nextVersion = existing.length ? Math.max(...existing.map(q => q.version || 1)) + 1 : 1;
    const payload = { project_id: currentProject.id, version: nextVersion, status: 'draft', subtotal: 0, tax: 0, total: 0, created_at: new Date().toISOString() };
    const newId = await sbInsert('quotes', payload);
    const q = assignOrgId({ id: newId || Date.now(), projectId: currentProject.id, version: nextVersion, status: 'draft', subtotal: 0, tax: 0, total: 0, createdAt: payload.created_at }, 'quotes');
    quotes.push(q);
    currentQuoteId = q.id;
    renderProjectPanelExtras(currentProject);
}
function recalcQuoteTotals(quote){
    const items = getQuoteItems(quote.id);
    const subtotal = items.reduce((sum,i)=> sum + (parseFloat(i.lineTotal||0) || 0), 0);
    const tax = parseFloat(quote.tax || 0) || 0;
    quote.subtotal = subtotal;
    quote.total = subtotal + tax;
}
async function saveQuoteTotals(quote){
    recalcQuoteTotals(quote);
    await sbUpdate('quotes', quote.id, { subtotal: quote.subtotal, tax: quote.tax || 0, total: quote.total });
}
async function addQuoteItem(){
    if (!currentProject) return;
    const quote = getActiveQuote(currentProject.id);
    if (!quote) return toast('Create a quote first');
    const name = ($('#qi-name').value || '').trim();
    const qty = parseFloat($('#qi-qty').value || '1');
    const unit = parseFloat($('#qi-unit').value || '0');
    const category = ($('#qi-cat').value || 'labor').trim();
    if (!name) return toast('Enter line item');
    const lineTotal = qty * unit;
    const payload = { quote_id: quote.id, name, qty, unit_price: unit, line_total: lineTotal, category };
    const newId = await sbInsert('quote_items', payload);
    quoteItems.push(assignOrgId({ id: newId || Date.now(), quoteId: quote.id, name, qty, unitPrice: unit, lineTotal, category }, 'quote_items'));
    $('#qi-name').value=''; $('#qi-qty').value='1'; $('#qi-unit').value='0'; $('#qi-cat').value='labor';
    await saveQuoteTotals(quote);
    renderProjectPanelExtras(currentProject);
}
 async function updateQuoteTax(val){
     if (!currentProject) return;
     const quote = getActiveQuote(currentProject.id);
     if (!quote) return;
     quote.tax = parseFloat(val || '0') || 0;
     await saveQuoteTotals(quote);
     renderProjectPanelExtras(currentProject);
 }

function getTodayIsoDate() {
    return new Date().toISOString().slice(0, 10);
}

function getDefaultQuoteExpiresAt() {
    const d = new Date();
    d.setDate(d.getDate() + 30);
    return d.toISOString().slice(0, 10);
}

function isQuoteExpired(quote) {
    if (!quote) return false;
    if ((quote.status || '').toLowerCase() === 'signed') return false;
    if (!quote.expiresAt) return false;
    return String(quote.expiresAt) < getTodayIsoDate();
}

async function updateQuoteExpiresAt(val) {
    if (!currentProject) return;
    const quote = getActiveQuote(currentProject.id);
    if (!quote) return;
    const next = (val || '').trim();
    quote.expiresAt = next || null;
    await sbUpdate('quotes', quote.id, { expires_at: quote.expiresAt });
    renderProjectPanelExtras(currentProject);
}
 async function setQuoteStatus(status){
     if (!currentProject) return;
     const quote = getActiveQuote(currentProject.id);
     if (!quote) return;
     quote.status = status;
     const payload = { status };
     if (status === 'sent' && !quote.expiresAt) {
         quote.expiresAt = getDefaultQuoteExpiresAt();
         payload.expires_at = quote.expiresAt;
     }
     await sbUpdate('quotes', quote.id, payload);
     renderProjectPanelExtras(currentProject);
 }
 async function signQuote(){
     if (!currentProject) return;
     const quote = getActiveQuote(currentProject.id);
     if (!quote) return;
     if (isQuoteExpired(quote)) return toast('Quote expired');
     const name = ($('#qi-sign-name').value || '').trim();
     const email = ($('#qi-sign-email').value || '').trim();
     if (!name) return toast('Enter signer name');
     quote.signedName = name;
    quote.signedEmail = email;
    quote.signedAt = new Date().toISOString();
    quote.status = 'signed';
    await sbUpdate('quotes', quote.id, { signed_name: name, signed_email: email, signed_at: quote.signedAt, status: 'signed' });
    renderProjectPanelExtras(currentProject);
    toast('Quote signed');
}
function downloadQuotePdfFromData(data) {
    try {
        const jsPDF = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null;
        if (!jsPDF) return false;

        const orgName = data.orgName || 'Quote';
        const projectName = data.projectName || '';
        const version = data.version || 1;
        const items = Array.isArray(data.items) ? data.items : [];
        const subtotal = Number(data.subtotal || 0) || 0;
        const tax = Number(data.tax || 0) || 0;
        const total = Number(data.total || 0) || 0;
        const filename = data.filename || 'quote.pdf';

        const doc = new jsPDF({ unit: 'pt', format: 'letter' });
        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        const margin = 40;
        let y = 54;

        doc.setFont('helvetica', 'bold');
        doc.setFontSize(18);
        doc.text(orgName, margin, y);
        y += 18;

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(11);
        doc.text(`Project: ${projectName}`, margin, y);
        y += 14;
        doc.text(`Quote Version: v${version}`, margin, y);
        y += 18;

        const colItem = margin;
        const colQty = pageW - margin - 200;
        const colUnit = pageW - margin - 120;
        const colTot = pageW - margin;

        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.text('Item', colItem, y);
        doc.text('Qty', colQty, y, { align: 'right' });
        doc.text('Unit', colUnit, y, { align: 'right' });
        doc.text('Total', colTot, y, { align: 'right' });
        y += 10;
        doc.setDrawColor(200);
        doc.line(margin, y, pageW - margin, y);
        y += 14;

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        const maxItemWidth = (colQty - 12) - colItem;

        for (const it of items) {
            const name = String(it.name || '');
            const qty = (Number(it.qty || it.quantity || 0) || 0);
            const unit = Number(it.unitPrice || it.unit_price || 0) || 0;
            const lineTotal = Number(it.lineTotal || it.line_total || 0) || 0;

            const lines = doc.splitTextToSize(name || '-', maxItemWidth);
            const rowHeight = Math.max(14, lines.length * 12);

            if (y + rowHeight + 120 > pageH) {
                doc.addPage();
                y = 54;
            }

            doc.text(lines, colItem, y);
            doc.text(String(qty || 1), colQty, y, { align: 'right' });
            doc.text(`$${unit.toFixed(2)}`, colUnit, y, { align: 'right' });
            doc.text(`$${lineTotal.toFixed(2)}`, colTot, y, { align: 'right' });
            y += rowHeight;
        }

        y += 10;
        doc.setDrawColor(220);
        doc.line(margin, y, pageW - margin, y);
        y += 16;

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(11);
        doc.text(`Subtotal: $${subtotal.toFixed(2)}`, colTot, y, { align: 'right' });
        y += 14;
        doc.text(`Tax: $${tax.toFixed(2)}`, colTot, y, { align: 'right' });
        y += 16;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(12);
        doc.text(`Total: $${total.toFixed(2)}`, colTot, y, { align: 'right' });

        doc.save(filename);
        return true;
    } catch (e) {
        console.warn('PDF generation failed:', e);
        return false;
    }
}

function downloadQuotePdf(){
    if (!currentProject) return;
    const quote = getActiveQuote(currentProject.id);
    if (!quote) return;
    const items = getQuoteItems(quote.id);
    const org = getActiveOrg();

    const ok = downloadQuotePdfFromData({
        orgName: org ? getOrgDisplayName(org) : 'Quote',
        projectName: currentProject.name || '',
        version: quote.version || 1,
        items: items.map(i => ({ name: i.name, qty: i.qty, unitPrice: i.unitPrice, lineTotal: i.lineTotal })),
        subtotal: quote.subtotal || 0,
        tax: quote.tax || 0,
        total: quote.total || 0,
        filename: sanitizeFilename(`Quote_${(currentProject.name || 'Project')}_v${quote.version || 1}.pdf`)
    });

    // Fallback: open printable HTML if jsPDF is blocked/unavailable
    if (ok) return;
    const html = `
        <html><head><title>Quote v${quote.version || 1}</title></head>
        <body style="font-family:Arial,sans-serif;padding:24px">
            <h2>${escapeHtml(org ? getOrgDisplayName(org) : 'Quote')}</h2>
            <div><strong>Project:</strong> ${escapeHtml(currentProject.name||'')}</div>
            <div><strong>Quote Version:</strong> ${quote.version || 1}</div>
            <table style="width:100%;border-collapse:collapse;margin-top:16px">
                <thead><tr><th style="text-align:left;border-bottom:1px solid #ccc;padding:6px">Item</th><th style="text-align:right;border-bottom:1px solid #ccc;padding:6px">Qty</th><th style="text-align:right;border-bottom:1px solid #ccc;padding:6px">Unit</th><th style="text-align:right;border-bottom:1px solid #ccc;padding:6px">Total</th></tr></thead>
                <tbody>
                ${items.map(i => `<tr><td style="padding:6px 0">${escapeHtml(i.name||'')}</td><td style="text-align:right">${i.qty||1}</td><td style="text-align:right">$${(i.unitPrice||0).toFixed(2)}</td><td style="text-align:right">$${(i.lineTotal||0).toFixed(2)}</td></tr>`).join('')}
                </tbody>
            </table>
            <div style="margin-top:12px;text-align:right"><div>Subtotal: $${(quote.subtotal||0).toFixed(2)}</div><div>Tax: $${(quote.tax||0).toFixed(2)}</div><div><strong>Total: $${(quote.total||0).toFixed(2)}</strong></div></div>
        </body></html>`;
    const w = window.open('', '_blank');
    if (w) { w.document.write(html); w.document.close(); w.focus(); }
}

async function createQuoteShareLink(){
    if (!currentProject) return;
    const quote = getActiveQuote(currentProject.id);
    if (!quote) return toast('Create a quote first');
    if (isQuoteExpired(quote)) return toast('Quote is expired');

    const exp = quote.expiresAt || getDefaultQuoteExpiresAt();
    if (!quote.expiresAt) {
        quote.expiresAt = exp;
        try { await sbUpdate('quotes', quote.id, { expires_at: exp }); } catch(e) {}
    }

    const headers = { 'Content-Type': 'application/json' };
    const token = (typeof _authAccessToken === 'string' && _authAccessToken) ? _authAccessToken : '';
    if (token) headers['Authorization'] = 'Bearer ' + token;

    const resp = await fetch('/api/quote-share', {
        method: 'POST',
        headers,
        body: JSON.stringify({ quoteId: quote.id, orgId: getActiveOrgId(), expiresAt: exp })
    });
    const data = await resp.json().catch(()=> ({}));
    if (!resp.ok || !data.shareUrl) return toast(data.error || 'Failed to create share link');
    openQuoteShareLinkModal(data.shareUrl, data.expiresAt || exp);
}

function openQuoteShareLinkModal(url, expiresAt){
    const bg = document.createElement('div');
    bg.className = 'modal-bg open';
    bg.id = 'modal-quote-share';
    bg.innerHTML = `
      <div class="modal" style="max-width:640px">
        <div class="modal-header">
          <h2 class="modal-title">Quote Share Link</h2>
          <button class="modal-close" onclick="document.getElementById('modal-quote-share')?.remove()"></button>
        </div>
        <div class="modal-body">
          <div style="font-size:13px;color:var(--text2);margin-bottom:10px">Anyone with this link can view and download the quote until <strong>${escapeHtml(expiresAt || '')}</strong>.</div>
          <div class="form-group">
            <label class="form-label">Share URL</label>
            <input type="text" class="form-input" id="quote-share-url" value="${escapeHtml(url)}" readonly onclick="this.select()">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="document.getElementById('modal-quote-share')?.remove()">Close</button>
          <button class="btn btn-primary" onclick="copyQuoteShareUrl()">Copy Link</button>
        </div>
      </div>`;
    document.body.appendChild(bg);
}

async function copyQuoteShareUrl(){
    const el = document.getElementById('quote-share-url');
    const url = el ? el.value : '';
    if (!url) return;
    try { await navigator.clipboard.writeText(url); toast('Link copied'); }
    catch(e) { el.select(); document.execCommand('copy'); toast('Link copied'); }
}

/* ====================== QUOTE SHARE (PUBLIC LINK) ====================== */
let _quoteSharePayload = null;

function initQuoteShare() {
    try {
        const params = new URLSearchParams(window.location.search || '');
        const token = params.get('quote');
        if (!token) return false;

        const overlay = document.getElementById('quote-share-overlay');
        if (overlay) overlay.classList.add('active');

        const appEl = document.querySelector('.app');
        if (appEl) appEl.style.display = 'none';

        const auth = document.getElementById('auth-overlay');
        if (auth) auth.style.display = 'none';

        // Hide portal UI if present
        const portalOverlay = document.getElementById('portal-overlay');
        if (portalOverlay) portalOverlay.classList.remove('active');
        const portalDash = document.getElementById('portal-dash');
        if (portalDash) portalDash.classList.remove('active');

        loadQuoteSharePublic(token);
        return true;
    } catch (e) {
        return false;
    }
}

async function loadQuoteSharePublic(token) {
    const loading = document.getElementById('quote-share-loading');
    const error = document.getElementById('quote-share-error');
    const content = document.getElementById('quote-share-content');

    if (loading) loading.style.display = '';
    if (error) { error.style.display = 'none'; error.textContent = ''; }
    if (content) { content.style.display = 'none'; content.innerHTML = ''; }

    try {
        const resp = await fetch('/api/quote-share?token=' + encodeURIComponent(token));
        const data = await resp.json().catch(()=> ({}));
        if (!resp.ok || !data || !data.ok) {
            const msg = (data && data.error) ? data.error : 'Unable to load quote';
            if (error) { error.textContent = msg; error.style.display = 'block'; }
            return;
        }
        _quoteSharePayload = data;
        renderQuoteSharePublic(data);
    } catch (e) {
        if (error) { error.textContent = 'Network error loading quote'; error.style.display = 'block'; }
    } finally {
        if (loading) loading.style.display = 'none';
    }
}

function renderQuoteSharePublic(data) {
    const brand = document.getElementById('quote-share-brand');
    const content = document.getElementById('quote-share-content');
    if (!content) return;

    const orgName = (data.org && data.org.name) ? data.org.name : 'Quote';
    if (brand) brand.innerHTML = `<span>V</span> ${escapeHtml(orgName)} Quote`;

    const projectName = (data.project && data.project.name) ? data.project.name : '';
    const quote = data.quote || {};
    const items = Array.isArray(data.items) ? data.items : [];
    const version = quote.version || 1;
    const expires = quote.expires_at || (data.share ? data.share.expires_at : '') || '';
    const subtotal = Number(quote.subtotal || 0) || 0;
    const tax = Number(quote.tax || 0) || 0;
    const total = Number(quote.total || 0) || 0;

    const rows = items.length ? items.map(it => {
        const name = escapeHtml(it.name || '');
        const qty = (it.qty != null ? it.qty : it.quantity);
        const unit = (it.unit_price != null ? it.unit_price : it.unitPrice);
        const line = (it.line_total != null ? it.line_total : it.lineTotal);
        return `<tr>
          <td>${name}</td>
          <td style="text-align:right">${qty != null ? qty : ''}</td>
          <td style="text-align:right">${unit != null ? '$' + (Number(unit)||0).toFixed(2) : ''}</td>
          <td style="text-align:right">${line != null ? '$' + (Number(line)||0).toFixed(2) : ''}</td>
        </tr>`;
    }).join('') : '<tr><td colspan="4" style="color:var(--muted);padding:14px 8px">No line items.</td></tr>';

    content.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap">
        <div>
          <h2 style="font-size:20px;font-weight:800;margin-bottom:4px">${escapeHtml(projectName || 'Project')}</h2>
          <div style="color:var(--text2);font-size:13px">Quote v${version}${expires ? '  Expires ' + escapeHtml(expires) : ''}</div>
        </div>
        <div class="quote-share-actions">
          <button class="btn btn-outline" onclick="downloadSharedQuotePdf()">Download PDF</button>
        </div>
      </div>

      <table class="quote-share-table">
        <thead>
          <tr><th>Item</th><th style="text-align:right">Qty</th><th style="text-align:right">Unit</th><th style="text-align:right">Total</th></tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>

      <div class="quote-share-total">
        <div>Subtotal: $${subtotal.toFixed(2)}</div>
        <div>Tax: $${tax.toFixed(2)}</div>
        <div><strong>Total: $${total.toFixed(2)}</strong></div>
      </div>

      <div style="margin-top:16px;font-size:12px;color:var(--muted)">
        This link is private. Please do not forward unless intended.
      </div>
    `;

    content.style.display = '';
}

function downloadSharedQuotePdf() {
    if (!_quoteSharePayload || !_quoteSharePayload.quote) return;
    const data = _quoteSharePayload;
    const orgName = (data.org && data.org.name) ? data.org.name : 'Quote';
    const projectName = (data.project && data.project.name) ? data.project.name : '';
    const quote = data.quote || {};
    const version = quote.version || 1;
    const items = Array.isArray(data.items) ? data.items : [];
    const filename = sanitizeFilename(`Quote_${(projectName || 'Project')}_v${version}.pdf`);

    const ok = downloadQuotePdfFromData({
        orgName,
        projectName,
        version,
        items,
        subtotal: quote.subtotal || 0,
        tax: quote.tax || 0,
        total: quote.total || 0,
        filename
    });
    if (!ok) alert('PDF download unavailable on this browser.');
}

function renderBmgQuote(project){
    if (!isBmgContext(project)) return '<div style="color:var(--muted);font-size:12px">Quotes are used for moving projects.</div>';
    const list = getQuotesForProject(project.id);
    const active = getActiveQuote(project.id);
    let h = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-size:12px;color:var(--text2)">Versions</div><button class="btn btn-outline" style="padding:4px 10px;font-size:11px" onclick="createQuoteVersion()">+ New Version</button></div>';
    h += list.length ? '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">' + list.map(q => {
        const status = q.status || 'draft';
        const activeCls = active && String(active.id) === String(q.id) ? 'background:var(--blue-lt);color:var(--blue);' : '';
        return `<button class="btn btn-outline" style="padding:4px 8px;font-size:11px;${activeCls}" onclick="currentQuoteId='${q.id}';renderProjectPanelExtras(currentProject)">v${q.version || 1}  ${status}</button>`;
    }).join('') + '</div>' : '<div style="color:var(--muted);font-size:12px;margin-bottom:8px">No quotes yet.</div>';
    if (!active) return h;
    const items = getQuoteItems(active.id);
    recalcQuoteTotals(active);
    const expired = isQuoteExpired(active);
    h += '<div class="mini-card" style="background:#fff;border:1px solid var(--border)">';
    h += '<div class="form-row"><div class="form-group"><label class="form-label">Status</label><select class="form-select" onchange="setQuoteStatus(this.value)">' +
        ['draft','sent','approved','signed','expired'].map(s => `<option value="${s}" ${active.status===s?'selected':''}>${s}</option>`).join('') + '</select></div>' +
        '<div class="form-group"><label class="form-label">Expires</label><input type="date" class="form-input" value="'+escapeHtml(active.expiresAt||'')+'" onblur="updateQuoteExpiresAt(this.value)"></div></div>';
    h += '<div class="form-row"><div class="form-group"><label class="form-label">Tax</label><input type="number" class="form-input" value="'+(active.tax||0)+'" onblur="updateQuoteTax(this.value)"></div>' +
        '<div class="form-group"><label class="form-label">Share Link</label><button class="btn btn-outline" style="width:100%" onclick="createQuoteShareLink()">Generate Link</button></div></div>';
    h += items.length ? items.map(i => `<div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px"><span>${escapeHtml(i.name||'')}</span><span>$${(i.lineTotal||0).toFixed(2)}</span></div>`).join('') : '<div style="font-size:12px;color:var(--muted)">No line items yet.</div>';
    h += '<div style="margin-top:8px;font-size:12px;text-align:right"><div>Subtotal: $'+(active.subtotal||0).toFixed(2)+'</div><div>Tax: $'+(active.tax||0).toFixed(2)+'</div><div><strong>Total: $'+(active.total||0).toFixed(2)+'</strong></div></div>';
    if (expired) h += '<div style="margin-top:8px;font-size:12px;color:var(--red)">This quote is expired (set a new expiration date to re-enable).</div>';
    h += '<div style="margin-top:10px;border-top:1px solid var(--border);padding-top:8px">' +
        '<div class="form-row"><div class="form-group"><label class="form-label">Line Item</label><input type="text" class="form-input" id="qi-name" placeholder="Labor, packing, truck"></div>' +
        '<div class="form-group"><label class="form-label">Qty</label><input type="number" class="form-input" id="qi-qty" value="1" min="1"></div></div>' +
        '<div class="form-row"><div class="form-group"><label class="form-label">Unit Price</label><input type="number" class="form-input" id="qi-unit" value="0"></div>' +
        '<div class="form-group"><label class="form-label">Category</label><select class="form-select" id="qi-cat"><option value="labor">Labor</option><option value="material">Material</option><option value="misc">Misc</option></select></div></div>' +
        '<div style="display:flex;justify-content:flex-end"><button class="btn btn-outline" onclick="addQuoteItem()">Add Line</button></div></div>';
    h += '<div style="margin-top:10px;border-top:1px solid var(--border);padding-top:8px">' +
        '<div class="form-row"><div class="form-group"><label class="form-label">Signer Name</label><input type="text" class="form-input" id="qi-sign-name" value="'+escapeHtml(active.signedName||'')+'"></div>' +
        '<div class="form-group"><label class="form-label">Signer Email</label><input type="email" class="form-input" id="qi-sign-email" value="'+escapeHtml(active.signedEmail||'')+'"></div></div>' +
        '<div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap"><button class="btn btn-outline" onclick="downloadQuotePdf()">Download PDF</button><button class="btn btn-primary" '+(expired?'disabled style=\"opacity:0.6;cursor:not-allowed\"':'')+' onclick="signQuote()">Sign Quote</button></div></div>';
    h += '</div>';
    return h;
}

function getMilestones(projectId){
    return (moveMilestones || []).filter(m => m.projectId === projectId);
}
async function initMoveMilestones(project){
    const existing = getMilestones(project.id);
    if (existing.length) return;
    const created = [];
    for (const stage of BMG_MILESTONE_STAGES) {
        const payload = { project_id: project.id, stage: stage.key, status: 'pending', updated_at: new Date().toISOString() };
        const newId = await sbInsert('move_milestones', payload);
        created.push(assignOrgId({ id: newId || Date.now(), projectId: project.id, stage: stage.key, status: 'pending', updatedAt: payload.updated_at }, 'move_milestones'));
    }
    moveMilestones = moveMilestones.concat(created);
    renderProjectPanelExtras(currentProject);
}
async function updateMilestone(id, field, value){
    const m = moveMilestones.find(x => String(x.id) === String(id));
    if (!m) return;
    m[field] = value;
    m.updatedAt = new Date().toISOString();
    const payload = { updated_at: m.updatedAt };
    payload[field === 'dueDate' ? 'due_date' : field] = value;
    await sbUpdate('move_milestones', id, payload);
    if (field === 'status' && (value === 'in-progress' || value === 'complete')) {
        await updateProjectStatusForBmg(m.stage);
    }
    renderProjectPanelExtras(currentProject);
}
function renderBmgMilestones(project){
    if (!isBmgContext(project)) return '<div style="color:var(--muted);font-size:12px">Milestones are for moving projects.</div>';
    const stages = getMilestones(project.id);
    if (!stages.length) return '<div class="mini-card" style="background:#fff;border:1px solid var(--border)"><div style="font-weight:600;margin-bottom:6px">Initialize Milestones</div><div style="font-size:12px;color:var(--text2);margin-bottom:8px">Create the standard move milestones for this project.</div><button class="btn btn-outline" onclick="initMoveMilestones(currentProject)">Create Milestones</button></div>';
    return stages.map(m => {
        const label = (BMG_MILESTONE_STAGES.find(s => s.key === m.stage)?.label) || m.stage;
        return `<div class="mini-card" style="background:#fff;border:1px solid var(--border)">
            <div style="display:flex;justify-content:space-between;align-items:center"><strong>${label}</strong>
            <select class="form-select" style="width:120px" onchange="updateMilestone(${m.id},'status',this.value)">
                <option value="pending" ${m.status==='pending'?'selected':''}>Pending</option>
                <option value="in-progress" ${m.status==='in-progress'?'selected':''}>In Progress</option>
                <option value="complete" ${m.status==='complete'?'selected':''}>Complete</option>
            </select></div>
            <div class="form-group" style="margin-top:6px"><label class="form-label">Due Date</label><input type="date" class="form-input" value="${m.dueDate||''}" onchange="updateMilestone(${m.id},'dueDate',this.value)"></div>
        </div>`;
    }).join('');
}

async function addMoveAccess(){
    if (!currentProject) return;
    const location = ($('#ma-location').value || '').trim();
    const contactName = ($('#ma-contact-name').value || '').trim();
    const contactPhone = ($('#ma-contact-phone').value || '').trim();
    const contactEmail = ($('#ma-contact-email').value || '').trim();
    const dockReservation = ($('#ma-dock').value || '').trim();
    const elevatorReservation = ($('#ma-elevator').value || '').trim();
    const coiStatus = ($('#ma-coi').value || 'pending');
    const notes = ($('#ma-notes').value || '').trim();
    if (!location) return toast('Enter location');
    const payload = { project_id: currentProject.id, location, contact_name: contactName, contact_phone: contactPhone, contact_email: contactEmail, dock_reservation: dockReservation, elevator_reservation: elevatorReservation, coi_status: coiStatus, notes, updated_at: new Date().toISOString() };
    const newId = await sbInsert('move_access', payload);
    moveAccess.push(assignOrgId({ id: newId || Date.now(), projectId: currentProject.id, location, contactName, contactPhone, contactEmail, dockReservation, elevatorReservation, coiStatus, notes, updatedAt: payload.updated_at }, 'move_access'));
    ['ma-location','ma-contact-name','ma-contact-phone','ma-contact-email','ma-dock','ma-elevator','ma-notes'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value='';});
    renderProjectPanelExtras(currentProject);
}
function renderBmgAccess(project){
    if (!isBmgContext(project)) return '<div style="color:var(--muted);font-size:12px">Access tracking is for moving projects.</div>';
    const entries = moveAccess.filter(a => a.projectId === project.id);
    let h = '<div class="mini-card" style="background:#fff;border:1px solid var(--border)">';
    h += '<div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" id="ma-location" placeholder="Building address"></div>';
    h += '<div class="form-row"><div class="form-group"><label class="form-label">Contact Name</label><input type="text" class="form-input" id="ma-contact-name"></div><div class="form-group"><label class="form-label">Contact Phone</label><input type="text" class="form-input" id="ma-contact-phone"></div></div>';
    h += '<div class="form-group"><label class="form-label">Contact Email</label><input type="email" class="form-input" id="ma-contact-email"></div>';
    h += '<div class="form-row"><div class="form-group"><label class="form-label">Dock Reservation</label><input type="text" class="form-input" id="ma-dock" placeholder="Time/permit"></div><div class="form-group"><label class="form-label">Elevator Reservation</label><input type="text" class="form-input" id="ma-elevator" placeholder="Time/permit"></div></div>';
    h += '<div class="form-row"><div class="form-group"><label class="form-label">COI Status</label><select class="form-select" id="ma-coi"><option value="pending">Pending</option><option value="sent">Sent</option><option value="approved">Approved</option></select></div><div class="form-group"><label class="form-label">Notes</label><input type="text" class="form-input" id="ma-notes" placeholder="Access instructions"></div></div>';
    h += '<div style="display:flex;justify-content:flex-end"><button class="btn btn-outline" onclick="addMoveAccess()">Add Access</button></div></div>';
    if (entries.length) {
        h += entries.map(a => `<div class="mini-card" style="background:#fff;border:1px solid var(--border)"><strong>${escapeHtml(a.location||'Location')}</strong>
            <div style="font-size:12px;color:var(--text2)">${escapeHtml(a.contactName||'')}${a.contactPhone ? '  '+escapeHtml(a.contactPhone) : ''}${a.contactEmail ? '  '+escapeHtml(a.contactEmail) : ''}</div>
            <div style="font-size:11px;color:var(--muted)">${a.dockReservation ? 'Dock: '+escapeHtml(a.dockReservation)+' ' : ''}${a.elevatorReservation ? 'Elevator: '+escapeHtml(a.elevatorReservation) : ''}</div>
            <div style="font-size:11px;color:var(--muted)">COI: ${escapeHtml(a.coiStatus||'pending')}</div>
        </div>`).join('');
    } else {
        h += '<div style="color:var(--muted);font-size:12px;margin-top:6px">No access entries yet.</div>';
    }
    return h;
}

function renderBmgFloorplans(project){
    if (!isBmgContext(project)) return '<div style="color:var(--muted);font-size:12px">Upload floor plans for moving projects.</div>';
    const docs = project.docs || {};
    const defs = [
        { k: 'floorPlan', n: 'Floor Plan' },
        { k: 'zoneMap', n: 'Zone Map' },
        { k: 'destinationMap', n: 'Destination Map' }
    ];
    return defs.map(d => {
        const entry = normalizeDocEntry(docs[d.k]);
        const hasUrl = entry && entry.url;
        const fileName = entry && entry.name ? entry.name : (hasUrl ? 'View file' : 'No file uploaded');
        return `<div class="doc-item">
            <div style="font-size:20px"></div>
            <div><div style="font-weight:500">${d.n}</div><div class="doc-meta">${escapeHtml(fileName)}</div></div>
            <div class="doc-actions">
                <button class="btn btn-outline" onclick="uploadDoc('${d.k}')">Upload</button>
                ${hasUrl ? `<a class="btn btn-primary" href="${escapeHtml(entry.url)}" target="_blank" rel="noopener">Download</a>` : ''}
            </div>
        </div>`;
    }).join('');
}

async function addMoveLabels(){
    if (!currentProject) return;
    const zone = ($('#ml-zone').value || '').trim();
    const destination = ($('#ml-dest').value || '').trim();
    const color = ($('#ml-color').value || '').trim();
    const qty = parseInt($('#ml-qty').value || '1', 10);
    if (!zone) return toast('Enter zone');
    const created = [];
    for (let i = 0; i < qty; i++) {
        const code = `LBL-${currentProject.id}-${Date.now().toString(36).slice(-6)}-${i+1}`;
        const qrDataUrl = await generateQrDataUrl(code);
        const payload = { project_id: currentProject.id, code, zone, destination, color, qr_data_url: qrDataUrl, created_at: new Date().toISOString() };
        const newId = await sbInsert('move_labels', payload);
        created.push(assignOrgId({ id: newId || Date.now(), projectId: currentProject.id, code, zone, destination, color, qrDataUrl, createdAt: payload.created_at }, 'move_labels'));
    }
    moveLabels = moveLabels.concat(created);
    $('#ml-zone').value = ''; $('#ml-dest').value = ''; $('#ml-qty').value = '1'; $('#ml-color').value='';
    renderProjectPanelExtras(currentProject);
}
function printMoveLabels(){
    if (!currentProject) return;
    const labels = moveLabels.filter(l => l.projectId === currentProject.id);
    if (!labels.length) return toast('No labels');
    const html = `<html><head><title>Labels</title></head><body style="font-family:Arial,sans-serif;padding:16px">
        <h3>Labels  ${escapeHtml(currentProject.name||'')}</h3>
        <div style="display:flex;flex-wrap:wrap;gap:12px">${labels.map(l => `<div style="border:1px solid #ccc;padding:8px;width:180px"><div><strong>${escapeHtml(l.zone||'')}</strong></div><div style="font-size:12px">${escapeHtml(l.destination||'')}</div><div style="font-size:11px;color:#666">${escapeHtml(l.code||'')}</div>${l.qrDataUrl ? `<img src="${l.qrDataUrl}" style="width:120px;height:120px">` : ''}</div>`).join('')}</div>
        </body></html>`;
    const w = window.open('', '_blank');
    if (w) { w.document.write(html); w.document.close(); w.focus(); }
}
function renderBmgLabels(project){
    if (!isBmgContext(project)) return '<div style="color:var(--muted);font-size:12px">Labels are for moving projects.</div>';
    const labels = moveLabels.filter(l => l.projectId === project.id);
    let h = '<div class="mini-card" style="background:#fff;border:1px solid var(--border)">' +
        '<div class="form-row"><div class="form-group"><label class="form-label">Zone</label><input type="text" class="form-input" id="ml-zone" placeholder="Zone A"></div>' +
        '<div class="form-group"><label class="form-label">Destination</label><input type="text" class="form-input" id="ml-dest" placeholder="Floor 4 / Room 410"></div></div>' +
        '<div class="form-row"><div class="form-group"><label class="form-label">Qty</label><input type="number" class="form-input" id="ml-qty" value="1" min="1"></div>' +
        '<div class="form-group"><label class="form-label">Color</label><input type="text" class="form-input" id="ml-color" placeholder="Blue"></div></div>' +
        '<div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-outline" onclick="addMoveLabels()">Generate</button><button class="btn btn-outline" onclick="printMoveLabels()">Print</button></div></div>';
    if (!labels.length) return h + '<div style="color:var(--muted);font-size:12px">No labels yet.</div>';
    h += labels.map(l => `<div class="mini-card" style="display:flex;gap:12px;align-items:center;background:#fff;border:1px solid var(--border)">
        <div style="flex:1"><strong>${escapeHtml(l.zone||'')}</strong><div style="font-size:12px;color:var(--text2)">${escapeHtml(l.destination||'')}</div><div style="font-size:11px;color:var(--muted)">${escapeHtml(l.code||'')}</div></div>
        ${l.qrDataUrl ? `<img src="${l.qrDataUrl}" style="width:70px;height:70px;border:1px solid var(--border);border-radius:6px">` : ''}
    </div>`).join('');
    return h;
}

async function addMoveMaterial(){
    if (!currentProject) return;
    const name = ($('#mm-name').value || '').trim();
    const plannedQty = parseFloat($('#mm-planned').value || '0') || 0;
    const actualQty = parseFloat($('#mm-actual').value || '0') || 0;
    const unitCost = parseFloat($('#mm-unit').value || '0') || 0;
    if (!name) return toast('Enter material');
    const totalCost = (actualQty || plannedQty) * unitCost;
    const payload = { project_id: currentProject.id, name, planned_qty: plannedQty, actual_qty: actualQty, unit_cost: unitCost, total_cost: totalCost, updated_at: new Date().toISOString() };
    const newId = await sbInsert('move_materials', payload);
    moveMaterials.push(assignOrgId({ id: newId || Date.now(), projectId: currentProject.id, name, plannedQty, actualQty, unitCost, totalCost, updatedAt: payload.updated_at }, 'move_materials'));
    $('#mm-name').value=''; $('#mm-planned').value=''; $('#mm-actual').value=''; $('#mm-unit').value='';
    renderProjectPanelExtras(currentProject);
}
function renderBmgMaterials(project){
    if (!isBmgContext(project)) return '<div style="color:var(--muted);font-size:12px">Materials tracking is for moving projects.</div>';
    const list = moveMaterials.filter(m => m.projectId === project.id);
    let h = '<div class="mini-card" style="background:#fff;border:1px solid var(--border)"><div class="form-row"><div class="form-group"><label class="form-label">Material</label><input type="text" class="form-input" id="mm-name" placeholder="Boxes, tape"></div>' +
        '<div class="form-group"><label class="form-label">Planned Qty</label><input type="number" class="form-input" id="mm-planned"></div></div>' +
        '<div class="form-row"><div class="form-group"><label class="form-label">Actual Qty</label><input type="number" class="form-input" id="mm-actual"></div>' +
        '<div class="form-group"><label class="form-label">Unit Cost</label><input type="number" class="form-input" id="mm-unit"></div></div>' +
        '<div style="display:flex;justify-content:flex-end"><button class="btn btn-outline" onclick="addMoveMaterial()">Add Material</button></div></div>';
    if (!list.length) return h + '<div style="color:var(--muted);font-size:12px">No materials yet.</div>';
    const total = list.reduce((s,m)=>s+(m.totalCost||0),0);
    h += list.map(m => `<div class="mini-card" style="background:#fff;border:1px solid var(--border)"><strong>${escapeHtml(m.name||'')}</strong>
        <div style="font-size:12px;color:var(--text2)">Planned: ${m.plannedQty || 0}  Actual: ${m.actualQty || 0}</div>
        <div style="font-size:11px;color:var(--muted)">Unit: $${(m.unitCost||0).toFixed(2)}  Total: $${(m.totalCost||0).toFixed(2)}</div></div>`).join('');
    h += `<div style="text-align:right;font-weight:600;margin-top:6px">Total Materials: $${total.toFixed(2)}</div>`;
    return h;
}

function renderPmAccess(project){
    if (!project) return '';
    const canEdit = canEditFeature('pm_access');
    const emails = getProjectPmEmails(project);
    const val = emails.join(', ');
    const ro = canEdit ? '' : 'readonly';
    let h = '<div class="form-group" style="margin-bottom:8px">' +
        '<label class="form-label">Allowed PM Emails</label>' +
        '<input type="text" class="form-input" id="panel-pm-emails" value="' + escapeHtml(val) + '" placeholder="pm1@company.com, pm2@company.com" ' + ro + '>' +
        '<div class="form-hint">Client email always has access. Only listed PMs can see this project.</div>' +
        '</div>';
    if (canEdit) {
        const typeVal = getProjectType(project);
        h += '<div class="form-group" style="margin-bottom:8px"><label class="form-label">Project Type</label>' +
            '<select class="form-select" id="panel-project-type" onchange="updateProjectType(this.value)">' +
            '<option value="install"' + (typeVal === 'install' ? ' selected' : '') + '>Install</option>' +
            '<option value="move"' + (typeVal === 'move' ? ' selected' : '') + '>Move (B2B Relocation)</option>' +
            '</select></div>';
    }
    if (canEdit) {
        h += '<button class="btn btn-outline" onclick="saveProjectPmEmails()">Save PM Access</button>';
    } else {
        h += '<div style="font-size:11px;color:var(--muted)">Office access only.</div>';
    }
    return h;
}

async function saveProjectPmEmails(){
    if (!currentProject) return;
    if (!canEditFeature('pm_access')) return toast('Office access only');
    const input = document.getElementById('panel-pm-emails');
    const emails = normalizeEmailList(parseEmailList(input?.value || ''));
    currentProject.pm_emails = emails;
    await sbUpdate('projects', currentProject.id, { pm_emails: emails });
    saveLocal();
    toast('PM access updated');
}

async function updateProjectType(val){
    if (!currentProject) return;
    if (!canEditFeature('pm_access')) return toast('Office access only');
    const type = (val || 'install').toLowerCase();
    currentProject.projectType = type;
    await sbUpdate('projects', currentProject.id, { project_type: type });
    saveLocal();
    openPanel(currentProject.id);
    toast('Project type updated');
}

function renderProjectPanelExtras(project){
    if (!project) return;
    const readinessEl = document.getElementById('panel-readiness');
    const issuesEl = document.getElementById('panel-issues');
    const returnsEl = document.getElementById('panel-returns');
    const timeEl = document.getElementById('panel-time');
    const updatesEl = document.getElementById('panel-updates');
    const coEl = document.getElementById('panel-change-orders');
    const pmAccessEl = document.getElementById('panel-pm-access');
    const moveChecklistEl = document.getElementById('panel-move-checklist');
    const moveInventoryEl = document.getElementById('panel-move-inventory');
    const surveyEl = document.getElementById('panel-survey');
    const quoteEl = document.getElementById('panel-quote');
    const milestonesEl = document.getElementById('panel-milestones');
    const accessEl = document.getElementById('panel-access');
    const floorplansEl = document.getElementById('panel-floorplans');
    const labelsEl = document.getElementById('panel-labels');
    const materialsEl = document.getElementById('panel-materials');
    if (readinessEl) readinessEl.innerHTML = renderJobsiteReadiness(project);
    if (issuesEl) issuesEl.innerHTML = renderFieldIssues(project);
    if (returnsEl) returnsEl.innerHTML = renderReturnsBackorders(project);
    if (timeEl) timeEl.innerHTML = renderTimeEntries(project);
    if (updatesEl) updatesEl.innerHTML = renderProjectUpdates(project);
    if (coEl) coEl.innerHTML = renderChangeOrders(project);
    if (pmAccessEl) pmAccessEl.innerHTML = renderPmAccess(project);
    if (moveChecklistEl) moveChecklistEl.innerHTML = renderMoveChecklist(project);
    if (moveInventoryEl) moveInventoryEl.innerHTML = renderMoveInventory(project);
    if (surveyEl) surveyEl.innerHTML = renderBmgSurvey(project);
    if (quoteEl) quoteEl.innerHTML = renderBmgQuote(project);
    if (milestonesEl) milestonesEl.innerHTML = renderBmgMilestones(project);
    if (accessEl) accessEl.innerHTML = renderBmgAccess(project);
    if (floorplansEl) floorplansEl.innerHTML = renderBmgFloorplans(project);
    if (labelsEl) labelsEl.innerHTML = renderBmgLabels(project);
    if (materialsEl) materialsEl.innerHTML = renderBmgMaterials(project);
}

function openShipmentPanel(shipId) {
    const s = shipments.find(x => x.id === shipId);
    if (!s) return;
    $('#panel-title').textContent = s.subitem || s.po;
    $('#panel-subtitle').textContent = 'PO: ' + s.po;
    $('#panel-tabs').style.display = 'none';
    let h = '<div style="margin-bottom:12px;font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px">DETAILS</div>';
    const locOpts = buildLocationOptions(s.location || '');
    // Client - editable dropdown
    h += '<div class="panel-field"><div class="panel-field-label">Client</div><div class="panel-field-value"><select class="form-select" onchange="updateShipmentField('+s.id+',\'clientId\',+this.value)" style="max-width:220px">';
    h += '<option value="">Select...</option>';
    getOrgClients().forEach(c => { h += '<option value="'+c.id+'"'+(s.clientId===c.id?' selected':'')+'>'+c.company+'</option>'; });
    h += '</select></div></div>';
    // Project - editable dropdown
    h += '<div class="panel-field"><div class="panel-field-label">Project</div><div class="panel-field-value"><select class="form-select" onchange="updateShipmentField('+s.id+',\'projectId\',+this.value)" style="max-width:220px">';
    h += '<option value="">Select...</option>';
    getOrgProjects().forEach(p => { h += '<option value="'+p.id+'"'+(s.projectId===p.id?' selected':'')+'>'+p.name+'</option>'; });
    h += '</select></div></div>';
    // Manufacturer - editable text
    h += '<div class="panel-field"><div class="panel-field-label">Manufacturer</div><div class="panel-field-value"><input type="text" class="form-input" value="'+(s.mfr||'')+'" onchange="updateShipmentField('+s.id+',\'mfr\',this.value)" style="max-width:220px"></div></div>';
    // Vendor - editable text
    h += '<div class="panel-field"><div class="panel-field-label">Vendor</div><div class="panel-field-value"><input type="text" class="form-input" value="'+(s.vendor||'')+'" onchange="updateShipmentField('+s.id+',\'vendor\',this.value)" style="max-width:220px"></div></div>';
    // Lead Time Days
    h += '<div class="panel-field"><div class="panel-field-label">Lead Time (days)</div><div class="panel-field-value"><input type="number" class="form-input" value="'+(s.leadTimeDays||'')+'" onchange="updateShipmentField('+s.id+',\'leadTimeDays\',+this.value)" style="max-width:220px"></div></div>';
    // Location - dropdown
    h += '<div class="panel-field"><div class="panel-field-label">Location</div><div class="panel-field-value"><select class="form-select" onchange="onShipmentLocationChange('+s.id+',this)" style="max-width:220px">' + locOpts + '</select></div></div>';
    // Status - editable dropdown
    h += '<div class="panel-field"><div class="panel-field-label">Status</div><div class="panel-field-value"><select class="form-select" onchange="updateShipmentField('+s.id+',\'status\',this.value)" style="max-width:220px">';
    h += '<option value="received"'+(s.status==='received'?' selected':'')+'>Received</option>';
    h += '<option value="not-received"'+(s.status==='not-received'?' selected':'')+'>Not Received</option>';
    h += '<option value="backorder"'+(s.status==='backorder'?' selected':'')+'>Backorder</option>';
    h += '<option value="return"'+(s.status==='return'?' selected':'')+'>Return</option>';
    h += '</select></div></div>';
    // Inventory - editable dropdown
    h += '<div class="panel-field"><div class="panel-field-label">Inventory</div><div class="panel-field-value"><select class="form-select" onchange="updateShipmentField('+s.id+',\'inventoryStatus\',this.value)" style="max-width:220px">';
    h += '<option value="in-warehouse"'+(s.inventoryStatus==='in-warehouse'?' selected':'')+'>In Warehouse</option>';
    h += '<option value="dispatched"'+(s.inventoryStatus==='dispatched'?' selected':'')+'>Dispatched</option>';
    h += '<option value="delivered"'+(s.inventoryStatus==='delivered'?' selected':'')+'>Delivered</option>';
    h += '</select></div></div>';
    // Received Date - editable
    h += '<div class="panel-field"><div class="panel-field-label">Received Date</div><div class="panel-field-value"><input type="date" class="form-input" value="'+(s.date||'')+'" onchange="updateShipmentField('+s.id+',\'date\',this.value)" style="max-width:220px"></div></div>';
    // Expected Date - editable
    h += '<div class="panel-field"><div class="panel-field-label">Expected Date</div><div class="panel-field-value"><input type="date" class="form-input" value="'+(s.expectedDate||'')+'" onchange="updateShipmentField('+s.id+',\'expectedDate\',this.value)" style="max-width:220px"></div></div>';
    // ETA Date - editable
    h += '<div class="panel-field"><div class="panel-field-label">ETA Date</div><div class="panel-field-value"><input type="date" class="form-input" value="'+(s.etaDate||'')+'" onchange="updateShipmentField('+s.id+',\'etaDate\',this.value)" style="max-width:220px"></div></div>';
    $('#panel-details').innerHTML = h;
    $('#panel-team').innerHTML = '';
    $('#panel-shipments').innerHTML = '';
    document.querySelector('#panel-punchlist-stats')&&($('#panel-punchlist-stats').innerHTML = '');
    $('#panel-punchlist').innerHTML = '';
    $('#panel-docs').innerHTML = '';
    $('#panel-move-checklist').innerHTML = '';
    $('#panel-move-inventory').innerHTML = '';
    $('#panel-readiness').innerHTML = '';
    $('#panel-issues').innerHTML = '';
    $('#panel-returns').innerHTML = '';
    $('#panel-time').innerHTML = '';
    $('#panel-updates').innerHTML = '';
    $('#panel-change-orders').innerHTML = '';
    $('#panel-pm-access').innerHTML = '';
    $('#panel-tab-details').style.display = '';
    $('#panel-tab-completion').style.display = 'none';
    $('#panel').classList.add('open');
}

async function updateShipmentLocation(shipId, loc) {
    const s = shipments.find(x => x.id === shipId);
    if (!s) return;
    s.location = loc;
    if (loc && loc.trim() && s.inventoryStatus !== 'dispatched') {
        s.inventoryStatus = 'in-warehouse';
        s.status = 'received';
    }
    await sbUpdate('shipments', shipId, { sortly: loc, inventory_status: s.inventoryStatus, status: s.status });
    saveLocal();
    renderShipments();
    if(typeof renderWarehouse==='function' && document.getElementById('wh-content')) renderWarehouse();
    const sugEl = document.getElementById('loc-sug-'+shipId);
    if(sugEl) sugEl.style.display='none';
    toast('Location updated' + (loc ? '  moved to warehouse' : ''));
}

// Generic shipment field updater
async function updateShipmentField(shipId, field, value) {
    const s = shipments.find(x => x.id === shipId);
    if (!s) return;
    s[field] = value;
    // Map JS fields to DB fields
    const dbMap = { clientId:'client_id', projectId:'project_id', expectedDate:'expected_date', date:'received_date', inventoryStatus:'inventory_status', mfr:'mfr', status:'status', leadTimeDays:'lead_time_days', etaDate:'eta_date', poStatus:'po_status' };
    const dbField = dbMap[field] || field;
    const update = {};
    update[dbField] = value;
    await sbUpdate('shipments', shipId, update);
    saveLocal();
    renderShipments();
    toast(field.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()) + ' updated');
}

// Location autocomplete
function getKnownLocations() {
    if(typeof whBins!=='undefined' && whBins.length) {
        return whBins.map(function(b){ return b.name; }).sort();
    }
    var locs = new Set();
    shipments.forEach(function(s){ if(s.location && s.location.trim()) locs.add(s.location.trim()); });
    return Array.from(locs).sort();
}

function getProjectsForClient(clientId) {
    const visibleProjects = getVisibleProjects();
    if (!clientId) return visibleProjects;
    return visibleProjects.filter(p => p.clientId == clientId);
}

function showProjectSuggestions(input, sugId) {
    var term = (input.value || '').trim().toLowerCase();
    var clientId = +$('#f-client').value || 0;
    var list = getProjectsForClient(clientId);
    var filtered = term ? list.filter(function(p){ return (p.name || '').toLowerCase().includes(term); }) : list;
    var sugEl = document.getElementById(sugId);
    if (!sugEl) return;
    var rows = [];
    rows.push('<div class="loc-sug-item" onmousedown="selectProjectSuggestion(\'_unknown\',\'Unknown\',\'' + input.id + '\',\'' + sugId + '\')"><strong>Unknown</strong></div>');
    filtered.slice(0, 20).forEach(function(p) {
        rows.push('<div class="loc-sug-item" onmousedown="selectProjectSuggestion(\'' + p.id + '\',\'' + escapeHtml(p.name) + '\',\'' + input.id + '\',\'' + sugId + '\')"><strong>' + escapeHtml(p.name) + '</strong></div>');
    });
    sugEl.innerHTML = rows.join('');
    sugEl.style.display = 'block';
}

function selectProjectSuggestion(id, name, inputId, sugId) {
    var input = document.getElementById(inputId);
    var hidden = document.getElementById('f-project-id');
    if (input) input.value = name;
    if (hidden) hidden.value = id;
    var sugEl = document.getElementById(sugId);
    if (sugEl) sugEl.style.display = 'none';
}

function focusProjectInput(input, sugId) { showProjectSuggestions(input, sugId); }
function blurProjectInput(input, sugId) {
    setTimeout(()=>{ const sugEl=document.getElementById(sugId); if(sugEl) sugEl.style.display='none'; },200);
    var term = (input.value || '').trim().toLowerCase();
    if (!term) { $('#f-project-id').value = ''; return; }
    var clientId = +$('#f-client').value || 0;
    var list = getProjectsForClient(clientId);
    var exact = list.find(function(p){ return (p.name || '').toLowerCase() === term; });
    if (exact) {
        $('#f-project-id').value = exact.id;
    } else if (term === 'unknown') {
        $('#f-project-id').value = '_unknown';
    } else {
        $('#f-project-id').value = '';
    }
}

function buildLocationOptions(selected) {
    var opts = '<option value="">Select...</option>';
    var locs = getKnownLocations();
    if (selected && !locs.some(function(l){ return l === selected; })) {
        locs = [selected].concat(locs);
    }
    locs.forEach(function(l) {
        var safe = escapeHtml(l);
        opts += '<option value="' + safe + '"' + (selected && l === selected ? ' selected' : '') + '>' + safe + '</option>';
    });
    opts += '<option value="__custom__">Other</option>';
    return opts;
}

function normalizeLocationSelect(selectEl) {
    var val = selectEl.value || '';
    if (val === '__custom__') {
        var custom = prompt('Enter location');
        if (custom && custom.trim()) {
            var clean = custom.trim();
            var opt = document.createElement('option');
            opt.value = clean;
            opt.textContent = clean;
            selectEl.insertBefore(opt, selectEl.querySelector('option[value="__custom__"]'));
            selectEl.value = clean;
            val = clean;
        } else {
            selectEl.value = '';
            val = '';
        }
    }
    return val;
}

function onFormLocationChange(selectEl) {
    normalizeLocationSelect(selectEl);
}

function onShipmentLocationChange(shipId, selectEl) {
    var val = normalizeLocationSelect(selectEl);
    updateShipmentLocation(shipId, val);
}

function updateCamLocation(id, selectEl) {
    var val = normalizeLocationSelect(selectEl);
    updateCamEdit(id, 'location', val);
}

function showLocSuggestions(input, shipId) {
    var val = input.value.trim().toUpperCase().replace(/[-\s]/g, '');
    var allLocs = getKnownLocations();
    var filtered = val ? allLocs.filter(function(l) {
        return l.toUpperCase().replace(/[-\s]/g, '').indexOf(val) > -1;
    }) : allLocs;
    var limited = filtered.slice(0, 20);
    var sugEl = document.getElementById('loc-sug-' + shipId);
    if (!sugEl) return;
    if (limited.length === 0) { sugEl.style.display = 'none'; return; }
    sugEl.innerHTML = limited.map(function(l) {
        var display = l;
        if (val) {
            var idx = l.toUpperCase().replace(/[-\s]/g, '').indexOf(val);
            display = '<strong>' + l + '</strong>';
        } else {
            display = '<strong>' + l + '</strong>';
        }
        return '<div class="loc-sug-item" onmousedown="selectLocSuggestion(\'' + l + '\',' + shipId + ')">' + display + '</div>';
    }).join('');
    sugEl.style.display = 'block';
}

function focusLocInput(input, shipId) { showLocSuggestions(input, shipId); }
function blurLocInput(input, shipId) {
    setTimeout(()=>{ const sugEl=document.getElementById('loc-sug-'+shipId); if(sugEl) sugEl.style.display='none'; },200);
    const val = input.value.trim();
    if(val) { const locs=getKnownLocations(); if(!locs.some(l=>l.toLowerCase()===val.toLowerCase())){ input.value=''; toast('Please select a valid location from the list'); } }
}

function selectLocSuggestion(loc, shipId) {
    const input = document.getElementById('ship-loc-'+shipId);
    if(input) input.value = loc;
    const sugEl = document.getElementById('loc-sug-'+shipId);
    if(sugEl) sugEl.style.display='none';
    updateShipmentLocation(shipId, loc);
}

// Also for the scan form location autocomplete
function showFormLocSuggestions(input, sugId) {
    var val = input.value.trim().toUpperCase().replace(/[-\s]/g, '');
    var inputId = input.id || '';
    var allLocs = getKnownLocations();
    var filtered = val ? allLocs.filter(function(l) {
        return l.toUpperCase().replace(/[-\s]/g, '').indexOf(val) > -1;
    }) : allLocs;
    var limited = filtered.slice(0, 20);
    var sugEl = document.getElementById(sugId);
    if (!sugEl) return;
    if (limited.length === 0) { sugEl.style.display = 'none'; return; }
    sugEl.innerHTML = limited.map(function(l) {
        return '<div class="loc-sug-item" onmousedown="selectFormLocSuggestion(\'' + l + '\',\'' + inputId + '\',\'' + sugId + '\')"><strong>' + l + '</strong></div>';
    }).join('');
    sugEl.style.display = 'block';
}
function focusFormLocInput(input, sugId) { showFormLocSuggestions(input, sugId); }
function blurFormLocInput(input, sugId) {
    setTimeout(()=>{ const sugEl=document.getElementById(sugId); if(sugEl) sugEl.style.display='none'; },200);
    const val = input.value.trim();
    if(val) { const locs=getKnownLocations(); if(!locs.some(l=>l.toLowerCase()===val.toLowerCase())){ input.value=''; toast('Please select a valid location from the list'); } }
}
function selectFormLocSuggestion(loc, inputId, sugId) {
    document.getElementById(inputId).value = loc;
    document.getElementById(sugId).style.display = 'none';
}
async function toggleTeam(pid) {
    if (!currentProject) return;
    if (!currentProject.team) currentProject.team = [];
    const i = currentProject.team.indexOf(pid);
    if (i >= 0) currentProject.team.splice(i, 1);
    else currentProject.team.push(pid);

    await sbUpdate('projects', currentProject.id, { team: currentProject.team });
    saveLocal();
    openPanel(currentProject.id);
    renderCalendar();
}
const PROJECT_DOC_BUCKET = 'project-docs';
const DOC_ALLOWED_EXT = ['pdf','doc','docx'];

function normalizeDocEntry(entry) {
    if (!entry) return null;
    if (typeof entry === 'string') return { url: entry };
    if (entry === true) return { name: 'Uploaded' };
    if (typeof entry === 'object') return entry;
    return null;
}

function isAllowedDoc(file) {
    const name = (file && file.name) ? file.name.toLowerCase() : '';
    const ext = name.split('.').pop();
    if (DOC_ALLOWED_EXT.includes(ext)) return true;
    const type = (file && file.type) ? file.type.toLowerCase() : '';
    return type.includes('pdf') || type.includes('msword') || type.includes('wordprocessingml');
}

function sanitizeFilename(name) {
    return name.replace(/[^a-zA-Z0-9._-]/g, '_');
}

async function uploadProjectDoc(k, file) {
    if (!currentProject) return;
    if (!isAllowedDoc(file)) return toast('Only PDF/DOC/DOCX allowed');
    const outlookInt = getOutlookIntegration();
    if (!outlookInt || outlookInt.status !== 'connected') return toast('Connect Outlook to upload documents');
    const ok = await ensureOutlookUploaderAccount();
    if (!ok) return;
    const safeName = sanitizeFilename(file.name);
    try {
        const folderId = await ensureOutlookProjectFolder(currentProject);
        if (!folderId) return toast('Outlook folder error. Check permissions.');
        const item = await uploadFileToDrive(folderId, file, safeName);
        const shareEmails = getShareEmailsForProject(currentProject);
        if (shareEmails.length) await inviteDriveItem(item.id, shareEmails);
        else toast('No warehouse/crew emails set  file uploaded but not shared');
        if (!currentProject.docs) currentProject.docs = {};
        currentProject.docs[k] = {
            name: file.name,
            url: item.webUrl || '',
            driveItemId: item.id,
            storage: 'onedrive',
            uploadedAt: new Date().toISOString()
        };
        await sbUpdate('projects', currentProject.id, { docs: currentProject.docs });
        saveLocal();
        await updateOutlookEventDocs(currentProject);
        openPanel(currentProject.id);
        toast('Uploaded to Outlook');
    } catch (e) {
        console.error('Outlook upload error:', e);
        toast('Upload failed. Check Outlook connection.');
    }
}

async function uploadDoc(k) {
    if (!currentProject) return;
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document';
    input.onchange = async () => {
        const file = input.files && input.files[0];
        if (!file) return;
        await uploadProjectDoc(k, file);
    };
    input.click();
}
function notifyTeam() { if (!currentProject?.team?.length) return toast('No team'); const m = people.filter(p => currentProject.team.includes(p.id)); window.open(`mailto:${m.map(p=>p.email).join(';')}?subject=Install: ${currentProject.name}`, '_blank'); }

function renderDispatches() {
    // Consolidated dispatch - render loading sheet form and history
    renderLoadingSheet();
    renderLoadingHistory();
}

function updateAvailableItems() {
    const projId = +$('#d-project').value;
    if (!projId) {
        $('#d-items-list').innerHTML = '<div style="padding:12px;color:var(--muted)">Select a project first</div>';
        return;
    }

    const projShipments = getOrgShipments().filter(s => s.projectId === projId);
    if (projShipments.length === 0) {
        $('#d-items-list').innerHTML = '<div style="padding:12px;color:var(--muted)">No shipments for this project</div>';
        return;
    }

    // Group by PO number
    const poGroups = {};
    projShipments.forEach(s => {
        const po = s.po || s.subitem?.split('-')[0] || 'Unknown';
        if (!poGroups[po]) poGroups[po] = [];
        poGroups[po].push(s);
    });

    let html = '';
    Object.entries(poGroups).forEach(([po, items]) => {
        html += `<div style="border-bottom:2px solid var(--border)">`;
        html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--gray-lt);font-weight:600;font-size:13px">`;
        html += `<span>PO: ${po}</span><span style="font-size:11px;color:var(--text2)">${items.length} item${items.length>1?'s':''}</span></div>`;
        items.forEach(s => {
            const inWH = s.inventoryStatus === 'in-warehouse';
            const received = s.status === 'received';
            const dispatched = s.inventoryStatus === 'dispatched';
            let statusBadge = '';
            let disabled = '';
            if (dispatched) {
                statusBadge = '<span style="background:var(--blue-lt);color:var(--blue);padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600">DISPATCHED</span>';
                disabled = 'disabled';
            } else if (inWH && received) {
                statusBadge = '<span style="background:var(--green-lt);color:var(--green);padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600">IN WAREHOUSE</span>';
            } else if (inWH && !received) {
                statusBadge = '<span style="background:var(--yellow-lt);color:#b8860b;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600">PENDING</span>';
            } else {
                statusBadge = '<span style="background:var(--gray-lt);color:var(--muted);padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600">' + (s.inventoryStatus || s.status || 'UNKNOWN').toUpperCase() + '</span>';
            }
            const loc = s.location ? `<span style="font-size:11px;color:var(--text2);margin-left:4px">[${s.location}]</span>` : '';
            html += `<label style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);cursor:${disabled?'not-allowed':'pointer'};${dispatched?'opacity:0.5;':''}">`;
            html += `<input type="checkbox" class="d-item-checkbox" value="${s.id}" style="cursor:pointer;min-width:16px" ${disabled}>`;
            html += `<div style="flex:1;min-width:0">`;
            html += `<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap"><span style="font-family:monospace;font-size:13px;font-weight:500">${s.subitem || s.po}</span>${loc}</div>`;
            html += `<div style="display:flex;align-items:center;gap:6px;margin-top:3px">${statusBadge}`;
            if (s.mfr) html += `<span style="font-size:11px;color:var(--text2)">${s.mfr}</span>`;
            html += `</div></div></label>`;
        });
        html += `</div>`;
    });

    // Select all / deselect all controls
    const totalSelectable = projShipments.filter(s => s.inventoryStatus !== 'dispatched').length;
    let controls = `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:1">`;
    controls += `<span style="font-size:12px;font-weight:600;color:var(--text2)">${projShipments.length} shipment${projShipments.length>1?'s':''}</span>`;
    controls += `<div style="display:flex;gap:8px">`;
    controls += `<button onclick="document.querySelectorAll('.d-item-checkbox:not(:disabled)').forEach(c=>c.checked=true)" style="background:none;border:none;color:var(--blue);font-size:11px;cursor:pointer;font-weight:600">Select All</button>`;
    controls += `<button onclick="document.querySelectorAll('.d-item-checkbox').forEach(c=>c.checked=false)" style="background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;font-weight:600">Clear</button>`;
    controls += `</div></div>`;

    $('#d-items-list').innerHTML = controls + html;
}

function renderDispatchHistory() {
    const projId = +$('#d-project').value;
    if (!projId) {
        $('#d-history').innerHTML = '<div style="padding:12px;color:var(--muted)">Select a project to view history</div>';
        return;
    }

    const projDispatches = getOrgDispatches().filter(d => d.projectId === projId).sort((a, b) => new Date(b.dispatchDate) - new Date(a.dispatchDate));
    if (projDispatches.length === 0) {
        $('#d-history').innerHTML = '<div style="padding:12px;color:var(--muted)">No dispatches yet</div>';
        return;
    }

    let historyHtml = '';
    projDispatches.forEach(d => {
        const person = getOrgPeople().find(p => p.id === d.dispatchedById);
        const statusColor = d.status === 'loading' ? 'yellow' : d.status === 'in-transit' ? 'blue' : 'green';
        const itemCount = d.items?.length || 0;
        historyHtml += `<div style="padding:12px;border-bottom:1px solid var(--border);background:var(--gray-lt);border-radius:6px;margin-bottom:8px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <div style="font-weight:600">Dispatch ${d.id}</div>
                <div style="background:var(--${statusColor});color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;text-transform:capitalize">${d.status}</div>
            </div>
            <div style="font-size:12px;color:var(--text2);margin-bottom:4px"> ${new Date(d.dispatchDate).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'})}</div>
            <div style="font-size:12px;color:var(--text2);margin-bottom:4px"> ${person?.name || 'Unknown'}</div>
            <div style="font-size:12px;color:var(--text2);margin-bottom:4px"> ${d.vehicles?.join(', ') || 'N/A'}</div>
            <div style="font-size:12px;color:var(--text2);margin-bottom:4px">${itemCount} items dispatched</div>
            ${d.notes ? '<div style="font-size:12px;color:var(--muted);margin-top:6px;padding-top:6px;border-top:1px solid var(--border)"><strong>Notes:</strong> ' + d.notes + '</div>' : ''}
        </div>`;
    });
    $('#d-history').innerHTML = historyHtml;
}

async function submitDispatch() {
    const projId = +$('#d-project').value;
    if (!projId) return toast('Select project');

    const itemCheckboxes = document.querySelectorAll('.d-item-checkbox:checked');
    const itemIds = Array.from(itemCheckboxes).map(cb => +cb.value);
    if (itemIds.length === 0) return toast('Select at least one item');

    const vehicleCheckboxes = document.querySelectorAll('.d-vehicle-checkbox:checked');
    const vehicles = Array.from(vehicleCheckboxes).map(cb => cb.value);
    if (vehicles.length === 0) return toast('Select at least one vehicle');

    // Get first person as dispatched_by (warehouse staff)
    const dispatchedById = getOrgPeople()[0]?.id || 1;

    const dispatchData = {
        project_id: projId,
        items: itemIds,
        vehicles: vehicles,
        dispatch_date: new Date().toISOString().split('T')[0],
        dispatched_by_id: dispatchedById,
        status: 'loading',
        notes: $('#d-notes').value.trim()
    };

    const newId = await sbInsert('dispatches', dispatchData);
    if (newId) {
        dispatches.unshift(assignOrgId({
            id: newId,
            projectId: projId,
            items: itemIds,
            vehicles: vehicles,
            dispatchDate: dispatchData.dispatch_date,
            dispatchedById: dispatchedById,
            status: 'loading',
            notes: dispatchData.notes
        }, 'dispatches'));

        // Update shipments to mark as dispatched
        for (let itemId of itemIds) {
            const shipment = shipments.find(s => s.id === itemId);
            if (shipment) {
                shipment.inventoryStatus = 'dispatched';
                await sbUpdate('shipments', itemId, { inventory_status: 'dispatched' });
            }
        }
    }

    saveLocal();
    render();
    showNav('dispatch');
    toast('Dispatch submitted!');
}

// === Dispatch (consolidated) ===
function switchDispatchTab(tab, el) {
    // Legacy function - no longer needed since consolidated
    renderLoadingSheet();
}

// === Loading Sheet Functions ===
function renderLoadingSheet() {
    // Populate driver dropdown
    const driverOpts = '<option value="">Select driver...</option>' +
        getOrgPeople().map(p => '<option value="' + p.id + '">' + p.name + ' (' + p.role + ')</option>').join('');
    const driverEl = document.getElementById('ls-driver');
    if (driverEl) driverEl.innerHTML = driverOpts;
    renderLoadingHistory();
}

function searchPOShipments() {
    const query = document.getElementById('ls-po-search').value.trim().toLowerCase();
    const resultsEl = document.getElementById('ls-search-results');
    const selectedEl = document.getElementById('ls-selected-items');
    const splitEl = document.getElementById('ls-split-section');

    if (!query || query.length < 2) {
        resultsEl.innerHTML = '';
        selectedEl.style.display = 'none';
        splitEl.style.display = 'none';
        return;
    }

    // Search by PO number OR project name
    const matchesByPO = getOrgShipments().filter(s =>
        s.po.toLowerCase().startsWith(query) ||
        s.subitem.toLowerCase().includes(query)
    );
    const matchesByProject = getOrgShipments().filter(s => {
        const proj = getOrgProjects().find(p => p.id === s.projectId);
        return proj && proj.name.toLowerCase().includes(query) && !matchesByPO.includes(s);
    });
    const matches = [...matchesByPO, ...matchesByProject];

    if (matches.length === 0) {
        resultsEl.innerHTML = '<div style="padding:16px;color:var(--muted);text-align:center">No shipments found for &quot;' + query + '&quot;</div>';
        splitEl.style.display = 'none';
        return;
    }

    // Group by PO
    const groups = {};
    matches.forEach(s => {
        if (!groups[s.po]) groups[s.po] = [];
        groups[s.po].push(s);
    });

    let h = '<div class="ls-results">';
    for (let po of Object.keys(groups)) {
        const items = groups[po];
        const proj = getOrgProjects().find(p => p.id === items[0].projectId);
        h += '<div style="padding:8px 12px;background:var(--gray-lt);font-weight:600;font-size:12px;border-bottom:1px solid var(--border)">PO: ' + po + (proj ? ' &mdash; ' + proj.name : '') + '</div>';
        items.forEach(s => {
            const statusIcon = s.inventoryStatus === 'dispatched' ? '&#128666;' : s.inventoryStatus === 'delivered' ? '&#9989;' : '&#128230;';
            const disabled = s.inventoryStatus === 'dispatched' || s.inventoryStatus === 'delivered';
            h += '<div class="ls-result-item" style="' + (disabled ? 'opacity:0.5' : '') + '">' +
                '<input type="checkbox" class="ls-item-cb" value="' + s.id + '"' + (disabled ? ' disabled' : '') + ' onchange="updateSelectedItems()" style="cursor:pointer">' +
                '<div style="flex:1">' +
                '<div class="ls-po-label">' + s.subitem + '</div>' +
                '<div class="ls-po-meta">' + (s.mfr || 'No mfr') + ' &middot; ' + (s.location || 'No location') + ' &middot; ' + statusIcon + ' ' + (s.inventoryStatus || 'in-warehouse') + '</div>' +
                '</div></div>';
        });
    }
    h += '</div>';
    resultsEl.innerHTML = h;
    splitEl.style.display = 'block';
}

function updateSelectedItems() {
    const checked = document.querySelectorAll('.ls-item-cb:checked');
    const selectedEl = document.getElementById('ls-selected-items');

    if (checked.length === 0) {
        selectedEl.style.display = 'none';
        return;
    }

    const ids = Array.from(checked).map(cb => +cb.value);
    const selected = getOrgShipments().filter(s => ids.includes(s.id));

    let h = '<div class="ls-selected"><div class="ls-selected-title">Selected (' + selected.length + ' items)</div>';
    selected.forEach(s => {
        h += '<div style="font-family:monospace;font-size:13px;padding:4px 0">' + s.subitem + '</div>';
    });
    h += '</div>';
    selectedEl.innerHTML = h;
    selectedEl.style.display = 'block';
}

function toggleSplitLoad() {
    const isChecked = document.getElementById('ls-is-split').checked;
    document.getElementById('ls-split-details').style.display = isChecked ? 'block' : 'none';
}

async function submitLoadingSheet() {
    const checked = document.querySelectorAll('.ls-item-cb:checked');
    const itemIds = Array.from(checked).map(cb => +cb.value);
    if (itemIds.length === 0) return toast('Select at least one shipment');

    const driverId = +document.getElementById('ls-driver').value;
    if (!driverId) return toast('Select a driver');

    const truck = document.getElementById('ls-truck').value;
    if (!truck) return toast('Select a truck');

    const equipment = Array.from(document.querySelectorAll('.ls-equip:checked')).map(cb => cb.value);
    const splitEl = document.getElementById('ls-is-split');
    const isSplit = splitEl ? splitEl.checked : false;
    const loadNum = isSplit ? +(document.getElementById('ls-load-num').value) : 1;
    const loadTotal = isSplit ? +(document.getElementById('ls-load-total').value) : 1;
    const loadComplete = document.getElementById('ls-complete').value;
    const notes = document.getElementById('ls-notes').value.trim();

    // Get the PO from the first selected shipment
    const firstShipment = getOrgShipments().find(s => s.id === itemIds[0]);
    const poSearch = firstShipment ? firstShipment.po : '';
    const projId = firstShipment ? firstShipment.projectId : null;
    const proj = projId ? getOrgProjects().find(p => p.id === projId) : null;

    const data = {
        po_search: poSearch,
        project_id: projId,
        project_name: proj ? proj.name : '',
        items: itemIds,
        driver_id: driverId,
        truck: truck,
        equipment: equipment,
        is_split: isSplit,
        load_number: loadNum,
        total_loads: loadTotal,
        load_complete: loadComplete,
        notes: notes,
        submitted_at: new Date().toISOString(),
        status: loadComplete === 'yes' ? 'complete' : 'loading'
    };

    const newId = await sbInsert('loading_sheets', data);
    if (newId) {
        loadingSheets.unshift({ id: newId, ...data });

        // Mark items as dispatched
        for (let itemId of itemIds) {
            const shipment = shipments.find(s => s.id === itemId);
            if (shipment) {
                shipment.inventoryStatus = 'dispatched';
                await sbUpdate('shipments', itemId, { inventory_status: 'dispatched' });
            }
        }
    } else {
        // Fallback: save locally even if Supabase fails
        loadingSheets.unshift({ id: Date.now(), ...data });
    }

    // Reset form
    document.getElementById('ls-po-search').value = '';
    document.getElementById('ls-search-results').innerHTML = '';
    document.getElementById('ls-selected-items').style.display = 'none';
    document.getElementById('ls-split-section').style.display = 'none';
    if (splitEl) splitEl.checked = false;
    const splitDet = document.getElementById('ls-split-details');
    if (splitDet) splitDet.style.display = 'none';
    document.getElementById('ls-driver').value = '';
    document.getElementById('ls-truck').value = '';
    document.querySelectorAll('.ls-equip').forEach(cb => { cb.checked = false; });
    document.getElementById('ls-complete').value = '';
    document.getElementById('ls-notes').value = '';

    saveLocal();
    renderLoadingHistory();
    toast('Loading sheet submitted!');
}

function renderLoadingHistory() {
    const historyEl = document.getElementById('ls-history');
    if (!historyEl) return;
    const searchQ = (document.getElementById('ls-history-search')?.value || '').trim().toLowerCase();
    let sheets = filterByOrg(loadingSheets);

    if (searchQ) {
        sheets = sheets.filter(ls =>
            (ls.po_search || '').toLowerCase().includes(searchQ) ||
            (ls.project_name || '').toLowerCase().includes(searchQ) ||
            (ls.truck || '').toLowerCase().includes(searchQ)
        );
    }

    sheets.sort((a, b) => new Date(b.submitted_at) - new Date(a.submitted_at));

    if (sheets.length === 0) {
        historyEl.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted)">No loading sheets yet</div>';
        return;
    }

    let h = '';
    sheets.forEach(ls => {
        const driver = getOrgPeople().find(p => p.id === (ls.driver_id));
        const itemCount = ls.items ? ls.items.length : 0;
        const statusClass = ls.status === 'complete' ? 'complete' : ls.load_complete === 'partial' ? 'partial' : 'loading';
        const verifiedTag = ls.verified_at ? '<span class="ls-tag ls-tag-complete">Verified</span>' : '';
        const date = ls.submitted_at ? new Date(ls.submitted_at) : new Date();

        h += '<div class="ls-history-card">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">' +
            '<div style="font-weight:600;font-family:monospace">PO: ' + (ls.po_search || 'N/A') + '</div>' +
            '<div style="display:flex;gap:6px">' +
            (ls.is_split ? '<span class="ls-tag ls-tag-split">Split ' + (ls.load_number||1) + '/' + (ls.total_loads||1) + '</span>' : '') +
            '<span class="ls-tag ls-tag-' + statusClass + '">' + (statusClass === 'complete' ? 'Complete' : statusClass === 'partial' ? 'Partial' : 'Loading') + '</span>' +
            verifiedTag +
            '</div></div>' +
            '<div style="font-size:12px;color:var(--text2);display:grid;grid-template-columns:1fr 1fr;gap:4px">' +
            '<div>&#128666; ' + (ls.truck || 'N/A') + '</div>' +
            '<div>&#128100; ' + (driver ? driver.name : 'Unknown') + '</div>' +
            '<div>&#128230; ' + itemCount + ' items</div>' +
            '<div>&#128197; ' + date.toLocaleDateString('en-US', {month:'short',day:'numeric'}) + '</div>' +
            '</div>' +
            (ls.equipment && ls.equipment.length ? '<div style="margin-top:8px;font-size:11px;color:var(--muted)">&#128295; ' + ls.equipment.join(', ') + '</div>' : '') +
            (ls.project_name ? '<div style="margin-top:4px;font-size:11px;color:var(--muted)">&#128193; ' + ls.project_name + '</div>' : '') +
            (ls.notes ? '<div style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border);font-size:12px;color:var(--muted)"><strong>Notes:</strong> ' + ls.notes + '</div>' : '') +
            '<div style="margin-top:8px;display:flex;justify-content:flex-end"><button class="btn btn-outline" style="padding:4px 8px;font-size:11px" onclick="openLoadoutModal('+ls.id+')">Verify Load</button></div>' +
            '</div>';
    });

    historyEl.innerHTML = h;
}

function openLoadoutModal(sheetId){
    const sheet = loadingSheets.find(ls => ls.id === sheetId);
    if (!sheet) return;
    currentLoadoutSheetId = sheetId;
    const canEdit = canEditFeature('loadout');
    const items = (sheet.items || []).map(id => getOrgShipments().find(s => s.id === id)).filter(Boolean);
    const checks = sheet.loadout_checks || {};
    const projName = sheet.project_name || (getOrgProjects().find(p => p.id === sheet.project_id)?.name) || '';
    const meta = `PO: ${sheet.po_search || 'N/A'}${projName ? '  ' + projName : ''}`;
    $('#loadout-meta').textContent = meta;
    if (!items.length) {
        $('#loadout-items').innerHTML = '<div style="color:var(--muted)">No items found for this load.</div>';
    } else {
        $('#loadout-items').innerHTML = items.map(it => {
            const c = checks[it.id] || {};
            const disabled = canEdit ? '' : 'disabled';
            return `<div class="mini-card" data-item-id="${it.id}" style="display:flex;justify-content:space-between;align-items:center;gap:12px">
                <div style="font-family:monospace;font-size:12px;flex:1">${escapeHtml(it.subitem || it.po || '')}</div>
                <label style="font-size:11px;display:flex;gap:6px;align-items:center"><input type="checkbox" class="loadout-check" data-field="picked" ${c.picked ? 'checked' : ''} ${disabled}>Picked</label>
                <label style="font-size:11px;display:flex;gap:6px;align-items:center"><input type="checkbox" class="loadout-check" data-field="loaded" ${c.loaded ? 'checked' : ''} ${disabled}>Loaded</label>
            </div>`;
        }).join('');
    }
    if (!canEdit) {
        $('#loadout-meta').textContent = meta + '  Warehouse access only';
    }
    openModal('loadout');
}

async function saveLoadoutVerification(){
    const sheet = loadingSheets.find(ls => ls.id === currentLoadoutSheetId);
    if (!sheet) return;
    if (!canEditFeature('loadout')) return toast('Warehouse access only');
    const checks = {};
    document.querySelectorAll('#loadout-items [data-item-id]').forEach(row => {
        const itemId = +row.getAttribute('data-item-id');
        const picked = row.querySelector('input[data-field="picked"]')?.checked || false;
        const loaded = row.querySelector('input[data-field="loaded"]')?.checked || false;
        checks[itemId] = { picked, loaded };
    });
    const verifiedBy = currentUserId || people[0]?.id || null;
    const payload = { loadout_checks: checks, verified_by_id: verifiedBy, verified_at: new Date().toISOString() };
    await sbUpdate('loading_sheets', sheet.id, payload);
    Object.assign(sheet, payload);
    saveLocal();
    renderLoadingHistory();
    closeModal('loadout');
    toast('Load-out verification saved');
}

// === Panel Tab Switcher ===
function switchPanelTab(tab, el) {
    document.querySelectorAll('.panel-tab-btn').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('panel-tab-details').style.display = tab === 'details' ? 'block' : 'none';
    document.getElementById('panel-tab-moving').style.display = tab === 'moving' ? 'block' : 'none';
    document.getElementById('panel-tab-completion').style.display = tab === 'completion' ? 'block' : 'none';
    if (tab === 'completion') renderProjectCompletion();
}

// === Project Completion Functions ===
function renderProjectCompletion() {
    const gate = document.getElementById('pc-role-gate');
    if (!gate || !currentProject) return;

    // Build user selector + role gate
    let h = '<div class="pc-section">' +
        '<div class="pc-section-title">Identify Yourself</div>' +
        '<select class="form-select" id="pc-user-select" onchange="onPCUserChange()">' +
        '<option value="">Select your name...</option>';
    people.forEach(p => {
        h += '<option value="' + p.id + '"' + (currentUserId === p.id ? ' selected' : '') + '>' + p.name + ' (' + p.role + ')</option>';
    });
    h += '</select></div>';

    // Check if a lead is selected
    const selectedPerson = currentUserId ? people.find(p => p.id === currentUserId) : null;
    const isLead = selectedPerson && selectedPerson.role.toLowerCase().includes('lead');

    if (!currentUserId) {
        h += '<div class="pc-role-lock"><div class="pc-role-lock-icon">&#128100;</div><div style="font-weight:600">Select your name above</div><div style="font-size:13px;color:var(--text2);margin-top:4px">Only Lead Installers can fill this form</div></div>';
    } else if (!isLead) {
        h += '<div class="pc-role-lock"><div class="pc-role-lock-icon">&#128274;</div><div style="font-weight:600">Access Restricted</div><div style="font-size:13px;color:var(--text2);margin-top:4px">Only Lead Installers can submit the completion form. Your role: ' + selectedPerson.role + '</div></div>';
    } else {
        // Show the full completion form
        const existing = projectCompletions.find(pc => pc.project_id === currentProject.id);
        const d = existing || {};

        h += '<div style="background:var(--green-lt);padding:10px 12px;border-radius:6px;margin-bottom:16px;font-size:13px;color:var(--green)">&#9989; Logged in as <strong>' + selectedPerson.name + '</strong> (Lead)</div>';

        // Is Final Day
        h += '<div class="pc-section"><div class="pc-section-title">Project Info</div>' +
            '<div class="form-group"><label class="form-label">Is This The Final Day of The Project? <span class="req">*</span></label>' +
            '<select class="form-select" id="pc-final-day"><option value="">Select...</option><option value="yes"' + (d.is_final_day === 'yes' ? ' selected' : '') + '>Yes</option><option value="no"' + (d.is_final_day === 'no' ? ' selected' : '') + '>No</option></select></div>' +
            '<div class="form-group"><label class="form-label">Project Name</label><input type="text" class="form-input" id="pc-proj-name" value="' + (currentProject.name || '') + '" readonly style="background:var(--gray-lt)"></div>' +
            '<div class="form-group"><label class="form-label">PO Number</label><input type="text" class="form-input" id="pc-po" value="' + (d.po_number || '') + '"></div>' +
            '<div class="form-group"><label class="form-label">Lead Name</label><input type="text" class="form-input" id="pc-lead-name" value="' + selectedPerson.name + '" readonly style="background:var(--gray-lt)"></div>' +
            '<div class="form-group"><label class="form-label">Phone</label><input type="tel" class="form-input" id="pc-phone" value="' + (d.phone || selectedPerson.phone || '') + '"></div></div>';

        // Product Placement Checklist
        h += '<div class="pc-section"><div class="pc-section-title">Product Placement Checklist</div><div class="pc-checklist">' +
            pcCheckbox('pc-panels-straight', 'Panels Are Straight', d) +
            pcCheckbox('pc-furniture-correct', 'Furniture Is Placed Correctly', d) +
            '</div></div>';

        // Leveling Checklist
        h += '<div class="pc-section"><div class="pc-section-title">Leveling Checklist</div><div class="pc-checklist">' +
            pcCheckbox('pc-panels-leveled', 'Panels Are Leveled', d) +
            pcCheckbox('pc-lateral-leveled', 'Lateral Files Are Leveled', d) +
            pcCheckbox('pc-surfaces-leveled', 'Surfaces Are Leveled', d) +
            '</div></div>';

        // Cleaning
        h += '<div class="pc-section"><div class="pc-section-title">Cleaning</div><div class="pc-checklist">' +
            pcCheckbox('pc-clean-panels', 'Panels / Workstations', d) +
            pcCheckbox('pc-clean-surfaces', 'Surfaces Are Clean', d) +
            pcCheckbox('pc-clean-pedestals', 'Pedestals and Drawers', d) +
            pcCheckbox('pc-clean-lateral', 'Lateral Files Are Clean', d) +
            pcCheckbox('pc-clean-legs', 'Legs Are Clean', d) +
            pcCheckbox('pc-clean-trash', 'Trash Is Removed', d) +
            pcCheckbox('pc-clean-vacuum', 'Vacuum Floors', d) +
            '</div></div>';

        // End of Day Checklist
        h += '<div class="pc-section"><div class="pc-section-title">End Of Day Checklist</div><div class="pc-checklist">' +
            pcCheckbox('pc-eod-trash', 'Trash Is Organized/Removed', d) +
            pcCheckbox('pc-eod-hallways', 'Hallways Are Clear', d) +
            pcCheckbox('pc-eod-pictures', 'Take Pictures', d) +
            '</div></div>';

        // Product Return
        h += '<div class="pc-section"><div class="pc-section-title">Product Return</div>' +
            '<div class="form-group"><label class="form-label">Product Return</label>' +
            '<select class="form-select" id="pc-return"><option value="">Select...</option><option value="yes"' + (d.product_return === 'yes' ? ' selected' : '') + '>Yes</option><option value="no"' + (d.product_return === 'no' ? ' selected' : '') + '>No</option></select></div>' +
            '<div class="form-group"><label class="form-label">Product Return Inventory</label>' +
            '<textarea class="form-input" id="pc-return-inv" placeholder="Ex: 2 speedpacks, 1 chair, 1 desk" style="resize:vertical;min-height:60px">' + (d.product_return_inventory || '') + '</textarea></div></div>';

        // Product Damaged
        h += '<div class="pc-section"><div class="pc-section-title">Product Damaged</div>' +
            '<div class="form-group"><label class="form-label">Product Damaged</label>' +
            '<select class="form-select" id="pc-damaged"><option value="">Select...</option><option value="yes"' + (d.product_damaged === 'yes' ? ' selected' : '') + '>Yes</option><option value="no"' + (d.product_damaged === 'no' ? ' selected' : '') + '>No</option></select></div>' +
            '<div class="form-group"><label class="form-label">Take Photos Of The Following:</label><div class="pc-checklist">' +
            pcCheckbox('pc-photo-damage', 'Damage On Item', d) +
            pcCheckbox('pc-photo-sticker', 'Sticker/Label', d) +
            pcCheckbox('pc-photo-box', 'Complete Box', d) +
            '</div></div>' +
            '<div class="form-group"><label class="form-label">Inventory Of Damaged Items</label>' +
            '<textarea class="form-input" id="pc-damaged-inv" placeholder="Ex: 1 Shared Leg SN 158342" style="resize:vertical;min-height:60px">' + (d.inventory_damaged_items || '') + '</textarea></div></div>';

        // Client Sign-off
        h += '<div class="pc-section"><div class="pc-section-title">Client Sign-off</div>' +
            '<div class="form-group"><label class="form-label">Client Name</label><input type="text" class="form-input" id="pc-sign-name" value="' + (d.signoff_name || '') + '"></div>' +
            '<div class="form-group"><label class="form-label">Title / Role</label><input type="text" class="form-input" id="pc-sign-title" value="' + (d.signoff_title || '') + '"></div>' +
            '<div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="pc-sign-email" value="' + (d.signoff_email || '') + '"></div>' +
            '<label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);margin-top:6px">' +
            '<input type="checkbox" id="pc-sign-confirm" ' + (d.signoff_confirmed ? 'checked' : '') + '> Client confirms installation is complete</label>' +
            '</div>';

        // Submit
        h += '<button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="submitProjectCompletion()">' + (existing ? 'Update Completion Form' : 'Submit Completion Form') + '</button>';
        if (existing) {
            h += '<div style="text-align:center;margin-top:8px;font-size:12px;color:var(--muted)">Last submitted: ' + new Date(existing.submitted_at).toLocaleString() + '</div>';
        }
    }

    gate.innerHTML = h;
}

function pcCheckbox(id, label, data) {
    const checked = data && data.checklists && data.checklists[id] ? ' checked' : '';
    return '<label><input type="checkbox" id="' + id + '"' + checked + ' style="cursor:pointer"> <span>' + label + '</span></label>';
}

function onPCUserChange() {
    currentUserId = +document.getElementById('pc-user-select').value || null;
    renderProjectCompletion();
}

async function submitProjectCompletion() {
    if (!currentProject || !currentUserId) return toast('Select your name first');
    if (!canEditFeature('completion')) return toast('Lead access only');

    const checklists = {};
    document.querySelectorAll('#panel-tab-completion input[type="checkbox"]').forEach(cb => {
        if (cb.id && cb.id.startsWith('pc-')) checklists[cb.id] = cb.checked;
    });

    const data = {
        project_id: currentProject.id,
        lead_id: currentUserId,
        is_final_day: document.getElementById('pc-final-day').value,
        po_number: document.getElementById('pc-po').value.trim(),
        phone: document.getElementById('pc-phone').value.trim(),
        checklists: checklists,
        product_return: document.getElementById('pc-return').value,
        product_return_inventory: document.getElementById('pc-return-inv').value.trim(),
        product_damaged: document.getElementById('pc-damaged').value,
        inventory_damaged_items: document.getElementById('pc-damaged-inv').value.trim(),
        signoff_name: document.getElementById('pc-sign-name').value.trim(),
        signoff_title: document.getElementById('pc-sign-title').value.trim(),
        signoff_email: document.getElementById('pc-sign-email').value.trim(),
        signoff_confirmed: !!document.getElementById('pc-sign-confirm').checked,
        submitted_at: new Date().toISOString()
    };

    const existing = projectCompletions.find(pc => pc.project_id === currentProject.id);
    if (existing && existing.signoff_at) data.signoff_at = existing.signoff_at;
    if (data.signoff_confirmed && !data.signoff_at) {
        data.signoff_at = new Date().toISOString();
    }
    if (existing) {
        await sbUpdate('project_completions', existing.id, data);
        Object.assign(existing, data);
        toast('Completion form updated!');
    } else {
        const newId = await sbInsert('project_completions', data);
        if (newId) {
            projectCompletions.push({ id: newId, ...data });
        } else {
            projectCompletions.push({ id: Date.now(), ...data });
        }
        toast('Completion form submitted!');
    }

    saveLocal();
    renderProjectCompletion();
}

function completeProject() {
    if (!currentProject) return;
    const proj = getOrgProjects().find(p => p.id === currentProject.id);
    if (!proj) return;

    if (proj.status === 'completed') {
        projectToDelete = proj;
        openModal('delete-project');
    } else {
        proj.status = 'completed';
        sbUpdate('projects', proj.id, { status: 'completed' });
        saveLocal();
        render();
        openPanel(proj.id);
        toast('Project marked complete');
    }
}

async function confirmDeleteProject() {
    if (!projectToDelete) return;

    // Delete all shipments for this project
    const projShipments = shipments.filter(s => s.projectId === projectToDelete.id);
    for (let s of projShipments) {
        await sbDelete('shipments', s.id);
    }
    shipments = shipments.filter(s => s.projectId !== projectToDelete.id);

    // Delete all punchlist items for this project
    const projPunchlist = punchlist.filter(p => p.projectId === projectToDelete.id);
    for (let p of projPunchlist) {
        await sbDelete('punchlist', p.id);
    }
    punchlist = punchlist.filter(p => p.projectId !== projectToDelete.id);

    // Delete all dispatches for this project
    const projDispatches = dispatches.filter(d => d.projectId === projectToDelete.id);
    for (let d of projDispatches) {
        await sbDelete('dispatches', d.id);
    }
    dispatches = dispatches.filter(d => d.projectId !== projectToDelete.id);

    // Delete the project
    await sbDelete('projects', projectToDelete.id);
    projects = projects.filter(p => p.id !== projectToDelete.id);

    projectToDelete = null;
    saveLocal();
    render();
    closeModal('delete-project');
    closePanel();
    toast('Project deleted');
}

function renderProjects() {
    updateProjectsViewTabs();
    const visible = getVisibleProjects();
    const q = (projectSearchQuery || '').toLowerCase();
    const filtered = !q ? visible : visible.filter(p => projectMatchesSearch(p, q));
    const listEl = $('#projects-list');
    if (isBmgWorkspace()) {
        const moves = filtered.filter(p => isMoveProject(p));
        if (listEl) listEl.style.display = 'block';
        if (listEl) listEl.innerHTML = (projectsViewMode === 'list') ? renderMoveProjectsList(moves) : renderMovePipeline(moves);
        return;
    }
    if (listEl) listEl.style.display = '';
    $('#projects-list').innerHTML = filtered.map(p => {
        const c = getOrgClients().find(x => x.id === p.clientId);
        const ps = getOrgShipments().filter(s => s.projectId === p.id);
        const rec = ps.filter(s => s.status === 'received').length;
        const statusLabel = getProjectStatusLabel(p, p.status);
        const isCompleted = p.status === 'completed';
        return `<div class="card" onclick="openPanel(${p.id})" style="${isCompleted ? 'opacity:0.6;border-color:var(--gray)' : ''}">
            <div class="card-header">
                <div class="card-avatar" style="background:${isCompleted ? 'var(--gray-lt)' : 'var(--green-lt)'};color:${isCompleted ? 'var(--muted)' : 'var(--green)'}">${isCompleted ? '' : ''}</div>
                <div>
                    <div class="card-title">${escapeHtml(p.name)} <span class="status-pill">${escapeHtml(statusLabel)}</span></div>
                    <div class="card-subtitle">${escapeHtml(c?.company || '')}</div>
                </div>
            </div>
            <div class="card-stats"><span><strong>${rec}/${ps.length}</strong> received</span><span><strong>${p.team?.length || 0}</strong> assigned</span></div>
        </div>`;
    }).join('');
}

function renderDashboard() {
    const el = document.getElementById('dashboard-content');
    if (!el) return;
    const isBmg = isBmgWorkspace();
    const allProjects = getVisibleProjects().filter(p => isBmg ? isMoveProject(p) : true);
    const activeProjects = allProjects.filter(p => isMoveProject(p) ? p.status !== 'close' : p.status !== 'completed');
    const totalPending = activeProjects.reduce((sum, p) => {
        const ship = getProjectShipmentStats(p.id);
        const move = getProjectMoveItemStats(p.id);
        return sum + ship.pending + move.pending;
    }, 0);
    const inTransit = activeProjects.filter(p => getProjectLocationStatus(p.id) === 'In Transit').length;
    const atJobsite = activeProjects.filter(p => getProjectLocationStatus(p.id) === 'At Jobsite').length;

    const today = new Date();
    const upcoming = allProjects.map(p => ({ p, d: p.date ? new Date(p.date + 'T12:00:00') : null }))
        .filter(x => x.d && x.d >= today && x.d <= new Date(today.getTime() + 14*24*60*60*1000))
        .sort((a,b) => a.d - b.d)
        .slice(0, 6);

    const pendingProjects = activeProjects.map(p => {
        const ship = getProjectShipmentStats(p.id);
        const move = getProjectMoveItemStats(p.id);
        const pending = ship.pending + move.pending;
        const total = ship.total + move.total;
        return { p, pending, total };
    }).filter(x => x.pending > 0).sort((a,b) => b.pending - a.pending).slice(0, 6);

    const updates = projectUpdates
        .filter(u => activeProjects.some(p => p.id === u.projectId))
        .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))
        .slice(0, 6);

    const milestonesDue = isBmg
        ? moveMilestones
            .filter(m => m.dueDate && m.status !== 'complete')
            .map(m => ({ m, d: new Date(m.dueDate + 'T12:00:00') }))
            .filter(x => x.d >= today && x.d <= new Date(today.getTime() + 7*24*60*60*1000))
            .sort((a,b) => a.d - b.d)
            .slice(0, 6)
        : [];

    let html = '<div class="dashboard-grid">';
    html += `<div class="dashboard-card"><div class="dashboard-stat">${activeProjects.length}</div><div class="dashboard-stat-label">Active ${isBmg ? 'Moves' : 'Projects'}</div></div>`;
    html += `<div class="dashboard-card"><div class="dashboard-stat">${totalPending}</div><div class="dashboard-stat-label">Pending Items</div></div>`;
    html += `<div class="dashboard-card"><div class="dashboard-stat">${inTransit}</div><div class="dashboard-stat-label">In Transit</div></div>`;
    html += `<div class="dashboard-card"><div class="dashboard-stat">${atJobsite}</div><div class="dashboard-stat-label">At Jobsite</div></div>`;
    html += '</div>';

    html += `<div class="dashboard-grid">`;
    html += `<div class="dashboard-card"><h3>Upcoming ${isBmg ? 'Moves' : 'Installs'}</h3><div class="dashboard-list">` +
        (upcoming.length ? upcoming.map(x => {
            const client = getOrgClients().find(c => c.id === x.p.clientId);
            const dateStr = x.d ? x.d.toLocaleDateString('en-US', {month:'short', day:'numeric'}) : '';
            return `<div class="dashboard-item" onclick="openPanel(${x.p.id})">
                <div><div class="dashboard-item-title">${escapeHtml(x.p.name || '')}</div><div class="dashboard-item-sub">${escapeHtml(client?.company || '')}</div></div>
                <div class="dashboard-item-meta">${dateStr}</div>
            </div>`;
        }).join('') : '<div class="pipeline-empty">No upcoming items.</div>') +
        `</div></div>`;

    html += `<div class="dashboard-card"><h3>Pending Items</h3><div class="dashboard-list">` +
        (pendingProjects.length ? pendingProjects.map(x => {
            const client = getOrgClients().find(c => c.id === x.p.clientId);
            return `<div class="dashboard-item" onclick="openPanel(${x.p.id})">
                <div><div class="dashboard-item-title">${escapeHtml(x.p.name || '')}</div><div class="dashboard-item-sub">${escapeHtml(client?.company || '')}</div></div>
                <div class="dashboard-item-meta">${x.pending}/${x.total}</div>
            </div>`;
        }).join('') : '<div class="pipeline-empty">No pending items.</div>') +
        `</div></div>`;

    html += `<div class="dashboard-card"><h3>${isBmg ? 'Milestones Due' : 'Recent Updates'}</h3><div class="dashboard-list">`;
    if (isBmg) {
        html += milestonesDue.length ? milestonesDue.map(x => {
            const proj = getOrgProjects().find(p => p.id === x.m.projectId);
            const stageLabel = (BMG_MILESTONE_STAGES.find(s => s.key === x.m.stage)?.label) || x.m.stage;
            const dateStr = x.d ? x.d.toLocaleDateString('en-US', {month:'short', day:'numeric'}) : '';
            return `<div class="dashboard-item" onclick="openPanel(${proj?.id || 0})">
                <div><div class="dashboard-item-title">${escapeHtml(stageLabel)}</div><div class="dashboard-item-sub">${escapeHtml(proj?.name || '')}</div></div>
                <div class="dashboard-item-meta">${dateStr}</div>
            </div>`;
        }).join('') : '<div class="pipeline-empty">No milestones due.</div>';
    } else {
        html += updates.length ? updates.map(u => {
            const proj = getOrgProjects().find(p => p.id === u.projectId);
            const statusLabel = getProjectStatusLabel(proj || {}, u.status);
            return `<div class="dashboard-item" onclick="openPanel(${proj?.id || 0})">
                <div><div class="dashboard-item-title">${escapeHtml(statusLabel)}</div><div class="dashboard-item-sub">${escapeHtml(u.message || '')}</div></div>
                <div class="dashboard-item-meta">${proj?.name || ''}</div>
            </div>`;
        }).join('') : '<div class="pipeline-empty">No updates yet.</div>';
    }
    html += `</div></div>`;

    html += `</div>`;
    el.innerHTML = html;
}

function getAutomationStorageKey() {
    return 'v10_automations_' + (getActiveOrgId() || 'default');
}
function getAutomationFolderStorageKey() {
    return 'v10_automation_folders_' + (getActiveOrgId() || 'default');
}

function normalizeAutomation(a) {
    if (!a) return null;
    const status = a.status || (a.enabled ? 'published' : (a.enabled === false ? 'paused' : 'draft'));
    return {
        id: a.id || ('auto-' + Date.now()),
        name: a.name || 'Untitled',
        folder: a.folder || 'Operations',
        status: status,
        triggerType: a.triggerType || 'date',
        triggerValue: a.triggerValue || 'move_date',
        offsetDays: typeof a.offsetDays === 'number' ? a.offsetDays : 0,
        channel: a.channel || 'Email',
        audience: a.audience || 'PM',
        subject: a.subject || '',
        message: a.message || a.description || '',
        aiEnabled: !!a.aiEnabled,
        aiPrompt: a.aiPrompt || '',
        updatedAt: a.updatedAt || new Date().toISOString()
    };
}

function loadAutomations() {
      if (automations && automations.length) return;
      // Try Supabase first
      sbFetch('automations', 'GET', '?org_id=eq.' + getActiveOrgId() + '&order=name.asc').then(data => {
        if (data && data.length) {
          automations = data.map(normalizeAutomation).filter(Boolean);
          renderAutomations();
        }
      }).catch(e => console.warn('Supabase automations fetch failed, using localStorage', e));
      // Fallback to localStorage
      let stored;
      try { stored = JSON.parse(localStorage.getItem(getAutomationStorageKey())); } catch(e) {}
      if (stored && stored.length) {
        automations = stored.map(normalizeAutomation).filter(Boolean);
      } else {
        automations = DEFAULT_AUTOMATIONS;
        saveAutomations();
      }
      loadAutomationFolders();
    }

function saveAutomations() {
      try { localStorage.setItem(getAutomationStorageKey(), JSON.stringify(automations)); } catch (e) {}
    }

function loadAutomationFolders() {
      let stored;
      try { stored = JSON.parse(localStorage.getItem(getAutomationFolderStorageKey())); } catch(e) {}
      if (stored && stored.length) {
        automationFolders = stored;
      } else {
        const fromAutos = Array.from(new Set(automations.map(a => a.folder).filter(Boolean)));
        automationFolders = fromAutos.length ? fromAutos : ['Operations'];
        saveAutomationFolders();
      }
      // Also try loading from Supabase
      sbFetch('automation_folders', 'GET', '?org_id=eq.' + getActiveOrgId()).then(data => {
        if (data && data.length) {
          const sbFolders = data.map(d => d.name);
          const merged = Array.from(new Set([...automationFolders, ...sbFolders]));
          if (merged.length > automationFolders.length) {
            automationFolders = merged;
            renderAutomations();
          }
        }
      }).catch(e => {});
    }

function saveAutomationFolders() {
      try { localStorage.setItem(getAutomationFolderStorageKey(), JSON.stringify(automationFolders)); } catch (e) {}
    }

function toggleAutomation(id, checked) {
    const a = automations.find(x => x.id === id);
    if (!a) return;
    a.status = checked ? 'published' : 'paused';
    a.updatedAt = new Date().toISOString();
    saveAutomations();
    sbFetch('automations', 'PATCH', `?id=eq.${encodeURIComponent(a.id)}`, { status: a.status, updatedAt: a.updatedAt }).catch(e => console.warn('Supabase toggle failed', e));
    renderAutomations();
}

function setAutomationSearch(val) {
    automationSearchQuery = (val || '').trim().toLowerCase();
    renderAutomations();
}

function setAutomationFilter(val) {
    automationFilter = val || 'all';
    renderAutomations();
}

function setAutomationFolderFilter(val) {
    automationFolderFilter = val || 'all';
    renderAutomations();
}

function createAutomationFolder() {
    const name = prompt('Folder name');
    if (!name) return;
    if (!automationFolders.includes(name)) {
        automationFolders.push(name);
        saveAutomationFolders();
        const payload = assignOrgId({ name }, 'automation_folders');
        sbFetch('automation_folders', 'POST', '', payload, {'Prefer': 'resolution=merge-duplicates'}).catch(e => console.warn('Supabase folder save failed', e));
    }
    renderAutomations();
}

function automationStatusLabel(status) {
    if (status === 'published') return 'Published';
    if (status === 'paused') return 'Paused';
    if (status === 'draft') return 'Draft';
    if (status === 'archived') return 'Archived';
    return status || 'Draft';
}

function automationStatusPill(status) {
    const s = status || 'draft';
    const map = {
        published: { bg: 'var(--green-lt)', color: 'var(--green)' },
        paused: { bg: 'var(--yellow-lt)', color: 'var(--yellow)' },
        draft: { bg: 'var(--gray-lt)', color: 'var(--text2)' },
        archived: { bg: 'var(--gray-lt)', color: 'var(--muted)' }
    };
    const m = map[s] || map.draft;
    return `<span class="status-pill small" style="background:${m.bg};color:${m.color}">${automationStatusLabel(s)}</span>`;
}

function openAutomationModal(id) {
    loadAutomations();
    editingAutomationId = id || null;
    const modal = document.getElementById('modal-automation');
    if (!modal) return;
    const data = editingAutomationId ? (automations.find(a => a.id === editingAutomationId) || {}) : normalizeAutomation({});
    document.getElementById('auto-name').value = data.name || '';
    document.getElementById('auto-folder').value = data.folder || 'Operations';
    document.getElementById('auto-status').value = data.status || 'draft';
    document.getElementById('auto-trigger-type').value = data.triggerType || 'date';
    document.getElementById('auto-trigger-value').value = data.triggerValue || '';
    document.getElementById('auto-offset').value = typeof data.offsetDays === 'number' ? data.offsetDays : 0;
    document.getElementById('auto-channel').value = data.channel || 'Email';
    document.getElementById('auto-audience').value = data.audience || 'PM';
    document.getElementById('auto-subject').value = data.subject || '';
    document.getElementById('auto-message').value = data.message || '';
    document.getElementById('auto-ai-enabled').checked = !!data.aiEnabled;
    document.getElementById('auto-ai-prompt').value = data.aiPrompt || '';
    document.getElementById('auto-ai-section').style.display = data.aiEnabled ? 'block' : 'none';
    document.getElementById('automation-modal-title').textContent = editingAutomationId ? 'Edit Workflow' : 'Create Workflow';
    modal.classList.add('open');
    loadWorkflowSteps(id);
}

function closeAutomationModal() {
    const modal = document.getElementById('modal-automation');
    if (modal) modal.classList.remove('open');
}

function toggleAutomationAI(enabled) {
    const sec = document.getElementById('auto-ai-section');
    if (sec) sec.style.display = enabled ? 'block' : 'none';
}

function saveAutomation() {
    loadAutomations();
    const payload = assignOrgId({
        id: editingAutomationId || ('auto-' + Date.now()),
        name: document.getElementById('auto-name').value.trim() || 'Untitled',
        folder: document.getElementById('auto-folder').value.trim() || 'Operations',
        status: document.getElementById('auto-status').value,
        triggerType: document.getElementById('auto-trigger-type').value,
        triggerValue: document.getElementById('auto-trigger-value').value.trim(),
        offsetDays: parseInt(document.getElementById('auto-offset').value || '0', 10) || 0,
        channel: document.getElementById('auto-channel').value,
        audience: document.getElementById('auto-audience').value,
        subject: document.getElementById('auto-subject').value.trim(),
        message: document.getElementById('auto-message').value.trim(),
        aiEnabled: !!document.getElementById('auto-ai-enabled').checked,
        aiPrompt: document.getElementById('auto-ai-prompt').value.trim(),
        updatedAt: new Date().toISOString()
    }, 'automations');
    if (!automationFolders.includes(payload.folder)) {
        automationFolders.push(payload.folder);
        saveAutomationFolders();
    }
    const idx = automations.findIndex(a => a.id === payload.id);
    if (idx >= 0) automations[idx] = payload;
    else automations.unshift(payload);
    saveAutomations();
    
      // Upsert to Supabase
      sbFetch('automations', 'POST', '', payload, {'Prefer': 'resolution=merge-duplicates'}).catch(e => console.warn('Supabase save failed', e));
      // Save workflow steps to Supabase
      saveWorkflowSteps(payload.id);
      closeAutomationModal();
    renderAutomations();
}

function deleteAutomation(id) {
    if (!confirm('Delete this workflow?')) return;
    automations = automations.filter(a => a.id !== id);
    saveAutomations();
    sbFetch('automations', 'DELETE', `?id=eq.${encodeURIComponent(id)}`).catch(e => console.warn('Supabase delete failed', e));
    renderAutomations();
}

function renderAutomations() {
    const el = document.getElementById('automations-list');
    if (!el) return;
    loadAutomations();
    loadAutomationFolders();
    const folders = automationFolders.length ? automationFolders : ['Operations'];
    const filtered = automations.filter(a => {
        if (automationFilter !== 'all' && a.status !== automationFilter) return false;
        if (automationFolderFilter !== 'all' && (a.folder || '') !== automationFolderFilter) return false;
        if (automationSearchQuery) {
            const hay = [a.name, a.folder, a.channel, a.audience, a.triggerType, a.triggerValue, a.message].filter(Boolean).join(' ').toLowerCase();
            if (!hay.includes(automationSearchQuery)) return false;
        }
        return true;
    });
    const folderOptions = ['<option value="all">All folders</option>']
        .concat(folders.map(f => `<option value="${escapeHtml(f)}"${automationFolderFilter===f?' selected':''}>${escapeHtml(f)}</option>`))
        .join('');
    el.innerHTML = `
        <div class="auto-toolbar">
            <div class="auto-filters">
                ${['all','published','draft','paused'].map(f => `<button class="auto-filter-btn ${automationFilter===f?'active':''}" onclick="setAutomationFilter('${f}')">${automationStatusLabel(f)}</button>`).join('')}
            </div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                <select class="form-select" style="min-width:160px" onchange="setAutomationFolderFilter(this.value)">${folderOptions}</select>
                <div class="list-search">
                    <span class="search-icon"></span>
                    <input type="text" placeholder="Search workflows..." oninput="setAutomationSearch(this.value)" value="${escapeHtml(automationSearchQuery)}">
                </div>
                <button class="btn btn-outline" onclick="createAutomationFolder()">Create Folder</button>
                <button class="btn btn-primary" onclick="openAutomationModal()">+ Create Workflow</button>
            </div>
        </div>
        <table class="auto-table">
            <thead><tr><th>Name</th><th>Folder</th><th>Status</th><th>Trigger</th><th>Channel</th><th>Updated</th><th></th></tr></thead>
            <tbody>
                ${filtered.length ? filtered.map(a => {
                    const triggerLabel = a.triggerType === 'date' ? `${a.triggerValue || 'date'} ${a.offsetDays || 0}d` : (a.triggerType === 'status' ? `Status  ${a.triggerValue}` : (a.triggerType === 'schedule' ? a.triggerValue : a.triggerType));
                    const updated = a.updatedAt ? new Date(a.updatedAt).toLocaleDateString() : '';
                    return `<tr>
                        <td><strong>${escapeHtml(a.name)}</strong></td>
                        <td>${escapeHtml(a.folder || '')}</td>
                        <td>${automationStatusPill(a.status)}</td>
                        <td>${escapeHtml(triggerLabel || '')}</td>
                        <td>${escapeHtml(a.channel || '')}</td>
                        <td>${escapeHtml(updated)}</td>
                        <td>
                            <div class="auto-row-actions">
                                <label class="toggle-switch">
                                    <input type="checkbox" ${a.status==='published'?'checked':''} onchange="toggleAutomation('${a.id}', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                                <button class="btn btn-outline" onclick="openAutomationModal('${a.id}')">Edit</button>
                                <button class="btn btn-outline" onclick="deleteAutomation('${a.id}')">Delete</button>
                            </div>
                        </td>
                    </tr>`;
                }).join('') : '<tr><td colspan="7" style="padding:16px;color:var(--muted)">No workflows found.</td></tr>'}
            </tbody>
        </table>
    `;
}

//  Workflow Steps (CRUD) 
function loadWorkflowSteps(automationId) {
    if (!automationId) {
        window._currentWorkflowSteps = [];
        renderWorkflowSteps();
        return;
    }
    sbFetch('workflow_steps', 'GET', '?automation_id=eq.' + automationId + '&order=stepOrder.asc')
        .then(function(data) {
            window._currentWorkflowSteps = (data && data.length) ? data : [];
            renderWorkflowSteps();
        })
        .catch(function(e) {
            console.warn('Failed to load workflow steps', e);
            window._currentWorkflowSteps = [];
            renderWorkflowSteps();
        });
}

function renderWorkflowSteps() {
    var list = document.getElementById("steps-list");
    if (!list) return;
    var steps = window._currentWorkflowSteps || [];
    if (!steps.length) {
        list.innerHTML = '<div style="color:var(--muted);padding:8px 0;font-size:13px;">No steps defined. Click + Add Step to build the workflow.</div>';
        return;
    }
    list.innerHTML = steps.map(function(s, i) {
        var typeColors = {trigger: "#3b82f6", action: "#10b981", wait: "#f59e0b"};
        var color = typeColors[s.stepType] || "#64748b";
        var configStr = typeof s.config === "object" ? JSON.stringify(s.config, null, 2) : (s.config || "{}");
        return '<div style="border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;background:var(--card-bg);">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">' +
                '<div style="display:flex;gap:8px;align-items:center;">' +
                    '<span style="background:' + color + ';color:white;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;">' + escapeHtml(s.stepType || "action") + '</span>' +
                    '<strong>' + escapeHtml(s.actionName || s.actionType || "Untitled") + '</strong>' +
                '</div>' +
                '<button type="button" onclick="removeWorkflowStep(' + i + ')" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:16px;">&times;</button>' +
            '</div>' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">' +
                '<div><label class="form-label" style="font-size:11px;">Step Type</label>' +
                    '<select class="form-select" onchange="updateStepField(' + i + ',\'stepType\',this.value)">' +
                        '<option value="trigger"' + (s.stepType==="trigger"?" selected":"") + '>Trigger</option>' +
                        '<option value="action"' + (s.stepType==="action"?" selected":"") + '>Action</option>' +
                        '<option value="wait"' + (s.stepType==="wait"?" selected":"") + '>Wait</option>' +
                    '</select></div>' +
                '<div><label class="form-label" style="font-size:11px;">Action Type</label>' +
                    '<select class="form-select" onchange="updateStepField(' + i + ',\'actionType\',this.value)">' +
                        '<option value="form_submitted"' + (s.actionType==="form_submitted"?" selected":"") + '>Form Submitted</option>' +
                        '<option value="contact_created"' + (s.actionType==="contact_created"?" selected":"") + '>Contact Created</option>' +
                        '<option value="status_changed"' + (s.actionType==="status_changed"?" selected":"") + '>Status Changed</option>' +
                        '<option value="call_received"' + (s.actionType==="call_received"?" selected":"") + '>Call Received</option>' +
                        '<option value="invoice_sent"' + (s.actionType==="invoice_sent"?" selected":"") + '>Invoice Sent</option>' +
                        '<option value="send_sms"' + (s.actionType==="send_sms"?" selected":"") + '>Send SMS</option>' +
                        '<option value="send_email"' + (s.actionType==="send_email"?" selected":"") + '>Send Email</option>' +
                        '<option value="internal_notification"' + (s.actionType==="internal_notification"?" selected":"") + '>Internal Notification</option>' +
                        '<option value="wait"' + (s.actionType==="wait"?" selected":"") + '>Wait/Delay</option>' +
                    '</select></div>' +
            '</div>' +
            '<div style="margin-top:8px;"><label class="form-label" style="font-size:11px;">Action Name</label>' +
                '<input type="text" class="form-input" value="' + escapeHtml(s.actionName || "") + '" onchange="updateStepField(' + i + ',\'actionName\',this.value)" /></div>' +
            '<div style="margin-top:8px;"><label class="form-label" style="font-size:11px;">Config (JSON)</label>' +
                '<textarea class="form-input" onchange="updateStepField(' + i + ',\'config\',this.value)" style="font-family:monospace;font-size:12px;min-height:60px;resize:vertical;">' + escapeHtml(configStr) + '</textarea></div>' +
        '</div>';
    }).join("");
}

function addWorkflowStep() {
    var steps = window._currentWorkflowSteps || [];
    steps.push({stepOrder: steps.length, stepType: "action", actionType: "send_sms", actionName: "New Step", config: {}});
    window._currentWorkflowSteps = steps;
    renderWorkflowSteps();
}

function removeWorkflowStep(i) {
    var steps = window._currentWorkflowSteps || [];
    steps.splice(i, 1);
    steps.forEach(function(s, idx) { s.stepOrder = idx; });
    window._currentWorkflowSteps = steps;
    renderWorkflowSteps();
}

function updateStepField(i, field, value) {
    var steps = window._currentWorkflowSteps || [];
    if (steps[i]) {
        if (field === "config") {
            try { steps[i].config = JSON.parse(value); } catch(e) { steps[i].config = value; }
        } else {
            steps[i][field] = value;
        }
    }
}

function saveWorkflowSteps(automationId) {
    var steps = window._currentWorkflowSteps || [];
    var orgId = getActiveOrgId();
    sbFetch("workflow_steps", "DELETE", "?automation_id=eq." + automationId)
        .then(function() {
            steps.forEach(function(s, i) {
                var row = {
                    automation_id: automationId,
                    org_id: orgId,
                    stepOrder: i,
                    stepType: s.stepType || "action",
                    actionType: s.actionType || "",
                    actionName: s.actionName || "",
                    config: typeof s.config === "string" ? JSON.parse(s.config || "{}") : (s.config || {})
                };
                sbFetch("workflow_steps", "POST", "", row, {"Prefer": "resolution=merge-duplicates"})
                    .catch(function(e) { console.warn("Step save failed", e); });
            });
        })
        .catch(function(e) { console.warn("Step delete failed", e); });
}

function setProjectSearch(val) {
    projectSearchQuery = (val || '').trim();
    renderProjects();
}

function setClientSearch(val) {
    clientSearchQuery = (val || '').trim();
    renderClients();
}

function projectMatchesSearch(p, q) {
    if (!q) return true;
    const client = getOrgClients().find(c => c.id === p.clientId);
    const statusLabel = getProjectStatusLabel(p, p.status);
    const hay = [
        p.name, p.location, p.project_manager, p.status, statusLabel,
        client ? client.company : '', client ? client.email : ''
    ].filter(Boolean).join(' ').toLowerCase();
    return hay.includes(q);
}

function renderMovePipeline(list) {
    const stages = MOVE_STATUS_OPTIONS;
    let html = '<div class="pipeline-board">';
    stages.forEach(stage => {
        const items = (list || []).filter(p => (p.status || MOVE_STATUS_OPTIONS[0].value) === stage.value);
        html += `<div class="pipeline-col">
            <div class="pipeline-col-header"><span>${stage.label}</span><span>${items.length}</span></div>
            <div class="pipeline-col-body">`;
        if (items.length) {
            html += items.map(p => {
                const client = getOrgClients().find(c => c.id === p.clientId);
                const dt = p.date ? new Date(p.date + 'T12:00:00') : null;
                const dateStr = dt ? dt.toLocaleDateString('en-US', {month:'short', day:'numeric'}) : '';
                const timeStr = p.time ? p.time : '';
                const locStr = p.location ? p.location : '';
                const meta = [dateStr, timeStr, locStr].filter(Boolean).join('  ');
                return `<div class="pipeline-card" onclick="openPanel(${p.id})">
                    <div class="pipeline-card-title">${escapeHtml(p.name || 'Move')}</div>
                    <div class="pipeline-card-sub">${escapeHtml(client?.company || '')}</div>
                    ${meta ? `<div class="pipeline-card-meta">${escapeHtml(meta)}</div>` : ''}
                </div>`;
            }).join('');
        } else {
            html += '<div class="pipeline-empty">No moves yet.</div>';
        }
        html += `</div></div>`;
    });
    html += '</div>';
    return html;
}

function getProjectShipmentStats(projectId) {
    const items = getOrgShipments().filter(s => s.projectId === projectId);
    const total = items.length;
    const received = items.filter(s => s.status === 'received').length;
    const pending = Math.max(total - received, 0);
    return { total, received, pending };
}

function getProjectMoveItemStats(projectId) {
    const items = getOrgMoveItems().filter(i => i.projectId === projectId);
    const total = items.length;
    const arrived = items.filter(i => i.arrived).length;
    const pending = Math.max(total - arrived, 0);
    return { total, arrived, pending };
}

function getProjectLocationStatus(projectId) {
    const shipItems = getOrgShipments().filter(s => s.projectId === projectId);
    if (shipItems.length) {
        const pending = shipItems.filter(s => s.status !== 'received').length;
        if (pending > 0) return 'Awaiting items';
        const inv = shipItems.map(s => s.inventoryStatus || s.inventory_status || '');
        if (inv.includes('dispatched')) return 'In Transit';
        if (inv.includes('delivered')) return 'At Jobsite';
        return 'In Warehouse';
    }
    const moveInv = getOrgMoveItems().filter(i => i.projectId === projectId);
    if (moveInv.length) {
        const pending = moveInv.filter(i => !i.arrived).length;
        return pending ? 'Awaiting arrival' : 'At Jobsite';
    }
    return 'No items yet';
}

function renderMoveProjectsList(list) {
    let html = '<table class="projects-table"><thead><tr>' +
        '<th>Project</th><th>Client</th><th>Status</th><th>Location</th><th>Pending Items</th>' +
        '</tr></thead><tbody>';
    if (!list.length) {
        html += '<tr><td colspan="5" style="padding:16px;color:var(--muted)">No moves yet.</td></tr>';
        html += '</tbody></table>';
        return html;
    }
    list.forEach(p => {
        const client = getOrgClients().find(c => c.id === p.clientId);
        const statusLabel = getProjectStatusLabel(p, p.status);
        const shipStats = getProjectShipmentStats(p.id);
        const moveStats = getProjectMoveItemStats(p.id);
        const pending = shipStats.pending + moveStats.pending;
        const total = shipStats.total + moveStats.total;
        const pendingLabel = total ? `${pending}/${total}` : '0';
        const locationLabel = getProjectLocationStatus(p.id);
        html += `<tr onclick="openPanel(${p.id})" style="cursor:pointer">
            <td><strong>${escapeHtml(p.name || 'Move')}</strong></td>
            <td>${escapeHtml(client?.company || '')}</td>
            <td>${escapeHtml(statusLabel)}</td>
            <td>${escapeHtml(locationLabel)}</td>
            <td>${escapeHtml(pendingLabel)}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    return html;
}
function renderPeople() { $('#people-list').innerHTML = getOrgPeople().map(p => `<div class="card" style="cursor:default"><div class="card-header"><div class="card-avatar">${escapeHtml((p.name||'').split(' ').map(n=>n[0]).join(''))}</div><div><div class="card-title">${escapeHtml(p.name)}</div><div class="card-subtitle">${escapeHtml(p.role)}</div></div></div><div class="card-stats"><span>${escapeHtml(p.phone || '')}</span></div></div>`).join(''); }
function renderClients() {
    var list = $('#clients-list');
    if (!list) return;
    const q = (clientSearchQuery || '').toLowerCase();
    const visibleClients = !q ? getOrgClients() : getOrgClients().filter(function(c){
      const hay = [
        c.company, c.email, c.phone, c.address, c.city, c.state, c.zip
      ].filter(Boolean).join(' ').toLowerCase();
      return hay.includes(q);
    });
    list.innerHTML = visibleClients.map(function(c) {
      var projCount = getOrgProjects().filter(function(p) { return p.clientId === c.id; }).length;
      return '<div class="card" style="cursor:pointer;padding:12px;margin-bottom:8px" onclick="openClientPanel(' + c.id + ')">' +
        '<div style="display:flex;justify-content:space-between;align-items:center">' +
        '<div><strong>' + escapeHtml(c.company || '') + '</strong>' +
        (c.email ? '<div style="font-size:12px;color:var(--text-secondary)">' + escapeHtml(c.email) + '</div>' : '') + '</div>' +
        '<div style="text-align:right;font-size:12px;color:var(--text-secondary)">' + projCount + ' project' + (projCount !== 1 ? 's' : '') + '</div>' +
        '</div></div>';
    }).join('');
  }

function populateSelects() {
    const visibleClients = pmAccess.enabled ? getOrgClients().filter(c => pmAccess.clientIds.includes(c.id)) : getOrgClients();
    const visibleProjects = getVisibleProjects();
    const o = '<option value="">Select...</option>' + visibleClients.map(c => `<option value="${c.id}">${escapeHtml(c.company)}</option>`).join('');
    $('#f-client').innerHTML = o;
    $('#p-client').innerHTML = o;

    const projOptions = '<option value="">Select...</option>' + visibleProjects.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
    $('#pi-project').innerHTML = projOptions;

    const peopleOptions = '<option value="">Select...</option>' + getOrgPeople().map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    $('#pi-reportedby').innerHTML = peopleOptions;
    const assignedEl = document.getElementById('pi-assigned');
    if (assignedEl) assignedEl.innerHTML = peopleOptions;
}

async function saveProject() {
    const n = $('#p-name').value.trim();
    const c = +$('#p-client').value;
    if (!n) return toast('Enter name');
    if (!c) return toast('Select client');

    const projectType = $('#p-project-type').value || getDefaultProjectType() || 'install';
    const defaultStatus = projectType === 'move' ? 'survey' : 'scheduled';
    const data = {
        name: n,
        client_id: c,
        project_type: projectType,
        install_date: $('#p-date').value || null,
        install_time: $('#p-time').value || '07:00',
        location: $('#p-location').value.trim(),
        project_manager: (document.getElementById('p-project-manager')?.value || null),
        project_manager_id: null,
        team: [],
        docs: {},
        pm_emails: (function(){
            const list = parseEmailList(document.getElementById('p-pm-emails')?.value || '');
            const pmVal = (document.getElementById('p-project-manager')?.value || '').trim();
            if (pmVal && pmVal.includes('@')) list.unshift(pmVal);
            return normalizeEmailList(list);
        })(),
        status: defaultStatus
    };

    const newId = await sbInsert('projects', data);
    if (newId) {
        projects.push(assignOrgId({ id: newId, name: n, clientId: c, projectType: data.project_type, date: data.install_date, time: data.install_time, location: data.location, team: [], docs: {}, status: defaultStatus, pm_emails: data.pm_emails || [] }, 'projects'));
    }
    recomputePMAccess();
    saveLocal();
    render();
    closeModal('project');
    toast('Created');
    const outlookInt = getOutlookIntegration();
    if (outlookInt && outlookInt.status === 'connected') {
        const proj = getOrgProjects().find(p => p.id === newId);
        if (proj) ensureOutlookEventForProject(proj).catch(e => console.warn('Outlook event create error:', e));
    }
}
async function savePerson() {
    const n = $('#pe-name').value.trim();
    if (!n) return toast('Enter name');

    const data = {
        name: n,
        role: $('#pe-role').value,
        phone: $('#pe-phone').value.trim(),
        email: $('#pe-email').value.trim()
    };

    const newId = await sbInsert('people', data);
    if (newId) {
        people.push(assignOrgId({ id: newId, ...data }, 'people'));
    }
    saveLocal();
    render();
    closeModal('person');
    toast('Added');
}
async function saveClient() {
    const c = $('#c-company').value.trim();
    if (!c) return toast('Enter company');

    const data = {
        company: c,
        email: $('#c-email').value.trim()
    };

    const newId = await sbInsert('clients', data);
    if (newId) {
        clients.push(assignOrgId({ id: newId, ...data }, 'clients'));
    }
    saveLocal();
    render();
    closeModal('client');
    toast('Created');
}

function toggleInline(t) { $(`#inline-${t}`).classList.toggle('hidden'); }
async function addInlineClient() {
    const n = $('#il-client').value.trim();
    if (!n) return;

    const data = { company: n, email: '' };
    const newId = await sbInsert('clients', data);
    if (newId) {
        const c = assignOrgId({ id: newId, ...data }, 'clients');
        clients.push(c);
    }
    saveLocal();
    populateSelects();
    $('#f-client').value = newId;
    onClientChange();
    $('#il-client').value = '';
    $('#inline-client').classList.add('hidden');
}
async function addInlineProject() {
    const n = $('#il-project').value.trim();
    const c = +$('#f-client').value;
    if (!n) return;
    if (!c) return toast('Select client first');

    const data = {
        name: n,
        client_id: c,
        install_date: null,
        install_time: '07:00',
        location: '',
        team: [],
        docs: {}
    };

    const newId = await sbInsert('projects', data);
    if (newId) {
        const p = assignOrgId({
            id: newId,
            name: n,
            clientId: c,
            date: null,
            time: '07:00',
            location: '',
            team: [],
            docs: {}
        }, 'projects');
        projects.push(p);
    }
    saveLocal();
    onClientChange();
    $('#f-project-id').value = newId;
    $('#f-project-search').value = n;
    $('#il-project').value = '';
    $('#inline-project').classList.add('hidden');
}

async function processNewScan() {
    if (pendingScan) {
        const data = {
            filename: pendingScan.filename,
            timestamp: pendingScan.timestamp,
            status: pendingScan.status,
            po: null,
            thumbnail: null,
            onedrive_url: null,
            pdf_url: pendingScan.pdf_url || null,
            camscanner_id: pendingScan.camscanner_id || null
        };

        const newId = await sbInsert('scans', data);
        if (newId) {
            pendingScan.id = newId;
            scans.unshift(assignOrgId(pendingScan, 'scans'));
        }
        saveLocal();
        render();
        closeScanAlert();
        openScanForm(newId || pendingScan.id);
        pendingScan = null;
    }
}
async function closeScanAlert() {
    if (pendingScan) {
        const data = {
            filename: pendingScan.filename,
            timestamp: pendingScan.timestamp,
            status: pendingScan.status,
            po: null,
            thumbnail: null,
            onedrive_url: null
        };

        const newId = await sbInsert('scans', data);
        if (newId) {
            pendingScan.id = newId;
            scans.unshift(pendingScan);
        }
        saveLocal();
        render();
        pendingScan = null;
    }
    $('#scan-alert').classList.remove('show');
}

let _receivingTab = 'scans';
let _dispatchTab = 'prepare';
let _settingsTab = 'people';
let calendarTab = 'calendar';
let availabilitySchedules = [];
let activeAvailabilityScheduleId = null;
let availabilityStaffId = null;

function isMobile() {
  return window.matchMedia && window.matchMedia('(max-width: 900px)').matches;
}

function mobileTabForView(v) {
  if (v === 'dashboard') return 'dashboard';
  if (v === 'warehouse') return 'receiving';
  if (v === 'people' || v === 'clients' || v === 'settings') return 'settings';
  return v;
}

function updateMobileNav(active) {
  document.querySelectorAll('.mobile-nav .mobile-tab').forEach(function(btn) {
    btn.classList.toggle('active', btn.dataset.view === active);
  });
}

function mobileNav(view) {
  if (view === 'receiving') {
    mobileReceivingTab(_receivingTab || 'scans');
  } else if (view === 'dispatch') {
    mobileDispatchTab(_dispatchTab || 'prepare');
  } else if (view === 'projects') {
    showNav('projects');
  } else if (view === 'dashboard') {
    showNav('dashboard');
  } else if (view === 'calendar') {
    showNav('calendar');
  } else if (view === 'settings') {
    mobileSettingsTab(_settingsTab || 'people');
  }
}

function updateMobileReceivingTabs() {
  document.querySelectorAll('.mobile-receiving-tabs .seg-btn').forEach(function(btn) {
    btn.classList.toggle('active', btn.dataset.tab === _receivingTab);
  });
}

function mobileReceivingTab(tab) {
  _receivingTab = tab;
  if (tab === 'warehouse') {
    showNav('warehouse', 'receiving');
    initWarehouse();
  } else {
    showNav('receiving', 'receiving');
    switchTab(tab);
  }
  updateMobileReceivingTabs();
}

function updateMobileDispatchTabs() {
  document.querySelectorAll('.mobile-dispatch-tabs .seg-btn').forEach(function(btn) {
    btn.classList.toggle('active', btn.dataset.tab === _dispatchTab);
  });
  var prepare = document.getElementById('dispatch-prepare');
  var history = document.getElementById('dispatch-history');
  if (prepare && history) {
    if (isMobile()) {
      prepare.style.display = _dispatchTab === 'prepare' ? 'block' : 'none';
      history.style.display = _dispatchTab === 'history' ? 'block' : 'none';
    } else {
      prepare.style.display = 'block';
      history.style.display = 'block';
    }
  }
}

function mobileDispatchTab(tab) {
  _dispatchTab = tab;
  showNav('dispatch', 'dispatch');
  updateMobileDispatchTabs();
}

function updateMobileSettingsTabs() {
  document.querySelectorAll('.mobile-settings-tabs .seg-btn').forEach(function(btn) {
    btn.classList.toggle('active', btn.dataset.tab === _settingsTab);
  });
}

function mobileSettingsTab(tab) {
  _settingsTab = tab;
  if (tab === 'people') {
    showNav('people', 'settings');
  } else if (tab === 'clients') {
    showNav('clients', 'settings');
  } else {
    showNav('settings', 'settings');
    settingsTab('staff');
  }
  updateMobileSettingsTabs();
}

function showNav(v, mobileOverride) {
  $$('.view').forEach(x => x.classList.remove('active'));
  $(`#view-${v}`).classList.add('active');
  $$('.nav-item').forEach(n => n.classList.remove('active'));
  let navEl = $(`.nav-item[onclick="showNav('${v}')"]`) || $(`.nav-item[onclick*="showNav('${v}')"]`);
  if (!navEl && v === 'projects' && isBmgWorkspace()) {
    navEl = projectsViewMode === 'board' ? document.getElementById('nav-moving') : document.getElementById('nav-projects');
  }
  if (!navEl) navEl = $(`.nav-item[onclick*="showProjects"]`);
  if (navEl) navEl.classList.add('active');
  const mobileTab = mobileOverride || mobileTabForView(v);
  updateMobileNav(mobileTab);
  if (v === 'warehouse') _receivingTab = 'warehouse';
  updateMobileReceivingTabs();
  updateMobileDispatchTabs();
  updateMobileSettingsTabs();
  closePanel();
}

function setProjectsViewMode(mode) {
  projectsViewMode = mode || 'list';
  const title = document.querySelector('#view-projects .header-title');
  if (title) {
    title.textContent = isBmgWorkspace() ? (projectsViewMode === 'list' ? 'Projects' : 'Moves') : 'Projects';
  }
  updateProjectsViewTabs();
  renderProjects();
}

function updateProjectsViewTabs() {
  document.querySelectorAll('.projects-view-tab').forEach(function(tab) {
    const mode = tab.getAttribute('data-mode');
    if (mode === projectsViewMode) tab.classList.add('active');
    else tab.classList.remove('active');
  });
}

function showProjectsBoard() {
  setProjectsViewMode('board');
  showNav('projects');
}

function showProjectsList() {
  setProjectsViewMode('list');
  showNav('projects');
}

function switchTab(t, el) {
  _receivingTab = t;
  document.querySelectorAll(".header-tab").forEach(function(x){ x.classList.remove("active"); });
  if (!el) el = document.querySelector('.header-tab[data-tab="'+t+'"]');
  if (el) el.classList.add("active");
  document.querySelectorAll(".tab-content").forEach(function(x){ x.classList.remove("active"); });
  var target = document.getElementById("tab-" + t);
  if (target) target.classList.add("active");
  updateMobileReceivingTabs();
}
function openModal(t) {
      if (arguments[0] === 'project') {
          loadPMDropdown();
          var pmInput = document.getElementById('p-pm-emails');
          if (pmInput) pmInput.value = '';
          var pt = document.getElementById('p-project-type');
          if (pt) pt.value = getDefaultProjectType();
      }
      document.getElementById('modal-'+t).classList.add('open');
      if(t==='shipment-list'){ document.getElementById('sl-client').innerHTML='<option value="">Select...</option>'+getOrgClients().map(function(c){return '<option value="'+c.id+'">'+c.company+'</option>';}).join(''); document.getElementById('sl-project').innerHTML='<option value="">Select...</option>'+getOrgProjects().map(function(p){return '<option value="'+p.id+'">'+p.name+'</option>';}).join(''); document.getElementById('sl-email').value='';document.getElementById('sl-po').value='';document.getElementById('sl-preview').style.display='none';document.getElementById('sl-submit-btn').disabled=true;document.getElementById('sl-submit-btn').textContent='Import Shipments';parsedShipmentOrders=[]; } }
function closeModal(t) { $(`#modal-${t}`).classList.remove('open'); }
function toast(m) { $('#toast-msg').textContent = m; $('#toast').classList.add('show'); setTimeout(() => $('#toast').classList.remove('show'), 3000); }

// ===== WAREHOUSE MODULE =====
let whRows=[],whBays=[],whBins=[],whItems=[],whCustomFields=[];
let whNav={level:'rows',rowId:null,bayId:null,binId:null,itemId:null};
let currentItemEdit=null, currentItemCFs=[], whLoaded=false;
let currentLoadoutSheetId = null;
let whSearchQuery='';

function naturalSort(a,b){ return new Intl.Collator(undefined,{numeric:true,sensitivity:'base'}).compare(a,b); }

async function loadWarehouse(){
    const r=await sbFetch('warehouse_rows','GET');
    whRows=filterByOrg(r||[]).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
    const b=await sbFetch('warehouse_bays','GET');
    whBays=filterByOrg(b||[]).sort((a,b2)=>naturalSort(a.name,b2.name));
    const bn=await sbFetch('warehouse_bins','GET');
    whBins=filterByOrg(bn||[]).sort((a,b2)=>(a.sort_order||0)-(b2.sort_order||0));
    const it=await sbFetch('inventory_items','GET');
    whItems=filterByOrg(it||[]);
    const cf=await sbFetch('item_custom_fields','GET');
    whCustomFields=cf||[];
}

async function initWarehouse(){
    if(!whLoaded){ await loadWarehouse(); whLoaded=true; }
    renderWarehouse();
}

function setWarehouseSearch(val){
    whSearchQuery=(val||'').trim();
    renderWarehouse();
}

function clearWarehouseSearch(){
    whSearchQuery='';
    const input=document.getElementById('wh-search');
    if(input) input.value='';
    renderWarehouse();
}

function whNavigateFromSearch(level,id){
    whSearchQuery='';
    const input=document.getElementById('wh-search');
    if(input) input.value='';
    whNavigate(level,id);
}

function renderWarehouse(){
    const bc=$('#wh-breadcrumb'), ct=$('#wh-content');
    if(!bc||!ct) return;
    const q=(whSearchQuery||'').trim();
    if(q){
        bc.innerHTML=`<div class="wh-breadcrumb"><span class="current">Search: "${escapeHtml(q)}"</span><span class="separator"></span><a onclick="clearWarehouseSearch()">Clear</a></div>`;
        ct.innerHTML=renderWhSearchResults(q);
        return;
    }
    // Breadcrumb
    let crumbs=[`<a onclick="whNavigate('rows')">All Rows</a>`];
    if(whNav.rowId){ const row=whRows.find(r=>r.id==whNav.rowId); if(row) crumbs.push(`<span class="separator"></span><a onclick="whNavigate('bays',${whNav.rowId})">${row.name}</a>`); }
    if(whNav.bayId){ const bay=whBays.find(b=>b.id==whNav.bayId); if(bay) crumbs.push(`<span class="separator"></span><a onclick="whNavigate('bins',${whNav.bayId})">${bay.name}</a>`); }
    if(whNav.binId){ const bin=whBins.find(b=>b.id==whNav.binId); if(bin) crumbs.push(`<span class="separator"></span><a onclick="whNavigate('items',${whNav.binId})">${bin.name}</a>`); }
    if(whNav.level==='detail'&&whNav.itemId){ const item=whItems.find(i=>i.id==whNav.itemId); if(item) crumbs.push(`<span class="separator"></span><span class="current">${item.name}</span>`); }
    bc.innerHTML=`<div class="wh-breadcrumb">${crumbs.join('')}</div>`;

    let h='';
    if(whNav.level==='rows') h=renderWhRows();
    else if(whNav.level==='bays') h=renderWhBays(whNav.rowId);
    else if(whNav.level==='bins') h=renderWhBins(whNav.bayId);
    else if(whNav.level==='items') h=renderWhItems(whNav.binId);
    else if(whNav.level==='detail') h=renderWhItemDetail(whNav.itemId);
    ct.innerHTML=h;
}

function whItemLocationLabel(binId){
    const bin=whBins.find(b=>b.id==binId);
    if(!bin) return '';
    const bay=whBays.find(b=>b.id==bin.bay_id);
    const row=bay?whRows.find(r=>r.id==bay.row_id):null;
    return [row?row.name:'', bay?bay.name:'', bin.name||''].filter(Boolean).join('  ');
}

function renderWhSearchResults(query){
    const q=query.toLowerCase();
    let h='';
    const itemMatches=whItems.filter(item=>{
        const loc=whItemLocationLabel(item.bin_id);
        const hay=[
            item.name, item.tags, item.notes, item.barcode_id,
            item.unit_type, loc
        ].filter(Boolean).join(' ').toLowerCase();
        return hay.includes(q);
    });
    const binMatches=whBins.filter(bin=>{
        return (bin.name||'').toLowerCase().includes(q);
    });
    const shipmentMatches=getOrgShipments().filter(s=>{
        const cl=getOrgClients().find(c=>c.id===s.clientId);
        const hay=[
            s.subitem, s.po, s.mfr, s.location,
            cl?cl.company:''
        ].filter(Boolean).join(' ').toLowerCase();
        return hay.includes(q);
    });

    if(!itemMatches.length && !binMatches.length && !shipmentMatches.length){
        return `<div class="wh-empty"><div class="wh-empty-icon"></div>No results for "${escapeHtml(query)}"</div>`;
    }

    if(itemMatches.length){
        h+='<div class="wh-search-section"><div class="wh-search-title">Inventory Items</div><div class="wh-grid">';
        itemMatches.forEach(item=>{
            const photos=item.photos||[];
            const thumb=photos.length?`<img src="${photos[0]}">`:'';
            const loc=whItemLocationLabel(item.bin_id);
            h+=`<div class="wh-item-card" onclick="whNavigateFromSearch('detail',${item.id})"><div class="thumb">${thumb}</div><div class="info"><div class="name">${escapeHtml(item.name||'')}</div><div class="qty">${item.quantity} ${escapeHtml(item.unit_type||'units')}${loc?'  '+escapeHtml(loc):''}</div></div></div>`;
        });
        h+='</div></div>';
    }

    if(binMatches.length){
        h+='<div class="wh-search-section"><div class="wh-search-title">Bins</div><div class="wh-grid">';
        binMatches.forEach(bin=>{
            const total=whItems.filter(i=>i.bin_id===bin.id).length;
            const loc=whItemLocationLabel(bin.id);
            h+=`<div class="wh-card" onclick="whNavigateFromSearch('items',${bin.id})"><div class="wh-card-icon bin">${(bin.name||'').split('-').pop().charAt(0)}</div><div class="wh-card-info"><div class="name">${escapeHtml(bin.name||'')}</div><div class="count">${total} item${total!==1?'s':''}${loc?'  '+escapeHtml(loc):''}</div></div></div>`;
        });
        h+='</div></div>';
    }

    if(shipmentMatches.length){
        h+='<div class="wh-search-section"><div class="wh-search-title">Shipments</div><div class="wh-grid">';
        shipmentMatches.forEach(s=>{
            const cl=getOrgClients().find(c=>c.id===s.clientId);
            const label=escapeHtml(s.subitem||s.po||'Shipment');
            const meta=[s.mfr, cl?cl.company:'', s.location].filter(Boolean).join('  ');
            h+=`<div class="wh-item-card" onclick="openShipmentPanel(${s.id})" style="border-left:3px solid var(--blue)"><div class="thumb"></div><div class="info"><div class="name">${label}</div><div class="qty">${escapeHtml(meta)}</div></div></div>`;
        });
        h+='</div></div>';
    }

    return h;
}

function whNavigate(level,id){
    if(level==='rows') whNav={level:'rows',rowId:null,bayId:null,binId:null,itemId:null};
    else if(level==='bays'){ whNav.level='bays'; whNav.rowId=id; whNav.bayId=null; whNav.binId=null; whNav.itemId=null; }
    else if(level==='bins'){ whNav.level='bins'; whNav.bayId=id; whNav.binId=null; whNav.itemId=null; }
    else if(level==='items'){ whNav.level='items'; whNav.binId=id; whNav.itemId=null; }
    else if(level==='detail'){ whNav.level='detail'; whNav.itemId=id; }
    renderWarehouse();
}

function renderWhRows(){
    if(!whRows.length) return '<div class="wh-empty"><div class="wh-empty-icon"></div>No warehouse rows found</div>';
    let h='<div class="wh-grid">';
    whRows.forEach(row=>{
        const bc=whBays.filter(b=>b.row_id===row.id).length;
        const icon=row.is_special?'':row.name.charAt(0);
        const cls=row.is_special?'special':'row';
        h+=`<div class="wh-card" onclick="whNavigate('bays',${row.id})"><div class="wh-card-icon ${cls}">${icon}</div><div class="wh-card-info"><div class="name">Row ${row.name}</div><div class="count">${bc} bay${bc!==1?'s':''}</div></div></div>`;
    });
    return h+'</div>';
}

function renderWhBays(rowId){
    const bays=whBays.filter(b=>b.row_id==rowId).sort((a,b)=>naturalSort(a.name,b.name));
    if(!bays.length) return '<div class="wh-empty"><div class="wh-empty-icon"></div>No bays found</div>';
    let h='<div class="wh-grid">';
    bays.forEach(bay=>{
        const bc=whBins.filter(b=>b.bay_id===bay.id).length;
        h+=`<div class="wh-card" onclick="whNavigate('bins',${bay.id})"><div class="wh-card-icon bay">${bay.name.replace(/[^A-Z]/gi,'').charAt(0)}</div><div class="wh-card-info"><div class="name">${bay.name}</div><div class="count">${bc} bin${bc!==1?'s':''}</div></div></div>`;
    });
    return h+'</div>';
}

function renderWhBins(bayId){
    const bins=whBins.filter(b=>b.bay_id==bayId).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
    if(!bins.length) return '<div class="wh-empty"><div class="wh-empty-icon"></div>No bins found</div>';
    let h='<div class="wh-grid">';
    bins.forEach(bin=>{
        const ic=whItems.filter(i=>i.bin_id===bin.id).length;
        const sc=getOrgShipments().filter(s=>s.location&&s.location.toLowerCase()===bin.name.toLowerCase()).length;
        const total=ic+sc;
        h+=`<div class="wh-card" onclick="whNavigate('items',${bin.id})"><div class="wh-card-icon bin">${bin.name.split('-').pop().charAt(0)}</div><div class="wh-card-info"><div class="name">${bin.name}</div><div class="count">${total} item${total!==1?'s':''}${sc?' ('+sc+' shipment'+(sc!==1?'s':'')+')':''}</div></div></div>`;
    });
    return h+'</div>';
}

function renderWhItems(binId){
    const items=whItems.filter(i=>i.bin_id==binId);
    const bin=whBins.find(b=>b.id==binId);
    const binName=bin?bin.name:'';
    const binShipments=binName?getOrgShipments().filter(s=>s.location&&s.location.toLowerCase()===binName.toLowerCase()):[];
    if(!items.length&&!binShipments.length) return '<div class="wh-empty"><div class="wh-empty-icon"></div>No items in this bin<br><button class="btn btn-primary" style="margin-top:16px" onclick="openItemModal(null)">+ Add Item</button></div>';
    let h='';
    if(binShipments.length){
        h+='<div style="margin-bottom:16px"><div style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Shipments in this bin</div><div class="wh-grid">';
        binShipments.forEach(s=>{
            const cl=getOrgClients().find(c=>c.id===s.clientId);
            h+=`<div class="wh-item-card" onclick="openShipmentPanel(${s.id})" style="border-left:3px solid var(--blue)"><div class="thumb"></div><div class="info"><div class="name">${s.subitem||s.po}</div><div class="qty">${s.mfr||''}${cl?'  '+cl.company:''}</div></div></div>`;
        });
        h+='</div></div>';
    }
    if(items.length){
        if(binShipments.length) h+='<div style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Inventory items</div>';
        h+='<div class="wh-grid">';
        items.forEach(item=>{
            const photos=item.photos||[];
            const thumb=photos.length?`<img src="${photos[0]}">`:'';
            h+=`<div class="wh-item-card" onclick="whNavigate('detail',${item.id})"><div class="thumb">${thumb}</div><div class="info"><div class="name">${item.name}</div><div class="qty">${item.quantity} ${item.unit_type||'units'}${item.price?'  $'+(item.quantity*item.price).toFixed(2):''}</div></div></div>`;
        });
        h+='</div>';
    }
    return h;
}

function renderWhItemDetail(itemId){
    const item=whItems.find(i=>i.id==itemId);
    if(!item) return '<p>Item not found</p>';
    const bin=whBins.find(b=>b.id===item.bin_id);
    const bay=bin?whBays.find(b=>b.id===bin.bay_id):null;
    const row=bay?whRows.find(r=>r.id===bay.row_id):null;
    const loc=row&&bay&&bin?`${row.name}  ${bay.name}  ${bin.name}`:'Unknown';
    const tv=(item.quantity||0)*(item.price||0);
    const fields=whCustomFields.filter(f=>f.item_id==itemId).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
    const tags=item.tags?item.tags.split(',').map(t=>t.trim()).filter(t=>t):[];
    let h=`<div class="wh-detail"><div class="wh-detail-header"><div class="wh-detail-title">${item.name}</div><div style="display:flex;gap:8px"><button class="btn btn-outline" onclick="openItemModal(${item.id})">Edit</button><button class="btn" style="background:var(--red);color:#fff" onclick="deleteItem(${item.id})">Delete</button></div></div>`;
    h+=`<div class="wh-detail-section"><div class="wh-detail-label">Location</div><div class="wh-detail-value">${loc}</div></div>`;
    h+=`<div class="wh-detail-section"><div class="wh-detail-row"><div><div class="wh-detail-label">Quantity</div><div class="wh-detail-value">${item.quantity} ${item.unit_type||'units'}</div></div><div><div class="wh-detail-label">Min Level</div><div class="wh-detail-value">${item.min_level||0}</div></div></div><div class="wh-detail-row"><div><div class="wh-detail-label">Unit Price</div><div class="wh-detail-value">$${(item.price||0).toFixed(2)}</div></div><div><div class="wh-detail-label">Total Value</div><div class="wh-detail-value">$${tv.toFixed(2)}</div></div></div></div>`;
    if(tags.length) { h+='<div class="wh-detail-section"><div class="wh-detail-label">Tags</div><div>'; tags.forEach(t=>{h+=`<span class="wh-tag">${t}</span>`;}); h+='</div></div>'; }
    if(item.notes) h+=`<div class="wh-detail-section"><div class="wh-detail-label">Notes</div><div class="wh-detail-value">${item.notes}</div></div>`;
    if(item.photos && item.photos.length){
        h+=`<div class="wh-detail-section"><div class="wh-detail-label">Photos</div><div class="wh-photos">${item.photos.map(src => `<div class="wh-photo"><img src="${src}" alt="photo"></div>`).join('')}</div></div>`;
    }
    if(fields.length){ h+='<div class="wh-detail-section"><div class="wh-detail-label">Custom Fields</div>'; fields.forEach(f=>{h+=`<div style="margin-bottom:8px"><strong>${f.field_name}:</strong> ${f.field_value}</div>`;}); h+='</div>'; }
    if(item.barcode_id) h+=`<div class="wh-detail-section"><div class="wh-detail-label">Barcode/QR ID</div><div class="wh-detail-value" style="font-family:monospace">${item.barcode_id}</div></div>`;
    return h+'</div>';
}

function openItemModal(itemId){
    currentItemEdit=itemId?whItems.find(i=>i.id==itemId):null;
    currentItemCFs=itemId?whCustomFields.filter(f=>f.item_id==itemId).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0)):[];
    $('#wh-modal-title').textContent=currentItemEdit?'Edit Item':'Add Item';
    // Populate bin dropdown
    let binOpts='<option value="">Select bin...</option>';
    whRows.forEach(row=>{
        const bays=whBays.filter(b=>b.row_id===row.id);
        bays.forEach(bay=>{
            const bins=whBins.filter(b=>b.bay_id===bay.id);
            bins.forEach(bin=>{ binOpts+=`<option value="${bin.id}">${row.name}  ${bay.name}  ${bin.name}</option>`; });
        });
    });
    $('#wh-item-bin').innerHTML=binOpts;
    if(currentItemEdit){
        $('#wh-item-name').value=currentItemEdit.name||'';
        $('#wh-item-quantity').value=currentItemEdit.quantity||0;
        $('#wh-item-unit').value=currentItemEdit.unit_type||'units';
        $('#wh-item-min-level').value=currentItemEdit.min_level||0;
        $('#wh-item-price').value=currentItemEdit.price||0;
        $('#wh-item-tags').value=currentItemEdit.tags||'';
        $('#wh-item-notes').value=currentItemEdit.notes||'';
        $('#wh-item-barcode').value=currentItemEdit.barcode_id||'';
        $('#wh-item-bin').value=currentItemEdit.bin_id||'';
        pendingItemPhotos = (currentItemEdit.photos || []).slice();
        const bin=whBins.find(b=>b.id===currentItemEdit.bin_id);
        const bay=bin?whBays.find(b=>b.id===bin.bay_id):null;
        const row=bay?whRows.find(r=>r.id===bay.row_id):null;
        $('#wh-location-display').textContent=row&&bay&&bin?`${row.name}  ${bay.name}  ${bin.name}`:'Not assigned';
    } else {
        $('#wh-item-name').value=''; $('#wh-item-quantity').value=0; $('#wh-item-unit').value='units';
        $('#wh-item-min-level').value=0; $('#wh-item-price').value=0; $('#wh-item-tags').value='';
        $('#wh-item-notes').value=''; $('#wh-item-barcode').value=''; currentItemCFs=[];
        pendingItemPhotos = [];
        if(whNav.binId) $('#wh-item-bin').value=whNav.binId;
        const bin=whBins.find(b=>b.id==whNav.binId);
        const bay=bin?whBays.find(b=>b.id===bin.bay_id):null;
        const row=bay?whRows.find(r=>r.id===bay.row_id):null;
        $('#wh-location-display').textContent=row&&bay&&bin?`${row.name}  ${bay.name}  ${bin.name}`:'Select below';
    }
    const photoInput = $('#wh-item-photos');
    if (photoInput) photoInput.value = '';
    renderWarehousePhotoPreviews();
    renderCFsForm();
    openModal('inventory-item');
}

function renderCFsForm(){
    let h='';
    currentItemCFs.forEach((f,i)=>{
        h+=`<div class="wh-custom-field"><input type="text" class="form-input wh-cf-name" value="${f.field_name||''}" placeholder="Field name"><input type="text" class="form-input wh-cf-val" value="${f.field_value||''}" placeholder="Value"><button type="button" class="remove-btn" onclick="removeCF(${i})"></button></div>`;
    });
    $('#wh-custom-fields-container').innerHTML=h;
}
function addCustomField(){ currentItemCFs.push({field_name:'',field_value:'',sort_order:currentItemCFs.length}); renderCFsForm(); }
function removeCF(i){ currentItemCFs.splice(i,1); renderCFsForm(); }

function renderWarehousePhotoPreviews(){
    const container = $('#wh-photo-previews');
    if (!container) return;
    if (!pendingItemPhotos || !pendingItemPhotos.length) { container.innerHTML = ''; return; }
    container.innerHTML = pendingItemPhotos.map((src, idx) => (
        `<div class="photo-preview"><img src="${src}" alt="photo"><button type="button" class="photo-remove" onclick="removeWarehousePhoto(${idx})">x</button></div>`
    )).join('');
}

function removeWarehousePhoto(idx){
    if (!pendingItemPhotos || idx < 0 || idx >= pendingItemPhotos.length) return;
    pendingItemPhotos.splice(idx, 1);
    renderWarehousePhotoPreviews();
}

async function handleWarehousePhotos(event){
    const files = Array.from(event.target.files || []);
    if (!files.length) return;
    for (const file of files) {
        try {
            const compressed = await compressImageFile(file);
            pendingItemPhotos.push(compressed.dataUrl);
        } catch (e) {
            console.warn('Warehouse photo compress failed, skipping', e);
        }
    }
    event.target.value = '';
    renderWarehousePhotoPreviews();
}

async function saveItem(){
    const name=$('#wh-item-name').value.trim();
    if(!name) return toast('Enter item name');
    const binId=$('#wh-item-bin').value;
    if(!binId) return toast('Select a bin location');
    const obj={name, bin_id:+binId, quantity:+($('#wh-item-quantity').value)||0, unit_type:$('#wh-item-unit').value, min_level:+($('#wh-item-min-level').value)||0, price:+($('#wh-item-price').value)||0, tags:$('#wh-item-tags').value.trim(), notes:$('#wh-item-notes').value.trim(), barcode_id:$('#wh-item-barcode').value.trim(), photos: pendingItemPhotos || [], updated_at:new Date().toISOString()};
    try {
        let itemId;
        if(currentItemEdit){
            await sbUpdate('inventory_items',currentItemEdit.id,obj);
            itemId=currentItemEdit.id;
        } else {
            obj.photos = pendingItemPhotos || [];
            itemId=await sbInsert('inventory_items',obj);
        }
        // Save custom fields
        const names=$$('.wh-cf-name'), vals=$$('.wh-cf-val');
        if(currentItemEdit){ for(let f of currentItemCFs){ if(f.id) await sbDelete('item_custom_fields',f.id); } }
        for(let i=0;i<names.length;i++){
            const fn=names[i].value.trim(), fv=vals[i].value.trim();
            if(fn||fv) await sbInsert('item_custom_fields',{item_id:itemId,field_name:fn,field_value:fv,sort_order:i});
        }
        closeModal('inventory-item');
        await loadWarehouse();
        renderWarehouse();
        toast(currentItemEdit?'Item updated':'Item added');
    } catch(e){ console.error('Save item error:',e); toast('Error saving item'); }
}

async function deleteItem(id){
    if(!confirm('Delete this item permanently?')) return;
    const fields=whCustomFields.filter(f=>f.item_id==id);
    for(let f of fields) await sbDelete('item_custom_fields',f.id);
    await sbDelete('inventory_items',id);
    await loadWarehouse();
    whNavigate('items',whNav.binId);
    toast('Item deleted');
}

/* ====================== SETTINGS & STAFF MANAGEMENT ====================== */

function settingsTab(tab, el) {
    activeSettingsTab = tab;
    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
    if (el) { el.classList.add('active'); }
    else {
        const tabs = document.querySelectorAll('.settings-tab');
        const tabMap = {integrations:0, staff:1, system:2};
        if(tabs[tabMap[tab]]) tabs[tabMap[tab]].classList.add('active');
    }
    const sec = document.getElementById('settings-'+tab);
    if(sec) sec.classList.add('active');
    renderSettings();
}

function renderSettings() {
    renderIntegrations();
    renderStaffTab();
    renderSystemTab();
}

const OUTLOOK_SCOPES = 'Calendars.ReadWrite Files.ReadWrite offline_access User.Read';

function getOutlookIntegration() {
    return getOrgIntegrations().find(i => i.type === 'outlook');
}

function getOutlookConfig() {
    const outlookInt = getOutlookIntegration();
    const config = outlookInt && outlookInt.config
        ? (typeof outlookInt.config === 'string' ? JSON.parse(outlookInt.config) : outlookInt.config)
        : {};
    const requiredUploaderEmail = (config.requiredUploaderEmail !== undefined)
        ? config.requiredUploaderEmail
        : 'alex@vectorinstallations.com';
    return {
        clientId: config.clientId || '',
        warehouseEmails: config.warehouseEmails || '',
        shareWithTeam: config.shareWithTeam !== false,
        defaultDurationHours: config.defaultDurationHours || 8,
        driveRootName: config.driveRootName || 'Vector CRM',
        requiredUploaderEmail: requiredUploaderEmail,
        connectedEmail: config.connectedEmail || '',
        linkedCalendar: config.linkedCalendar || 'Outlook Calendar',
        conflictCalendars: config.conflictCalendars || ['Outlook Calendar'],
        privateMode: config.privateMode !== false
    };
}

async function saveOutlookConfig(patch) {
    const outlookInt = getOutlookIntegration();
    if (!outlookInt) return;
    const current = getOutlookConfig();
    const updated = Object.assign({}, current, patch || {});
    await sbUpdate('integrations', outlookInt.id, { config: JSON.stringify(updated) });
    outlookInt.config = JSON.stringify(updated);
}

function renderIntegrations() {
    const el = document.getElementById('settings-integrations');
    if(!el) return;
    const outlookInt = getOutlookIntegration();
    const isConnected = outlookInt && outlookInt.status === 'connected';
    const cameraInt = getOrgIntegrations().find(i => i.type === 'camera');
    const cameraOn = cameraInt && cameraInt.status === 'connected';
    const outlookCfg = getOutlookConfig();
    const requiredUploaderEmail = (outlookCfg.requiredUploaderEmail || '').trim();
    const connectedEmail = (outlookCfg.connectedEmail || '').trim();
    const uploaderMismatch = isConnected && requiredUploaderEmail && connectedEmail && (requiredUploaderEmail.toLowerCase() !== connectedEmail.toLowerCase());
    const connectedLine = connectedEmail
        ? '<div style="font-size:12px;color:var(--text2);margin:6px 0 10px">Connected as <strong>'+escapeHtml(connectedEmail)+'</strong></div>'
        : '';
    const mismatchLine = uploaderMismatch
        ? '<div style="font-size:12px;color:var(--red);margin:-6px 0 10px">Uploads require '+escapeHtml(requiredUploaderEmail)+'. Reconnect Outlook.</div>'
        : '';
    const outlookSettings = isConnected ? (
        '<div style="margin-top:12px;padding:12px;border:1px solid var(--border);border-radius:8px;background:#fff">' +
            '<div style="font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Sharing</div>' +
            connectedLine +
            mismatchLine +
            '<div class="form-group" style="margin-bottom:10px">' +
                '<label class="form-label">Upload To This OneDrive Account</label>' +
                '<input type="text" class="form-input" id="outlook-uploader-email" placeholder="alex@vectorinstallations.com" value="'+escapeHtml(requiredUploaderEmail)+'">' +
                '<div class="form-hint">Files always upload to this email\'s OneDrive. Reconnect Outlook if it doesn\'t match.</div>' +
            '</div>' +
            '<div class="form-group" style="margin-bottom:10px">' +
                '<label class="form-label">Warehouse Emails (comma-separated)</label>' +
                '<input type="text" class="form-input" id="outlook-warehouse-emails" placeholder="warehouse@yourcompany.com" value="'+escapeHtml(outlookCfg.warehouseEmails)+'">' +
                '<div class="form-hint">Crew access is pulled from the assigned project team.</div>' +
            '</div>' +
            '<label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);margin-bottom:10px">' +
                '<input type="checkbox" id="outlook-share-team" '+(outlookCfg.shareWithTeam ? 'checked' : '')+'> Share with assigned team' +
            '</label>' +
            '<div class="form-group" style="margin-bottom:10px">' +
                '<label class="form-label">Default Event Duration (hours)</label>' +
                '<input type="number" class="form-input" id="outlook-duration-hours" min="1" max="12" value="'+escapeHtml(outlookCfg.defaultDurationHours)+'">' +
            '</div>' +
            '<button class="btn btn-outline" onclick="saveOutlookSettings()">Save Outlook Settings</button>' +
        '</div>'
    ) : '';

    el.innerHTML = '<div class="settings-card"><div class="settings-card-header"><h3>Microsoft Outlook Calendar</h3><span class="badge '+(isConnected?'badge-connected':'badge-disconnected')+'">'+(isConnected?'Connected':'Not Connected')+'</span></div><div class="integration-card"><div class="integration-icon" style="background:#0078d4;color:#fff">\u{1F4C5}</div><div class="integration-info"><p>Sync your Outlook calendar to see upcoming installs, deliveries, and team schedules directly in Vector CRM.</p>'+(isConnected?'<div style="display:flex;gap:8px;align-items:center"><button class="btn btn-outline" onclick="syncOutlookCalendar()">\u{1F504} Sync Now</button><button class="btn btn-outline" style="color:var(--red);border-color:var(--red)" onclick="disconnectOutlook()">Disconnect</button></div>':'<button class="btn btn-primary" onclick="initiateOutlookAuth()">Connect Outlook</button><span style="font-size:11px;color:var(--muted);margin-left:8px">Requires Microsoft 365 account</span>')+outlookSettings+'</div></div></div><div class="settings-card"><div class="settings-card-header"><h3>Camera Upload</h3><span class="badge '+(cameraOn?'badge-connected':'badge-disconnected')+'">'+(cameraOn?'Active':'Inactive')+'</span></div><div class="integration-card"><div class="integration-icon" style="background:var(--green);color:#fff">\u{1F4F8}</div><div class="integration-info"><p>Enable camera photo capture for receiving, punchlist documentation, and project completion photos.</p><label class="toggle-switch"><input type="checkbox" '+(cameraOn?'checked':'')+' onchange="toggleCameraIntegration(this.checked)"><span class="toggle-slider"></span></label></div></div></div><div class="settings-card"><div class="settings-card-header"><h3>Supabase Database</h3><span class="badge badge-connected">Connected</span></div><div class="integration-card"><div class="integration-icon" style="background:#3ecf8e;color:#fff">\u{1F5C4}\u{FE0F}</div><div class="integration-info"><p>Cloud database powering Vector CRM. All data syncs in real-time.</p><span style="font-size:12px;color:var(--muted)">8 active tables</span></div></div></div>';
}

// ============ GoHighLevel Integration ============
function renderGhlCard() {
  var intSection = document.getElementById('settings-integrations');
  if (!intSection || document.getElementById('ghl-integration-card')) return;
  var ghlCard = document.createElement('div');
  ghlCard.className = 'settings-card';
  ghlCard.id = 'ghl-integration-card';
  ghlCard.innerHTML = '<div class="settings-card-header"><h3>GoHighLevel (GHL)</h3><span class="badge" id="ghl-status-badge" style="background:#e8e8e8;color:#666">Checking...</span></div>' +
    '<div class="integration-card"><div class="integration-icon" style="background:#ff6b35;color:#fff;font-size:20px;display:flex;align-items:center;justify-content:center;width:42px;height:42px;border-radius:10px">G</div>' +
    '<div class="integration-info"><p>Sync automations, contacts, pipelines, and opportunities from GoHighLevel into Vector CRM.</p>' +
    '<div id="ghl-config-section" style="margin-top:8px">' +
    '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><label style="font-size:12px;color:#666;min-width:80px">API Key:</label>' +
    '<input type="password" id="ghl-api-key-input" placeholder="Enter GHL Location API Key" style="flex:1;padding:6px 10px;border:1px solid #ddd;border-radius:6px;font-size:13px" />' +
    '<button class="btn btn-primary" onclick="saveGhlApiKey()" style="padding:4px 12px;font-size:12px">Save</button></div>' +
    '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><label style="font-size:12px;color:#666;min-width:80px">Location:</label>' +
    '<span id="ghl-location-id" style="font-size:12px;color:#999">Loading...</span></div>' +
    '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">' +
    '<button class="btn" onclick="testGhlConnection()" id="ghl-test-btn" style="padding:4px 12px;font-size:12px;background:#f0f0f0;border:1px solid #ddd;border-radius:6px;cursor:pointer">Test Connection</button>' +
    '<button class="btn" onclick="syncGhl(\x27workflows\x27)" style="padding:4px 12px;font-size:12px;background:#f0f0f0;border:1px solid #ddd;border-radius:6px;cursor:pointer">Sync Workflows</button>' +
    '<button class="btn" onclick="syncGhl(\x27contacts\x27)" style="padding:4px 12px;font-size:12px;background:#f0f0f0;border:1px solid #ddd;border-radius:6px;cursor:pointer">Sync Contacts</button>' +
    '<button class="btn" onclick="syncGhl(\x27pipelines\x27)" style="padding:4px 12px;font-size:12px;background:#f0f0f0;border:1px solid #ddd;border-radius:6px;cursor:pointer">Sync Pipelines</button>' +
    '<button class="btn" onclick="syncGhl(\x27opportunities\x27)" style="padding:4px 12px;font-size:12px;background:#f0f0f0;border:1px solid #ddd;border-radius:6px;cursor:pointer">Sync Opportunities</button></div>' +
    '<div id="ghl-sync-status" style="font-size:12px;color:#666"></div>' +
    '<div id="ghl-last-sync" style="font-size:11px;color:#999;margin-top:4px"></div></div></div></div>';
  intSection.appendChild(ghlCard);
  loadGhlConfig();
}

async function loadGhlConfig() {
  var orgId = getActiveOrgId();
  if (!orgId) return;
  try {
    var configs = await sbFetch('ghl_config', 'GET', '?org_id=eq.' + encodeURIComponent(orgId));
    var cfg = (configs || [])[0];
    var badge = document.getElementById('ghl-status-badge');
    var locSpan = document.getElementById('ghl-location-id');
    var apiInput = document.getElementById('ghl-api-key-input');
    if (!badge) return;
    if (cfg) {
      locSpan.textContent = cfg.ghl_location_id || 'Not set';
      if (cfg.ghl_api_key) {
        badge.textContent = 'Configured';
        badge.style.background = '#e6f9e6';
        badge.style.color = '#2d7d2d';
        apiInput.placeholder = 'Key saved (enter new to replace)';
      } else {
        badge.textContent = 'Key Needed';
        badge.style.background = '#fff4e5';
        badge.style.color = '#b36b00';
      }
      if (cfg.last_sync_at) {
        var lsEl = document.getElementById('ghl-last-sync');
        if (lsEl) lsEl.textContent = 'Last sync: ' + new Date(cfg.last_sync_at).toLocaleString();
      }
    } else {
      badge.textContent = 'Not Configured';
      badge.style.background = '#fee';
      badge.style.color = '#c00';
      locSpan.textContent = 'No config for this org';
    }
  } catch(e) { console.error('loadGhlConfig:', e); }
}

async function saveGhlApiKey() {
  var orgId = getActiveOrgId();
  var input = document.getElementById('ghl-api-key-input');
  var key = input.value.trim();
  if (!key) { alert('Please enter a GHL API key'); return; }
  try {
    await sbFetch('ghl_config', 'PATCH', '?org_id=eq.' + encodeURIComponent(orgId), { ghl_api_key: key });
    input.value = '';
    loadGhlConfig();
    alert('GHL API key saved!');
  } catch(e) { alert('Error: ' + e.message); }
}

async function testGhlConnection() {
  var orgId = getActiveOrgId();
  var btn = document.getElementById('ghl-test-btn');
  var statusDiv = document.getElementById('ghl-sync-status');
  btn.textContent = 'Testing...';
  btn.disabled = true;
  try {
    var configs = await sbFetch('ghl_config', 'GET', '?org_id=eq.' + encodeURIComponent(orgId));
    var cfg = (configs || [])[0];
    if (!cfg || !cfg.ghl_location_id) { statusDiv.innerHTML = '<span style="color:red">No GHL config found</span>'; btn.textContent = 'Test Connection'; btn.disabled = false; return; }
    var resp = await fetch('/api/ghl-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ org_id: orgId, endpoint: 'pipelines/', method: 'GET' })
    });
    var data = await resp.json();
    if (resp.ok && data.pipelines) {
      statusDiv.innerHTML = '<span style="color:green">Connected! Location: ' + (data.pipelines.length + ' pipeline(s)' || data.id) + '</span>';
      var badge = document.getElementById('ghl-status-badge');
      if (badge) { badge.textContent = 'Connected'; badge.style.background = '#e6f9e6'; badge.style.color = '#2d7d2d'; }
    } else {
      statusDiv.innerHTML = '<span style="color:red">Failed: ' + (data.error || 'Unknown error') + '</span>';
    }
  } catch(e) { statusDiv.innerHTML = '<span style="color:red">' + e.message + '</span>'; }
  btn.textContent = 'Test Connection';
  btn.disabled = false;
}

async function syncGhl(syncType) {
  var orgId = getActiveOrgId();
  var statusDiv = document.getElementById('ghl-sync-status');
  statusDiv.innerHTML = '<span style="color:var(--blue)">Syncing ' + syncType + '...</span>';
  try {
    var resp = await fetch('/api/ghl-sync', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ org_id: orgId, sync_type: syncType })
    });
    var data = await resp.json();
    if (resp.ok && data.success) {
      statusDiv.innerHTML = '<span style="color:green">Synced ' + data.records_synced + ' ' + syncType + '!</span>';
      loadGhlConfig();
    } else {
      statusDiv.innerHTML = '<span style="color:red">Failed: ' + (data.error || 'Unknown') + '</span>';
    }
  } catch(e) { statusDiv.innerHTML = '<span style="color:red">' + e.message + '</span>'; }
}

// Patch renderIntegrations to also render GHL card
var _origRenderIntegrations = renderIntegrations;
renderIntegrations = function() { _origRenderIntegrations(); renderGhlCard(); };
// ============ End GHL Integration ============


function generateCodeVerifier() {
    const arr = new Uint8Array(32);
    crypto.getRandomValues(arr);
    return btoa(String.fromCharCode(...arr)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
}

async function generateCodeChallenge(verifier) {
    const encoder = new TextEncoder();
    const data = encoder.encode(verifier);
    const digest = await crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
}

async function initiateOutlookAuth() {
    const outlookInt = getOutlookIntegration();
    const config = getOutlookConfig();
    const clientId = config.clientId || '';
    if (!clientId) { openOAuthSetupModal(); return; }
    const verifier = generateCodeVerifier();
    sessionStorage.setItem('oauth_verifier', verifier);
    const challenge = await generateCodeChallenge(verifier);
    const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname);
    const scope = encodeURIComponent(OUTLOOK_SCOPES);
    window.location.href = 'https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id='+clientId+'&response_type=code&redirect_uri='+redirectUri+'&scope='+scope+'&code_challenge='+challenge+'&code_challenge_method=S256&response_mode=query';
}

function openOAuthSetupModal() {
    const modal = document.createElement('div');
    modal.className = 'modal open';
    modal.id = 'modal-oauth-setup';
    modal.innerHTML = '<div class="modal-content" style="max-width:560px"><div class="modal-header"><h3>Connect Microsoft Outlook</h3><button class="modal-close" onclick="this.closest(\'.modal\').remove()">\u2715</button></div><div class="modal-body" style="padding:20px"><div style="background:var(--blue-lt);border-radius:8px;padding:16px;margin-bottom:16px"><strong>Setup Required</strong><p style="font-size:13px;color:var(--text2);margin-top:4px">To connect Outlook + files, you need to register an Azure AD app first.</p></div><ol style="font-size:13px;color:var(--text2);line-height:1.8;padding-left:20px"><li>Go to <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank" style="color:var(--blue)">Azure App Registrations</a></li><li>Click "New registration"</li><li>Name: <strong>Vector CRM</strong></li><li>Redirect URI: <strong>SPA</strong> \u2192 <code style="background:var(--gray-lt);padding:2px 6px;border-radius:4px">'+window.location.origin+window.location.pathname+'</code></li><li>Copy the Application (client) ID and paste below</li></ol><div class="form-group" style="margin-top:16px"><label class="form-label">Azure Application Client ID</label><input type="text" class="form-input" id="oauth-client-id" placeholder="e.g. 12345678-abcd-efgh-ijkl-123456789012"></div><div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-primary" onclick="saveOAuthClientId()">Save & Connect</button><button class="btn btn-outline" onclick="this.closest(\'.modal\').remove()">Cancel</button></div></div></div>';
    document.body.appendChild(modal);
}

async function saveOAuthClientId() {
    const clientId = document.getElementById('oauth-client-id').value.trim();
    if (!clientId) { toast('Please enter a Client ID'); return; }
    const existing = getOutlookIntegration();
    const cfg = Object.assign({}, getOutlookConfig(), { clientId });
    if (existing) {
        await sbUpdate('integrations', existing.id, {config: JSON.stringify(cfg)});
        existing.config = JSON.stringify(cfg);
    } else {
        try {
            const newId = await sbInsert('integrations', {type:'outlook', status:'pending', config: JSON.stringify(cfg)});
            if(newId) crmIntegrations.push(assignOrgId({id:newId, type:'outlook', status:'pending', config: JSON.stringify(cfg)}, 'integrations'));
        } catch(e) {}
    }
    document.getElementById('modal-oauth-setup').remove();
    toast('Client ID saved! Starting OAuth...');
    const verifier = generateCodeVerifier();
    sessionStorage.setItem('oauth_verifier', verifier);
    const challenge = await generateCodeChallenge(verifier);
    const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname);
    const scope = encodeURIComponent(OUTLOOK_SCOPES);
    window.location.href = 'https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id='+clientId+'&response_type=code&redirect_uri='+redirectUri+'&scope='+scope+'&code_challenge='+challenge+'&code_challenge_method=S256&response_mode=query';
}

async function handleOAuthCallback() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    if (!code) return;
    const verifier = sessionStorage.getItem('oauth_verifier');
    if (!verifier) return;
    const outlookInt = getOutlookIntegration();
    const config = getOutlookConfig();
    const clientId = config.clientId;
    if (!clientId) { toast('OAuth error: no client ID'); return; }
    try {
        const tokenRes = await fetch('https://login.microsoftonline.com/common/oauth2/v2.0/token', {
            method: 'POST', headers: {'Content-Type':'application/x-www-form-urlencoded'},
            body: new URLSearchParams({client_id:clientId, grant_type:'authorization_code', code:code, redirect_uri:window.location.origin+window.location.pathname, code_verifier:verifier, scope:OUTLOOK_SCOPES})
        });
        const tokens = await tokenRes.json();
        if (tokens.access_token) {
            const ud = {status:'connected', access_token:tokens.access_token, refresh_token:tokens.refresh_token||'', token_expires:new Date(Date.now()+tokens.expires_in*1000).toISOString(), config:JSON.stringify(config)};
            if (outlookInt) { await sbUpdate('integrations', outlookInt.id, ud); Object.assign(outlookInt, ud); }
            try {
                const email = await fetchOutlookConnectedEmail();
                if (email) await saveOutlookConfig({ connectedEmail: email });
            } catch (e) {}
            toast('Outlook connected!');
            sessionStorage.removeItem('oauth_verifier');
            window.history.replaceState({}, '', window.location.pathname);
            renderSettings();
        } else { toast('OAuth error: '+(tokens.error_description||tokens.error)); }
    } catch(e) { toast('OAuth error: '+e.message); }
}

async function refreshOutlookToken(outlookInt) {
    const config = getOutlookConfig();
    if (!outlookInt || !outlookInt.refresh_token || !config.clientId) {
        toast('Outlook session expired. Reconnect.');
        return false;
    }
    try {
        const tokenRes = await fetch('https://login.microsoftonline.com/common/oauth2/v2.0/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                client_id: config.clientId,
                grant_type: 'refresh_token',
                refresh_token: outlookInt.refresh_token,
                scope: OUTLOOK_SCOPES
            })
        });
        const tokens = await tokenRes.json();
        if (!tokens.access_token) {
            console.warn('Outlook refresh failed:', tokens);
            toast('Outlook refresh failed. Reconnect.');
            return false;
        }
        const ud = {
            access_token: tokens.access_token,
            refresh_token: tokens.refresh_token || outlookInt.refresh_token,
            token_expires: new Date(Date.now() + (tokens.expires_in || 3600) * 1000).toISOString(),
            status: 'connected'
        };
        await sbUpdate('integrations', outlookInt.id, ud);
        Object.assign(outlookInt, ud);
        return true;
    } catch (e) {
        console.warn('Outlook refresh error:', e);
        toast('Outlook refresh failed. Reconnect.');
        return false;
    }
}

async function getOutlookAccessToken() {
    const outlookInt = getOutlookIntegration();
    if (!outlookInt || outlookInt.status !== 'connected') return null;
    const expiresAt = outlookInt.token_expires ? new Date(outlookInt.token_expires).getTime() : 0;
    if (!outlookInt.access_token || (expiresAt && Date.now() > (expiresAt - 120000))) {
        const ok = await refreshOutlookToken(outlookInt);
        if (!ok) return null;
    }
    return outlookInt.access_token;
}

async function outlookFetch(url, options) {
    const token = await getOutlookAccessToken();
    if (!token) throw new Error('Outlook not connected');
    const opts = options || {};
    const headers = Object.assign({}, opts.headers || {}, { 'Authorization': 'Bearer ' + token });
    const res = await fetch(url, Object.assign({}, opts, { headers }));
    if (res.status === 401) {
        const outlookInt = getOutlookIntegration();
        const ok = await refreshOutlookToken(outlookInt);
        if (!ok) return res;
        const retryHeaders = Object.assign({}, opts.headers || {}, { 'Authorization': 'Bearer ' + outlookInt.access_token });
        return fetch(url, Object.assign({}, opts, { headers: retryHeaders }));
    }
    return res;
}

let lastOutlookUploaderWarning = 0;

async function fetchOutlookConnectedEmail() {
    try {
        const res = await outlookFetch('https://graph.microsoft.com/v1.0/me?$select=mail,userPrincipalName');
        if (!res.ok) return '';
        const data = await res.json();
        return (data.mail || data.userPrincipalName || '').trim().toLowerCase();
    } catch (e) {
        return '';
    }
}

async function ensureOutlookUploaderAccount() {
    const cfg = getOutlookConfig();
    const required = (cfg.requiredUploaderEmail || '').trim().toLowerCase();
    if (!required) return true;
    let connected = (cfg.connectedEmail || '').trim().toLowerCase();
    if (!connected) {
        connected = await fetchOutlookConnectedEmail();
        if (connected) await saveOutlookConfig({ connectedEmail: connected });
    }
    if (connected && connected === required) return true;
    const now = Date.now();
    if (now - lastOutlookUploaderWarning > 60000) {
        toast('Connect Outlook as ' + required + ' to upload files.');
        lastOutlookUploaderWarning = now;
    }
    return false;
}

function parseEmailList(str) {
    return (str || '')
        .split(/[;,]/g)
        .map(s => s.trim())
        .filter(Boolean);
}

function getShareEmailsForProject(project) {
    const cfg = getOutlookConfig();
    const emails = new Set(parseEmailList(cfg.warehouseEmails));
    if (cfg.shareWithTeam && project && Array.isArray(project.team)) {
        project.team.forEach(id => {
            const p = getOrgPeople().find(x => x.id === id);
            if (p && p.email) emails.add(p.email);
        });
    }
    return Array.from(emails);
}

function buildOutlookDateTime(dateStr, timeStr, durationHours) {
    if (!dateStr) return null;
    const parts = dateStr.split('-').map(Number);
    if (parts.length < 3) return null;
    const t = (timeStr || '07:00').split(':').map(Number);
    const local = new Date(parts[0], parts[1]-1, parts[2], t[0] || 7, t[1] || 0);
    const end = new Date(local.getTime() + (durationHours || 8) * 60 * 60 * 1000);
    return {
        start: { dateTime: local.toISOString().replace('Z',''), timeZone: 'UTC' },
        end: { dateTime: end.toISOString().replace('Z',''), timeZone: 'UTC' }
    };
}

function buildOutlookEventBody(project) {
    const docs = project.docs || {};
    const entries = [
        { k: 'workOrder', n: 'Work Order' },
        { k: 'deliveryReceipt', n: 'Delivery Receipt' },
        { k: 'drawing', n: 'Drawing' },
        { k: 'moveGuide', n: 'Move Guide' },
        { k: 'coi', n: 'COI' },
        { k: 'beforePlan', n: 'Before Prints' },
        { k: 'afterPlan', n: 'After Prints' },
        { k: 'floorPlan', n: 'Floor Plan' },
        { k: 'zoneMap', n: 'Zone Map' },
        { k: 'destinationMap', n: 'Destination Map' }
    ];
    const links = entries.map(e => {
        const d = normalizeDocEntry(docs[e.k]);
        return d && d.url ? `<li><a href="${escapeHtml(d.url)}" target="_blank" rel="noopener">${escapeHtml(e.n)}</a></li>` : '';
    }).filter(Boolean).join('');
    const loc = project.location ? `<div><strong>Location:</strong> ${escapeHtml(project.location)}</div>` : '';
    const team = (project.team || []).map(id => {
        const p = getOrgPeople().find(x => x.id === id);
        return p ? p.name : null;
    }).filter(Boolean).join(', ');
    const teamLine = team ? `<div><strong>Crew:</strong> ${escapeHtml(team)}</div>` : '';
    return `<div><strong>Project:</strong> ${escapeHtml(project.name || '')}</div>${loc}${teamLine}` +
        `<div style="margin-top:8px"><strong>Documents</strong></div>` +
        (links ? `<ul>${links}</ul>` : `<div style="color:#666">No documents uploaded yet.</div>`);
}

async function findOutlookEventForProject(project) {
    if (!project || !project.date) return null;
    const start = new Date(project.date + 'T00:00:00');
    const end = new Date(project.date + 'T23:59:59');
    const res = await outlookFetch('https://graph.microsoft.com/v1.0/me/calendarview?startDateTime=' + start.toISOString() + '&endDateTime=' + end.toISOString() + '&$top=50');
    const data = await res.json();
    const name = (project.name || '').toLowerCase();
    return (data.value || []).find(ev => (ev.subject || '').toLowerCase().includes(name)) || null;
}

async function ensureOutlookEventForProject(project) {
    if (!project) return null;
    const ok = await ensureOutlookUploaderAccount();
    if (!ok) return null;
    project.docs = project.docs || {};
    if (project.docs.outlookEventId) return project.docs.outlookEventId;
    try {
        const existing = await findOutlookEventForProject(project);
        if (existing && existing.id) {
            project.docs.outlookEventId = existing.id;
            await sbUpdate('projects', project.id, { docs: project.docs });
            return existing.id;
        }
    } catch (e) {}
    const cfg = getOutlookConfig();
    const dt = buildOutlookDateTime(project.date, project.time, cfg.defaultDurationHours);
    if (!dt) return null;
    const payload = {
        subject: 'Project: ' + (project.name || ''),
        body: { contentType: 'HTML', content: buildOutlookEventBody(project) },
        start: dt.start,
        end: dt.end,
        location: { displayName: project.location || '' }
    };
    const res = await outlookFetch('https://graph.microsoft.com/v1.0/me/events', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data && data.id) {
        project.docs.outlookEventId = data.id;
        await sbUpdate('projects', project.id, { docs: project.docs });
        return data.id;
    }
    return null;
}

async function updateOutlookEventDocs(project) {
    if (!project) return;
    const eventId = await ensureOutlookEventForProject(project);
    if (!eventId) return;
    const payload = { body: { contentType: 'HTML', content: buildOutlookEventBody(project) } };
    await outlookFetch('https://graph.microsoft.com/v1.0/me/events/' + eventId, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
}

async function ensureOutlookRootFolder() {
    const cfg = getOutlookConfig();
    const name = cfg.driveRootName || 'Vector CRM';
    const filterName = name.replace(/'/g, "''");
    const res = await outlookFetch('https://graph.microsoft.com/v1.0/me/drive/root/children?$filter=name eq \'' + filterName + '\'');
    const data = await res.json();
    if (data.value && data.value.length) return data.value[0];
    const createRes = await outlookFetch('https://graph.microsoft.com/v1.0/me/drive/root/children', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name, folder: {}, '@microsoft.graph.conflictBehavior': 'rename' })
    });
    return await createRes.json();
}

async function ensureOutlookProjectFolder(project) {
    project.docs = project.docs || {};
    if (project.docs.outlookFolderId) return project.docs.outlookFolderId;
    const root = await ensureOutlookRootFolder();
    const safeName = sanitizeFilename((project.name || 'Project') + '_' + project.id).replace(/_/g, '-');
    const createRes = await outlookFetch('https://graph.microsoft.com/v1.0/me/drive/items/' + root.id + '/children', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: safeName, folder: {}, '@microsoft.graph.conflictBehavior': 'rename' })
    });
    const folder = await createRes.json();
    if (folder && folder.id) {
        project.docs.outlookFolderId = folder.id;
        project.docs.outlookFolderName = folder.name || safeName;
    }
    return project.docs.outlookFolderId;
}

async function uploadFileToDrive(folderId, file, fileName) {
    const sessionRes = await outlookFetch('https://graph.microsoft.com/v1.0/me/drive/items/' + folderId + ':/' + encodeURIComponent(fileName) + ':/createUploadSession', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item: { '@microsoft.graph.conflictBehavior': 'replace', name: fileName } })
    });
    const session = await sessionRes.json();
    if (!session.uploadUrl) throw new Error('Upload session failed');
    const uploadUrl = session.uploadUrl;
    const chunkSize = 320 * 1024 * 5;
    let start = 0;
    const total = file.size;
    while (start < total) {
        const end = Math.min(start + chunkSize, total) - 1;
        const slice = file.slice(start, end + 1);
        const res = await fetch(uploadUrl, {
            method: 'PUT',
            headers: {
                'Content-Length': slice.size,
                'Content-Range': 'bytes ' + start + '-' + end + '/' + total
            },
            body: slice
        });
        if (res.status === 202) {
            start = end + 1;
            continue;
        }
        if (res.ok) {
            return await res.json();
        }
        const errText = await res.text().catch(() => '');
        throw new Error('Upload failed: ' + errText);
    }
    throw new Error('Upload failed');
}

async function inviteDriveItem(itemId, emails) {
    if (!emails || !emails.length) return;
    await outlookFetch('https://graph.microsoft.com/v1.0/me/drive/items/' + itemId + '/invite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            recipients: emails.map(e => ({ email: e })),
            requireSignIn: true,
            sendInvitation: false,
            roles: ['read']
        })
    });
}

async function syncOutlookCalendar() {
    const outlookInt = getOutlookIntegration();
    if (!outlookInt || outlookInt.status !== 'connected') { toast('Outlook not connected'); return; }
    const ok = await ensureOutlookUploaderAccount();
    if (!ok) return;
    toast('Syncing calendar...');
    try {
        const now = new Date().toISOString();
        const future = new Date(Date.now()+30*24*60*60*1000).toISOString();
        const res = await outlookFetch('https://graph.microsoft.com/v1.0/me/calendarview?startDateTime='+now+'&endDateTime='+future+'&$top=50');
        const data = await res.json();
        if (data.value) { toast('Synced '+data.value.length+' events'); renderSettings(); }
    } catch(e) { toast('Sync error: '+e.message); }
}

async function disconnectOutlook() {
    if (!confirm('Disconnect Outlook Calendar?')) return;
    const outlookInt = getOutlookIntegration();
    if (outlookInt) {
        await sbUpdate('integrations', outlookInt.id, {status:'disconnected', access_token:'', refresh_token:''});
        outlookInt.status = 'disconnected'; outlookInt.access_token = '';
    }
    toast('Outlook disconnected'); renderSettings();
}

async function saveOutlookSettings() {
    const outlookInt = getOutlookIntegration();
    if (!outlookInt) return;
    const requiredUploaderEmail = (document.getElementById('outlook-uploader-email')?.value || '').trim();
    const warehouseEmails = (document.getElementById('outlook-warehouse-emails')?.value || '').trim();
    const shareWithTeam = !!document.getElementById('outlook-share-team')?.checked;
    const durationVal = parseFloat(document.getElementById('outlook-duration-hours')?.value || '8');
    const defaultDurationHours = Math.min(12, Math.max(1, isNaN(durationVal) ? 8 : durationVal));
    await saveOutlookConfig({ requiredUploaderEmail, warehouseEmails, shareWithTeam, defaultDurationHours });
    toast('Outlook settings saved');
    renderSettings();
}

async function toggleCameraIntegration(on) {
    const cam = getOrgIntegrations().find(i => i.type === 'camera');
    if (cam) { await sbUpdate('integrations', cam.id, {status:on?'connected':'disconnected'}); cam.status = on?'connected':'disconnected'; }
    else { try { const nid = await sbInsert('integrations', {type:'camera', status:on?'connected':'disconnected', config:'{}'}); if(nid) crmIntegrations.push(assignOrgId({id:nid, type:'camera', status:on?'connected':'disconnected'}, 'integrations')); } catch(e) {} }
    toast(on?'Camera enabled':'Camera disabled'); renderSettings();
}


function renderStaffTab() {
    const el = document.getElementById('settings-staff');
    if(!el) return;
    const orgPeople = getOrgPeople();
    const orgRoles = getOrgStaffRoles();
    const orgUsers = getOrgUsers();
    let h = '<div class="staff-header"><h3>Team Members</h3><button class="btn btn-primary" onclick="openAddStaffModal()">+ Add Staff</button></div><div class="settings-card" style="padding:0;overflow:hidden"><table class="staff-table"><thead><tr><th>Name</th><th>Role</th><th>Email</th><th>Phone</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
    orgPeople.forEach(p => {
        const user = orgUsers.find(u => u.person_id === p.id);
        const role = user ? orgRoles.find(r => r.id === user.role_id) : null;
        const roleName = role ? role.name : (p.role || 'Unassigned');
        const roleClass = getRoleClass(roleName);
        const isActive = user ? user.is_active !== false : true;
        h += '<tr><td><div style="display:flex;align-items:center;gap:8px"><div style="width:32px;height:32px;border-radius:50%;background:var(--blue-lt);color:var(--blue);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:12px">'+p.name.split(' ').map(n=>n[0]).join('')+'</div>'+p.name+'</div></td><td><span class="role-badge '+roleClass+'">'+roleName+'</span></td><td>'+(p.email||'\u2014')+'</td><td>'+(p.phone||'\u2014')+'</td><td><span style="color:'+(isActive?'var(--green)':'var(--muted)')+'">'+(isActive?'\u25CF Active':'\u25CB Inactive')+'</span></td><td><button class="btn btn-outline" style="padding:4px 10px;font-size:11px" onclick="editStaffMember('+p.id+')">Edit</button></td></tr>';
    });
    h += '</tbody></table></div>';

    h += '<div class="staff-header" style="margin-top:32px"><h3>Roles</h3><button class="btn btn-outline" onclick="openAddRoleModal()">+ New Role</button></div>';
    orgRoles.forEach(r => {
        const count = orgPeople.filter(p => (p.role||'').toLowerCase().includes(r.name.toLowerCase())).length;
        h += '<div class="role-card"><div><div class="role-name">'+r.name+'</div><div style="font-size:12px;color:var(--text2)">'+(r.description||'')+'</div></div><div style="display:flex;align-items:center;gap:12px"><span class="role-count">'+count+' member'+(count!==1?'s':'')+'</span><button class="btn btn-outline" style="padding:4px 10px;font-size:11px" onclick="editRole('+r.id+')">Edit</button></div></div>';
    });

    h += '<div class="staff-header" style="margin-top:32px"><h3>Permissions</h3><div style="display:flex;gap:8px"><select class="form-input" id="perm-role-select" style="width:200px" onchange="renderPermissionGrid()">'+orgRoles.map(r => '<option value="'+r.id+'">'+r.name+'</option>').join('')+'</select></div></div><div id="perm-grid-container"></div>';
    el.innerHTML = h;
    renderPermissionGrid();
}

function getRoleClass(name) {
    const n = (name||'').toLowerCase();
    if (n.includes('admin')) return 'role-admin';
    if (n.includes('lead')) return 'role-lead';
    if (n.includes('installer')) return 'role-installer';
    if (n.includes('driver')) return 'role-driver';
    if (n.includes('office')) return 'role-office';
    return 'role-installer';
}

function renderPermissionGrid() {
    const container = document.getElementById('perm-grid-container');
    if(!container) return;
    const sel = document.getElementById('perm-role-select');
    const orgRoles = getOrgStaffRoles();
    const orgPerms = getOrgStaffPermissions();
    const roleId = sel ? parseInt(sel.value) : (orgRoles[0] ? orgRoles[0].id : null);
    if (!roleId) { container.innerHTML = '<p style="color:var(--muted)">No roles defined.</p>'; return; }
    const sections = [{key:'receiving',icon:'\u{1F4E6}',label:'Receiving'},{key:'warehouse',icon:'\u{1F3ED}',label:'Warehouse'},{key:'dispatch',icon:'\u{1F69A}',label:'Dispatch'},{key:'calendar',icon:'\u{1F4C5}',label:'Calendar'},{key:'projects',icon:'\u{1F4C1}',label:'Projects'},{key:'people',icon:'\u{1F464}',label:'People'},{key:'clients',icon:'\u{1F3E2}',label:'Clients'},{key:'settings',icon:'\u2699\uFE0F',label:'Settings'}];
    const actions = ['view','create','edit','delete'];
    let g = '<table class="perm-grid"><thead><tr><th>Section</th>';
    actions.forEach(a => { g += '<th>'+a.charAt(0).toUpperCase()+a.slice(1)+'</th>'; });
    g += '</tr></thead><tbody>';
    sections.forEach(sec => {
        g += '<tr><td><span class="section-icon">'+sec.icon+'</span>'+sec.label+'</td>';
        actions.forEach(act => {
            const perm = orgPerms.find(p => p.role_id === roleId && p.section === sec.key && p.action === act);
            const checked = perm ? perm.allowed : false;
            g += '<td><input type="checkbox" class="perm-check" '+(checked?'checked':'')+' onchange="togglePermission('+roleId+',\''+sec.key+'\',\''+act+'\',this.checked)"></td>';
        });
        g += '</tr>';
    });
    g += '</tbody></table>';
    g += '<div style="margin-top:12px;display:flex;gap:8px"><button class="btn btn-outline" style="font-size:11px" onclick="quickAssignPerms('+roleId+',\'all\')">Full Access</button><button class="btn btn-outline" style="font-size:11px" onclick="quickAssignPerms('+roleId+',\'view\')">View Only</button><button class="btn btn-outline" style="font-size:11px" onclick="quickAssignPerms('+roleId+',\'field\')">Field Only</button><button class="btn btn-outline" style="font-size:11px" onclick="quickAssignPerms('+roleId+',\'none\')">No Access</button></div>';
    container.innerHTML = g;
}

async function togglePermission(roleId, section, action, allowed) {
    const existing = staffPermissions.find(p => p.role_id === roleId && p.section === section && p.action === action);
    if (existing) { await sbUpdate('staff_permissions', existing.id, {allowed}); existing.allowed = allowed; }
    else { try { const nid = await sbInsert('staff_permissions', {role_id:roleId, section, action, allowed}); if(nid) staffPermissions.push(assignOrgId({id:nid, role_id:roleId, section, action, allowed}, 'staff_permissions')); } catch(e) {} }
}

async function quickAssignPerms(roleId, preset) {
    const sections = ['receiving','warehouse','dispatch','calendar','projects','people','clients','settings'];
    const actions = ['view','create','edit','delete'];
    const fieldSections = ['receiving','warehouse','dispatch','projects'];
    for (const sec of sections) {
        for (const act of actions) {
            let allowed = false;
            if (preset === 'all') allowed = true;
            else if (preset === 'view') allowed = (act === 'view');
            else if (preset === 'field') allowed = fieldSections.includes(sec);
            await togglePermission(roleId, sec, act, allowed);
        }
    }
    renderPermissionGrid();
    toast('Permissions set to "'+preset+'"');
}


function openAddStaffModal() {
    const roleOpts = getOrgStaffRoles().map(r => '<option value="'+r.id+'">'+r.name+'</option>').join('');
    const modal = document.createElement('div');
    modal.className = 'modal open'; modal.id = 'modal-add-staff';
    modal.innerHTML = '<div class="modal-content" style="max-width:480px"><div class="modal-header"><h3>Add Staff Member</h3><button class="modal-close" onclick="this.closest(\'.modal\').remove()">\u2715</button></div><div class="modal-body" style="padding:20px"><div class="form-group"><label class="form-label">Full Name</label><input type="text" class="form-input" id="staff-name"></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="staff-email"></div><div class="form-group"><label class="form-label">Phone</label><input type="text" class="form-input" id="staff-phone"></div><div class="form-group"><label class="form-label">Role</label><select class="form-input" id="staff-role">'+roleOpts+'</select></div><div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-primary" onclick="saveNewStaff()">Add Member</button><button class="btn btn-outline" onclick="this.closest(\'.modal\').remove()">Cancel</button></div></div></div>';
    document.body.appendChild(modal);
}

async function saveNewStaff() {
    const name = document.getElementById('staff-name').value.trim();
    const email = document.getElementById('staff-email').value.trim();
    const phone = document.getElementById('staff-phone').value.trim();
    const roleId = parseInt(document.getElementById('staff-role').value);
    if (!name) { toast('Name is required'); return; }
    const role = getOrgStaffRoles().find(r => r.id === roleId);
    const roleName = role ? role.name : '';
    const personId = await sbInsert('people', {name, email, phone, role: roleName});
    if (personId) {
        people.push(assignOrgId({id:personId, name, email, phone, role:roleName}, 'people'));
        try { const uid = await sbInsert('users', {person_id:personId, role_id:roleId, email, is_active:true}); if(uid) crmUsers.push(assignOrgId({id:uid, person_id:personId, role_id:roleId, email, is_active:true}, 'users')); } catch(e) {}
    }
    document.getElementById('modal-add-staff').remove();
    renderSettings(); renderPeople();
    toast(name+' added to team');
}

function editStaffMember(personId) {
    const p = getOrgPeople().find(x => x.id === personId);
    if (!p) return;
    const user = getOrgUsers().find(u => u.person_id === personId);
    const currentRoleId = user ? user.role_id : '';
    const roleOpts = getOrgStaffRoles().map(r => '<option value="'+r.id+'" '+(r.id===currentRoleId?'selected':'')+'>'+r.name+'</option>').join('');
    const modal = document.createElement('div');
    modal.className = 'modal open'; modal.id = 'modal-edit-staff';
    modal.innerHTML = '<div class="modal-content" style="max-width:480px"><div class="modal-header"><h3>Edit Staff \u2014 '+p.name+'</h3><button class="modal-close" onclick="this.closest(\'.modal\').remove()">\u2715</button></div><div class="modal-body" style="padding:20px"><div class="form-group"><label class="form-label">Full Name</label><input type="text" class="form-input" id="edit-staff-name" value="'+p.name+'"></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="edit-staff-email" value="'+(p.email||'')+'"></div><div class="form-group"><label class="form-label">Phone</label><input type="text" class="form-input" id="edit-staff-phone" value="'+(p.phone||'')+'"></div><div class="form-group"><label class="form-label">Role</label><select class="form-input" id="edit-staff-role">'+roleOpts+'</select></div><div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-primary" onclick="saveEditStaff('+personId+')">Save Changes</button><button class="btn btn-outline" style="color:var(--red);border-color:var(--red)" onclick="deactivateStaff('+personId+')">Deactivate</button><button class="btn btn-outline" onclick="this.closest(\'.modal\').remove()">Cancel</button></div></div></div>';
    document.body.appendChild(modal);
}

async function saveEditStaff(personId) {
    const name = document.getElementById('edit-staff-name').value.trim();
    const email = document.getElementById('edit-staff-email').value.trim();
    const phone = document.getElementById('edit-staff-phone').value.trim();
    const roleId = parseInt(document.getElementById('edit-staff-role').value);
    if (!name) { toast('Name is required'); return; }
    const role = getOrgStaffRoles().find(r => r.id === roleId);
    const roleName = role ? role.name : '';
    await sbUpdate('people', personId, {name, email, phone, role:roleName});
    const p = getOrgPeople().find(x => x.id === personId);
    if (p) { p.name=name; p.email=email; p.phone=phone; p.role=roleName; }
    const user = getOrgUsers().find(u => u.person_id === personId);
    if (user) { await sbUpdate('users', user.id, {role_id:roleId, email}); user.role_id=roleId; user.email=email; }
    else { try { const uid = await sbInsert('users', {person_id:personId, role_id:roleId, email, is_active:true}); if(uid) crmUsers.push(assignOrgId({id:uid, person_id:personId, role_id:roleId, email, is_active:true}, 'users')); } catch(e) {} }
    document.getElementById('modal-edit-staff').remove();
    renderSettings(); renderPeople();
    toast(name+' updated');
}

async function deactivateStaff(personId) {
    if (!confirm('Deactivate this staff member?')) return;
    const user = getOrgUsers().find(u => u.person_id === personId);
    if (user) { await sbUpdate('users', user.id, {is_active:false}); user.is_active=false; }
    const modal = document.getElementById('modal-edit-staff');
    if(modal) modal.remove();
    renderSettings(); toast('Staff member deactivated');
}


function openAddRoleModal() {
    const modal = document.createElement('div');
    modal.className = 'modal open'; modal.id = 'modal-add-role';
    modal.innerHTML = '<div class="modal-content" style="max-width:400px"><div class="modal-header"><h3>New Role</h3><button class="modal-close" onclick="this.closest(\'.modal\').remove()">\u2715</button></div><div class="modal-body" style="padding:20px"><div class="form-group"><label class="form-label">Role Name</label><input type="text" class="form-input" id="new-role-name" placeholder="e.g. Project Manager"></div><div class="form-group"><label class="form-label">Description</label><input type="text" class="form-input" id="new-role-desc" placeholder="Brief description"></div><div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-primary" onclick="saveNewRole()">Create Role</button><button class="btn btn-outline" onclick="this.closest(\'.modal\').remove()">Cancel</button></div></div></div>';
    document.body.appendChild(modal);
}

async function saveNewRole() {
    const name = document.getElementById('new-role-name').value.trim();
    const desc = document.getElementById('new-role-desc').value.trim();
    if (!name) { toast('Role name is required'); return; }
    try { const nid = await sbInsert('staff_roles', {name, description:desc, is_default:false}); if(nid) staffRoles.push(assignOrgId({id:nid, name, description:desc, is_default:false}, 'staff_roles')); } catch(e) { toast('Error creating role'); return; }
    document.getElementById('modal-add-role').remove();
    renderSettings(); toast('Role "'+name+'" created');
}

function editRole(roleId) {
    const r = getOrgStaffRoles().find(x => x.id === roleId);
    if (!r) return;
    const modal = document.createElement('div');
    modal.className = 'modal open'; modal.id = 'modal-edit-role';
    modal.innerHTML = '<div class="modal-content" style="max-width:400px"><div class="modal-header"><h3>Edit Role</h3><button class="modal-close" onclick="this.closest(\'.modal\').remove()">\u2715</button></div><div class="modal-body" style="padding:20px"><div class="form-group"><label class="form-label">Role Name</label><input type="text" class="form-input" id="edit-role-name" value="'+r.name+'"></div><div class="form-group"><label class="form-label">Description</label><input type="text" class="form-input" id="edit-role-desc" value="'+(r.description||'')+'"></div><div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-primary" onclick="saveEditRole('+roleId+')">Save</button>'+(!r.is_default?'<button class="btn btn-outline" style="color:var(--red);border-color:var(--red)" onclick="deleteRole('+roleId+')">Delete</button>':'')+'<button class="btn btn-outline" onclick="this.closest(\'.modal\').remove()">Cancel</button></div></div></div>';
    document.body.appendChild(modal);
}

async function saveEditRole(roleId) {
    const name = document.getElementById('edit-role-name').value.trim();
    const desc = document.getElementById('edit-role-desc').value.trim();
    if (!name) { toast('Role name is required'); return; }
    await sbUpdate('staff_roles', roleId, {name, description:desc});
    const r = staffRoles.find(x => x.id === roleId);
    if(r) { r.name=name; r.description=desc; }
    document.getElementById('modal-edit-role').remove();
    renderSettings(); toast('Role "'+name+'" updated');
}

async function deleteRole(roleId) {
    if (!confirm('Delete this role?')) return;
    const perms = staffPermissions.filter(p => p.role_id === roleId);
    for (const p of perms) { try { await sbDelete('staff_permissions', p.id); } catch(e) {} }
    staffPermissions = staffPermissions.filter(p => p.role_id !== roleId);
    try { await sbDelete('staff_roles', roleId); } catch(e) {}
    staffRoles = staffRoles.filter(r => r.id !== roleId);
    document.getElementById('modal-edit-role').remove();
    renderSettings(); toast('Role deleted');
}

function hasPermission(section, action) {
    if (!currentUserId) return true;
    const user = getOrgUsers().find(u => u.person_id === currentUserId);
    if (!user) return true;
    const role = getOrgStaffRoles().find(r => r.id === user.role_id);
    if (role && role.name === 'Admin') return true;
    const perm = getOrgStaffPermissions().find(p => p.role_id === user.role_id && p.section === section && p.action === action);
    return perm ? perm.allowed : false;
}

function renderSystemTab() {
    const el = document.getElementById('settings-system');
    if(!el) return;
    const org = getActiveOrg();
    const orgName = org ? getOrgDisplayName(org) : 'Company';
    el.innerHTML = '<div class="settings-card"><h3 style="margin-bottom:16px">Company Information</h3><div class="form-group"><label class="form-label">Company Name</label><input type="text" class="form-input" id="sys-company" value="'+escapeHtml(orgName)+'" style="max-width:400px"></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="sys-email" value="ismael@vectorinstallations.com" style="max-width:400px"></div><button class="btn btn-primary" style="margin-top:8px" onclick="toast(\'Company info saved\')">Save</button></div><div class="settings-card"><h3 style="margin-bottom:16px">Data Management</h3><div class="system-item"><div><div class="sys-label">Export All Data</div><div class="sys-desc">Download all CRM data as a JSON file for backup</div></div><button class="btn btn-outline" onclick="exportAllData()">Export JSON</button></div><div class="system-item"><div><div class="sys-label">Clear Local Cache</div><div class="sys-desc">Remove cached data from browser. Data is preserved in Supabase.</div></div><button class="btn btn-outline" onclick="clearLocalCache()">Clear Cache</button></div><div class="system-item"><div><div class="sys-label">Database Status</div><div class="sys-desc">Connected to Supabase \u2022 '+getOrgClients().length+' clients, '+getOrgPeople().length+' people, '+getOrgProjects().length+' projects, '+getOrgShipments().length+' shipments</div></div><span class="badge badge-connected">Online</span></div></div><div class="settings-card"><h3 style="margin-bottom:16px">About</h3><div style="font-size:13px;color:var(--text2)"><p><strong>Vector CRM</strong> v16</p><p style="margin-top:4px">Built for '+escapeHtml(orgName)+'.</p></div></div>';
}

function exportAllData() {
    const data = {orgs, activeOrgId, clients, people, projects, scans, shipments, punchlist, dispatches, loadingSheets, projectCompletions, moveChecklists, moveItems, jobsiteReadiness, timeEntries, projectUpdates, changeOrders, surveys, surveyRooms, surveyItems, quotes, quoteItems, moveMilestones, moveAccess, moveLabels, moveMaterials, staffRoles, staffPermissions, crmUsers, crmIntegrations};
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'vector-crm-backup-'+new Date().toISOString().split('T')[0]+'.json';
    a.click(); URL.revokeObjectURL(url);
    toast('Data exported');
}

function clearLocalCache() {
    if (!confirm('Clear all cached data?')) return;
    Object.keys(localStorage).filter(k => k.startsWith('v10_')).forEach(k => localStorage.removeItem(k));
    toast('Local cache cleared');
}


/* ====================== CLIENT PORTAL ====================== */
let portalClient = null;

function initPortal() {
    if (window.location.search.includes('portal')) {
        document.querySelector('.app').style.display = 'none';
        document.getElementById('portal-overlay').classList.add('active');
        // Check if already logged in via sessionStorage
        const saved = sessionStorage.getItem('portalClient');
        if (saved) {
            portalClient = JSON.parse(saved);
            showPortalDashboard();
        }
    }
}

async function portalLogin() {
    const email = document.getElementById('portal-email').value.trim().toLowerCase();
    const code = document.getElementById('portal-code').value.trim();
    const errEl = document.getElementById('portal-error');
    errEl.style.display = 'none';
    if (!email || !code) { errEl.textContent = 'Please enter both email and access code'; errEl.style.display = 'block'; return; }
    const normalizePortalCode = (client) => client.portal_code || client.company.toLowerCase().replace(/\s+/g, '');
    // Look up client by email
    try {
        const r = await fetch(SB + '/rest/v1/clients?email=eq.' + encodeURIComponent(email) + '&select=*', { headers: { apikey: SK, Authorization: 'Bearer ' + SK } });
        const data = await r.json();
        if (data && data.length) {
            const client = data[0];
            const validCode = normalizePortalCode(client);
            if (code !== validCode) { errEl.textContent = 'Invalid access code'; errEl.style.display = 'block'; return; }
            portalClient = { id: client.id, company: client.company, email: client.email, role: 'client', clientIds: [client.id] };
            sessionStorage.setItem('portalClient', JSON.stringify(portalClient));
            showPortalDashboard();
            return;
        }
        // If not a client email, check project-level PM access
        const pmProjectsRes = await fetch(SB + '/rest/v1/projects?select=id,client_id,pm_emails,project_manager', { headers: { apikey: SK, Authorization: 'Bearer ' + SK } });
        const pmProjects = await pmProjectsRes.json();
        const allowedProjects = (pmProjects || []).filter(p => getProjectPmEmails(p).includes(email));
        if (!allowedProjects.length) { errEl.textContent = 'No account found with that email'; errEl.style.display = 'block'; return; }
        const clientIds = Array.from(new Set(allowedProjects.map(p => p.client_id)));
        const cRes = await fetch(SB + '/rest/v1/clients?id=in.(' + clientIds.join(',') + ')&select=*', { headers: { apikey: SK, Authorization: 'Bearer ' + SK } });
        const pmClients = await cRes.json();
        const codes = (pmClients || []).map(normalizePortalCode);
        if (!codes.includes(code)) { errEl.textContent = 'Invalid access code'; errEl.style.display = 'block'; return; }
        const projectIds = allowedProjects.map(p => p.id);
        portalClient = { id: clientIds[0], company: 'Project Manager', email, role: 'pm', clientIds, projectIds };
        sessionStorage.setItem('portalClient', JSON.stringify(portalClient));
        showPortalDashboard();
    } catch(e) { errEl.textContent = 'Connection error. Please try again.'; errEl.style.display = 'block'; console.error(e); }
}

async function showPortalDashboard() {
    document.getElementById('portal-login').style.display = 'none';
    document.getElementById('portal-overlay').classList.remove('active');
    document.getElementById('portal-dash').classList.add('active');
    document.getElementById('portal-company').textContent = portalClient.company;
    const clientIds = portalClient.clientIds || [portalClient.id];
    const allowedProjectIds = portalClient.role === 'pm' ? (portalClient.projectIds || []) : null;
    const clientIdQuery = clientIds.length > 1 ? 'in.(' + clientIds.join(',') + ')' : ('eq.' + clientIds[0]);
    // Fetch projects for this client(s)
    const pRes = await fetch(SB + '/rest/v1/projects?client_id=' + clientIdQuery + '&select=*', { headers: { apikey: SK, Authorization: 'Bearer ' + SK } });
    let clientProjects = await pRes.json();
    // Fetch shipments for this client(s)
    const sRes = await fetch(SB + '/rest/v1/shipments?client_id=' + clientIdQuery + '&select=*', { headers: { apikey: SK, Authorization: 'Bearer ' + SK } });
    let clientShipments = await sRes.json();
    if (allowedProjectIds && allowedProjectIds.length) {
        clientProjects = clientProjects.filter(p => allowedProjectIds.includes(p.id));
        clientShipments = clientShipments.filter(s => allowedProjectIds.includes(s.project_id));
    }
    // Fetch project updates for this client's projects
    const projIds = (clientProjects || []).map(p => p.id);
    let clientUpdates = [];
    if (projIds.length) {
        try {
            const uRes = await fetch(SB + '/rest/v1/project_updates?project_id=in.(' + projIds.join(',') + ')&select=*', { headers: { apikey: SK, Authorization: 'Bearer ' + SK } });
            clientUpdates = await uRes.json();
        } catch(e) { clientUpdates = []; }
    }
    // Calculate stats
    const totalShipments = clientShipments.length;
    const received = clientShipments.filter(s => s.status === 'received').length;
    const inWarehouse = clientShipments.filter(s => s.inventory_status === 'in-warehouse').length;
    const dispatched = clientShipments.filter(s => s.inventory_status === 'dispatched').length;
    const delivered = clientShipments.filter(s => s.inventory_status === 'delivered').length;
    let html = '';
    // Stats bar
    html += '<div class="portal-stats">';
    html += '<div class="portal-stat"><div class="num">' + clientProjects.length + '</div><div class="label">Projects</div></div>';
    html += '<div class="portal-stat"><div class="num">' + totalShipments + '</div><div class="label">Total Shipments</div></div>';
    html += '<div class="portal-stat"><div class="num">' + inWarehouse + '</div><div class="label">In Warehouse</div></div>';
    html += '<div class="portal-stat"><div class="num">' + dispatched + '</div><div class="label">Dispatched</div></div>';
    html += '<div class="portal-stat"><div class="num">' + delivered + '</div><div class="label">At Jobsite</div></div>';
    html += '</div>';
    // Projects section
    html += '<div class="portal-section"><h3>Your Projects</h3>';
    if (clientProjects.length === 0) {
        html += '<p style="color:var(--text2)">No projects found.</p>';
    } else {
        clientProjects.forEach(p => {
            const projShipments = clientShipments.filter(s => s.project_id === p.id);
            const projReceived = projShipments.filter(s => s.status === 'received').length;
            const latestUpdate = clientUpdates.filter(u => u.project_id === p.id).sort((a,b)=>new Date(b.created_at)-new Date(a.created_at))[0];
            const statusLabel = getProjectStatusLabel(p, p.status);
            html += '<div class="portal-project-card" onclick="portalShowProject(' + p.id + ')">';
            html += '<h4>' + (p.name || 'Unnamed Project') + '</h4>';
            html += '<div class="meta">';
            if (p.install_date) html += '<span>Install: ' + p.install_date + '</span>';
            if (p.location) html += '<span>Location: ' + p.location + '</span>';
            html += '<span>Status: ' + statusLabel + '</span>';
            html += '<span>Shipments: ' + projReceived + '/' + projShipments.length + ' received</span>';
            html += '</div></div>';
            if (latestUpdate && latestUpdate.message) {
                html += '<div style="margin:-6px 0 12px 0;font-size:12px;color:var(--text2)">Latest update: ' + latestUpdate.message + '</div>';
            }
        });
    }
    html += '</div>';
    // All shipments table
    html += '<div class="portal-section"><h3>Warehouse Inventory</h3>';
    if (clientShipments.length === 0) {
        html += '<p style="color:var(--text2)">No shipments found.</p>';
    } else {
        html += '<table class="portal-shipment-table"><thead><tr>';
        html += '<th>PO</th><th>Item</th><th>Manufacturer</th><th>Location</th><th>Status</th><th>Received</th>';
        html += '</tr></thead><tbody>';
        clientShipments.forEach(s => {
            const inv = s.inventory_status || '';
            const statusClass = inv === 'delivered' ? 'status-received' : (s.status === 'received' ? 'status-received' : 'status-not-received');
            const statusText = inv === 'delivered' ? 'At Jobsite' : (s.status === 'received' ? 'Received' : 'Pending');
            const invText = inv === 'dispatched' ? ' (Dispatched)' : inv === 'delivered' ? '' : '';
            const loc = s.sortly || s.location || (inv === 'delivered' ? 'Jobsite' : '');
            html += '<tr>';
            html += '<td><strong>' + (s.po || '') + '</strong></td>';
            html += '<td>' + (s.subitem || '') + '</td>';
            html += '<td>' + (s.mfr || '') + '</td>';
            html += '<td>' + loc + '</td>';
            html += '<td><span class="status ' + statusClass + '">' + statusText + invText + '</span></td>';
            html += '<td>' + (s.received_date || '') + '</td>';
            html += '</tr>';
        });
        html += '</tbody></table>';
    }
    html += '</div>';
    document.getElementById('portal-body').innerHTML = html;
}

async function portalShowProject(projId) {
    if (portalClient?.role === 'pm' && Array.isArray(portalClient.projectIds) && !portalClient.projectIds.includes(projId)) {
        document.getElementById('portal-body').innerHTML = '<div style="padding:20px;color:var(--muted)">Access denied for this project.</div>';
        return;
    }
    const clientIds = portalClient.clientIds || [portalClient.id];
    const clientIdQuery = clientIds.length > 1 ? 'in.(' + clientIds.join(',') + ')' : ('eq.' + clientIds[0]);
    const sRes = await fetch(SB + '/rest/v1/shipments?client_id=' + clientIdQuery + '&project_id=eq.' + projId + '&select=*', { headers: { apikey: SK, Authorization: 'Bearer ' + SK } });
    const projShipments = await sRes.json();
    const pRes = await fetch(SB + '/rest/v1/projects?id=eq.' + projId + '&select=*', { headers: { apikey: SK, Authorization: 'Bearer ' + SK } });
    const projData = await pRes.json();
    const proj = projData[0];
    let updates = [];
    let milestoneData = [];
    let docs = {};
    try {
        const uRes = await fetch(SB + '/rest/v1/project_updates?project_id=eq.' + projId + '&select=*', { headers: { apikey: SK, Authorization: 'Bearer ' + SK } });
        updates = await uRes.json();
    } catch(e) { updates = []; }
    try {
        const mRes = await fetch(SB + '/rest/v1/move_milestones?project_id=eq.' + projId + '&select=*', { headers: { apikey: SK, Authorization: 'Bearer ' + SK } });
        milestoneData = await mRes.json();
    } catch(e) { milestoneData = []; }
    let html = '<div style="margin-bottom:16px"><button class="btn btn-outline" onclick="showPortalDashboard()">Back to Dashboard</button></div>';
    html += '<div class="portal-section"><h3>' + (proj?.name || 'Project') + '</h3>';
    if (proj?.location) html += '<p style="color:var(--text2);margin-bottom:8px">Location: ' + proj.location + '</p>';
    if (proj?.install_date) html += '<p style="color:var(--text2);margin-bottom:16px">Install Date: ' + proj.install_date + (proj.install_time ? ' at ' + proj.install_time : '') + '</p>';
    if (proj?.status) html += '<p style="color:var(--text2);margin-bottom:16px">Status: ' + getProjectStatusLabel(proj, proj.status) + '</p>';
    try { docs = proj?.docs ? (typeof proj.docs === 'string' ? JSON.parse(proj.docs) : proj.docs) : {}; } catch(e) { docs = {}; }
    const received = projShipments.filter(s => s.status === 'received').length;
    html += '<div class="portal-stats">';
    html += '<div class="portal-stat"><div class="num">' + projShipments.length + '</div><div class="label">Total Items</div></div>';
    html += '<div class="portal-stat"><div class="num">' + received + '</div><div class="label">Received</div></div>';
    html += '<div class="portal-stat"><div class="num">' + (projShipments.length - received) + '</div><div class="label">Pending</div></div>';
    html += '</div>';
    if (projShipments.length > 0) {
        // Group by PO
        const pos = {};
        projShipments.forEach(s => { if (!pos[s.po]) pos[s.po] = []; pos[s.po].push(s); });
        Object.keys(pos).forEach(po => {
            html += '<h4 style="margin:16px 0 8px;font-size:14px;color:var(--text2)">PO: ' + po + '</h4>';
            html += '<table class="portal-shipment-table"><thead><tr><th>Item</th><th>Manufacturer</th><th>Location</th><th>Status</th><th>Received</th></tr></thead><tbody>';
            pos[po].forEach(s => {
                const inv = s.inventory_status || '';
                const sc = inv === 'delivered' ? 'status-received' : (s.status === 'received' ? 'status-received' : 'status-not-received');
                const invText = inv === 'dispatched' ? ' (Dispatched)' : '';
                const statusText = inv === 'delivered' ? 'At Jobsite' : (s.status==='received'?'Received':'Pending');
                const loc = s.sortly || s.location || (inv === 'delivered' ? 'Jobsite' : '');
                html += '<tr><td>' + (s.subitem||'') + '</td><td>' + (s.mfr||'') + '</td><td>' + loc + '</td><td><span class="status ' + sc + '">' + statusText + invText + '</span></td><td>' + (s.received_date||'') + '</td></tr>';
            });
            html += '</tbody></table>';
        });
    } else {
        html += '<p style="color:var(--text2)">No shipments for this project yet.</p>';
    }
    if (docs && Object.keys(docs).length) {
        const docDefs = [
            { k: 'workOrder', n: 'Work Order' },
            { k: 'deliveryReceipt', n: 'Delivery Receipt' },
            { k: 'drawing', n: 'Drawing' },
            { k: 'moveGuide', n: 'Move Guide' },
            { k: 'coi', n: 'COI' },
            { k: 'beforePlan', n: 'Before Prints' },
            { k: 'afterPlan', n: 'After Prints' },
            { k: 'floorPlan', n: 'Floor Plan' },
            { k: 'zoneMap', n: 'Zone Map' },
            { k: 'destinationMap', n: 'Destination Map' }
        ];
        const links = docDefs.map(d => {
            const entry = normalizeDocEntry(docs[d.k]);
            return entry && entry.url ? '<div><a href="' + entry.url + '" target="_blank" rel="noopener">' + d.n + '</a></div>' : '';
        }).filter(Boolean).join('');
        if (links) {
            html += '<div class="portal-section"><h3>Project Documents</h3>' + links + '</div>';
        }
    }
    if (updates && updates.length) {
        updates.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
        html += '<div class="portal-section"><h3>Updates</h3>';
        updates.forEach(u => {
            html += '<div class="portal-project-card" style="cursor:default">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center"><strong>' + getProjectStatusLabel(proj, u.status) + '</strong><span style="font-size:12px;color:var(--muted)">' + (u.created_at ? new Date(u.created_at).toLocaleString() : '') + '</span></div>';
            html += '<div style="font-size:13px;color:var(--text2);margin-top:6px">' + (u.message || '') + '</div>';
            html += '</div>';
        });
        html += '</div>';
    }
    if (milestoneData && milestoneData.length) {
        html += '<div class="portal-section"><h3>Move Milestones</h3>';
        milestoneData.forEach(m => {
            html += '<div class="portal-project-card" style="cursor:default">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center"><strong>' + (m.stage || 'Milestone') + '</strong><span style="font-size:12px;color:var(--muted)">' + (m.status || 'pending') + '</span></div>';
            if (m.due_date) html += '<div style="font-size:12px;color:var(--text2);margin-top:4px">Due: ' + m.due_date + '</div>';
            html += '</div>';
        });
        html += '</div>';
    }
    html += '</div>';
    document.getElementById('portal-body').innerHTML = html;
}

function portalLogout() {
    sessionStorage.removeItem('portalClient');
    portalClient = null;
    document.getElementById('portal-dash').classList.remove('active');
    document.getElementById('portal-overlay').classList.add('active');
    document.getElementById('portal-login').style.display = '';
    document.getElementById('portal-email').value = '';
    document.getElementById('portal-code').value = '';
}

// Initialize portal check on page load
document.addEventListener('DOMContentLoaded', () => { initPortal(); });
</script>

<script>
// ========== AUTH SYSTEM ==========
const _supabaseAuth = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});
let _manualSignOut = false;
let _lastAuthAt = 0;
const AUTH_GRACE_MS = 120000;
const AUTH_RETRY_MS = 1500;
let authPendingToken = false;
let _authHandling = false;   // re-entrancy guard for handleAuthSession
let _authRestoring = false;  // prevent restore  SIGNED_IN  restore loop
let _authInitRunning = false;
let _authListenerAttached = false;
let _authKeepAliveStarted = false;
const _authWait = (ms) => new Promise(r => setTimeout(r, ms));
const isAbortError = (err) => err && (err.name === 'AbortError' || /aborted/i.test(err.message));
const ALT_AUTH_KEY = 'vector_auth';
const hasLocalAuth = () => !!_authAccessToken || !!getStoredAuth();
const getHashTokens = () => {
    try {
        if (!window.location.hash) return null;
        const params = new URLSearchParams(window.location.hash.replace(/^#/, ''));
        const access_token = params.get('access_token');
        const refresh_token = params.get('refresh_token');
        const expires_in = parseInt(params.get('expires_in') || '0', 10);
        if (!access_token) return null;
        return { access_token, refresh_token, expires_in };
    } catch(e) { return null; }
};
const decodeJwtPayload = (token) => {
    try {
        const parts = token.split('.');
        if (!parts[1]) return null;
        let b64 = parts[1].replace(/-/g, '+').replace(/_/g, '/');
        const pad = b64.length % 4;
        if (pad) b64 += '='.repeat(4 - pad);
        return JSON.parse(atob(b64));
    } catch(e) { return null; }
};
const isTokenExpired = (token, skewMs = 30000) => {
    const p = decodeJwtPayload(token);
    if (!p || !p.exp) return false;
    return Date.now() > (p.exp * 1000 - skewMs);
};
function getStoredAuth() {
    try {
        const alt = localStorage.getItem(ALT_AUTH_KEY);
        if (alt) {
            const parsed = JSON.parse(alt);
            if (parsed && parsed.access_token && parsed.refresh_token) return parsed;
        }
        const key = `sb-${SUPABASE_REF}-auth-token`;
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : null;
    } catch (e) { return null; }
}
async function safeGetSession() {
    try {
        return await _supabaseAuth.auth.getSession();
    } catch (err) {
        if (isAbortError(err)) {
            console.warn('[AUTH] getSession aborted (safe to ignore)');
            return { data: { session: null }, error: err };
        }
        console.error('[AUTH] getSession error:', err);
        return { data: { session: null }, error: err };
    }
}
async function manualRefreshSession() {
    try {
        const stored = getStoredAuth();
        const refreshToken = stored && stored.refresh_token ? stored.refresh_token : null;
        if (!refreshToken) return null;
        const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=refresh_token`, {
            method: 'POST',
            headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
            body: JSON.stringify({ refresh_token: refreshToken })
        });
        if (!res.ok) {
            const txt = await res.text().catch(() => '');
            console.warn('[AUTH] manual refresh failed:', res.status, txt);
            return null;
        }
        const data = await res.json();
        if (data && data.access_token) {
            _authAccessToken = data.access_token;
            const expires_at = data.expires_at || (data.expires_in ? Math.floor(Date.now()/1000) + data.expires_in : null);
            localStorage.setItem(ALT_AUTH_KEY, JSON.stringify({
                access_token: data.access_token,
                refresh_token: data.refresh_token || refreshToken,
                expires_at
            }));
            return data;
        }
    } catch (err) {
        if (isAbortError(err)) console.warn('[AUTH] manual refresh aborted (safe to ignore)');
        else console.error('[AUTH] manual refresh error:', err);
    }
    return null;
}
async function ensureAccessToken() {
    if (_authAccessToken && !isTokenExpired(_authAccessToken)) return true;
    const stored = getStoredAuth();
    if (stored && stored.access_token && !isTokenExpired(stored.access_token)) {
        _authAccessToken = stored.access_token;
        return true;
    }
    const manual = await manualRefreshSession();
    if (manual && manual.access_token) return true;
    const supa = await tryRefreshSession();
    return !!supa;
}
async function applyHashSessionIfPresent() {
    const tokens = getHashTokens();
    if (!tokens || !tokens.access_token) return false;
    try {
        _authAccessToken = tokens.access_token;
        // Store minimal session locally so we can refresh later even if supabase auth storage fails
        const expires_at = tokens.expires_in ? Math.floor(Date.now()/1000) + tokens.expires_in : null;
        localStorage.setItem(ALT_AUTH_KEY, JSON.stringify({
            access_token: tokens.access_token,
            refresh_token: tokens.refresh_token || '',
            expires_at
        }));
        if (tokens.refresh_token) {
            await _supabaseAuth.auth.setSession({
                access_token: tokens.access_token,
                refresh_token: tokens.refresh_token
            });
        }
        // Remove hash ASAP to prevent reprocessing
        history.replaceState({}, '', window.location.pathname + window.location.search);
        return true;
    } catch (err) {
        if (isAbortError(err)) {
            console.warn('[AUTH] applyHashSession aborted (safe to ignore)');
            return true; // We still set _authAccessToken for REST calls
        }
        console.error('[AUTH] applyHashSession error:', err);
        return false;
    }
}
async function tryRefreshSession() {
    try {
        const { data, error } = await _supabaseAuth.auth.refreshSession();
        if (error) {
            console.warn('[AUTH] refreshSession error:', error.message || error);
            // fallback to manual refresh
            return await manualRefreshSession();
        }
        if (data && data.session) {
            _authAccessToken = data.session.access_token;
            _lastAuthAt = Date.now();
            // persist a fallback auth token
            try {
                localStorage.setItem(ALT_AUTH_KEY, JSON.stringify({
                    access_token: data.session.access_token,
                    refresh_token: data.session.refresh_token || '',
                    expires_at: data.session.expires_at || null
                }));
            } catch(e) {}
            return data.session;
        }
    } catch (err) {
        if (isAbortError(err)) {
            console.warn('[AUTH] refreshSession aborted (safe to ignore)');
            return await manualRefreshSession();
        } else {
            console.error('[AUTH] refreshSession error:', err);
        }
    }
    return null;
}
async function restoreSessionIfPossible() {
    if (_authRestoring) return false;
    _authRestoring = true;
    try {
        const stored = getStoredAuth();
        if (stored && stored.access_token && stored.refresh_token) {
            if (isTokenExpired(stored.access_token)) {
                const refreshed = await tryRefreshSession();
                if (refreshed) {
                    hideLoginScreen();
                    return true;
                }
            } else {
                await _supabaseAuth.auth.setSession({ access_token: stored.access_token, refresh_token: stored.refresh_token });
            }
            const { data: { session } } = await safeGetSession();
            if (session) {
                _authAccessToken = session.access_token;
                _lastAuthAt = Date.now();
                hideLoginScreen();
                return true;
            }
        }
        return false;
    } catch (e) {
        if (isAbortError(e)) {
            console.warn('[AUTH] restore aborted (safe to ignore)');
        }
        return false;
    }
    finally { _authRestoring = false; }
}

function showLoginScreen(force = false) {
    if (!force && hasLocalAuth()) {
        hideLoginScreen();
        return;
    }
    document.getElementById('auth-overlay').style.display = 'flex';
    document.getElementById('auth-loading').style.display = 'none';
    document.getElementById('auth-error').style.display = 'none';
}

function hideLoginScreen() {
    document.getElementById('auth-overlay').style.display = 'none';
}

function showAuthError(msg) {
    var el = document.getElementById('auth-error');
    el.textContent = msg;
    el.style.display = 'block';
    document.getElementById('auth-loading').style.display = 'none';
}

async function signInWithGoogle() {
    document.getElementById('auth-loading').style.display = 'block';
    document.getElementById('auth-error').style.display = 'none';
    var { error } = await _supabaseAuth.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: window.location.origin }
    });
    if (error) showAuthError(error.message);
}

async function signInWithMicrosoft() {
    document.getElementById('auth-loading').style.display = 'block';
    document.getElementById('auth-error').style.display = 'none';
    var { error } = await _supabaseAuth.auth.signInWithOAuth({
        provider: 'azure',
        options: {
            redirectTo: window.location.origin,
            scopes: 'openid email profile'
        }
    });
    if (error) showAuthError(error.message);
}

async function signOutUser() {
    _manualSignOut = true;
    await _supabaseAuth.auth.signOut();
    _authAccessToken = null;
    _currentUser = null;
    try { localStorage.removeItem(ALT_AUTH_KEY); } catch(e){}
    showLoginScreen(true);
    _manualSignOut = false;
}

async function handleAuthSession(session) {
    if (!session) {
        if (hasLocalAuth()) { hideLoginScreen(); return; }
        showLoginScreen();
        return;
    }
    if (_authHandling) {
        // Still update the token even if we skip the full flow
        _authAccessToken = session.access_token;
        return;
    }
    _authHandling = true;

    try {
        console.log('[AUTH] handleAuthSession for:', session.user.email);
        _authAccessToken = session.access_token;
        _lastAuthAt = Date.now();
        // Clean auth hash from URL  but only AFTER session is confirmed
        if (window.location.hash && window.location.hash.includes('access_token')) {
            var { data: { session: confirmSess } } = await safeGetSession();
            if (confirmSess) {
                history.replaceState({}, '', window.location.pathname + window.location.search);
            }
        }
        
        // Check if user exists in DB
        var { data: userData, error: userError } = await _supabaseAuth
            .from('users')
            .select('*')
            .eq('auth_id', session.user.id)
            .maybeSingle();
        
        if (userError) console.error('[AUTH] Error checking user:', userError);
        
        if (userData) {
            console.log('[AUTH] User found:', userData.id, userData.email, 'role:', userData.role);
            _currentUser = userData;
            // Update last login
            await _supabaseAuth.from('users')
                .update({ last_login: new Date().toISOString() })
                .eq('auth_id', session.user.id);
        } else {
            // Check if user exists by email (pre-created record)
            var { data: emailUser } = await _supabaseAuth
                .from('users')
                .select('*')
                .eq('email', session.user.email)
                .maybeSingle();
            
            if (emailUser) {
                // Link auth_id to existing user
                console.log('[AUTH] Linking auth_id to existing user:', emailUser.email);
                await _supabaseAuth.from('users')
                    .update({ auth_id: session.user.id, last_login: new Date().toISOString() })
                    .eq('id', emailUser.id);
                _currentUser = { ...emailUser, auth_id: session.user.id };
            } else {
                // Create new user (staff by default for now)
                console.log('[AUTH] Creating new user for:', session.user.email);
                var { data: newUser } = await _supabaseAuth.from('users')
                    .insert({ 
                        email: session.user.email, 
                        auth_id: session.user.id, 
                        is_staff: true, 
                        is_active: true,
                        role: 'staff'
                    })
                    .select()
                    .single();
                _currentUser = newUser;
            }
        }
        
        // Refresh PM access and UI after auth
        try { if (typeof recomputePMAccess === 'function') { recomputePMAccess(); if (typeof render === 'function') render(); } } catch(e) {}
        // Hide overlay and let the CRM load
        hideLoginScreen();
        
        // Add sign-out button
        addSignOutButton();
        
        // Load CRM data after auth is confirmed
        if (!window._crmDataLoaded) {
            console.log('[AUTH] Loading CRM data with auth token');
            window._crmDataLoaded = true;
            try { await load(); render(); } catch(e) { console.error('[AUTH] load/render error:', e); }
        }
        
    } catch (err) {
        console.error('[AUTH] handleAuthSession error:', err);
        if (isAbortError(err) || hasLocalAuth()) {
            // Abort/timeouts should not kick the user out
            hideLoginScreen();
            addSignOutButton();
            if (!window._crmDataLoaded) {
                window._crmDataLoaded = true;
                try { await load(); render(); } catch(e) { console.error('[AUTH] load/render error:', e); }
            }
            return;
        }
        showAuthError('Authentication error: ' + err.message);
    } finally {
        _authHandling = false;
    }
}

function addSignOutButton() {
    if (document.getElementById('sign-out-container')) return;
    var sidebar = document.querySelector('.sidebar, #sidebar, [class*="sidebar"]');
    if (sidebar) {
        var container = document.createElement('div');
        container.id = 'sign-out-container';
        container.style.cssText = 'position: absolute; bottom: 0; left: 0; right: 0; padding: 12px 16px; background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 6px;';
        var email = _currentUser ? _currentUser.email : '';
        var role = _currentUser ? (_currentUser.role || 'staff') : '';
        container.innerHTML = '<div style="display:flex;align-items:center;gap:8px;">' +
            '<div style="width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:center;font-size:12px;color:rgba(255,255,255,0.8);">' + (email ? email[0].toUpperCase() : 'U') + '</div>' +
            '<div style="flex:1;min-width:0;"><div style="font-size:12px;color:rgba(255,255,255,0.8);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + email + '</div>' +
            '<div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;">' + role + '</div></div>' +
            '<button onclick="signOutUser()" style="background:none;border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.6);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;white-space:nowrap;" onmouseover="this.style.borderColor=\'rgba(255,100,100,0.4)\';this.style.color=\'#ff6b6b\'" onmouseout="this.style.borderColor=\'rgba(255,255,255,0.2)\';this.style.color=\'rgba(255,255,255,0.6)\'">Sign Out</button></div>';
        sidebar.style.position = 'relative';
        sidebar.style.paddingBottom = '60px';
        sidebar.appendChild(container);
    }
}

// Swallow Supabase abort errors that otherwise surface as unhandled rejections
window.addEventListener('unhandledrejection', (e) => {
    if (isAbortError(e.reason)) {
        console.warn('[AUTH] Swallowing AbortError (unhandledrejection)');
        if (typeof e.preventDefault === 'function') e.preventDefault();
    }
});

async function initAuth() {
    if (_authInitRunning) return;
    _authInitRunning = true;
    // If we already have a token from localStorage, hide overlay immediately
    if (_authAccessToken) {
        hideLoginScreen();
        addSignOutButton();
        // Don't set _crmDataLoaded here  load() hasn't run yet
    }
    console.log('[AUTH] initAuth called');
    try {
        // Detect if URL has an OAuth callback token
        authPendingToken = /access_token=|code=/.test(location.hash);
        // Apply hash tokens immediately for faster auth
        await applyHashSessionIfPresent();

        // If we already have a local token, use it immediately (no Supabase delay)
        if (hasLocalAuth()) {
            await ensureAccessToken();
            hideLoginScreen();
            addSignOutButton();
            if (!window._crmDataLoaded) {
                window._crmDataLoaded = true;
                try { await load(); render(); } catch(e) { console.error('[AUTH] load/render error:', e); }
            }
            // Background refresh (non-blocking)
            tryRefreshSession();
            _authInitRunning = false;
            return;
        }

        // First attempt at session restore
        await restoreSessionIfPossible();
        var { data: { session } } = await safeGetSession();

        // If no session but URL has token, wait and retry (Supabase needs time to process)
        if (!session && authPendingToken) {
            console.log('[AUTH] Token in URL but no session yet, retrying...');
            await _authWait(800);
            await restoreSessionIfPossible();
            var result = await safeGetSession();
            session = result.data.session;
            authPendingToken = false;
        }

        if (session) {
            console.log('[AUTH] Session found for:', session.user.email);
            _lastAuthAt = Date.now();
            await handleAuthSession(session);
        } else if (authPendingToken) {
            console.log('[AUTH] No session yet, but local auth exists  staying in app');
            hideLoginScreen();
            addSignOutButton();
            if (!window._crmDataLoaded) {
                window._crmDataLoaded = true;
                try { await load(); render(); } catch(e) { console.error('[AUTH] load/render error:', e); }
            }
            // Background refresh only (dont block UI)
            tryRefreshSession();
            _authInitRunning = false;
            return;
        } else {
            console.log('[AUTH] No session found, showing login');
            showLoginScreen();
        }

        // Listen for auth changes (token refresh, sign in/out)
        if (!_authListenerAttached) {
        _authListenerAttached = true;
        _supabaseAuth.auth.onAuthStateChange(async (event, session) => {
            console.log('[AUTH] Auth state changed:', event, 'session:', !!session);

            // For token refreshes, just update the token  don't re-run full auth flow
            if (event === 'TOKEN_REFRESHED' || event === 'USER_UPDATED') {
                _lastAuthAt = Date.now();
                if (session) {
                    _authAccessToken = session.access_token;
                    hideLoginScreen();
                }
                return;
            }

            if (event === 'SIGNED_IN') {
                _lastAuthAt = Date.now();
                if (session && !_authRestoring) {
                    hideLoginScreen();
                    await handleAuthSession(session);
                } else if (session) {
                    _authAccessToken = session.access_token;
                    hideLoginScreen();
                }
                return;
            }

            if (event === 'SIGNED_OUT') {
                if (_manualSignOut) { showLoginScreen(true); return; }

                // Guard against false sign-outs during grace window or pending token
                const inGrace = (Date.now() - _lastAuthAt) < AUTH_GRACE_MS;
                const hasStored = hasLocalAuth();
                const offline = (navigator.onLine === false);

                if (offline || inGrace || authPendingToken || hasStored) {
                    console.log('[AUTH] Ignoring SIGNED_OUT (grace:', inGrace, 'pending:', authPendingToken, 'stored:', hasStored, ')');
                    await restoreSessionIfPossible();
                    var { data: { session: s2 } } = await safeGetSession();
                    if (s2) {
                        _lastAuthAt = Date.now();
                        await handleAuthSession(s2);
                        return;
                    }
                    if (hasStored) {
                        hideLoginScreen();
                        return;
                    }
                }
                // Only show login if we truly have no local auth
                setTimeout(() => { if (!hasLocalAuth()) showLoginScreen(true); }, 1000);
            }
        });
        }

        // Keep-alive: prevent idle sign-out by periodically checking session
        if (!_authKeepAliveStarted) {
            _authKeepAliveStarted = true;
            setInterval(async () => {
                try {
                    var { data: { session: s } } = await safeGetSession();
                    if (!s && getStoredAuth()) {
                        console.log('[AUTH] Keep-alive: restoring session');
                        await restoreSessionIfPossible();
                        // If still no session but we have local auth, keep UI alive
                        if (!s && hasLocalAuth()) hideLoginScreen();
                    }
                } catch (e) {
                    if (!isAbortError(e)) console.error('[AUTH] Keep-alive error:', e);
                }
            }, 30000);
        }

    } catch (err) {
        // AbortError is a known Supabase race condition  NOT a real auth failure
        if (isAbortError(err)) {
            console.warn('[AUTH] initAuth AbortError (safe to ignore), retrying...');
            setTimeout(initAuth, AUTH_RETRY_MS);
            _authInitRunning = false;
            return;
        }
        console.error('[AUTH] initAuth error:', err);
        showLoginScreen();
    } finally {
        _authInitRunning = false;
    }
}

// Initialize auth on page load
if (typeof initQuoteShare === 'function' && initQuoteShare()) {
    // Public quote-share mode (skip auth + app boot)
} else {
    initAuth();
}

    // V39: Populate Project Manager dropdown from people table
    async function loadPMDropdown() {
        var sel = document.getElementById("p-project-manager");
        if (!sel) return;
        sel.innerHTML = '<option value="">Select PM...</option>';
        var clientId = +(document.getElementById("p-client").value || 0);
        var client = getOrgClients().find(function(c) { return c.id === clientId; });
        var pms = client ? getClientPMs(client) : [];
        if (pms.length) {
            pms.forEach(function(pm) {
                var opt = document.createElement("option");
                opt.value = pm.email || pm.name || "";
                opt.dataset.name = pm.name || "";
                opt.textContent = pm.email ? pm.name + " \u2014 " + pm.email : pm.name;
                sel.appendChild(opt);
            });
        } else {
            sel.innerHTML += '<option value="">(No PMs for this client)</option>';
        }
    }
// V39: Override openModal to populate PM dropdown when project modal opens
    var _origOpenModal = typeof openModal === 'function' ? openModal : null;
    

async function fetchCamScannerPdf(docId) {
  try {
    var resp = await fetch('/api/camscanner?endpoint=doc/detail&doc_id=' + docId);
    var data = await resp.json();
    if (data && data.data && data.data.download_url) {
      return data.data.download_url;
    }
  } catch(e) { console.log('CamScanner PDF fetch error:', e); }
  return null;
}

function countScanPdfs() {
  window.scanPdfCount = getOrgScans().filter(function(s) { return s.pdf_url; }).length;
}


// === CLIENT EDIT PANEL ===
var editingClientId = null;
var pendingClientPMs = [];
function openClientPanel(id) {
  var c = id ? getOrgClients().find(function(x) { return x.id === id; }) : null;
  if (!c && id) return;
  if (!c) c = {id:0, company:'', email:'', phone:'', address:'', city:'', state:'', zip:'', cc_emails:'', notes:'', project_managers:[]};
  editingClientId = id;
  pendingClientPMs = Array.isArray(c.project_managers) ? c.project_managers : getClientPMs(c);
  $('#client-modal-title').textContent = 'Edit Client: ' + (c.company || '');
  $('#ce-company').value = c.company || '';
  $('#ce-email').value = c.email || '';
  $('#ce-phone').value = c.phone || '';
  $('#ce-address').value = c.address || '';
  $('#ce-city').value = c.city || '';
  $('#ce-state').value = c.state || '';
  $('#ce-zip').value = c.zip || '';
  $('#ce-ccemails').value = c.cc_emails || '';
  $('#ce-notes').value = c.notes || '';
  // Show current PMs
  if(document.getElementById("pm-name")){document.getElementById("pm-name").value="";document.getElementById("pm-email").value="";document.getElementById("pm-save-btn").textContent="Add";} editingPMIndex=null; renderClientPMs(c);
  // Show projects for this client
  var cProjs = getOrgProjects().filter(function(p) { return p.clientId === id; });
  var projHTML = '<label class="form-label">Projects (' + cProjs.length + ')</label>';
  if (cProjs.length) { projHTML += '<div style="font-size:13px">' + cProjs.map(function(p) { return '<div style="padding:4px 0;border-bottom:1px solid var(--border)">' + escapeHtml(p.name) + (p.project_manager ? ' <span style="color:var(--text-secondary)">PM: '+escapeHtml(p.project_manager)+'</span>' : '') + '</div>'; }).join('') + '</div>'; }
  $('#ce-projects').innerHTML = projHTML;
  $('#client-edit-modal').style.display = 'block';
}

let editingPMIndex = null;
function getClientPMs(c) { let pms = c && c.project_managers ? c.project_managers : []; if (typeof pms === "string") { try { pms = JSON.parse(pms); } catch(e) { pms = []; } } return Array.isArray(pms) ? pms : []; }
function renderClientPMs(c) { var pms = getClientPMs(c); if (!pms.length) { $("#ce-pm-list").innerHTML = '<span style="color:var(--text-secondary);font-size:13px">No PMs assigned</span>'; return; } $("#ce-pm-list").innerHTML = pms.map(function(pm, i) { var label = (pm.name || "") + (pm.email ? " \u2014 " + pm.email : ""); return '<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;background:var(--bg-secondary);padding:6px 10px;border-radius:6px;margin:4px 0"><div style="font-size:13px">' + label + '</div><div style="display:flex;gap:6px"><button class="btn btn-outline" style="padding:3px 8px;font-size:11px" onclick="editPM(' + i + ')">Edit</button><button class="btn btn-outline" style="padding:3px 8px;font-size:11px;color:var(--red);border-color:var(--red)" onclick="deletePM(' + i + ')">Delete</button></div></div>'; }).join(""); }
async function savePM() { var name = $("#pm-name").value.trim(); var email = $("#pm-email").value.trim(); if (!name) return toast("Enter PM name"); var c = getOrgClients().find(function(x) { return x.id === editingClientId; }); var pms = c ? getClientPMs(c) : (pendingClientPMs || []); var pmObj = { name: name, email: email }; if (editingPMIndex !== null) { pms[editingPMIndex] = pmObj; } else { pms.push(pmObj); } if (c) { c.project_managers = pms; await sbUpdate('clients', c.id, { project_managers: JSON.stringify(pms), cc_emails: pms.map(function(pm){return pm.email}).filter(Boolean).join(',') }); } else { pendingClientPMs = pms; } editingPMIndex = null; $("#pm-name").value = ""; $("#pm-email").value = ""; $("#pm-save-btn").textContent = "Add"; renderClientPMs(c || { project_managers: pendingClientPMs }); }
function editPM(idx) { var c = getOrgClients().find(function(x) { return x.id === editingClientId; }); var pms = c ? getClientPMs(c) : (pendingClientPMs || []); var pm = pms[idx]; if (!pm) return; $("#pm-name").value = pm.name || ""; $("#pm-email").value = pm.email || ""; editingPMIndex = idx; $("#pm-save-btn").textContent = "Save"; }
async function deletePM(idx) { var c = getOrgClients().find(function(x) { return x.id === editingClientId; }); var pms = c ? getClientPMs(c) : (pendingClientPMs || []); pms.splice(idx, 1); if (c) { c.project_managers = pms; await sbUpdate('clients', c.id, { project_managers: JSON.stringify(pms), cc_emails: pms.map(function(pm){return pm.email}).filter(Boolean).join(',') }); } else { pendingClientPMs = pms; } renderClientPMs(c || { project_managers: pendingClientPMs }); }
function closeClientModal() {
  $('#client-edit-modal').style.display = 'none';
  editingClientId = null;
  pendingClientPMs = [];
}

        async function saveClientEdit() {
            var c = getOrgClients().find(function(x) { return x.id === editingClientId; });
            var isNew = !editingClientId || !c;
            var pms = (c && c.project_managers) ? c.project_managers : (pendingClientPMs || []);
            if (typeof pms === 'string') { try { pms = JSON.parse(pms); } catch(e) { pms = []; } }
            var updates = {
                company: $('#ce-company').value || '',
                email: $('#ce-email').value || '',
                phone: $('#ce-phone').value || '',
                address: $('#ce-address').value || '',
                city: $('#ce-city').value || '',
                state: $('#ce-state').value || '',
                zip: $('#ce-zip').value || '',
                cc_emails: ($('#ce-ccemails').value || '').trim() || pms.map(function(pm){return pm.email}).filter(Boolean).join(','),
                notes: $('#ce-notes').value || '',
                project_managers: JSON.stringify(pms)
            };
            try {
                if (isNew) {
                    var newId = await sbInsert('clients', updates);
                    if (!newId) throw new Error('Client insert failed');
                    c = assignOrgId({ id: newId, ...updates }, 'clients');
                    clients.push(c);
                    editingClientId = newId;
                    pendingClientPMs = [];
                } else {
                    await sbUpdate('clients', editingClientId, updates);
                    Object.assign(c, updates);
                }
                recomputePMAccess();
                renderClients();
                closeClientModal();
            } catch(e) {
                console.error('Save client error:', e);
                alert('Error saving client: ' + e.message);
            }
        }


function getProjectEmailRecipients(projectId) {
  var proj = getOrgProjects().find(function(p) { return p.id === projectId; });
  if (!proj) return {to:"", cc:[]};
  var client = getOrgClients().find(function(c) { return c.id === proj.clientId; });
  if (!client) return {to:"", cc:[]};
  var to = client.email || "";
  var cc = [];
  var pmEmails = getProjectPmEmails(proj);
  if (pmEmails.length) {
    cc = pmEmails;
  } else {
    var pms = typeof getClientPMs === "function" ? getClientPMs(client) : [];
    if (proj.project_manager) {
      var pm = pms.find(function(x) { return (x.name || x) === proj.project_manager; });
      if (pm && pm.email) cc = [pm.email];
    } else {
      cc = pms.map(function(pm){return pm.email}).filter(Boolean);
    }
  }
  return {to:to, cc:cc};
}
function emailClient(projectId) { var rec = getProjectEmailRecipients(projectId); if (!rec.to) return toast("No client email on file"); var subject = "Project Update"; var ccStr = rec.cc.join(";"); window.open("mailto:" + encodeURIComponent(rec.to) + "?cc=" + encodeURIComponent(ccStr) + "&subject=" + encodeURIComponent(subject), "_blank"); }
async function sendEmailViaOutlook(to, ccList, subject, body) {
  try {
    const res = await fetch('/api/send-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ to, cc: ccList || [], subject, body })
    });
    if (!res.ok) {
      const t = await res.text().catch(() => '');
      console.warn('Outlook send failed:', t);
      return false;
    }
    return true;
  } catch (e) {
    console.warn('Outlook send error:', e);
    return false;
  }
}
function fallbackMailto(to, ccList, subject, body) {
  var ccStr = (ccList || []).filter(Boolean).join(";");
  var url = "mailto:" + encodeURIComponent(to) +
    "?cc=" + encodeURIComponent(ccStr) +
    "&subject=" + encodeURIComponent(subject) +
    "&body=" + encodeURIComponent(body);
  window.open(url, "_blank");
}
async function sendReceivingEmail(clientId, pmName, po, projectId, details) {
  var client = getOrgClients().find(function(c) { return c.id === clientId; });
  if (!client || !client.email) return;
  var pms = typeof getClientPMs === "function" ? getClientPMs(client) : [];
  var pm = pmName ? pms.find(function(x){ return x.name === pmName; }) : null;
  var cc = pm && pm.email ? [pm.email] : [];
  var subject = buildReceivingEmailSubject(po);
  var body = buildReceivingEmailBody(po, details);
  const ok = await sendEmailViaOutlook(client.email, cc, subject, body);
  if (!ok) fallbackMailto(client.email, cc, subject, body);
}
async function sendReceivingEmailMulti(clientId, pmEmails, po, projectId, details) {
  var client = getOrgClients().find(function(c) { return c.id === clientId; });
  if (!client || !client.email) return;
  var subject = buildReceivingEmailSubject(po);
  var body = buildReceivingEmailBody(po, details);
  const ok = await sendEmailViaOutlook(client.email, pmEmails || [], subject, body);
  if (!ok) fallbackMailto(client.email, pmEmails || [], subject, body);
}
function buildReceivingEmailSubject(po) {
  return "Shipment Received PO: " + (po || "");
}
function buildReceivingEmailBody(po, details) {
  var d = details || {};
  var statusLabel = d.status === "received" ? "Complete" : "Incomplete";
  var lines = [];
  lines.push("Hi, Your shipment under PO:" + (po || "") + " has been received.");
  if (d.manufacturer) lines.push(" Manufacturer: " + d.manufacturer);
  if (d.receivedDate) lines.push(" Received Date: " + d.receivedDate);
  lines.push("Status (Complete or incomplete): " + statusLabel);
  if (d.pdfUrl) lines.push("Packing Slip Link: " + d.pdfUrl);
  lines.push("Thanks,");
  lines.push("Warehouse Vector Installation Services");
  return lines.join("\n");
}
function getCamScanForShipment(s) {
  return (camScans || []).find(function(sc) { return sc.po === s.subitem || sc.po === s.po; });
}

// === CAMSCANNER PDF INTEGRATION ===
async function loadCamScannerDocs(force) {
  if (camScansLoaded && !force) return;
  try {
    var resp = await fetch("/api/camscanner?endpoint=query_recent_doc_list&num=50&order_type=0");
    var data = await resp.json();
    var docs = data.doc_list || [];
    camScans = docs.map(function(doc) {
      var fileId = doc.file_name ? doc.file_name.replace(".jdoc", "") : "";
      var pdfLink = fileId ? ("https://www.camscanner.com/file/detail?id=" + fileId) : "";
      return {
        id: "cs_" + (doc.file_name || doc.first_page_id || doc.title || Math.random().toString(36).slice(2)),
        filename: doc.title || doc.file_name || "CamScanner Doc",
        timestamp: doc.modify_time ? new Date(doc.modify_time * 1000).toISOString() : new Date().toISOString(),
        status: "done",
        po: doc.title || "",
        pdf_url: pdfLink,
        source: "camscanner"
      };
    });
    camScansLoaded = true;
  } catch (e) {
    console.error("CamScanner load error:", e);
    camScans = [];
  } finally {
    renderScans();
    if (typeof renderShipments === "function") renderShipments();
    if (typeof renderCamScanInbox === "function") renderCamScanInbox();
  }
}

</script>
    <div class="modal-bg" id="modal-loadout">
        <div class="modal" style="max-width:680px">
            <div class="modal-header"><h2 class="modal-title">Load-out Verification</h2><button class="modal-close" onclick="closeModal('loadout')"></button></div>
            <div class="modal-body">
                <div id="loadout-meta" style="font-size:12px;color:var(--muted);margin-bottom:12px"></div>
                <div id="loadout-items"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('loadout')">Cancel</button>
                <button class="btn btn-primary" onclick="saveLoadoutVerification()">Save Verification</button>
            </div>
        </div>
    </div>
</body>
</html>
